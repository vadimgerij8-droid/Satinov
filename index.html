<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=yes"/>
  <title>FANTASYAS ¬∑ –º–æ–±—ñ–ª—å–Ω–∞ –≤–µ—Ä—Å—ñ—è</title>
  <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;500;600;700;800&display=swap" rel="stylesheet"/>
  <style>
    /* ========== –û–ü–¢–ò–ú–Ü–ó–û–í–ê–ù–ò–ô –¢–ê –û–ù–û–í–õ–ï–ù–ò–ô –ß–û–†–ù–û-–ë–Ü–õ–ò–ô –°–¢–ò–õ–¨ –ó –ê–ù–Ü–ú–ê–¶–Ü–Ø–ú–ò ========== */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Manrope', sans-serif;
      -webkit-tap-highlight-color: transparent;
    }

    :root {
      --bg: #000000;
      --surface: rgba(17, 17, 17, 0.7); /* –ü–æ–∫—Ä–∞—â–µ–Ω–æ –ø—Ä–æ–∑–æ—Ä—ñ—Å—Ç—å –¥–ª—è –∫—Ä–∞—â–æ–≥–æ –≤–∏–≥–ª—è–¥—É */
      --card: rgba(26, 26, 26, 0.6);
      --border: rgba(255, 255, 255, 0.15);
      --text: #ffffff;
      --text-sec: #bbbbbb; /* –¢—Ä–æ—Ö–∏ —Å–≤—ñ—Ç–ª—ñ—à–∏–π –¥–ª—è –∫—Ä–∞—â–æ—ó —á–∏—Ç–∞–±–µ–ª—å–Ω–æ—Å—Ç—ñ */
      --accent: #999999;
      --hover: rgba(50, 50, 50, 0.8);
      --shadow: 0 6px 24px rgba(0, 0, 0, 0.4); /* –û–ø—Ç–∏–º—ñ–∑–æ–≤–∞–Ω–æ –¥–ª—è –ø—Ä–æ–¥—É–∫—Ç–∏–≤–Ω–æ—Å—Ç—ñ */
      --blur: blur(12px);
      --font-scale: 1;
      --post-padding: 20px;
      --avatar-size: 48px;
      --font-size-base: 1rem;
      --transition-fast: 0.2s ease; /* –°—Ç–∞–Ω–¥–∞—Ä—Ç–∏–∑–æ–≤–∞–Ω—ñ –ø–µ—Ä–µ—Ö–æ–¥–∏ –¥–ª—è –æ–ø—Ç–∏–º—ñ–∑–∞—Ü—ñ—ó */
      --transition-slow: 0.4s cubic-bezier(0.25, 0.1, 0.25, 1);
    }

    body.light {
      --bg: #f0f0f0;
      --surface: rgba(255, 255, 255, 0.7);
      --card: rgba(240, 240, 240, 0.6);
      --border: rgba(0, 0, 0, 0.15);
      --text: #111111;
      --text-sec: #666666;
      --accent: #777777;
      --hover: rgba(220, 220, 220, 0.8);
      --shadow: 0 6px 24px rgba(0, 0, 0, 0.08);
    }

    body.tv {
      --font-scale: 1.5;
      --post-padding: 40px;
      --avatar-size: 90px;
      --font-size-base: 1.2rem;
    }

    body.tv .post { margin-bottom: 40px; }
    body.tv .post-header { gap: 24px; }
    body.tv .username { font-size: 1.8rem; }
    body.tv .post-content { font-size: 1.6rem; line-height: 1.5; }
    body.tv .post-footer button { font-size: 1.8rem; gap: 16px; padding: 14px 28px; }
    body.tv .subscribe-post-btn { font-size: 1.4rem; padding: 12px 28px; }
    body.tv .comments-section { margin-top: 40px; }
    body.tv .comment .avatar { width: 60px; height: 60px; }
    body.tv .comment-content { font-size: 1.4rem; padding: 16px 24px; }
    body.tv .comment-input-area textarea { font-size: 1.4rem; padding: 16px 24px; }
    body.tv .top-bar { height: 100px; }
    body.tv .site-name { font-size: 2.8rem; }
    body.tv .burger { width: 50px; height: 34px; }
    body.tv .burger span { height: 4px; }
    body.tv .sidebar a { font-size: 2rem; margin: 2.5rem 0; }
    body.tv .card { padding: 40px; }
    body.tv input, body.tv textarea, body.tv button { font-size: 1.4rem; padding: 18px 28px; }
    body.tv :focus { outline: 3px solid var(--accent); outline-offset: 5px; }

    body {
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
      transition: background var(--transition-fast), color var(--transition-fast);
      font-size: calc(var(--font-size-base) * var(--font-scale));
      will-change: background, color; /* –û–ø—Ç–∏–º—ñ–∑–∞—Ü—ñ—è –¥–ª—è –∞–Ω—ñ–º–∞—Ü—ñ–π */
    }

    .top-bar {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      height: 60px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 20px;
      background: var(--surface);
      backdrop-filter: var(--blur);
      border-bottom: 1px solid var(--border);
      box-shadow: var(--shadow);
      z-index: 1000;
      transition: background var(--transition-fast);
    }
    .top-bar:hover { background: var(--hover); }

    .site-name {
      font-size: 1.8rem;
      font-weight: 800;
      background: linear-gradient(145deg, #ddd, #999); /* –ß–æ—Ä–Ω–æ-–±—ñ–ª–∏–π –≥—Ä–∞–¥—ñ—î–Ω—Ç */
      -webkit-background-clip: text;
      background-clip: text;
      color: transparent;
      letter-spacing: -0.4px;
      animation: gradient-shift 4s infinite ease-in-out;
    }
    @keyframes gradient-shift {
      0% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
      100% { background-position: 0% 50%; }
    }
    body.light .site-name { background: linear-gradient(145deg, #222, #666); -webkit-background-clip: text; }

    .burger {
      width: 28px;
      height: 20px;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
      cursor: pointer;
    }
    .burger span {
      height: 2px;
      width: 100%;
      background: var(--text);
      border-radius: 4px;
      transition: transform var(--transition-slow);
    }
    .burger.active span:nth-child(1) { transform: rotate(45deg) translate(6px, 5px); }
    .burger.active span:nth-child(2) { opacity: 0; transform: scale(0); }
    .burger.active span:nth-child(3) { transform: rotate(-45deg) translate(6px, -5px); }

    .sidebar {
      position: fixed;
      top: 0;
      left: -280px;
      width: 260px;
      height: 100%;
      background: var(--surface);
      backdrop-filter: var(--blur);
      padding: 90px 24px;
      border-right: 1px solid var(--border);
      box-shadow: var(--shadow);
      transition: left var(--transition-slow);
      z-index: 999;
    }
    body.tv .sidebar { width: 320px; left: -320px; }
    .sidebar.active { left: 0; }

    .sidebar a {
      display: flex;
      align-items: center;
      gap: 10px;
      color: var(--text-sec);
      text-decoration: none;
      font-size: 1.2rem;
      font-weight: 600;
      margin: 1.8rem 0;
      transition: transform var(--transition-fast), color var(--transition-fast);
      position: relative;
      width: fit-content;
    }
    .sidebar a .icon-svg {
      width: 24px;
      height: 24px;
      stroke: var(--text-sec);
      stroke-width: 1.6;
      fill: none;
      transition: stroke var(--transition-fast), transform var(--transition-fast);
    }
    .sidebar a:hover .icon-svg {
      stroke: var(--text);
      transform: scale(1.08) rotate(4deg);
    }
    .sidebar a:hover {
      color: var(--text);
      transform: translateX(6px);
    }
    .sidebar a::after {
      content: '';
      position: absolute;
      bottom: -3px;
      left: 0;
      width: 0;
      height: 1.5px;
      background: var(--accent);
      transition: width var(--transition-fast);
    }
    .sidebar a:hover::after { width: 100%; }

    .badge {
      background: #ee4444;
      color: white;
      border-radius: 50%;
      padding: 1px 6px;
      font-size: 0.7rem;
      margin-left: 6px;
      display: inline-block;
      animation: pulse-badge 1.4s infinite ease-in-out;
    }
    @keyframes pulse-badge {
      0% { transform: scale(1); }
      50% { transform: scale(1.08); }
      100% { transform: scale(1); }
    }

    .main-content {
      margin-top: 80px;
      padding: 16px;
      max-width: 640px;
      margin-left: auto;
      margin-right: auto;
      transition: all var(--transition-slow);
    }
    body.tv .main-content { max-width: 960px; }

    .section { display: none; opacity: 0; transform: translateY(15px); transition: opacity var(--transition-slow), transform var(--transition-slow); }
    .section.active { display: block; opacity: 1; transform: translateY(0); }

    .card {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 24px;
      padding: 20px;
      margin-bottom: 20px;
      box-shadow: var(--shadow);
      backdrop-filter: var(--blur);
      transition: border-color var(--transition-fast), transform var(--transition-fast);
    }
    .card:hover { border-color: var(--accent); transform: translateY(-4px); }

    input, textarea {
      width: 100%;
      padding: 14px 18px;
      border-radius: 18px;
      border: 1px solid var(--border);
      background: var(--surface);
      color: var(--text);
      font-size: 1rem;
      outline: none;
      transition: border-color var(--transition-fast), background var(--transition-fast), transform var(--transition-fast);
      backdrop-filter: var(--blur);
    }
    input:focus, textarea:focus { border-color: var(--accent); background: var(--card); transform: scale(1.005); }
    ::placeholder { color: var(--text-sec); opacity: 0.6; }

    button {
      padding: 12px 24px;
      border: none;
      border-radius: 36px;
      background: var(--surface);
      color: var(--text);
      font-weight: 600;
      border: 1px solid var(--border);
      cursor: pointer;
      transition: background var(--transition-fast), transform var(--transition-fast), border-color var(--transition-fast);
      box-shadow: var(--shadow);
      backdrop-filter: var(--blur);
      position: relative;
      overflow: hidden;
    }
    button::before {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      width: 0;
      height: 0;
      background: rgba(255,255,255,0.08);
      border-radius: 50%;
      transform: translate(-50%, -50%);
      transition: width 0.4s, height 0.4s;
    }
    button:active::before {
      width: 180%;
      height: 180%;
    }
    button:hover {
      background: var(--hover);
      transform: scale(1.015);
      border-color: var(--accent);
    }

    .skeleton-post {
      background: linear-gradient(90deg, var(--card) 25%, var(--hover) 50%, var(--card) 75%);
      background-size: 200% 100%;
      animation: skeleton-loading 1.4s infinite ease-in-out;
      border-radius: 24px;
      height: 180px;
      margin-bottom: 20px;
    }
    @keyframes skeleton-loading {
      0% { background-position: 200% 0; }
      100% { background-position: -200% 0; }
    }

    .feed-header {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
      justify-content: center;
    }
    .feed-header button {
      flex: 1;
      max-width: 180px;
      background: var(--surface);
      border: 1px solid var(--border);
      font-size: 1rem;
      padding: 10px 18px;
      backdrop-filter: var(--blur);
      transition: all var(--transition-fast);
    }
    .feed-header button.active {
      background: var(--accent);
      color: black;
      border-color: var(--accent);
      transform: scale(1.03);
    }

    .popular-search { margin-bottom: 16px; }
    .feed { display: flex; flex-direction: column; gap: 20px; }

    .post {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 24px;
      padding: var(--post-padding);
      opacity: 0;
      transform: translateY(25px) scale(0.98);
      transition: opacity var(--transition-slow), transform var(--transition-slow), box-shadow var(--transition-fast);
      backdrop-filter: var(--blur);
      box-shadow: var(--shadow);
    }
    .post.show { opacity: 1; transform: translateY(0) scale(1); }
    .post:hover {
      box-shadow: 0 10px 32px rgba(0, 0, 0, 0.5);
      border-color: var(--accent);
    }

    .post-header {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 16px;
      position: relative;
      flex-wrap: wrap;
    }
    .avatar {
      width: var(--avatar-size);
      height: var(--avatar-size);
      border-radius: 50%;
      background: #222;
      background-size: cover;
      background-position: center;
      border: 2px solid var(--border);
      cursor: pointer;
      transition: border-color var(--transition-fast), transform var(--transition-fast), box-shadow var(--transition-fast);
      box-shadow: 0 0 8px rgba(255,255,255,0.08);
    }
    .avatar:hover { border-color: var(--accent); transform: scale(1.04) rotate(4deg); box-shadow: 0 0 12px rgba(255,255,255,0.15); }
    .post-user {
      display: flex;
      flex-direction: column;
    }
    .username {
      font-weight: 700;
      font-size: 1.1rem;
      cursor: pointer;
      text-decoration: none;
      color: var(--text);
      transition: color var(--transition-fast);
    }
    .username:hover { text-decoration: underline; color: var(--accent); }
    .user-id-small {
      color: var(--accent);
      font-size: 0.8rem;
    }
    .edit-post-btn {
      background: none;
      border: none;
      margin-left: auto;
      cursor: pointer;
    }
    .edit-post-btn svg {
      width: 22px;
      height: 22px;
      stroke: var(--text-sec);
      transition: stroke var(--transition-fast), transform var(--transition-fast);
    }
    .edit-post-btn:hover svg {
      stroke: var(--text);
      transform: scale(1.08) rotate(8deg);
    }
    .menu-btn {
      margin-left: 6px;
      font-size: 1.8rem;
      line-height: 1;
      background: none;
      border: none;
      color: var(--text-sec);
      padding: 0 6px;
      cursor: pointer;
      transition: transform var(--transition-fast), color var(--transition-fast);
    }
    .menu-btn:hover { color: var(--text); transform: scale(1.15) rotate(90deg); }

    .subscribe-post-btn {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 28px;
      padding: 5px 14px;
      font-size: 0.85rem;
      font-weight: 600;
      margin-left: 14px;
      cursor: pointer;
      transition: all var(--transition-fast);
      backdrop-filter: var(--blur);
    }
    .subscribe-post-btn:hover {
      background: var(--accent);
      color: black;
      border-color: var(--accent);
      transform: scale(1.04) rotate(1.5deg);
    }
    .subscribe-post-btn:active {
      animation: pulse 0.25s ease;
    }

    .post-content {
      font-size: 1rem;
      line-height: 1.55;
      margin-bottom: 14px;
      word-break: break-word;
      transition: transform var(--transition-fast);
    }
    .post-content:hover {
      transform: translateX(4px);
    }

    .truncated + .show-more {
      background: none;
      border: none;
      color: var(--accent);
      font-weight: 600;
      padding: 3px 6px;
      cursor: pointer;
      transition: color var(--transition-fast);
    }
    .truncated + .show-more:hover {
      color: var(--text);
    }

    .post-media {
      width: 100%;
      border-radius: 20px;
      margin: 14px 0;
      transition: transform var(--transition-fast), box-shadow var(--transition-fast);
      loading: lazy; /* –û–ø—Ç–∏–º—ñ–∑–∞—Ü—ñ—è –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è */
    }
    .post-media:hover {
      transform: scale(1.015);
      box-shadow: 0 4px 12px rgba(0,0,0,0.25);
    }

    .post-footer {
      display: flex;
      gap: 24px;
      margin: 14px 0 6px;
    }

    .post-footer button {
      background: none;
      border: none;
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 1rem;
      padding: 5px 10px;
      border-radius: 36px;
      color: var(--text-sec);
      transition: all var(--transition-fast);
    }

    .post-footer button:hover {
      background: var(--hover);
      color: var(--text);
      transform: scale(1.08);
      border: none;
    }

    .like-btn svg {
      width: 26px;
      height: 26px;
      fill: transparent;
      stroke: var(--text-sec);
      stroke-width: 1.8;
      transition: all var(--transition-fast);
    }

    .like-btn.liked svg {
      fill: #ff3040;
      stroke: #ff3040;
      animation: heartPop 0.4s ease;
    }

    .comments-toggle svg {
      width: 24px;
      height: 24px;
      stroke: var(--text-sec);
      stroke-width: 1.8;
      fill: none;
      transition: stroke var(--transition-fast), transform var(--transition-fast);
    }

    .comments-toggle:hover svg {
      stroke: var(--text);
      transform: rotate(-4deg) scale(1.08);
    }

    .comments-section {
      margin-top: 20px;
      border-top: 1px solid var(--border);
      padding-top: 16px;
      transition: height var(--transition-slow);
    }
    .comment {
      display: flex;
      gap: 10px;
      margin-bottom: 14px;
      animation: fadeSlideUp 0.35s ease;
    }
    .comment .avatar { width: 32px; height: 32px; }
    .comment-content {
      background: var(--surface);
      padding: 10px 14px;
      border-radius: 20px;
      flex: 1;
      border: 1px solid var(--border);
      backdrop-filter: var(--blur);
      transition: transform var(--transition-fast);
    }
    .comment-content:hover {
      transform: translateY(-2px);
    }
    .comment-author { font-weight: 700; margin-right: 6px; cursor: pointer; }
    .comment-author:hover { text-decoration: underline; color: var(--accent); }

    .comment-input-area {
      display: flex;
      gap: 8px;
      margin: 14px 0 6px;
    }
    .comment-input-area textarea {
      flex: 1;
      min-height: 40px;
      border-radius: 28px;
      padding: 10px 16px;
      transition: box-shadow var(--transition-fast);
    }
    .comment-input-area textarea:focus {
      box-shadow: 0 0 8px var(--accent);
    }

    .emoji-panel {
      display: flex;
      gap: 6px;
      background: var(--surface);
      border-radius: 36px;
      padding: 6px 12px;
      border: 1px solid var(--border);
      width: fit-content;
      margin-bottom: 8px;
      backdrop-filter: var(--blur);
    }
    .emoji-panel span {
      font-size: 1.6rem;
      cursor: pointer;
      transition: transform var(--transition-fast);
      filter: grayscale(30%);
    }
    .emoji-panel span:hover { transform: scale(1.25) rotate(12deg); filter: grayscale(0); }

    .search-input {
      margin-bottom: 20px;
      padding: 16px 20px;
      font-size: 1rem;
      transition: box-shadow var(--transition-fast);
    }
    .search-input:focus {
      box-shadow: 0 0 12px var(--accent);
    }
    .user-item {
      display: flex;
      align-items: center;
      gap: 14px;
      padding: 14px;
      border-radius: 24px;
      background: var(--card);
      border: 1px solid var(--border);
      margin-bottom: 10px;
      cursor: pointer;
      transition: transform var(--transition-fast), border-color var(--transition-fast);
      backdrop-filter: var(--blur);
      box-shadow: var(--shadow);
    }
    .user-item:hover { border-color: var(--accent); transform: translateX(5px) scale(1.015); }
    .user-id { color: var(--accent); font-size: 0.85rem; }
    .follow-btn {
      margin-left: auto;
      background: var(--accent);
      color: black;
      font-weight: 700;
      padding: 7px 20px;
      border-radius: 36px;
      border: none;
      transition: all var(--transition-fast);
    }
    .follow-btn:hover {
      transform: scale(1.04) rotate(-2.5deg);
    }

    .chat-list { display: flex; flex-direction: column; gap: 6px; max-height: 65vh; overflow-y: auto; }
    .chat-item {
      display: flex; align-items: center; gap: 14px; padding: 14px; border-radius: 22px;
      background: var(--card); border: 1px solid var(--border); cursor: pointer; transition: transform var(--transition-fast), background var(--transition-fast), border-color var(--transition-fast);
      backdrop-filter: var(--blur);
    }
    .chat-item:hover { background: var(--hover); border-color: var(--accent); transform: translateY(-2px); }
    .chat-item.unread { background: rgba(255,255,255,0.04); border-left: 3px solid var(--accent); }
    .chat-avatar { width: 52px; height: 52px; border-radius: 50%; background-size: cover; border: 2px solid var(--border); transition: transform var(--transition-fast); }
    .chat-avatar:hover { transform: scale(1.08); }
    .chat-info { flex: 1; min-width: 0; }
    .chat-name { font-weight: 700; font-size: 1rem; display: flex; align-items: center; gap: 6px; }
    .chat-userid { color: var(--accent); font-size: 0.8rem; }
    .chat-last { color: var(--text-sec); font-size: 0.85rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .chat-meta { display: flex; flex-direction: column; align-items: flex-end; gap: 3px; }
    .chat-time { color: var(--text-sec); font-size: 0.7rem; }
    .chat-badge { background: var(--accent); color: black; border-radius: 50%; min-width: 22px; height: 22px; display: flex; align-items: center; justify-content: center; font-size: 0.75rem; font-weight: 700; animation: bounce 0.4s ease; }

    .chat-window {
      display: none; flex-direction: column; height: 65vh; border: 1px solid var(--border); border-radius: 28px;
      overflow: hidden; background: var(--card); margin-top: 16px;
      backdrop-filter: var(--blur);
      box-shadow: var(--shadow);
      transition: transform var(--transition-fast);
    }
    .chat-window:hover {
      transform: translateY(-4px);
    }
    .chat-header { padding: 18px; border-bottom: 1px solid var(--border); display: flex; align-items: center; gap: 8px; background: var(--surface); }
    .chat-messages { flex: 1; padding: 18px; overflow-y: auto; display: flex; flex-direction: column; gap: 10px; }
    .message { max-width: 70%; padding: 10px 16px; border-radius: 24px; animation: messagePop 0.25s; word-break: break-word; backdrop-filter: var(--blur); transition: transform var(--transition-fast); }
    .message:hover { transform: scale(1.015); }
    .message.sent { background: var(--accent); color: black; align-self: flex-end; border-bottom-right-radius: 5px; }
    .message.received { background: var(--surface); border: 1px solid var(--border); align-self: flex-start; border-bottom-left-radius: 5px; }
    .chat-input { display: flex; padding: 14px; border-top: 1px solid var(--border); background: var(--surface); }
    .chat-input input { flex: 1; margin-right: 14px; border-radius: 36px; transition: box-shadow var(--transition-fast); }
    .chat-input input:focus { box-shadow: 0 0 8px var(--accent); }

    .profile-header { display: flex; flex-wrap: wrap; gap: 24px; align-items: center; position: relative; }
    .profile-header.sticky { position: sticky; top: 60px; background: var(--surface); backdrop-filter: var(--blur); z-index: 900; padding: 14px; border-radius: 24px; }
    .profile-avatar { width: 110px; height: 110px; border-radius: 50%; background: #222; background-size: cover; border: 2.5px solid var(--border); cursor: pointer; transition: transform var(--transition-fast), box-shadow var(--transition-fast); box-shadow: 0 0 12px rgba(255,255,255,0.08); }
    .profile-avatar:hover { border-color: var(--accent); transform: scale(1.015) rotate(4deg); box-shadow: 0 0 16px rgba(255,255,255,0.15); }
    .edit-profile-btn {
      background: none;
      border: none;
      margin-left: auto;
      cursor: pointer;
    }
    .edit-profile-btn svg {
      width: 26px;
      height: 26px;
      stroke: var(--text-sec);
      transition: stroke var(--transition-fast), transform var(--transition-fast);
    }
    .edit-profile-btn:hover svg { stroke: var(--text); transform: rotate(90deg); }

    .profile-tabs {
      display: flex;
      gap: 10px;
      margin: 20px 0;
      border-bottom: 1px solid var(--border);
      padding-bottom: 10px;
    }
    .profile-tab {
      background: none;
      border: none;
      color: var(--text-sec);
      font-size: 1rem;
      padding: 7px 14px;
      border-radius: 28px;
      transition: transform var(--transition-fast);
    }
    .profile-tab.active {
      background: var(--accent);
      color: black;
      transform: scale(1.03);
    }

    .modal {
      position: fixed; inset: 0; background: rgba(0,0,0,0.6); backdrop-filter: blur(10px);
      display: none; align-items: center; justify-content: center; z-index: 3000;
    }
    .modal.active { display: flex; }
    .modal-content {
      background: var(--card); border: 1px solid var(--border); border-radius: 36px; padding: 28px;
      width: 90%; max-width: 460px; box-shadow: var(--shadow); animation: modalPop 0.25s;
      backdrop-filter: var(--blur);
    }
    .close-modal { float: right; font-size: 2.2rem; line-height: 1; cursor: pointer; color: var(--text-sec); transition: transform var(--transition-fast); }
    .close-modal:hover { transform: rotate(90deg); }

    .feed-end-sentinel {
      height: 15px;
      width: 100%;
    }

    @media (max-width: 700px) {
      .main-content { padding: 14px; }
      .profile-header { flex-direction: column; text-align: center; }
      .post-footer { gap: 14px; }
      .post-footer button { padding: 5px 7px; }
      .like-btn svg, .comments-toggle svg { width: 22px; height: 22px; }
    }
  </style>
</head>
<body>

<div class="top-bar">
  <div class="burger" id="burger"><span></span><span></span><span></span></div>
  <div class="site-name">FANTASYAS</div>
</div>

<nav class="sidebar" id="sidebar">
  <a data-section="home">
    <svg class="icon-svg" viewBox="0 0 24 24"><path d="M3 10l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>
    –ì–æ–ª–æ–≤–Ω–∞
  </a>
  <a data-section="search">
    <svg class="icon-svg" viewBox="0 0 24 24"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>
    –ü–æ—à—É–∫
  </a>
  <a data-section="profile">
    <svg class="icon-svg" viewBox="0 0 24 24"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
    –ü—Ä–æ—Ñ—ñ–ª—å
  </a>
  <a data-section="chats">
    <svg class="icon-svg" viewBox="0 0 24 24"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>
    –ü–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è
    <span id="unreadBadge" class="badge" style="display:none;">0</span>
  </a>
  <a data-section="settings">
    <svg class="icon-svg" viewBox="0 0 24 24"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H5.78a1.65 1.65 0 0 0-1.51 1 1.65 1.65 0 0 0 .33 1.82l.07.07A10 10 0 0 0 12 17.66a10 10 0 0 0 6.26-2.26z"/></svg>
    –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è
  </a>
</nav>

<main class="main-content">

  <!-- –ì–û–õ–û–í–ù–ê -->
  <div id="home" class="section active">
    <div class="card" id="authBox">
      <div id="loginForm">
        <input type="text" id="loginNickname" placeholder="–ü—Å–µ–≤–¥–æ–Ω—ñ–º (–±–µ–∑ @)" autocomplete="off"/>
        <input type="password" id="loginPassword" placeholder="–ü–∞—Ä–æ–ª—å"/>
        <button id="loginBtn">–£–≤—ñ–π—Ç–∏</button>
        <div style="display:flex; gap:10px; margin-top:15px;">
          <button id="googleLoginBtn" style="flex:1; background:#282828;">Google</button>
          <button id="appleLoginBtn" style="flex:1; background:#181818;">Apple</button>
        </div>
        <p style="margin-top:18px;">–ù–µ–º–∞—î –∞–∫–∞—É–Ω—Ç–∞? <span id="toRegister" style="color:var(--accent);cursor:pointer;">–ó–∞—Ä–µ—î—Å—Ç—Ä—É–≤–∞—Ç–∏—Å—è</span></p>
        <p><a href="#" id="forgotPassword" style="color:var(--accent);">–ó–∞–±—É–ª–∏ –ø–∞—Ä–æ–ª—å?</a></p>
      </div>
      <div id="registerForm" style="display:none;">
        <input type="text" id="registerNickname" placeholder="–ü—Å–µ–≤–¥–æ–Ω—ñ–º (–±–µ–∑ @)"/>
        <input type="password" id="registerPassword" placeholder="–ü–∞—Ä–æ–ª—å"/>
        <button id="registerBtn">–ó–∞—Ä–µ—î—Å—Ç—Ä—É–≤–∞—Ç–∏—Å—è</button>
        <p style="margin-top:18px;">–í–∂–µ —î –∞–∫–∞—É–Ω—Ç? <span id="toLogin" style="color:var(--accent);cursor:pointer;">–£–≤—ñ–π—Ç–∏</span></p>
      </div>
    </div>

    <div class="card" id="newPostBox" style="display:none;">
      <textarea id="postText" placeholder="–©–æ –Ω–æ–≤–æ–≥–æ?" rows="3"></textarea>
      <div style="display:flex; gap:10px; align-items:center; margin:14px 0;">
        <button id="emojiPostBtn">üòä –î–æ–¥–∞—Ç–∏ –µ–º–æ–¥–∑—ñ</button>
        <div id="emojiPostPicker" class="emoji-panel" style="display:none;">
          <span>üòä</span><span>üòÇ</span><span>‚ù§Ô∏è</span><span>üî•</span><span>üëç</span><span>üéâ</span><span>üò¢</span><span>üòé</span>
        </div>
      </div>
      <input type="file" id="postMedia" accept="image/*,video/*" style="margin:10px 0;"/>
      <button id="addPost">–û–ø—É–±–ª—ñ–∫—É–≤–∞—Ç–∏</button>
    </div>

    <!-- –ü–µ—Ä–µ–º–∏–∫–∞—á —Å—Ç—Ä—ñ—á–æ–∫ -->
    <div class="feed-header">
      <button id="feedNewBtn" class="active">
        <svg class="icon-svg" viewBox="0 0 24 24" style="width:18px; height:18px;"><path d="M12 2l-5.5 9h11z"/><circle cx="17.5" cy="17.5" r="4.5"/><path d="M3 13.5h8v8H3z"/></svg> –ù–æ–≤—ñ
      </button>
      <button id="feedPopularBtn">
        <svg class="icon-svg" viewBox="0 0 24 24" style="width:18px; height:18px;"><path d="M15 5l-1.41 1.41L18.17 11H2v2h16.17l-4.59 4.59L15 19l7-7z"/></svg> –ü–æ–ø—É–ª—è—Ä–Ω—ñ
      </button>
    </div>

    <!-- –ü–æ—à—É–∫ —É –ø–æ–ø—É–ª—è—Ä–Ω–æ–º—É -->
    <div id="popularSearchContainer" class="popular-search" style="display: none;">
      <input type="text" id="popularSearchInput" placeholder="–ü–æ—à—É–∫ –∑–∞ –Ω—ñ–∫–æ–º –∞–≤—Ç–æ—Ä–∞..." />
    </div>

    <!-- –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –ø–æ—Å—Ç—ñ–≤ -->
    <div class="feed" id="feed"></div>
    <div class="feed-end-sentinel" id="feedSentinel"></div>
    <div id="skeletonContainer" style="display:none;">
      <div class="skeleton-post"></div>
      <div class="skeleton-post"></div>
    </div>
  </div>

  <!-- –ü–û–®–£–ö -->
  <div id="search" class="section">
    <input type="text" id="searchInput" class="search-input" placeholder="–ü–æ—à—É–∫ –∑–∞ @id –∞–±–æ —ñ–º'—è–º..."/>
    <div class="user-list" id="userList"></div>
  </div>

  <!-- –ü–†–û–§–Ü–õ–¨ -->
  <div id="profile" class="section">
    <div class="card profile-header" id="profileHeader"></div>
    <div class="profile-tabs" id="profileTabs"></div>
    <div class="feed" id="profileFeed"></div>
  </div>

  <!-- –ß–ê–¢–ò -->
  <div id="chats" class="section">
    <div class="chat-list" id="chatList"></div>
    <div class="chat-window" id="chatWindow">
      <div class="chat-header" id="chatHeader">
        <div class="avatar" id="chatAvatar"></div>
        <span id="chatName"></span>
        <span class="user-id-small" id="chatUserId"></span>
      </div>
      <div class="chat-messages" id="chatMessages"></div>
      <div class="chat-input">
        <input type="text" id="chatText" placeholder="–ù–∞–ø–∏—à—ñ—Ç—å –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è..."/>
        <button id="sendMessage">–ù–∞–¥—ñ—Å–ª–∞—Ç–∏</button>
      </div>
    </div>
  </div>

  <!-- –ù–ê–õ–ê–®–¢–£–í–ê–ù–ù–Ø -->
  <div id="settings" class="section card">
    <h2>–ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è</h2>
    <button id="toggleTheme" style="margin:18px 0;">–ü–µ—Ä–µ–º–∫–Ω—É—Ç–∏ —Ç–µ–º—É üåô/‚òÄÔ∏è</button>
    <button id="toggleTvMode" style="margin:18px 0;">–†–µ–∂–∏–º —Ç–µ–ª–µ–≤—ñ–∑–æ—Ä–∞ üì∫</button>
    <button id="logoutBtn">–í–∏–π—Ç–∏</button>
  </div>
</main>

<!-- –ú–û–î–ê–õ–ö–ê –†–ï–î–ê–ì–£–í–ê–ù–ù–Ø –ü–û–°–¢–ê -->
<div class="modal" id="editPostModal">
  <div class="modal-content">
    <span class="close-modal" id="closeEditPostModal">&times;</span>
    <h2>–†–µ–¥–∞–≥—É–≤–∞—Ç–∏ –ø–æ—Å—Ç</h2>
    <textarea id="editPostText" rows="5" style="margin:18px 0;"></textarea>
    <div style="display: flex; gap: 8px; justify-content: flex-end;">
      <button id="cancelEditPost">–°–∫–∞—Å—É–≤–∞—Ç–∏</button>
      <button id="savePostEdit">–ó–±–µ—Ä–µ–≥—Ç–∏</button>
    </div>
  </div>
</div>

<!-- –ú–û–î–ê–õ–ö–ê –†–ï–î–ê–ì–£–í–ê–ù–ù–Ø –ü–†–û–§–Ü–õ–Æ -->
<div class="modal" id="editProfileModal">
  <div class="modal-content">
    <span class="close-modal" id="closeModal">&times;</span>
    <h2>–†–µ–¥–∞–≥—É–≤–∞—Ç–∏ –ø—Ä–æ—Ñ—ñ–ª—å</h2>
    <input type="text" id="editNickname" placeholder="–ü—Å–µ–≤–¥–æ–Ω—ñ–º (–±–µ–∑ @)"/>
    <textarea id="editBio" placeholder="–ü—Ä–æ —Å–µ–±–µ" rows="4" style="margin:14px 0;"></textarea>
    <button id="saveProfileEdit">–ó–±–µ—Ä–µ–≥—Ç–∏</button>
  </div>
</div>

<script type="module">
  // ================= Firebase –∑ –≤–∏–ø—Ä–∞–≤–ª–µ–Ω–∏–º authDomain (–≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ –ø—Ä–∞–≤–∏–ª—å–Ω–∏–π –¥–æ–º–µ–Ω –¥–ª—è —Ä–µ–¥–∏—Ä–µ–∫—Ç—É) =================
  // –©–æ–± –≤–∏–ø—Ä–∞–≤–∏—Ç–∏ –ø–æ–º–∏–ª–∫—É 400: redirect_uri_mismatch, –¥–æ–¥–∞–π—Ç–µ –≤ Google Cloud Console (Credentials -> Web client –¥–ª—è –≤–∞—à–æ–≥–æ –ø—Ä–æ–µ–∫—Ç—É) 
  // –Ω–∞—Å—Ç—É–ø–Ω–∏–π redirect URI: https://fantasyasapp.firebaseapp.com/flowName=GeneralOAuthFlow
  // –Ø–∫—â–æ –¥–æ–º–µ–Ω –≤—ñ–¥—Ä—ñ–∑–Ω—è—î—Ç—å—Å—è (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥, —á–µ—Ä–µ–∑ –∫–∞—Å—Ç–æ–º–Ω–∏–π –¥–æ–º–µ–Ω), –¥–æ–¥–∞–π—Ç–µ –≤—ñ–¥–ø–æ–≤—ñ–¥–Ω–∏–π URI –∑ –≤–∞—à–∏–º –¥–æ–º–µ–Ω–æ–º.
  // –¶–µ –¥–æ–∑–≤–æ–ª–∏—Ç—å SDK –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞—Ç–∏ —Ü–µ–π –µ–Ω–¥–ø–æ—ñ–Ω—Ç. –Ø–∫—â–æ –ø—Ä–æ–±–ª–µ–º–∞ –≤ —Ç–∏–ø–æ –≤ –¥–æ–º–µ–Ω—ñ, –ø–µ—Ä–µ–≤—ñ—Ä—Ç–µ, —á–∏ projectId —ñ authDomain –∑–±—ñ–≥–∞—é—Ç—å—Å—è –∑ –≤–∞—à–∏–º –ø—Ä–æ–µ–∫—Ç–æ–º —É Firebase –∫–æ–Ω—Å–æ–ª—ñ.
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js";
  import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut, GoogleAuthProvider, OAuthProvider, signInWithRedirect, getRedirectResult, sendPasswordResetEmail } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-auth.js";
  import { getFirestore, doc, setDoc, getDoc, updateDoc, collection, addDoc, query, where, onSnapshot, orderBy, serverTimestamp, arrayUnion, arrayRemove, deleteDoc, getDocs, increment, limit, startAfter } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore.js";
  import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-storage.js";

  const firebaseConfig = {
    apiKey: "AIzaSyDRzC-QDE0-UXd-XL0i3iqayFiKcc6wmvc",
    authDomain: "fantasyasapp.firebaseapp.com", // –ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ, —á–∏ —Ü–µ –ø—Ä–∞–≤–∏–ª—å–Ω–∏–π –¥–æ–º–µ–Ω. –Ø–∫—â–æ –ø—Ä–æ–µ–∫—Ç –Ω–∞–∑–∏–≤–∞—î—Ç—å—Å—è "fantasyasaapp", –≤–∏–ø—Ä–∞–≤—Ç–µ –Ω–∞ "fantasyasaapp.firebaseapp.com" —ñ –æ–Ω–æ–≤—ñ—Ç—å –≤ –∫–æ–Ω—Å–æ–ª—ñ.
    projectId: "fantasyasapp",
    storageBucket: "fantasyasapp.appspot.com",
    messagingSenderId: "721763921060",
    appId: "1:721763921060:web:3d61044ea2424e8176ca31"
  };
  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);
  const storage = getStorage(app);

  let currentUser = null;
  let currentChatPartner = null;
  let unsubscribeFeed = null;
  let unsubscribeChat = null;
  let unsubscribeChatList = null;
  let currentEditPostId = null;
  let viewingProfileUid = null;
  let unreadCount = 0;
  let currentFeedType = 'new';
  let popularSearchTerm = '';

  let lastVisible = null;
  let loading = false;
  let hasMore = true;

  const getChatId = (uid1, uid2) => [uid1, uid2].sort().join('_');

  const tvQuery = window.matchMedia('(min-width: 1200px) and (hover: none) and (pointer: coarse)');
  if (tvQuery.matches) document.body.classList.add('tv');

  function updateUnreadBadge() {
    const badge = document.getElementById('unreadBadge');
    if (unreadCount > 0) {
      badge.textContent = unreadCount > 99 ? '99+' : unreadCount;
      badge.style.display = 'inline-block';
    } else {
      badge.style.display = 'none';
    }
  }

  // ========== –û–ë–†–û–ë–ö–ê –†–ï–ó–£–õ–¨–¢–ê–¢–£ –†–ï–î–ò–†–ï–ö–¢–£ (GOOGLE/APPLE) ==========
  async function handleRedirectResult() {
    try {
      const result = await getRedirectResult(auth);
      if (result) {
        const user = result.user;
        const userDoc = await getDoc(doc(db, "users", user.uid));
        if (!userDoc.exists()) {
          const nickname = user.displayName || user.email?.split('@')[0] || 'user';
          let userId = `@${nickname.toLowerCase()}`;
          const q = query(collection(db, "users"), where("userId", "==", userId));
          const snap = await getDocs(q);
          if (!snap.empty) userId = `@${nickname.toLowerCase()}${Math.floor(Math.random()*1000)}`;
          await setDoc(doc(db, "users", user.uid), {
            nickname,
            userId,
            nickname_lower: nickname.toLowerCase(),
            bio: '',
            avatar: user.photoURL || '',
            posts: [],
            likedPosts: [],
            followers: [],
            following: [],
            createdAt: serverTimestamp()
          });
        }
      }
    } catch (error) {
      console.error("–ü–æ–º–∏–ª–∫–∞ –ø—ñ—Å–ª—è —Ä–µ–¥–∏—Ä–µ–∫—Ç—É:", error);
      if (error.code === 'auth/account-exists-with-different-credential') {
        alert('–¶–µ–π email –≤–∂–µ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î—Ç—å—Å—è –∑ —ñ–Ω—à–∏–º –º–µ—Ç–æ–¥–æ–º –≤—Ö–æ–¥—É. –°–ø—Ä–æ–±—É–π—Ç–µ —É–≤—ñ–π—Ç–∏ —á–µ—Ä–µ–∑ email/–ø–∞—Ä–æ–ª—å.');
      } else {
        alert('–ü–æ–º–∏–ª–∫–∞ –≤—Ö–æ–¥—É: ' + error.message);
      }
    }
  }

  handleRedirectResult();

  document.getElementById('burger').onclick = () => {
    document.getElementById('burger').classList.toggle('active');
    document.getElementById('sidebar').classList.toggle('active');
  };

  document.querySelectorAll('[data-section]').forEach(link => {
    link.onclick = () => {
      const sectionId = link.dataset.section;
      document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
      document.getElementById(sectionId).classList.add('active');
      document.getElementById('sidebar').classList.remove('active');
      document.getElementById('burger').classList.remove('active');
      if (sectionId === 'search') loadSearchUsers();
      if (sectionId === 'chats') {
        document.getElementById('chatWindow').style.display = 'none';
        loadChatList();
      }
      if (sectionId === 'profile') {
        if (!viewingProfileUid || viewingProfileUid === currentUser?.uid) {
          viewingProfileUid = currentUser?.uid;
          loadMyProfile();
        } else {
          loadUserProfile(viewingProfileUid);
        }
      }
      if (sectionId === 'home') resetPagination();
    };
  });

  function resetPagination() {
    lastVisible = null;
    hasMore = true;
    document.getElementById('feed').innerHTML = '';
    loadMorePosts();
  }

  document.getElementById('toRegister').onclick = () => {
    document.getElementById('loginForm').style.display = 'none';
    document.getElementById('registerForm').style.display = 'block';
  };
  document.getElementById('toLogin').onclick = () => {
    document.getElementById('registerForm').style.display = 'none';
    document.getElementById('loginForm').style.display = 'block';
  };

  document.getElementById('registerBtn').onclick = async () => {
    const nickname = document.getElementById('registerNickname').value.trim();
    const password = document.getElementById('registerPassword').value.trim();
    if (!nickname) return alert('–í–≤–µ–¥—ñ—Ç—å –ø—Å–µ–≤–¥–æ–Ω—ñ–º');
    if (password.length < 6) return alert('–ú—ñ–Ω—ñ–º—É–º 6 —Å–∏–º–≤–æ–ª—ñ–≤');
    
    const userId = `@${nickname.toLowerCase()}`;
    const q = query(collection(db, "users"), where("userId", "==", userId));
    const snap = await getDocs(q);
    if (!snap.empty) {
      return alert('–¶–µ–π ID –≤–∂–µ –∑–∞–π–Ω—è—Ç–∏–π, –≤–∏–±–µ—Ä—ñ—Ç—å —ñ–Ω—à–∏–π –ø—Å–µ–≤–¥–æ–Ω—ñ–º');
    }
    
    try {
      const safeNick = nickname.toLowerCase().replace(/[^a-z0-9]/g, '');
      const email = `${safeNick}@fantasyas.local`;
      const cred = await createUserWithEmailAndPassword(auth, email, password);
      await setDoc(doc(db, "users", cred.user.uid), {
        nickname,
        userId,
        nickname_lower: nickname.toLowerCase(),
        bio: '',
        avatar: '',
        posts: [],
        likedPosts: [],
        followers: [],
        following: [],
        createdAt: serverTimestamp()
      });
      alert('–†–µ—î—Å—Ç—Ä–∞—Ü—ñ—è —É—Å–ø—ñ—à–Ω–∞');
      document.getElementById('toLogin').click();
      document.getElementById('loginNickname').value = nickname;
    } catch (e) { alert(e.message); }
  };

  document.getElementById('loginBtn').onclick = async () => {
    const nickname = document.getElementById('loginNickname').value.trim();
    const password = document.getElementById('loginPassword').value.trim();
    if (!nickname || !password) return alert('–ó–∞–ø–æ–≤–Ω—ñ—Ç—å –ø–æ–ª—è');
    try {
      const safeNick = nickname.toLowerCase().replace(/[^a-z0-9]/g, '');
      const email = `${safeNick}@fantasyas.local`;
      await signInWithEmailAndPassword(auth, email, password);
    } catch { alert('–ù–µ–≤—ñ—Ä–Ω–∏–π –ø—Å–µ–≤–¥–æ–Ω—ñ–º –∞–±–æ –ø–∞—Ä–æ–ª—å'); }
  };

  document.getElementById('googleLoginBtn').onclick = async () => {
    const provider = new GoogleAuthProvider();
    await signInWithRedirect(auth, provider);
  };

  document.getElementById('appleLoginBtn').onclick = async () => {
    const provider = new OAuthProvider('apple.com');
    provider.addScope('email name');
    await signInWithRedirect(auth, provider);
  };

  document.getElementById('forgotPassword').onclick = async (e) => {
    e.preventDefault();
    const email = prompt('–í–≤–µ–¥—ñ—Ç—å –≤–∞—à email (—è–∫—â–æ —Ä–µ—î—Å—Ç—Ä—É–≤–∞–ª–∏—Å—å —á–µ—Ä–µ–∑ email)');
    if (email) {
      try {
        await sendPasswordResetEmail(auth, email);
        alert('–õ–∏—Å—Ç –¥–ª—è —Å–∫–∏–¥–∞–Ω–Ω—è –ø–∞—Ä–æ–ª—è –≤—ñ–¥–ø—Ä–∞–≤–ª–µ–Ω–æ');
      } catch (err) {
        alert('–ü–æ–º–∏–ª–∫–∞: ' + err.message);
      }
    }
  };

  onAuthStateChanged(auth, (user) => {
    if (user) {
      currentUser = user;
      document.getElementById('authBox').style.display = 'none';
      document.getElementById('newPostBox').style.display = 'block';
      resetPagination();
      loadMyProfile();
      if (unsubscribeChatList) unsubscribeChatList();
      const q = query(collection(db, "chats"), where("participants", "array-contains", currentUser.uid));
      unsubscribeChatList = onSnapshot(q, (snapshot) => {
        let totalUnread = 0;
        snapshot.forEach(doc => {
          const data = doc.data();
          if (data.unread && data.unread[currentUser.uid]) {
            totalUnread += data.unread[currentUser.uid];
          }
        });
        unreadCount = totalUnread;
        updateUnreadBadge();
      });
    } else {
      currentUser = null;
      document.getElementById('authBox').style.display = 'block';
      document.getElementById('newPostBox').style.display = 'none';
      if (unsubscribeFeed) unsubscribeFeed();
      if (unsubscribeChatList) unsubscribeChatList();
      unreadCount = 0;
      updateUnreadBadge();
    }
  });

  document.getElementById('feedNewBtn').onclick = () => {
    if (currentFeedType === 'new') return;
    document.getElementById('feedNewBtn').classList.add('active');
    document.getElementById('feedPopularBtn').classList.remove('active');
    document.getElementById('popularSearchContainer').style.display = 'none';
    currentFeedType = 'new';
    popularSearchTerm = '';
    resetPagination();
  };

  document.getElementById('feedPopularBtn').onclick = () => {
    if (currentFeedType === 'popular') return;
    document.getElementById('feedPopularBtn').classList.add('active');
    document.getElementById('feedNewBtn').classList.remove('active');
    document.getElementById('popularSearchContainer').style.display = 'block';
    currentFeedType = 'popular';
    resetPagination();
  };

  document.getElementById('popularSearchInput').addEventListener('input', (e) => {
    popularSearchTerm = e.target.value.trim().toLowerCase();
    resetPagination();
  });

  document.getElementById('emojiPostBtn').onclick = () => {
    const p = document.getElementById('emojiPostPicker');
    p.style.display = p.style.display === 'none' ? 'flex' : 'none';
  };
  document.querySelectorAll('#emojiPostPicker span').forEach(s => {
    s.onclick = () => {
      document.getElementById('postText').value += s.textContent;
      document.getElementById('emojiPostPicker').style.display = 'none';
    };
  });

  document.getElementById('addPost').onclick = async () => {
    if (!currentUser) return alert('–£–≤—ñ–π–¥—ñ—Ç—å');
    const text = document.getElementById('postText').value.trim();
    const file = document.getElementById('postMedia').files[0];
    if (!text && !file) return alert('–î–æ–¥–∞–π—Ç–µ —Ç–µ–∫—Å—Ç –∞–±–æ –º–µ–¥—ñ–∞');
    try {
      let mediaUrl = '', mediaType = '';
      if (file) {
        const storageRef = ref(storage, `posts/${currentUser.uid}/${Date.now()}_${file.name}`);
        await uploadBytes(storageRef, file);
        mediaUrl = await getDownloadURL(storageRef);
        mediaType = file.type.split('/')[0];
      }
      
      const userSnap = await getDoc(doc(db, "users", currentUser.uid));
      const userData = userSnap.data();
      
      const postDoc = await addDoc(collection(db, "posts"), {
        author: currentUser.uid;
        authorName: userData.nickname,
        authorUserId: userData.userId,
        authorAvatar: userData.avatar || '',
        text,
        mediaUrl,
        mediaType,
        createdAt: serverTimestamp(),
        likes: [],
        likesCount: 0,
        commentsCount: 0
      });
      
      await updateDoc(doc(db, "users", currentUser.uid), { posts: arrayUnion(postDoc.id) });
      
      document.getElementById('postText').value = '';
      document.getElementById('postMedia').value = '';
    } catch (e) { alert(e.message); }
  };

  async function loadMorePosts() {
    if (loading || !hasMore || !currentUser) return;
    loading = true;
    document.getElementById('skeletonContainer').style.display = 'block';

    let q;
    if (currentFeedType === 'new') {
      q = query(collection(db, "posts"), orderBy("createdAt", "desc"), limit(10));
    } else {
      q = query(collection(db, "posts"), orderBy("likesCount", "desc"), orderBy("createdAt", "desc"), limit(10));
    }
    if (lastVisible) {
      q = query(q, startAfter(lastVisible));
    }
    
    const snapshot = await getDocs(q);
    document.getElementById('skeletonContainer').style.display = 'none';
    
    if (snapshot.empty) {
      hasMore = false;
      loading = false;
      return;
    }
    
    lastVisible = snapshot.docs[snapshot.docs.length - 1];
    await renderPosts(snapshot.docs);
    loading = false;
  }

  async function renderPosts(docs) {
    const feed = document.getElementById('feed');
    
    for (const docSnap of docs) {
      const post = { id: docSnap.id, ...docSnap.data() };
      
      if (currentFeedType === 'popular' && popularSearchTerm) {
        const authorName = post.authorName || '';
        if (!authorName.toLowerCase().includes(popularSearchTerm)) continue;
      }
      
      const isOwn = post.author === currentUser?.uid;
      const liked = post.likes?.includes(currentUser?.uid) || false;
      
      let isFollowing = false;
      if (currentUser && post.author !== currentUser.uid) {
        const currentUserSnap = await getDoc(doc(db, "users", currentUser.uid));
        isFollowing = currentUserSnap.data().following?.includes(post.author) || false;
      }
      
      let contentHtml = post.text ? post.text.replace(/\n/g,'<br>') : '';
      if (post.text && post.text.length > 300) {
        contentHtml = `<span class="truncated">${post.text.slice(0,300).replace(/\n/g,'<br>')}...</span> <button class="show-more">Show more</button>`;
      }
      
      const postEl = document.createElement('div');
      postEl.className = 'post';
      postEl.dataset.postId = post.id;
      postEl.innerHTML = `
        <div class="post-header">
          <div class="avatar" style="background-image:url(${post.authorAvatar || ''})" data-uid="${post.author}"></div>
          <div class="post-user">
            <span class="username" data-uid="${post.author}">${post.authorName || '–ù–µ–≤—ñ–¥–æ–º–æ'}</span>
            <span class="user-id-small">${post.authorUserId || ''}</span>
          </div>
          ${isOwn ? `
            <button class="edit-post-btn" data-post-id="${post.id}">
              <svg viewBox="0 0 24 24"><path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"/></svg>
            </button>
            <button class="menu-btn" data-post-id="${post.id}">‚ãØ</button>
          ` : ''}
          ${!isOwn && currentUser ? `<button class="subscribe-post-btn" data-author-uid="${post.author}">${isFollowing ? '–í—ñ–¥–ø–∏—Å–∞—Ç–∏—Å—è' : '–ü—ñ–¥–ø–∏—Å–∞—Ç–∏—Å—è'}</button>` : ''}
        </div>
        <div class="post-content">${contentHtml}</div>
        ${post.mediaUrl ? (post.mediaType==='image' ? `<img src="${post.mediaUrl}" class="post-media" loading="lazy">` : `<video src="${post.mediaUrl}" controls autoplay muted loop playsinline class="post-media" loading="lazy"></video>`) : ''}
        <div class="post-footer">
          <button class="like-btn ${liked ? 'liked' : ''}" data-post-id="${post.id}">
            <svg viewBox="0 0 24 24">
              <path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/>
            </svg>
            <span>${post.likesCount || 0}</span>
          </button>
          <button class="comments-toggle" data-post-id="${post.id}">
            <svg viewBox="0 0 24 24">
              <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/>
            </svg>
            <span>${post.commentsCount || 0}</span>
          </button>
        </div>
        <div class="comments-section" id="comments-${post.id}" style="display:none;">
          <div class="comments-list" id="comments-list-${post.id}"></div>
          <div class="comment-input-area">
            <textarea id="comment-text-${post.id}" placeholder="–ö–æ–º–µ–Ω—Ç–∞—Ä..."></textarea>
            <button class="send-comment" data-post-id="${post.id}">‚û§</button>
          </div>
          <div class="emoji-panel" id="emoji-comment-${post.id}" style="display:none;">
            <span>üòä</span><span>üòÇ</span><span>‚ù§Ô∏è</span><span>üî•</span><span>üëç</span><span>üéâ</span>
          </div>
          <button class="emoji-comment-btn" data-post-id="${post.id}">üòã –ï–º–æ–¥–∑—ñ</button>
        </div>
      `;
      
      feed.appendChild(postEl);
      setTimeout(() => postEl.classList.add('show'), 50);
      
      const commentsToggle = postEl.querySelector('.comments-toggle');
      commentsToggle.addEventListener('click', async () => {
        const commentsDiv = document.getElementById(`comments-${post.id}`);
        if (commentsDiv.style.display === 'none') {
          commentsDiv.style.display = 'block';
          if (!postEl.commentsLoaded) {
            const commentsQuery = query(collection(db, "posts", post.id, "comments"), orderBy("createdAt", "desc"), limit(5));
            const commentsSnap = await getDocs(commentsQuery);
            const commentsList = document.getElementById(`comments-list-${post.id}`);
            commentsList.innerHTML = commentsSnap.docs.reverse().map(c => {
              const data = c.data();
              return `<div class="comment">
                <div class="avatar" style="background-image:url(${data.authorAvatar || ''})" data-uid="${data.author}"></div>
                <div class="comment-content">
                  <span class="comment-author" data-uid="${data.author}">${data.authorNickname || '–Ω–µ–≤—ñ–¥–æ–º–æ'}</span> ${data.text}
                </div>
              </div>`;
            }).join('');
            postEl.commentsLoaded = true;
          }
        } else {
          commentsDiv.style.display = 'none';
        }
      });
    }
  }

  document.getElementById('feed').addEventListener('click', async (e) => {
    if (e.target.closest('.like-btn')) {
      const btn = e.target.closest('.like-btn');
      const postId = btn.dataset.postId;
      const liked = btn.classList.contains('liked');
      const countSpan = btn.querySelector('span:last-child');
      const oldCount = parseInt(countSpan.textContent);
      
      btn.classList.toggle('liked');
      countSpan.textContent = liked ? oldCount - 1 : oldCount + 1;
      
      try {
        const postRef = doc(db, "posts", postId);
        if (liked) {
          await updateDoc(postRef, {
            likes: arrayRemove(currentUser.uid),
            likesCount: increment(-1)
          });
          await updateDoc(doc(db, "users", currentUser.uid), {
            likedPosts: arrayRemove(postId)
          });
        } else {
          await updateDoc(postRef, {
            likes: arrayUnion(currentUser.uid),
            likesCount: increment(1)
          });
          await updateDoc(doc(db, "users", currentUser.uid), {
            likedPosts: arrayUnion(postId)
          });
        }
      } catch (e) {
        btn.classList.toggle('liked');
        countSpan.textContent = oldCount;
        alert('–ü–æ–º–∏–ª–∫–∞');
      }
    }
    
    if (e.target.closest('.edit-post-btn')) {
      const btn = e.target.closest('.edit-post-btn');
      const postId = btn.dataset.postId;
      const postDiv = btn.closest('.post');
      const contentDiv = postDiv.querySelector('.post-content');
      const currentText = contentDiv.innerText;
      
      const textarea = document.createElement('textarea');
      textarea.value = currentText;
      textarea.className = 'edit-post-textarea';
      textarea.style.width = '100%';
      textarea.style.minHeight = '80px';
      contentDiv.replaceWith(textarea);
      textarea.focus();
      
      const saveEdit = async () => {
        const newText = textarea.value.trim();
        await updateDoc(doc(db, "posts", postId), { text: newText });
        const newContent = document.createElement('div');
        newContent.className = 'post-content';
        newContent.innerHTML = newText.replace(/\n/g,'<br>');
        textarea.replaceWith(newContent);
      };
      
      textarea.addEventListener('blur', saveEdit);
      textarea.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' && !e.shiftKey) {
          e.preventDefault();
          saveEdit();
        }
      });
    }
    
    if (e.target.closest('.menu-btn')) {
      const postId = e.target.closest('.menu-btn').dataset.postId;
      if (confirm('–í–∏–¥–∞–ª–∏—Ç–∏ –ø–æ—Å—Ç?')) {
        const postRef = doc(db, "posts", postId);
        const postSnap = await getDoc(postRef);
        const author = postSnap.data().author;
        await deleteDoc(postRef);
        await updateDoc(doc(db, "users", author), { posts: arrayRemove(postId) });
        e.target.closest('.post').remove();
      }
    }
    
    if (e.target.classList.contains('show-more')) {
      const postDiv = e.target.closest('.post');
      const contentDiv = postDiv.querySelector('.post-content');
      const fullText = contentDiv.innerText.replace('... Show more', '');
      const postId = postDiv.dataset.postId;
      const postRef = doc(db, "posts", postId);
      const snap = await getDoc(postRef);
      contentDiv.innerHTML = snap.data().text.replace(/\n/g,'<br>');
    }
    
    if (e.target.closest('.send-comment')) {
      const btn = e.target.closest('.send-comment');
      const postId = btn.dataset.postId;
      const textarea = document.getElementById(`comment-text-${postId}`);
      const text = textarea.value.trim();
      if (!text) return;
      const userDoc = await getDoc(doc(db, "users", currentUser.uid));
      const userData = userDoc.data();
      await addDoc(collection(db, "posts", postId, "comments"), {
        author: currentUser.uid,
        authorNickname: userData.nickname,
        authorUserId: userData.userId,
        authorAvatar: userData.avatar || '',
        text,
        createdAt: serverTimestamp()
      });
      await updateDoc(doc(db, "posts", postId), { commentsCount: increment(1) });
      textarea.value = '';
    }
    
    if (e.target.closest('.emoji-comment-btn')) {
      const btn = e.target.closest('.emoji-comment-btn');
      const postId = btn.dataset.postId;
      const picker = document.getElementById(`emoji-comment-${postId}`);
      picker.style.display = picker.style.display === 'none' ? 'flex' : 'none';
    }
    
    if (e.target.closest('.emoji-panel span')) {
      const span = e.target.closest('.emoji-panel span');
      const picker = span.closest('.emoji-panel');
      const postId = picker.id.replace('emoji-comment-', '');
      const textarea = document.getElementById(`comment-text-${postId}`);
      textarea.value += span.textContent;
      picker.style.display = 'none';
    }
    
    if (e.target.closest('.subscribe-post-btn')) {
      const btn = e.target.closest('.subscribe-post-btn');
      const authorUid = btn.dataset.authorUid;
      await toggleFollow(authorUid);
      const isFollowing = (await getDoc(doc(db, "users", currentUser.uid))).data().following.includes(authorUid);
      btn.textContent = isFollowing ? '–í—ñ–¥–ø–∏—Å–∞—Ç–∏—Å—è' : '–ü—ñ–¥–ø–∏—Å–∞—Ç–∏—Å—è';
    }
    
    if (e.target.closest('[data-uid]')) {
      const el = e.target.closest('[data-uid]');
      const uid = el.dataset.uid;
      if (uid === currentUser.uid) {
        viewingProfileUid = currentUser.uid;
        loadMyProfile();
      } else {
        viewingProfileUid = uid;
        loadUserProfile(uid);
      }
      document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
      document.getElementById('profile').classList.add('active');
      document.getElementById('sidebar').classList.remove('active');
      document.getElementById('burger').classList.remove('active');
    }
  });

  // ========== –§–£–ù–ö–¶–Ü–á –ü–û–®–£–ö–£ ==========
  async function loadSearchUsers() {
    const val = document.getElementById('searchInput').value.trim().toLowerCase();
    const userList = document.getElementById('userList');
    if (!val) { userList.innerHTML = ''; return; }
    
    const mySnap = await getDoc(doc(db, "users", currentUser.uid));
    const myFollowing = mySnap.data().following || [];
    
    const q1 = query(collection(db, "users"), where("userId", ">=", val.startsWith('@') ? val : `@${val}`), where("userId", "<=", (val.startsWith('@') ? val : `@${val}`) + '\uf8ff'));
    const q2 = query(collection(db, "users"), where("nickname_lower", ">=", val), where("nickname_lower", "<=", val + '\uf8ff'));
    
    const [snap1, snap2] = await Promise.all([getDocs(q1), getDocs(q2)]);
    const usersMap = new Map();
    snap1.forEach(d => usersMap.set(d.id, d.data()));
    snap2.forEach(d => usersMap.set(d.id, d.data()));
    
    userList.innerHTML = '';
    usersMap.forEach((data, uid) => {
      if (uid === currentUser.uid) return;
      const isFollowing = myFollowing.includes(uid);
      const div = document.createElement('div');
      div.className = 'user-item';
      div.innerHTML = `
        <div class="avatar" style="background-image:url(${data.avatar || ''})"></div>
        <div>
          <div style="font-weight:600;">${data.nickname}</div>
          <div class="user-id">${data.userId || ''}</div>
        </div>
        <button class="follow-btn">${isFollowing ? '–í—ñ–¥–ø–∏—Å–∞—Ç–∏—Å—è' : '–ü—ñ–¥–ø–∏—Å–∞—Ç–∏—Å—è'}</button>
      `;
      div.querySelector('.follow-btn').onclick = async (e) => {
        e.stopPropagation();
        await toggleFollow(uid);
        loadSearchUsers();
      };
      div.onclick = () => {
        viewingProfileUid = uid;
        loadUserProfile(uid);
        document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
        document.getElementById('profile').classList.add('active');
        document.getElementById('sidebar').classList.remove('active');
        document.getElementById('burger').classList.remove('active');
      };
      userList.appendChild(div);
    });
  }
  document.getElementById('searchInput').addEventListener('input', loadSearchUsers);

  async function toggleFollow(targetUid) {
    const myRef = doc(db, "users", currentUser.uid);
    const targetRef = doc(db, "users", targetUid);
    const mySnap = await getDoc(myRef);
    const following = mySnap.data().following || [];
    if (following.includes(targetUid)) {
      await updateDoc(myRef, { following: arrayRemove(targetUid) });
      await updateDoc(targetRef, { followers: arrayRemove(currentUser.uid) });
    } else {
      await updateDoc(myRef, { following: arrayUnion(targetUid) });
      await updateDoc(targetRef, { followers: arrayUnion(currentUser.uid) });
    }
  }

  // ========== –ü–†–û–§–Ü–õ–¨ ==========
  async function loadMyProfile() {
    if (!currentUser) return;
    const snap = await getDoc(doc(db, "users", currentUser.uid));
    if (snap.exists()) {
      const data = snap.data();
      renderProfile(data, currentUser.uid, true);
    }
  }

  async function loadUserProfile(uid) {
    const snap = await getDoc(doc(db, "users", uid));
    if (snap.exists()) {
      const data = snap.data();
      const isOwn = uid === currentUser?.uid;
      renderProfile(data, uid, isOwn);
    }
  }

  function renderProfile(data, uid, isOwn) {
    const profileDiv = document.getElementById('profile');
    const isFollowing = !isOwn && currentUser ? (data.followers?.includes(currentUser.uid) || false) : false;
    
    profileDiv.innerHTML = `
      <div class="card profile-header" id="profileHeader">
        <div class="profile-avatar" style="background-image:url(${data.avatar || ''})" data-uid="${uid}"></div>
        ${isOwn ? '<input type="file" id="avatarInput" accept="image/*" style="display:none;"/>' : ''}
        <div style="flex:1;">
          <div style="display:flex; align-items:center; gap:10px;">
            <h2>${data.nickname}</h2>
            ${isOwn ? '<button class="edit-profile-btn"><svg viewBox="0 0 24 24" width="24" height="24"><path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"/></svg></button>' : ''}
          </div>
          <div class="user-id" style="font-size:1rem; margin:5px 0;">${data.userId || ''}</div>
          <p style="color:var(--text-sec); margin:10px 0;" id="profileBio">${data.bio || '–û–ø–∏—Å –≤—ñ–¥—Å—É—Ç–Ω—ñ–π'}</p>
          <div style="display:flex; gap:25px; font-weight:600;">
            <span>${data.posts?.length || 0} –ø–æ—Å—Ç—ñ–≤</span>
            <span>${data.followers?.length || 0} –ø—ñ–¥–ø–∏—Å–Ω–∏–∫—ñ–≤</span>
            <span>${data.following?.length || 0} –ø—ñ–¥–ø–∏—Å–æ–∫</span>
          </div>
          ${!isOwn && currentUser ? `
            <div style="margin-top:16px; display:flex; gap:10px;">
              <button id="profileFollowBtn">${isFollowing ? '–í—ñ–¥–ø–∏—Å–∞—Ç–∏—Å—è' : '–ü—ñ–¥–ø–∏—Å–∞—Ç–∏—Å—è'}</button>
              <button id="profileMessageBtn">–ù–∞–ø–∏—Å–∞—Ç–∏</button>
            </div>
          ` : ''}
        </div>
      </div>
      <div class="profile-tabs">
        <button class="profile-tab active" data-tab="posts">–ü–æ—Å—Ç–∏</button>
        <button class="profile-tab" data-tab="likes">–õ–∞–π–∫–∏</button>
        <button class="profile-tab" data-tab="media">–ú–µ–¥—ñ–∞</button>
      </div>
      <div class="feed" id="profileFeed"></div>
    `;
    
    document.querySelectorAll('.profile-tab').forEach(tab => {
      tab.onclick = () => {
        document.querySelectorAll('.profile-tab').forEach(t => t.classList.remove('active'));
        tab.classList.add('active');
        const tabType = tab.dataset.tab;
        loadProfileFeed(uid, tabType);
      };
    });
    
    loadProfileFeed(uid, 'posts');
    
    if (!isOwn && currentUser) {
      document.getElementById('profileFollowBtn').onclick = async () => {
        await toggleFollow(uid);
        loadUserProfile(uid);
      };
      document.getElementById('profileMessageBtn').onclick = () => {
        openChat(data.nickname, uid, data.userId);
      };
    }
    
    if (isOwn) {
      const avatar = document.querySelector('.profile-avatar');
      avatar.onclick = () => {
        document.getElementById('avatarInput').click();
      };
      document.getElementById('avatarInput').onchange = async (e) => {
        const file = e.target.files[0];
        if (!file) return;
        try {
          const storageRef = ref(storage, `avatars/${currentUser.uid}`);
          await uploadBytes(storageRef, file);
          const url = await getDownloadURL(storageRef);
          await updateDoc(doc(db, "users", currentUser.uid), { avatar: url });
          avatar.style.backgroundImage = `url(${url})`;
        } catch { alert('–ü–æ–º–∏–ª–∫–∞'); }
      };
      
      const editBtn = document.querySelector('.edit-profile-btn');
      if (editBtn) {
        editBtn.onclick = () => {
          document.getElementById('editNickname').value = data.nickname;
          document.getElementById('editBio').value = data.bio || '';
          document.getElementById('editProfileModal').classList.add('active');
        };
      }
    }
  }

  async function loadProfileFeed(uid, tab) {
    const feed = document.getElementById('profileFeed');
    feed.innerHTML = '';
    
    let posts = [];
    if (tab === 'posts') {
      const userSnap = await getDoc(doc(db, "users", uid));
      const postIds = userSnap.data().posts || [];
      for (const id of postIds.slice(0, 20)) {
        const postSnap = await getDoc(doc(db, "posts", id));
        if (postSnap.exists()) posts.push({ id: postSnap.id, ...postSnap.data() });
      }
    } else if (tab === 'likes') {
      const userSnap = await getDoc(doc(db, "users", uid));
      const likedIds = userSnap.data().likedPosts || [];
      for (const id of likedIds.slice(0, 20)) {
        const postSnap = await getDoc(doc(db, "posts", id));
        if (postSnap.exists()) posts.push({ id: postSnap.id, ...postSnap.data() });
      }
    } else if (tab === 'media') {
      const q = query(collection(db, "posts"), where("author", "==", uid), where("mediaUrl", "!=", ""));
      const snap = await getDocs(q);
      snap.forEach(doc => posts.push({ id: doc.id, ...doc.data() }));
    }
    
    posts.sort((a,b) => (b.createdAt?.seconds || 0) - (a.createdAt?.seconds || 0));
    
    for (const post of posts) {
      feed.innerHTML += `<div class="post">${post.text}</div>`;
    }
  }

  document.getElementById('closeModal').onclick = () => document.getElementById('editProfileModal').classList.remove('active');
  document.getElementById('saveProfileEdit').onclick = async () => {
    const nickname = document.getElementById('editNickname').value.trim();
    const bio = document.getElementById('editBio').value.trim();
    if (!nickname) return alert('–ü—Å–µ–≤–¥–æ–Ω—ñ–º –æ–±–æ–≤‚Äô—è–∑–∫–æ–≤–∏–π');
    
    const newUserId = `@${nickname.toLowerCase()}`;
    const q = query(collection(db, "users"), where("userId", "==", newUserId));
    const snap = await getDocs(q);
    if (!snap.empty && snap.docs[0].id !== currentUser.uid) {
      return alert('–¶–µ–π ID –≤–∂–µ –∑–∞–π–Ω—è—Ç–∏–π');
    }
    
    await updateDoc(doc(db, "users", currentUser.uid), {
      nickname,
      userId: newUserId,
      nickname_lower: nickname.toLowerCase(),
      bio
    });
    loadMyProfile();
    document.getElementById('editProfileModal').classList.remove('active');
  };

  // ========== –ß–ê–¢–ò ==========
  async function loadChatList() {
    const list = document.getElementById('chatList');
    list.innerHTML = '';
    const q = query(collection(db, "chats"), where("participants", "array-contains", currentUser.uid), orderBy("updatedAt", "desc"));
    onSnapshot(q, async (snapshot) => {
      list.innerHTML = '';
      for (const docSnap of snapshot.docs) {
        const chat = docSnap.data();
        const otherUid = chat.participants.find(uid => uid !== currentUser.uid);
        const userSnap = await getDoc(doc(db, "users", otherUid));
        const user = userSnap.data();
        const unread = chat.unread?.[currentUser.uid] || 0;
        const lastMsg = chat.lastMessage || '';
        const time = chat.updatedAt ? new Date(chat.updatedAt.seconds * 1000).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }) : '';
        
        const item = document.createElement('div');
        item.className = `chat-item ${unread > 0 ? 'unread' : ''}`;
        item.dataset.chatId = docSnap.id;
        item.dataset.otherUid = otherUid;
        item.innerHTML = `
          <div class="chat-avatar" style="background-image:url(${user.avatar || ''})"></div>
          <div class="chat-info">
            <div class="chat-name">${user.nickname} <span class="chat-userid">${user.userId || ''}</span></div>
            <div class="chat-last">${lastMsg}</div>
          </div>
          <div class="chat-meta">
            <div class="chat-time">${time}</div>
            ${unread > 0 ? `<div class="chat-badge">${unread}</div>` : ''}
          </div>
        `;
        item.onclick = () => openChatFromList(docSnap.id, otherUid, user.nickname, user.userId, user.avatar);
        list.appendChild(item);
      }
    });
  }

  async function openChatFromList(chatId, otherUid, otherName, otherUserId, otherAvatar) {
    currentChatPartner = otherUid;
    document.getElementById('chatWindow').style.display = 'flex';
    document.getElementById('chatName').textContent = otherName;
    document.getElementById('chatUserId').textContent = otherUserId || '';
    document.getElementById('chatAvatar').style.backgroundImage = `url(${otherAvatar || ''})`;
    const chatRef = doc(db, "chats", chatId);
    await updateDoc(chatRef, { [`unread.${currentUser.uid}`]: 0 });
    subscribeToChat(chatId);
  }

  function openChat(otherName, otherUid, otherUserId) {
    currentChatPartner = otherUid;
    document.getElementById('chatWindow').style.display = 'flex';
    document.getElementById('chatName').textContent = otherName;
    document.getElementById('chatUserId').textContent = otherUserId || '';
    getDoc(doc(db, "users", otherUid)).then(snap => {
      if (snap.exists()) {
        document.getElementById('chatAvatar').style.backgroundImage = `url(${snap.data().avatar || ''})`;
      }
    });
    const chatId = getChatId(currentUser.uid, otherUid);
    const chatRef = doc(db, "chats", chatId);
    getDoc(chatRef).then(async (docSnap) => {
      if (!docSnap.exists()) {
        await setDoc(chatRef, {
          participants: [currentUser.uid, otherUid],
          createdAt: serverTimestamp(),
          updatedAt: serverTimestamp(),
          lastMessage: '',
          unread: { [currentUser.uid]: 0, [otherUid]: 0 }
        });
      } else {
        await updateDoc(chatRef, { [`unread.${currentUser.uid}`]: 0 });
      }
      subscribeToChat(chatId);
    });
  }

  function subscribeToChat(chatId) {
    if (unsubscribeChat) unsubscribeChat();
    const q = query(collection(db, `chats/${chatId}/messages`), orderBy("createdAt"));
    unsubscribeChat = onSnapshot(q, (snap) => {
      const messages = document.getElementById('chatMessages');
      messages.innerHTML = '';
      snap.forEach(m => {
        const msg = m.data();
        const div = document.createElement('div');
        div.className = `message ${msg.from === currentUser.uid ? 'sent' : 'received'}`;
        div.textContent = msg.text;
        messages.appendChild(div);
      });
      messages.scrollTop = messages.scrollHeight;
    });
  }

  document.getElementById('sendMessage').onclick = async () => {
    const text = document.getElementById('chatText').value.trim();
    if (!text || !currentChatPartner) return;
    const chatId = getChatId(currentUser.uid, currentChatPartner);
    const chatRef = doc(db, "chats", chatId);
    const messageRef = collection(db, `chats/${chatId}/messages`);
    await addDoc(messageRef, { from: currentUser.uid, text, createdAt: serverTimestamp() });
    await updateDoc(chatRef, {
      lastMessage: text,
      updatedAt: serverTimestamp(),
      [`unread.${currentChatPartner}`]: increment(1)
    });
    document.getElementById('chatText').value = '';
  };

  document.getElementById('toggleTheme').onclick = () => {
    document.body.classList.toggle('light');
    localStorage.setItem('theme', document.body.classList.contains('light') ? 'light' : 'dark');
  };
  if (localStorage.getItem('theme') === 'light') document.body.classList.add('light');

  document.getElementById('toggleTvMode').onclick = () => {
    document.body.classList.toggle('tv');
  };

  document.getElementById('logoutBtn').onclick = () => signOut(auth);

  const sentinel = document.getElementById('feedSentinel');
  const observer = new IntersectionObserver((entries) => {
    if (entries[0].isIntersecting) {
      loadMorePosts();
    }
  }, { threshold: 0.5 });
  observer.observe(sentinel);

  let focusableElements = [];
  let currentFocusIndex = -1;

  function updateFocusable() {
    const activeSection = document.querySelector('.section.active');
    focusableElements = Array.from(activeSection.querySelectorAll('button, a, input, textarea, [tabindex="0"], .avatar, .username, .post'));
    focusableElements = focusableElements.filter(el => !el.disabled);
  }

  document.addEventListener('keydown', (e) => {
    if (!document.body.classList.contains('tv')) return;
    
    if (e.key === 'ArrowDown') {
      e.preventDefault();
      if (focusableElements.length === 0) updateFocusable();
      currentFocusIndex = (currentFocusIndex + 1) % focusableElements.length;
      focusableElements[currentFocusIndex]?.focus();
    } else if (e.key === 'ArrowUp') {
      e.preventDefault();
      if (focusableElements.length === 0) updateFocusable();
      currentFocusIndex = (currentFocusIndex - 1 + focusableElements.length) % focusableElements.length;
      focusableElements[currentFocusIndex]?.focus();
    } else if (e.key === 'Enter') {
      e.preventDefault();
      document.activeElement?.click();
    } else if (e.key === 'Escape') {
      document.querySelector('.modal.active')?.classList.remove('active');
      document.getElementById('sidebar')?.classList.remove('active');
    }
  });

  document.querySelectorAll('[data-section]').forEach(link => {
    link.addEventListener('click', () => {
      setTimeout(updateFocusable, 200);
    });
  });

  resetPagination();
</script>
</body>
</html>

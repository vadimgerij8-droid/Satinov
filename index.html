<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>FANTASYAS ¬∑ new profile</title>
  <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;500;600;700;800&display=swap" rel="stylesheet"/>
  <script src="https://unpkg.com/@lottiefiles/lottie-player@1.7.1/dist/lottie-player.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Manrope', sans-serif;
    }

    :root {
      --bg: #000000;
      --surface: #111111;
      --card: #1a1a1a;
      --border: #2a2a2a;
      --text: #ffffff;
      --text-sec: #aaaaaa;
      --accent: #888888;
      --hover: #2c2c2c;
      --shadow: 0 12px 30px rgba(0, 0, 0, 0.8);
    }

    body.light {
      --bg: #f8f8f8;
      --surface: #ffffff;
      --card: #eeeeee;
      --border: #d0d0d0;
      --text: #111111;
      --text-sec: #555555;
      --accent: #666666;
      --hover: #e0e0e0;
      --shadow: 0 8px 24px rgba(0, 0, 0, 0.05);
    }

    body {
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
      transition: background 0.25s, color 0.25s;
    }

    /* –¢–æ–ø–±–∞—Ä */
    .top-bar {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      height: 70px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 24px;
      background: rgba(0,0,0,0.7);
      backdrop-filter: blur(18px);
      -webkit-backdrop-filter: blur(18px);
      border-bottom: 1px solid var(--border);
      z-index: 1000;
    }
    body.light .top-bar { background: rgba(255,255,255,0.8); }

    .site-name {
      font-size: 2rem;
      font-weight: 800;
      background: linear-gradient(145deg, #fff, #aaa);
      -webkit-background-clip: text;
      background-clip: text;
      color: transparent;
      letter-spacing: -0.5px;
    }
    body.light .site-name { background: linear-gradient(145deg, #111, #555); -webkit-background-clip: text; }

    /* –ë—É—Ä–≥–µ—Ä */
    .burger {
      width: 32px;
      height: 22px;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
      cursor: pointer;
    }
    .burger span {
      height: 3px;
      width: 100%;
      background: var(--text);
      border-radius: 6px;
      transition: 0.3s cubic-bezier(0.68, -0.6, 0.32, 1.6);
    }
    .burger.active span:nth-child(1) { transform: rotate(45deg) translate(7px, 6px); }
    .burger.active span:nth-child(2) { opacity: 0; transform: scale(0); }
    .burger.active span:nth-child(3) { transform: rotate(-45deg) translate(7px, -6px); }

    /* –°–∞–π–¥–±–∞—Ä –∑ SVG —ñ–∫–æ–Ω–∫–∞–º–∏ */
    .sidebar {
      position: fixed;
      top: 0;
      left: -300px;
      width: 280px;
      height: 100%;
      background: rgba(10,10,10,0.7);
      backdrop-filter: blur(24px);
      -webkit-backdrop-filter: blur(24px);
      padding: 100px 28px;
      border-right: 1px solid var(--border);
      transition: left 0.4s cubic-bezier(0.16, 1, 0.3, 1);
      z-index: 999;
    }
    body.light .sidebar { background: rgba(255,255,255,0.7); }
    .sidebar.active { left: 0; }

    .sidebar a {
      display: flex;
      align-items: center;
      gap: 12px;
      color: var(--text-sec);
      text-decoration: none;
      font-size: 1.3rem;
      font-weight: 600;
      margin: 2rem 0;
      transition: 0.2s;
      position: relative;
      width: fit-content;
    }
    .sidebar a .icon-svg {
      width: 28px;
      height: 28px;
      stroke: var(--text-sec);
      stroke-width: 1.8;
      fill: none;
      transition: stroke 0.2s, transform 0.2s;
    }
    .sidebar a:hover .icon-svg {
      stroke: var(--text);
      transform: scale(1.1);
    }
    .sidebar a:hover {
      color: var(--text);
      transform: translateX(8px);
    }
    .sidebar a::after {
      content: '';
      position: absolute;
      bottom: -4px;
      left: 0;
      width: 0;
      height: 2px;
      background: var(--accent);
      transition: width 0.2s;
    }
    .sidebar a:hover::after { width: 100%; }

    .badge {
      background: #ff4444;
      color: white;
      border-radius: 50%;
      padding: 2px 8px;
      font-size: 0.8rem;
      margin-left: 8px;
      display: inline-block;
    }

    .main-content {
      margin-top: 90px;
      padding: 20px;
      max-width: 680px;
      margin-left: auto;
      margin-right: auto;
    }

    .section { display: none; opacity: 0; transform: translateY(20px); transition: 0.4s; }
    .section.active { display: block; opacity: 1; transform: translateY(0); }

    .card {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 28px;
      padding: 24px;
      margin-bottom: 24px;
      box-shadow: var(--shadow);
      transition: 0.25s;
    }
    .card:hover { border-color: var(--accent); }

    input, textarea {
      width: 100%;
      padding: 16px 20px;
      border-radius: 20px;
      border: 1px solid var(--border);
      background: var(--surface);
      color: var(--text);
      font-size: 1rem;
      outline: none;
      transition: 0.2s;
    }
    input:focus, textarea:focus { border-color: var(--accent); background: var(--card); }
    ::placeholder { color: var(--text-sec); opacity: 0.5; }

    button {
      padding: 14px 26px;
      border: none;
      border-radius: 40px;
      background: var(--surface);
      color: var(--text);
      font-weight: 600;
      border: 1px solid var(--border);
      cursor: pointer;
      transition: 0.2s;
      box-shadow: 0 2px 8px rgba(0,0,0,0.2);
    }
    button:hover {
      background: var(--hover);
      transform: scale(1.02);
      border-color: var(--accent);
    }

    /* –ü—Ä–æ—Ñ—ñ–ª—å */
    .profile-header {
      display: flex;
      flex-wrap: wrap;
      gap: 28px;
      align-items: center;
    }
    .profile-avatar {
      width: 120px;
      height: 120px;
      border-radius: 50%;
      background: #333;
      background-size: cover;
      border: 3px solid var(--border);
      cursor: pointer;
      transition: 0.2s;
    }
    .profile-avatar:hover { border-color: var(--accent); transform: scale(1.02); }

    .profile-tabs {
      display: flex;
      gap: 12px;
      margin: 24px 0;
      border-bottom: 1px solid var(--border);
      padding-bottom: 12px;
    }
    .profile-tab {
      background: none;
      border: none;
      color: var(--text-sec);
      font-size: 1.1rem;
      padding: 8px 16px;
      border-radius: 30px;
      transition: 0.2s;
    }
    .profile-tab.active {
      background: var(--accent);
      color: black;
    }

    /* –ü–æ—à—É–∫ */
    .search-input {
      margin-bottom: 24px;
      padding: 18px 24px;
      font-size: 1.1rem;
    }
    .user-item {
      display: flex;
      align-items: center;
      gap: 16px;
      padding: 16px;
      border-radius: 28px;
      background: var(--card);
      border: 1px solid var(--border);
      margin-bottom: 12px;
      cursor: pointer;
      transition: 0.2s;
    }
    .user-item:hover { border-color: var(--accent); transform: translateX(6px); }
    .user-id {
      color: var(--accent);
      font-size: 0.9rem;
    }
    .follow-btn {
      margin-left: auto;
      background: var(--accent);
      color: black;
      font-weight: 700;
      padding: 8px 22px;
      border-radius: 40px;
      border: none;
    }

    /* –°—Ç—Ä—ñ—á–∫–∞ */
    .feed { display: flex; flex-direction: column; gap: 24px; }

    .post {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 28px;
      padding: 24px;
      opacity: 0;
      transform: translateY(30px);
      transition: opacity 0.6s cubic-bezier(0.2, 0.9, 0.3, 1), transform 0.6s cubic-bezier(0.2, 0.9, 0.3, 1);
    }
    .post.show { opacity: 1; transform: translateY(0); }

    .post-header {
      display: flex;
      align-items: center;
      gap: 14px;
      margin-bottom: 18px;
      position: relative;
      flex-wrap: wrap;
    }
    .avatar {
      width: 52px;
      height: 52px;
      border-radius: 50%;
      background: #333;
      background-size: cover;
      background-position: center;
      border: 2px solid var(--border);
      cursor: pointer;
      transition: 0.2s;
    }
    .avatar:hover { border-color: var(--accent); }
    .post-user {
      display: flex;
      flex-direction: column;
    }
    .username {
      font-weight: 700;
      font-size: 1.15rem;
      cursor: pointer;
      text-decoration: none;
      color: var(--text);
    }
    .username:hover { text-decoration: underline; }
    .user-id-small {
      color: var(--accent);
      font-size: 0.85rem;
    }
    .menu-btn {
      margin-left: auto;
      font-size: 2rem;
      line-height: 1;
      background: none;
      border: none;
      color: var(--text-sec);
      padding: 0 8px;
    }
    .menu-btn:hover { color: var(--text); transform: scale(1.2); background: none; border: none; }

    .post-content {
      font-size: 1.05rem;
      line-height: 1.6;
      margin-bottom: 16px;
      word-break: break-word;
    }

    .post-media {
      width: 100%;
      border-radius: 24px;
      margin: 16px 0;
    }

    .post-footer {
      display: flex;
      gap: 28px;
      margin: 16px 0 8px;
    }
    .post-footer button {
      background: none;
      border: none;
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 1.1rem;
      padding: 6px 12px;
      border-radius: 40px;
      color: var(--text-sec);
    }
    .post-footer button:hover { background: var(--hover); color: var(--text); border: none; }

    /* –ê–Ω—ñ–º–æ–≤–∞–Ω–∏–π –ª–∞–π–∫ Lottie */
    .like-btn lottie-player {
      width: 32px;
      height: 32px;
    }
    .like-btn.liked lottie-player {
      filter: drop-shadow(0 0 6px #ff4444);
    }

    .comments-section {
      margin-top: 24px;
      border-top: 1px solid var(--border);
      padding-top: 20px;
    }
    .comment {
      display: flex;
      gap: 12px;
      margin-bottom: 16px;
      animation: fadeSlideUp 0.4s ease;
    }
    @keyframes fadeSlideUp {
      0% { opacity: 0; transform: translateY(15px); }
      100% { opacity: 1; transform: translateY(0); }
    }
    .comment .avatar { width: 36px; height: 36px; }
    .comment-content {
      background: var(--surface);
      padding: 12px 16px;
      border-radius: 22px;
      flex: 1;
      border: 1px solid var(--border);
    }
    .comment-author { font-weight: 700; margin-right: 8px; cursor: pointer; }
    .comment-author:hover { text-decoration: underline; }

    .comment-input-area {
      display: flex;
      gap: 10px;
      margin: 16px 0 8px;
    }
    .comment-input-area textarea {
      flex: 1;
      min-height: 44px;
      border-radius: 30px;
      padding: 12px 18px;
    }

    .emoji-panel {
      display: flex;
      gap: 8px;
      background: var(--surface);
      border-radius: 40px;
      padding: 8px 14px;
      border: 1px solid var(--border);
      width: fit-content;
      margin-bottom: 10px;
    }
    .emoji-panel span {
      font-size: 1.8rem;
      cursor: pointer;
      transition: 0.15s;
      filter: grayscale(20%);
    }
    .emoji-panel span:hover { transform: scale(1.3); filter: grayscale(0); }

    /* –ß–∞—Ç */
    .chat-list { display: flex; flex-direction: column; gap: 8px; max-height: 70vh; overflow-y: auto; }
    .chat-item {
      display: flex; align-items: center; gap: 16px; padding: 16px; border-radius: 24px;
      background: var(--card); border: 1px solid var(--border); cursor: pointer; transition: 0.2s;
    }
    .chat-item:hover { background: var(--hover); border-color: var(--accent); }
    .chat-item.unread { background: rgba(255,255,255,0.05); border-left: 4px solid var(--accent); }
    .chat-avatar { width: 56px; height: 56px; border-radius: 50%; background-size: cover; border: 2px solid var(--border); }
    .chat-info { flex: 1; min-width: 0; }
    .chat-name { font-weight: 700; font-size: 1.1rem; display: flex; align-items: center; gap: 8px; }
    .chat-userid { color: var(--accent); font-size: 0.85rem; }
    .chat-last { color: var(--text-sec); font-size: 0.9rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .chat-meta { display: flex; flex-direction: column; align-items: flex-end; gap: 4px; }
    .chat-time { color: var(--text-sec); font-size: 0.75rem; }
    .chat-badge { background: var(--accent); color: black; border-radius: 50%; min-width: 24px; height: 24px; display: flex; align-items: center; justify-content: center; font-size: 0.8rem; font-weight: 700; }

    .chat-window {
      display: none; flex-direction: column; height: 70vh; border: 1px solid var(--border); border-radius: 32px;
      overflow: hidden; background: var(--card); margin-top: 20px;
    }
    .chat-header { padding: 20px; border-bottom: 1px solid var(--border); display: flex; align-items: center; gap: 10px; background: var(--surface); }
    .chat-header .avatar { width: 40px; height: 40px; }
    .chat-messages { flex: 1; padding: 20px; overflow-y: auto; display: flex; flex-direction: column; gap: 12px; }
    .message { max-width: 75%; padding: 12px 18px; border-radius: 26px; animation: messagePop 0.3s; word-break: break-word; }
    .message.sent { background: var(--accent); color: black; align-self: flex-end; border-bottom-right-radius: 6px; }
    .message.received { background: var(--surface); border: 1px solid var(--border); align-self: flex-start; border-bottom-left-radius: 6px; }
    .chat-input { display: flex; padding: 16px; border-top: 1px solid var(--border); background: var(--surface); }
    .chat-input input { flex: 1; margin-right: 16px; border-radius: 40px; }

    /* –ú–æ–¥–∞–ª–∫–∏ */
    .modal {
      position: fixed; inset: 0; background: rgba(0,0,0,0.7); backdrop-filter: blur(12px);
      display: none; align-items: center; justify-content: center; z-index: 3000;
    }
    .modal.active { display: flex; }
    .modal-content {
      background: var(--card); border: 1px solid var(--border); border-radius: 40px; padding: 32px;
      width: 92%; max-width: 480px; box-shadow: var(--shadow); animation: modalPop 0.3s;
    }
    @keyframes modalPop {
      from { opacity: 0; transform: scale(0.9); }
      to { opacity: 1; transform: scale(1); }
    }
    .close-modal { float: right; font-size: 2.5rem; line-height: 1; cursor: pointer; color: var(--text-sec); }

    @media (max-width: 700px) {
      .main-content { padding: 16px; }
      .profile-header { flex-direction: column; text-align: center; }
    }
  </style>
</head>
<body>

<div class="top-bar">
  <div class="burger" id="burger"><span></span><span></span><span></span></div>
  <div class="site-name">FANTASYAS</div>
</div>

<nav class="sidebar" id="sidebar">
  <a data-section="home">
    <svg class="icon-svg" viewBox="0 0 24 24"><path d="M3 10l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>
    –ì–æ–ª–æ–≤–Ω–∞
  </a>
  <a data-section="search">
    <svg class="icon-svg" viewBox="0 0 24 24"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>
    –ü–æ—à—É–∫
  </a>
  <a data-section="profile">
    <svg class="icon-svg" viewBox="0 0 24 24"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
    –ü—Ä–æ—Ñ—ñ–ª—å
  </a>
  <a data-section="chats">
    <svg class="icon-svg" viewBox="0 0 24 24"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>
    –ü–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è
    <span id="unreadBadge" class="badge" style="display:none;">0</span>
  </a>
  <a data-section="settings">
    <svg class="icon-svg" viewBox="0 0 24 24"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H5.78a1.65 1.65 0 0 0-1.51 1 1.65 1.65 0 0 0 .33 1.82l.07.07A10 10 0 0 0 12 17.66a10 10 0 0 0 6.26-2.26z"/></svg>
    –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è
  </a>
</nav>

<main class="main-content">

  <!-- –ì–û–õ–û–í–ù–ê -->
  <div id="home" class="section active">
    <div class="card" id="authBox">
      <div id="loginForm">
        <input type="text" id="loginNickname" placeholder="–ü—Å–µ–≤–¥–æ–Ω—ñ–º (–±–µ–∑ @)" autocomplete="off"/>
        <input type="password" id="loginPassword" placeholder="–ü–∞—Ä–æ–ª—å"/>
        <button id="loginBtn">–£–≤—ñ–π—Ç–∏</button>
        <div style="display:flex; gap:10px; margin-top:15px;">
          <button id="googleLoginBtn" style="flex:1; background:#2a2a2a;">Google</button>
          <button id="appleLoginBtn" style="flex:1; background:#1a1a1a;">Apple</button>
        </div>
        <p style="margin-top:18px;">–ù–µ–º–∞—î –∞–∫–∞—É–Ω—Ç–∞? <span id="toRegister" style="color:var(--accent);cursor:pointer;">–ó–∞—Ä–µ—î—Å—Ç—Ä—É–≤–∞—Ç–∏—Å—è</span></p>
      </div>
      <div id="registerForm" style="display:none;">
        <input type="text" id="registerNickname" placeholder="–ü—Å–µ–≤–¥–æ–Ω—ñ–º (–±–µ–∑ @)"/>
        <input type="password" id="registerPassword" placeholder="–ü–∞—Ä–æ–ª—å"/>
        <button id="registerBtn">–ó–∞—Ä–µ—î—Å—Ç—Ä—É–≤–∞—Ç–∏—Å—è</button>
        <p style="margin-top:18px;">–í–∂–µ —î –∞–∫–∞—É–Ω—Ç? <span id="toLogin" style="color:var(--accent);cursor:pointer;">–£–≤—ñ–π—Ç–∏</span></p>
      </div>
    </div>

    <div class="card" id="newPostBox" style="display:none;">
      <textarea id="postText" placeholder="–©–æ –Ω–æ–≤–æ–≥–æ?" rows="3"></textarea>
      <div style="display:flex; gap:12px; align-items:center; margin:15px 0;">
        <button id="emojiPostBtn">üòä –î–æ–¥–∞—Ç–∏ –µ–º–æ–¥–∑—ñ</button>
        <div id="emojiPostPicker" class="emoji-panel" style="display:none;">
          <span>üòä</span><span>üòÇ</span><span>‚ù§Ô∏è</span><span>üî•</span><span>üëç</span><span>üéâ</span><span>üò¢</span><span>üòé</span>
        </div>
      </div>
      <input type="file" id="postMedia" accept="image/*,video/*" style="margin:12px 0;"/>
      <button id="addPost">–û–ø—É–±–ª—ñ–∫—É–≤–∞—Ç–∏</button>
    </div>

    <!-- –ü–µ—Ä–µ–º–∏–∫–∞—á —Å—Ç—Ä—ñ—á–æ–∫ -->
    <div class="feed-header" style="display:flex; gap:12px; margin-bottom:24px; justify-content:center;">
      <button id="feedNewBtn" class="active" style="flex:1; max-width:200px;">‚ú® –ù–æ–≤—ñ</button>
      <button id="feedPopularBtn" style="flex:1; max-width:200px;">üî• –ü–æ–ø—É–ª—è—Ä–Ω—ñ</button>
    </div>

    <div class="feed" id="feed"></div>
  </div>

  <!-- –ü–û–®–£–ö (–æ–Ω–æ–≤–ª–µ–Ω–∏–π) -->
  <div id="search" class="section">
    <input type="text" id="searchInput" class="search-input" placeholder="–ü–æ—à—É–∫ –∑–∞ @id –∞–±–æ —ñ–º'—è–º..."/>
    <div class="user-list" id="userList"></div>
  </div>

  <!-- –ü–†–û–§–Ü–õ–¨ (–æ–Ω–æ–≤–ª–µ–Ω–∏–π) -->
  <div id="profile" class="section">
    <div class="card profile-header" id="profileHeader"></div>
    <div class="profile-tabs" id="profileTabs"></div>
    <div class="feed" id="profileFeed"></div>
  </div>

  <!-- –ß–ê–¢–ò -->
  <div id="chats" class="section">
    <div class="chat-list" id="chatList"></div>
    <div class="chat-window" id="chatWindow">
      <div class="chat-header" id="chatHeader">
        <div class="avatar" id="chatAvatar"></div>
        <span id="chatName"></span>
        <span class="user-id-small" id="chatUserId"></span>
      </div>
      <div class="chat-messages" id="chatMessages"></div>
      <div class="chat-input">
        <input type="text" id="chatText" placeholder="–ù–∞–ø–∏—à—ñ—Ç—å –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è..."/>
        <button id="sendMessage">–ù–∞–¥—ñ—Å–ª–∞—Ç–∏</button>
      </div>
    </div>
  </div>

  <!-- –ù–ê–õ–ê–®–¢–£–í–ê–ù–ù–Ø -->
  <div id="settings" class="section card">
    <h2>–ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è</h2>
    <button id="toggleTheme" style="margin:20px 0;">–ü–µ—Ä–µ–º–∫–Ω—É—Ç–∏ —Ç–µ–º—É üåô/‚òÄÔ∏è</button>
    <button id="logoutBtn">–í–∏–π—Ç–∏</button>
  </div>
</main>

<!-- –ú–û–î–ê–õ–ö–ò -->
<div class="modal" id="editProfileModal">
  <div class="modal-content">
    <span class="close-modal" id="closeModal">&times;</span>
    <h2>–†–µ–¥–∞–≥—É–≤–∞—Ç–∏ –ø—Ä–æ—Ñ—ñ–ª—å</h2>
    <input type="text" id="editNickname" placeholder="–ü—Å–µ–≤–¥–æ–Ω—ñ–º (–±–µ–∑ @)"/>
    <textarea id="editBio" placeholder="–ü—Ä–æ —Å–µ–±–µ" rows="4" style="margin:16px 0;"></textarea>
    <button id="saveProfileEdit">–ó–±–µ—Ä–µ–≥—Ç–∏</button>
  </div>
</div>

<div class="modal" id="editPostModal">
  <div class="modal-content">
    <span class="close-modal" id="closeEditPostModal">&times;</span>
    <h2>–†–µ–¥–∞–≥—É–≤–∞—Ç–∏ –ø–æ—Å—Ç</h2>
    <textarea id="editPostText" rows="5" style="margin:20px 0;"></textarea>
    <div style="display: flex; gap: 10px; justify-content: flex-end;">
      <button id="cancelEditPost">–°–∫–∞—Å—É–≤–∞—Ç–∏</button>
      <button id="savePostEdit">–ó–±–µ—Ä–µ–≥—Ç–∏</button>
    </div>
  </div>
</div>

<script type="module">
  // –Ü–º–ø–æ—Ä—Ç–∏ Firebase
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js";
  import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut, GoogleAuthProvider, OAuthProvider, signInWithPopup } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-auth.js";
  import { getFirestore, doc, setDoc, getDoc, updateDoc, collection, addDoc, query, where, onSnapshot, orderBy, serverTimestamp, arrayUnion, arrayRemove, deleteDoc, getDocs, increment, limit } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore.js";
  import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-storage.js";

  const firebaseConfig = {
    apiKey: "AIzaSyDRzC-QDE0-UXd-XL0i3iqayFiKcc6wmvc",
    authDomain: "fantasyasapp.firebaseapp.com",
    projectId: "fantasyasapp",
    storageBucket: "fantasyasapp.firebasestorage.app",
    messagingSenderId: "721763921060",
    appId: "1:721763921060:web:3d61044ea2424e8176ca31"
  };
  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);
  const storage = getStorage(app);

  let currentUser = null;
  let currentChatPartner = null;
  let unsubscribeFeed = null;
  let unsubscribeChat = null;
  let unsubscribeChatList = null;
  let currentEditPostId = null;
  let viewingProfileUid = null;
  let unreadCount = 0;
  let currentFeedType = 'new';
  let currentProfileTab = 'posts'; // 'posts', 'likes', 'media'

  const getChatId = (uid1, uid2) => [uid1, uid2].sort().join('_');

  function updateUnreadBadge() {
    const badge = document.getElementById('unreadBadge');
    if (unreadCount > 0) {
      badge.textContent = unreadCount > 99 ? '99+' : unreadCount;
      badge.style.display = 'inline-block';
    } else {
      badge.style.display = 'none';
    }
  }

  // –ë—É—Ä–≥–µ—Ä
  document.getElementById('burger').onclick = () => {
    document.getElementById('burger').classList.toggle('active');
    document.getElementById('sidebar').classList.toggle('active');
  };

  // –ù–∞–≤—ñ–≥–∞—Ü—ñ—è
  document.querySelectorAll('[data-section]').forEach(link => {
    link.onclick = () => {
      const sectionId = link.dataset.section;
      document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
      document.getElementById(sectionId).classList.add('active');
      document.getElementById('sidebar').classList.remove('active');
      document.getElementById('burger').classList.remove('active');
      if (sectionId === 'search') loadSearchUsers();
      if (sectionId === 'chats') {
        document.getElementById('chatWindow').style.display = 'none';
        loadChatList();
      }
      if (sectionId === 'profile') {
        if (!viewingProfileUid || viewingProfileUid === currentUser?.uid) {
          viewingProfileUid = currentUser?.uid;
          loadMyProfile();
        } else {
          loadUserProfile(viewingProfileUid);
        }
      }
    };
  });

  // –ü–µ—Ä–µ–º–∏–∫–∞–Ω–Ω—è –ª–æ–≥—ñ–Ω/—Ä–µ—î—Å—Ç—Ä–∞—Ü—ñ—è
  document.getElementById('toRegister').onclick = () => {
    document.getElementById('loginForm').style.display = 'none';
    document.getElementById('registerForm').style.display = 'block';
  };
  document.getElementById('toLogin').onclick = () => {
    document.getElementById('registerForm').style.display = 'none';
    document.getElementById('loginForm').style.display = 'block';
  };

  // –†–µ—î—Å—Ç—Ä–∞—Ü—ñ—è –∑ —É–Ω—ñ–∫–∞–ª—å–Ω–∏–º ID
  document.getElementById('registerBtn').onclick = async () => {
    const nickname = document.getElementById('registerNickname').value.trim();
    const password = document.getElementById('registerPassword').value.trim();
    if (!nickname) return alert('–í–≤–µ–¥—ñ—Ç—å –ø—Å–µ–≤–¥–æ–Ω—ñ–º');
    if (password.length < 6) return alert('–ú—ñ–Ω—ñ–º—É–º 6 —Å–∏–º–≤–æ–ª—ñ–≤');
    
    // –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞, —á–∏ ID –≤—ñ–ª—å–Ω–∏–π
    const userId = `@${nickname.toLowerCase()}`;
    const q = query(collection(db, "users"), where("userId", "==", userId));
    const snap = await getDocs(q);
    if (!snap.empty) {
      return alert('–¶–µ–π ID –≤–∂–µ –∑–∞–π–Ω—è—Ç–∏–π, –≤–∏–±–µ—Ä—ñ—Ç—å —ñ–Ω—à–∏–π –ø—Å–µ–≤–¥–æ–Ω—ñ–º');
    }
    
    try {
      const safeNick = nickname.toLowerCase().replace(/[^a-z0-9]/g, '');
      const email = `${safeNick}@fantasyas.local`;
      const cred = await createUserWithEmailAndPassword(auth, email, password);
      await setDoc(doc(db, "users", cred.user.uid), {
        nickname,
        userId: `@${nickname.toLowerCase()}`,
        nickname_lower: nickname.toLowerCase(),
        bio: '',
        avatar: '',
        posts: [],
        likedPosts: [],
        followers: [],
        following: [],
        createdAt: serverTimestamp()
      });
      alert('–†–µ—î—Å—Ç—Ä–∞—Ü—ñ—è —É—Å–ø—ñ—à–Ω–∞');
      document.getElementById('toLogin').click();
      document.getElementById('loginNickname').value = nickname;
    } catch (e) { alert(e.message); }
  };

  // –í—Ö—ñ–¥
  document.getElementById('loginBtn').onclick = async () => {
    const nickname = document.getElementById('loginNickname').value.trim();
    const password = document.getElementById('loginPassword').value.trim();
    if (!nickname || !password) return alert('–ó–∞–ø–æ–≤–Ω—ñ—Ç—å –ø–æ–ª—è');
    try {
      const safeNick = nickname.toLowerCase().replace(/[^a-z0-9]/g, '');
      const email = `${safeNick}@fantasyas.local`;
      await signInWithEmailAndPassword(auth, email, password);
    } catch { alert('–ù–µ–≤—ñ—Ä–Ω–∏–π –ø—Å–µ–≤–¥–æ–Ω—ñ–º –∞–±–æ –ø–∞—Ä–æ–ª—å'); }
  };

  // Google
  document.getElementById('googleLoginBtn').onclick = async () => {
    try {
      const provider = new GoogleAuthProvider();
      const result = await signInWithPopup(auth, provider);
      const user = result.user;
      const userDoc = await getDoc(doc(db, "users", user.uid));
      if (!userDoc.exists()) {
        const nickname = user.displayName || user.email.split('@')[0];
        const userId = `@${nickname.toLowerCase()}`;
        // –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ —É–Ω—ñ–∫–∞–ª—å–Ω–æ—Å—Ç—ñ
        const q = query(collection(db, "users"), where("userId", "==", userId));
        const snap = await getDocs(q);
        const finalUserId = snap.empty ? userId : `@${nickname.toLowerCase()}${Math.floor(Math.random()*1000)}`;
        await setDoc(doc(db, "users", user.uid), {
          nickname,
          userId: finalUserId,
          nickname_lower: nickname.toLowerCase(),
          bio: '',
          avatar: user.photoURL || '',
          posts: [],
          likedPosts: [],
          followers: [],
          following: [],
          createdAt: serverTimestamp()
        });
      }
    } catch (e) { alert(e.message); }
  };

  // Apple (–∞–Ω–∞–ª–æ–≥—ñ—á–Ω–æ)
  document.getElementById('appleLoginBtn').onclick = async () => {
    try {
      const provider = new OAuthProvider('apple.com');
      provider.addScope('email name');
      const result = await signInWithPopup(auth, provider);
      const user = result.user;
      const userDoc = await getDoc(doc(db, "users", user.uid));
      if (!userDoc.exists()) {
        const nickname = user.displayName || user.email.split('@')[0];
        const userId = `@${nickname.toLowerCase()}`;
        const q = query(collection(db, "users"), where("userId", "==", userId));
        const snap = await getDocs(q);
        const finalUserId = snap.empty ? userId : `@${nickname.toLowerCase()}${Math.floor(Math.random()*1000)}`;
        await setDoc(doc(db, "users", user.uid), {
          nickname,
          userId: finalUserId,
          nickname_lower: nickname.toLowerCase(),
          bio: '',
          avatar: user.photoURL || '',
          posts: [],
          likedPosts: [],
          followers: [],
          following: [],
          createdAt: serverTimestamp()
        });
      }
    } catch (e) { alert(e.message); }
  };

  // –°–ª—É—Ö–∞—á –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü—ñ—ó
  onAuthStateChanged(auth, (user) => {
    if (user) {
      currentUser = user;
      document.getElementById('authBox').style.display = 'none';
      document.getElementById('newPostBox').style.display = 'block';
      subscribeToFeed('new');
      loadMyProfile();
      if (unsubscribeChatList) unsubscribeChatList();
      const q = query(collection(db, "chats"), where("participants", "array-contains", currentUser.uid));
      unsubscribeChatList = onSnapshot(q, (snapshot) => {
        let totalUnread = 0;
        snapshot.forEach(doc => {
          const data = doc.data();
          if (data.unread && data.unread[currentUser.uid]) {
            totalUnread += data.unread[currentUser.uid];
          }
        });
        unreadCount = totalUnread;
        updateUnreadBadge();
      });
    } else {
      currentUser = null;
      document.getElementById('authBox').style.display = 'block';
      document.getElementById('newPostBox').style.display = 'none';
      if (unsubscribeFeed) unsubscribeFeed();
      if (unsubscribeChatList) unsubscribeChatList();
      unreadCount = 0;
      updateUnreadBadge();
    }
  });

  // –ü–µ—Ä–µ–º–∏–∫–∞–Ω–Ω—è —Å—Ç—Ä—ñ—á–æ–∫
  document.getElementById('feedNewBtn').onclick = () => {
    if (currentFeedType === 'new') return;
    document.getElementById('feedNewBtn').classList.add('active');
    document.getElementById('feedPopularBtn').classList.remove('active');
    currentFeedType = 'new';
    subscribeToFeed('new');
  };

  document.getElementById('feedPopularBtn').onclick = () => {
    if (currentFeedType === 'popular') return;
    document.getElementById('feedPopularBtn').classList.add('active');
    document.getElementById('feedNewBtn').classList.remove('active');
    currentFeedType = 'popular';
    subscribeToFeed('popular');
  };

  // –ï–º–æ–¥–∑—ñ –¥–ª—è –ø–æ—Å—Ç–∞
  document.getElementById('emojiPostBtn').onclick = () => {
    const p = document.getElementById('emojiPostPicker');
    p.style.display = p.style.display === 'none' ? 'flex' : 'none';
  };
  document.querySelectorAll('#emojiPostPicker span').forEach(s => {
    s.onclick = () => {
      document.getElementById('postText').value += s.textContent;
      document.getElementById('emojiPostPicker').style.display = 'none';
    };
  });

  // –ü—É–±–ª—ñ–∫–∞—Ü—ñ—è –ø–æ—Å—Ç–∞ (–∑ –¥–µ–Ω–æ—Ä–º–∞–ª—ñ–∑–∞—Ü—ñ—î—é)
  document.getElementById('addPost').onclick = async () => {
    if (!currentUser) return alert('–£–≤—ñ–π–¥—ñ—Ç—å');
    const text = document.getElementById('postText').value.trim();
    const file = document.getElementById('postMedia').files[0];
    if (!text && !file) return alert('–î–æ–¥–∞–π—Ç–µ —Ç–µ–∫—Å—Ç –∞–±–æ –º–µ–¥—ñ–∞');
    try {
      let mediaUrl = '', mediaType = '';
      if (file) {
        const storageRef = ref(storage, `posts/${currentUser.uid}/${Date.now()}_${file.name}`);
        await uploadBytes(storageRef, file);
        mediaUrl = await getDownloadURL(storageRef);
        mediaType = file.type.split('/')[0];
      }
      
      const userSnap = await getDoc(doc(db, "users", currentUser.uid));
      const userData = userSnap.data();
      
      const postRef = await addDoc(collection(db, "posts"), {
        author: currentUser.uid,
        authorName: userData.nickname,
        authorUserId: userData.userId,
        authorAvatar: userData.avatar || '',
        text,
        mediaUrl,
        mediaType,
        createdAt: serverTimestamp(),
        likes: [],
        likesCount: 0,
        commentsCount: 0
      });
      
      await updateDoc(doc(db, "users", currentUser.uid), {
        posts: arrayUnion(postRef.id)
      });
      
      document.getElementById('postText').value = '';
      document.getElementById('postMedia').value = '';
    } catch (e) { alert(e.message); }
  };

  // –ü—ñ–¥–ø–∏—Å–∫–∞ –Ω–∞ —Å—Ç—Ä—ñ—á–∫—É (–æ–Ω–æ–≤–ª–µ–Ω–∞ –¥–ª—è –ø–æ–∫–∞–∑—É userId)
  function subscribeToFeed(type) {
    if (unsubscribeFeed) unsubscribeFeed();
    let q;
    if (type === 'new') {
      q = query(collection(db, "posts"), orderBy("createdAt", "desc"));
    } else {
      q = query(collection(db, "posts"), orderBy("likesCount", "desc"), orderBy("createdAt", "desc"));
    }
    unsubscribeFeed = onSnapshot(q, async (snapshot) => {
      const feed = document.getElementById('feed');
      feed.innerHTML = '';
      let posts = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
      posts = posts.slice(0, 50);
      
      for (const post of posts) {
        const postId = post.id;
        const isOwn = post.author === currentUser?.uid;
        const liked = post.likes?.includes(currentUser?.uid) || false;
        
        let isFollowing = false;
        if (currentUser && post.author !== currentUser.uid) {
          const currentUserSnap = await getDoc(doc(db, "users", currentUser.uid));
          isFollowing = currentUserSnap.data().following?.includes(post.author) || false;
        }
        
        // –ö–æ–º–µ–Ω—Ç–∞—Ä—ñ (–æ—Å—Ç–∞–Ω–Ω—ñ 5)
        const commentsQuery = query(collection(db, "posts", postId, "comments"), orderBy("createdAt", "desc"), limit(5));
        const commentsSnap = await getDocs(commentsQuery);
        const comments = [];
        commentsSnap.forEach(c => comments.push({ id: c.id, ...c.data() }));
        
        const postEl = document.createElement('div');
        postEl.className = 'post';
        postEl.innerHTML = `
          <div class="post-header">
            <div class="avatar" style="background-image:url(${post.authorAvatar || ''})" data-uid="${post.author}"></div>
            <div class="post-user">
              <span class="username" data-uid="${post.author}">${post.authorName || '–ù–µ–≤—ñ–¥–æ–º–æ'}</span>
              <span class="user-id-small">${post.authorUserId || ''}</span>
            </div>
            ${isOwn ? `<button class="menu-btn" data-post-id="${postId}">‚ãØ</button>` : ''}
            ${!isOwn && currentUser ? `<button class="subscribe-post-btn" data-author-uid="${post.author}">${isFollowing ? '–í—ñ–¥–ø–∏—Å–∞—Ç–∏—Å—è' : '–ü—ñ–¥–ø–∏—Å–∞—Ç–∏—Å—è'}</button>` : ''}
          </div>
          <div class="post-content">${post.text ? post.text.replace(/\n/g,'<br>') : ''}</div>
          ${post.mediaUrl ? (post.mediaType==='image' ? `<img src="${post.mediaUrl}" class="post-media">` : `<video src="${post.mediaUrl}" controls class="post-media"></video>`) : ''}
          <div class="post-footer">
            <button class="like-btn ${liked ? 'liked' : ''}" data-post-id="${postId}">
              <lottie-player src="https://assets2.lottiefiles.com/packages/lf20_t9vz0c1s.json" background="transparent" speed="1" style="width:32px;height:32px;" loop></lottie-player>
              <span>${post.likesCount || 0}</span>
            </button>
            <button class="comments-toggle" data-post-id="${postId}">
              <svg class="icon-svg" viewBox="0 0 24 24" style="width:28px;height:28px;"><path d="M21 3H3c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h5v2h8v-2h5c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2z"/></svg>
              <span>${post.commentsCount || 0}</span>
            </button>
          </div>
          <div class="comments-section" id="comments-${postId}" style="display:none;">
            <div class="comments-list" id="comments-list-${postId}"></div>
            <div class="comment-input-area">
              <textarea id="comment-text-${postId}" placeholder="–ö–æ–º–µ–Ω—Ç–∞—Ä..."></textarea>
              <button class="send-comment" data-post-id="${postId}">‚û§</button>
            </div>
            <div class="emoji-panel" id="emoji-comment-${postId}" style="display:none;">
              <span>üòä</span><span>üòÇ</span><span>‚ù§Ô∏è</span><span>üî•</span><span>üëç</span><span>üéâ</span>
            </div>
            <button class="emoji-comment-btn" data-post-id="${postId}">üòã –ï–º–æ–¥–∑—ñ</button>
          </div>
        `;
        
        const listDiv = postEl.querySelector(`#comments-list-${postId}`);
        if (listDiv) {
          listDiv.innerHTML = comments.reverse().map(c => `
            <div class="comment">
              <div class="avatar" style="background-image:url(${c.authorAvatar || ''})" data-uid="${c.author}"></div>
              <div class="comment-content">
                <span class="comment-author" data-uid="${c.author}">${c.authorNickname || '–Ω–µ–≤—ñ–¥–æ–º–æ'}</span> ${c.text}
              </div>
            </div>
          `).join('');
        }
        
        feed.appendChild(postEl);
        setTimeout(() => postEl.classList.add('show'), 50 * feed.children.length);
      }
    });
  }

  // –û–±—Ä–æ–±–Ω–∏–∫ –ø–æ–¥—ñ–π —Å—Ç—Ä—ñ—á–∫–∏
  document.getElementById('feed').addEventListener('click', async (e) => {
    if (e.target.closest('.like-btn')) {
      const btn = e.target.closest('.like-btn');
      const player = btn.querySelector('lottie-player');
      if (player) player.play();
      
      const postId = btn.dataset.postId;
      const postRef = doc(db, "posts", postId);
      const snap = await getDoc(postRef);
      const likes = snap.data().likes || [];
      
      if (likes.includes(currentUser.uid)) {
        await updateDoc(postRef, {
          likes: arrayRemove(currentUser.uid),
          likesCount: increment(-1)
        });
        // –í–∏–¥–∞–ª–∏—Ç–∏ –∑ likedPosts –ø–æ—Ç–æ—á–Ω–æ–≥–æ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞
        await updateDoc(doc(db, "users", currentUser.uid), {
          likedPosts: arrayRemove(postId)
        });
      } else {
        await updateDoc(postRef, {
          likes: arrayUnion(currentUser.uid),
          likesCount: increment(1)
        });
        // –î–æ–¥–∞—Ç–∏ –≤ likedPosts
        await updateDoc(doc(db, "users", currentUser.uid), {
          likedPosts: arrayUnion(postId)
        });
      }
    }
    
    if (e.target.closest('.menu-btn')) {
      const postId = e.target.closest('.menu-btn').dataset.postId;
      const postRef = doc(db, "posts", postId);
      const snap = await getDoc(postRef);
      document.getElementById('editPostText').value = snap.data().text || '';
      currentEditPostId = postId;
      document.getElementById('editPostModal').classList.add('active');
    }
    
    if (e.target.closest('.comments-toggle')) {
      const postId = e.target.closest('.comments-toggle').dataset.postId;
      const sec = document.getElementById(`comments-${postId}`);
      sec.style.display = sec.style.display === 'none' ? 'block' : 'none';
    }
    
    if (e.target.closest('.send-comment')) {
      const btn = e.target.closest('.send-comment');
      const postId = btn.dataset.postId;
      const textarea = document.getElementById(`comment-text-${postId}`);
      const text = textarea.value.trim();
      if (!text) return;
      const userDoc = await getDoc(doc(db, "users", currentUser.uid));
      const userData = userDoc.data();
      await addDoc(collection(db, "posts", postId, "comments"), {
        author: currentUser.uid,
        authorNickname: userData.nickname,
        authorUserId: userData.userId,
        authorAvatar: userData.avatar || '',
        text,
        createdAt: serverTimestamp()
      });
      await updateDoc(doc(db, "posts", postId), { commentsCount: increment(1) });
      textarea.value = '';
    }
    
    if (e.target.closest('.emoji-comment-btn')) {
      const btn = e.target.closest('.emoji-comment-btn');
      const postId = btn.dataset.postId;
      const picker = document.getElementById(`emoji-comment-${postId}`);
      picker.style.display = picker.style.display === 'none' ? 'flex' : 'none';
    }
    
    if (e.target.closest('.emoji-panel span')) {
      const span = e.target.closest('.emoji-panel span');
      const picker = span.closest('.emoji-panel');
      const postId = picker.id.replace('emoji-comment-', '');
      const textarea = document.getElementById(`comment-text-${postId}`);
      textarea.value += span.textContent;
      picker.style.display = 'none';
    }
    
    if (e.target.closest('.subscribe-post-btn')) {
      const btn = e.target.closest('.subscribe-post-btn');
      const authorUid = btn.dataset.authorUid;
      await toggleFollow(authorUid);
      const isFollowing = (await getDoc(doc(db, "users", currentUser.uid))).data().following.includes(authorUid);
      btn.textContent = isFollowing ? '–í—ñ–¥–ø–∏—Å–∞—Ç–∏—Å—è' : '–ü—ñ–¥–ø–∏—Å–∞—Ç–∏—Å—è';
    }
    
    if (e.target.closest('[data-uid]')) {
      const el = e.target.closest('[data-uid]');
      const uid = el.dataset.uid;
      if (uid === currentUser.uid) {
        viewingProfileUid = currentUser.uid;
        loadMyProfile();
      } else {
        viewingProfileUid = uid;
        loadUserProfile(uid);
      }
      document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
      document.getElementById('profile').classList.add('active');
      document.getElementById('sidebar').classList.remove('active');
      document.getElementById('burger').classList.remove('active');
    }
  });

  // –†–µ–¥–∞–≥—É–≤–∞–Ω–Ω—è –ø–æ—Å—Ç–∞
  document.getElementById('savePostEdit').onclick = async () => {
    if (!currentEditPostId) return;
    const newText = document.getElementById('editPostText').value.trim();
    await updateDoc(doc(db, "posts", currentEditPostId), { text: newText });
    document.getElementById('editPostModal').classList.remove('active');
    currentEditPostId = null;
  };
  document.getElementById('cancelEditPost').onclick = () => {
    document.getElementById('editPostModal').classList.remove('active');
    currentEditPostId = null;
  };
  document.getElementById('closeEditPostModal').onclick = () => {
    document.getElementById('editPostModal').classList.remove('active');
    currentEditPostId = null;
  };

  // –û–Ω–æ–≤–ª–µ–Ω–∏–π –ø–æ—à—É–∫ (–∑–∞ ID —Ç–∞ —ñ–º'—è–º)
  async function loadSearchUsers() {
    const val = document.getElementById('searchInput').value.trim().toLowerCase();
    const userList = document.getElementById('userList');
    if (!val) { userList.innerHTML = ''; return; }
    
    const mySnap = await getDoc(doc(db, "users", currentUser.uid));
    const myFollowing = mySnap.data().following || [];
    
    // –ü–æ—à—É–∫ –∑–∞ userId (–∑ @) –∞–±–æ –∑–∞ nickname_lower
    const q1 = query(collection(db, "users"), where("userId", ">=", val.startsWith('@') ? val : `@${val}`), where("userId", "<=", (val.startsWith('@') ? val : `@${val}`) + '\uf8ff'));
    const q2 = query(collection(db, "users"), where("nickname_lower", ">=", val), where("nickname_lower", "<=", val + '\uf8ff'));
    
    const [snap1, snap2] = await Promise.all([getDocs(q1), getDocs(q2)]);
    const usersMap = new Map();
    snap1.forEach(d => usersMap.set(d.id, d.data()));
    snap2.forEach(d => usersMap.set(d.id, d.data()));
    
    userList.innerHTML = '';
    usersMap.forEach((data, uid) => {
      if (uid === currentUser.uid) return;
      const isFollowing = myFollowing.includes(uid);
      const div = document.createElement('div');
      div.className = 'user-item';
      div.innerHTML = `
        <div class="avatar" style="background-image:url(${data.avatar || ''})"></div>
        <div>
          <div style="font-weight:600;">${data.nickname}</div>
          <div class="user-id">${data.userId || ''}</div>
        </div>
        <button class="follow-btn">${isFollowing ? '–í—ñ–¥–ø–∏—Å–∞—Ç–∏—Å—è' : '–ü—ñ–¥–ø–∏—Å–∞—Ç–∏—Å—è'}</button>
      `;
      div.querySelector('.follow-btn').onclick = async (e) => {
        e.stopPropagation();
        await toggleFollow(uid);
        loadSearchUsers();
      };
      div.onclick = () => {
        viewingProfileUid = uid;
        loadUserProfile(uid);
        document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
        document.getElementById('profile').classList.add('active');
        document.getElementById('sidebar').classList.remove('active');
        document.getElementById('burger').classList.remove('active');
      };
      userList.appendChild(div);
    });
  }
  document.getElementById('searchInput').addEventListener('input', loadSearchUsers);

  async function toggleFollow(targetUid) {
    const myRef = doc(db, "users", currentUser.uid);
    const targetRef = doc(db, "users", targetUid);
    const mySnap = await getDoc(myRef);
    const following = mySnap.data().following || [];
    if (following.includes(targetUid)) {
      await updateDoc(myRef, { following: arrayRemove(targetUid) });
      await updateDoc(targetRef, { followers: arrayRemove(currentUser.uid) });
    } else {
      await updateDoc(myRef, { following: arrayUnion(targetUid) });
      await updateDoc(targetRef, { followers: arrayUnion(currentUser.uid) });
    }
  }

  // –ü—Ä–æ—Ñ—ñ–ª—å –∑ –≤–∫–ª–∞–¥–∫–∞–º–∏
  async function loadMyProfile() {
    if (!currentUser) return;
    const snap = await getDoc(doc(db, "users", currentUser.uid));
    if (snap.exists()) {
      const data = snap.data();
      renderProfile(data, currentUser.uid, true);
    }
  }

  async function loadUserProfile(uid) {
    const snap = await getDoc(doc(db, "users", uid));
    if (snap.exists()) {
      const data = snap.data();
      const isOwn = uid === currentUser?.uid;
      renderProfile(data, uid, isOwn);
    }
  }

  function renderProfile(data, uid, isOwn) {
    const profileDiv = document.getElementById('profile');
    const isFollowing = !isOwn && currentUser ? (data.followers?.includes(currentUser.uid) || false) : false;
    
    // –®–∞–ø–∫–∞ –ø—Ä–æ—Ñ—ñ–ª—é
    profileDiv.innerHTML = `
      <div class="card profile-header">
        <div class="profile-avatar" style="background-image:url(${data.avatar || ''})" data-uid="${uid}"></div>
        ${isOwn ? '<input type="file" id="avatarInput" accept="image/*" style="display:none;"/>' : ''}
        <div style="flex:1;">
          <h2>${data.nickname}</h2>
          <div class="user-id" style="font-size:1rem; margin:5px 0;">${data.userId || ''}</div>
          <p style="color:var(--text-sec); margin:10px 0;">${data.bio || '–û–ø–∏—Å –≤—ñ–¥—Å—É—Ç–Ω—ñ–π'}</p>
          <div style="display:flex; gap:25px; font-weight:600;">
            <span>${data.posts?.length || 0} –ø–æ—Å—Ç—ñ–≤</span>
            <span>${data.followers?.length || 0} –ø—ñ–¥–ø–∏—Å–Ω–∏–∫—ñ–≤</span>
            <span>${data.following?.length || 0} –ø—ñ–¥–ø–∏—Å–æ–∫</span>
          </div>
          ${!isOwn && currentUser ? `
            <div style="margin-top:16px; display:flex; gap:10px;">
              <button id="profileFollowBtn">${isFollowing ? '–í—ñ–¥–ø–∏—Å–∞—Ç–∏—Å—è' : '–ü—ñ–¥–ø–∏—Å–∞—Ç–∏—Å—è'}</button>
              <button id="profileMessageBtn">–ù–∞–ø–∏—Å–∞—Ç–∏</button>
            </div>
          ` : ''}
          ${isOwn ? '<button id="editProfileBtn" style="margin-top:16px;">–†–µ–¥–∞–≥—É–≤–∞—Ç–∏ –ø—Ä–æ—Ñ—ñ–ª—å</button>' : ''}
        </div>
      </div>
      <div class="profile-tabs">
        <button class="profile-tab active" data-tab="posts">–ü–æ—Å—Ç–∏</button>
        <button class="profile-tab" data-tab="likes">–õ–∞–π–∫–∏</button>
        <button class="profile-tab" data-tab="media">–ú–µ–¥—ñ–∞</button>
      </div>
      <div class="feed" id="profileFeed"></div>
    `;
    
    // –û–±—Ä–æ–±–Ω–∏–∫–∏ –≤–∫–ª–∞–¥–æ–∫
    document.querySelectorAll('.profile-tab').forEach(tab => {
      tab.onclick = () => {
        document.querySelectorAll('.profile-tab').forEach(t => t.classList.remove('active'));
        tab.classList.add('active');
        const tabType = tab.dataset.tab;
        loadProfileFeed(uid, tabType);
      };
    });
    
    // –ó–∞–≤–∞–Ω—Ç–∞–∂—É—î–º–æ –ø–æ—Å—Ç–∏ –∑–∞ –∑–∞–º–æ–≤—á—É–≤–∞–Ω–Ω—è–º
    loadProfileFeed(uid, 'posts');
    
    // –Ü–Ω—à—ñ –æ–±—Ä–æ–±–Ω–∏–∫–∏
    if (!isOwn && currentUser) {
      document.getElementById('profileFollowBtn').onclick = async () => {
        await toggleFollow(uid);
        loadUserProfile(uid);
      };
      document.getElementById('profileMessageBtn').onclick = () => {
        openChat(data.nickname, uid, data.userId);
      };
    }
    
    if (isOwn) {
      document.getElementById('profileAvatar').onclick = () => {
        document.getElementById('avatarInput').click();
      };
      document.getElementById('avatarInput').onchange = async (e) => {
        const file = e.target.files[0];
        if (!file) return;
        try {
          const storageRef = ref(storage, `avatars/${currentUser.uid}`);
          await uploadBytes(storageRef, file);
          const url = await getDownloadURL(storageRef);
          await updateDoc(doc(db, "users", currentUser.uid), { avatar: url });
          document.querySelector('.profile-avatar').style.backgroundImage = `url(${url})`;
        } catch { alert('–ü–æ–º–∏–ª–∫–∞'); }
      };
      document.getElementById('editProfileBtn').onclick = () => {
        document.getElementById('editNickname').value = data.nickname;
        document.getElementById('editBio').value = data.bio || '';
        document.getElementById('editProfileModal').classList.add('active');
      };
    }
  }

  // –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –ø–æ—Å—Ç—ñ–≤ –¥–ª—è –ø—Ä–æ—Ñ—ñ–ª—é
  async function loadProfileFeed(uid, tab) {
    const feed = document.getElementById('profileFeed');
    feed.innerHTML = '';
    
    let posts = [];
    if (tab === 'posts') {
      const userSnap = await getDoc(doc(db, "users", uid));
      const postIds = userSnap.data().posts || [];
      for (const id of postIds) {
        const postSnap = await getDoc(doc(db, "posts", id));
        if (postSnap.exists()) posts.push({ id: postSnap.id, ...postSnap.data() });
      }
    } else if (tab === 'likes') {
      const userSnap = await getDoc(doc(db, "users", uid));
      const likedIds = userSnap.data().likedPosts || [];
      for (const id of likedIds) {
        const postSnap = await getDoc(doc(db, "posts", id));
        if (postSnap.exists()) posts.push({ id: postSnap.id, ...postSnap.data() });
      }
    } else if (tab === 'media') {
      const q = query(collection(db, "posts"), where("author", "==", uid), where("mediaUrl", "!=", ""));
      const snap = await getDocs(q);
      snap.forEach(doc => posts.push({ id: doc.id, ...doc.data() }));
    }
    
    posts.sort((a,b) => b.createdAt?.seconds - a.createdAt?.seconds);
    posts = posts.slice(0, 50);
    
    for (const post of posts) {
      const postId = post.id;
      const isOwn = post.author === currentUser?.uid;
      const liked = post.likes?.includes(currentUser?.uid) || false;
      
      let isFollowing = false;
      if (currentUser && post.author !== currentUser.uid) {
        const currentUserSnap = await getDoc(doc(db, "users", currentUser.uid));
        isFollowing = currentUserSnap.data().following?.includes(post.author) || false;
      }
      
      const commentsQuery = query(collection(db, "posts", postId, "comments"), orderBy("createdAt", "desc"), limit(5));
      const commentsSnap = await getDocs(commentsQuery);
      const comments = [];
      commentsSnap.forEach(c => comments.push({ id: c.id, ...c.data() }));
      
      const postEl = document.createElement('div');
      postEl.className = 'post';
      postEl.innerHTML = `
        <div class="post-header">
          <div class="avatar" style="background-image:url(${post.authorAvatar || ''})" data-uid="${post.author}"></div>
          <div class="post-user">
            <span class="username" data-uid="${post.author}">${post.authorName || '–ù–µ–≤—ñ–¥–æ–º–æ'}</span>
            <span class="user-id-small">${post.authorUserId || ''}</span>
          </div>
          ${isOwn ? `<button class="menu-btn" data-post-id="${postId}">‚ãØ</button>` : ''}
          ${!isOwn && currentUser ? `<button class="subscribe-post-btn" data-author-uid="${post.author}">${isFollowing ? '–í—ñ–¥–ø–∏—Å–∞—Ç–∏—Å—è' : '–ü—ñ–¥–ø–∏—Å–∞—Ç–∏—Å—è'}</button>` : ''}
        </div>
        <div class="post-content">${post.text ? post.text.replace(/\n/g,'<br>') : ''}</div>
        ${post.mediaUrl ? (post.mediaType==='image' ? `<img src="${post.mediaUrl}" class="post-media">` : `<video src="${post.mediaUrl}" controls class="post-media"></video>`) : ''}
        <div class="post-footer">
          <button class="like-btn ${liked ? 'liked' : ''}" data-post-id="${postId}">
            <lottie-player src="https://assets2.lottiefiles.com/packages/lf20_t9vz0c1s.json" background="transparent" speed="1" style="width:32px;height:32px;" loop></lottie-player>
            <span>${post.likesCount || 0}</span>
          </button>
          <button class="comments-toggle" data-post-id="${postId}">
            <svg class="icon-svg" viewBox="0 0 24 24" style="width:28px;height:28px;"><path d="M21 3H3c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h5v2h8v-2h5c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2z"/></svg>
            <span>${post.commentsCount || 0}</span>
          </button>
        </div>
        <div class="comments-section" id="comments-${postId}" style="display:none;">
          <div class="comments-list" id="comments-list-${postId}"></div>
          <div class="comment-input-area">
            <textarea id="comment-text-${postId}" placeholder="–ö–æ–º–µ–Ω—Ç–∞—Ä..."></textarea>
            <button class="send-comment" data-post-id="${postId}">‚û§</button>
          </div>
          <div class="emoji-panel" id="emoji-comment-${postId}" style="display:none;">
            <span>üòä</span><span>üòÇ</span><span>‚ù§Ô∏è</span><span>üî•</span><span>üëç</span><span>üéâ</span>
          </div>
          <button class="emoji-comment-btn" data-post-id="${postId}">üòã –ï–º–æ–¥–∑—ñ</button>
        </div>
      `;
      
      const listDiv = postEl.querySelector(`#comments-list-${postId}`);
      if (listDiv) {
        listDiv.innerHTML = comments.reverse().map(c => `
          <div class="comment">
            <div class="avatar" style="background-image:url(${c.authorAvatar || ''})" data-uid="${c.author}"></div>
            <div class="comment-content">
              <span class="comment-author" data-uid="${c.author}">${c.authorNickname || '–Ω–µ–≤—ñ–¥–æ–º–æ'}</span> ${c.text}
            </div>
          </div>
        `).join('');
      }
      
      feed.appendChild(postEl);
      setTimeout(() => postEl.classList.add('show'), 50 * feed.children.length);
    }
  }

  // –†–µ–¥–∞–≥—É–≤–∞–Ω–Ω—è –ø—Ä–æ—Ñ—ñ–ª—é
  document.getElementById('closeModal').onclick = () => document.getElementById('editProfileModal').classList.remove('active');
  document.getElementById('saveProfileEdit').onclick = async () => {
    const nickname = document.getElementById('editNickname').value.trim();
    const bio = document.getElementById('editBio').value.trim();
    if (!nickname) return alert('–ü—Å–µ–≤–¥–æ–Ω—ñ–º –æ–±–æ–≤‚Äô—è–∑–∫–æ–≤–∏–π');
    
    // –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ —É–Ω—ñ–∫–∞–ª—å–Ω–æ—Å—Ç—ñ –Ω–æ–≤–æ–≥–æ ID
    const newUserId = `@${nickname.toLowerCase()}`;
    const q = query(collection(db, "users"), where("userId", "==", newUserId));
    const snap = await getDocs(q);
    if (!snap.empty && snap.docs[0].id !== currentUser.uid) {
      return alert('–¶–µ–π ID –≤–∂–µ –∑–∞–π–Ω—è—Ç–∏–π');
    }
    
    await updateDoc(doc(db, "users", currentUser.uid), {
      nickname,
      userId: newUserId,
      nickname_lower: nickname.toLowerCase(),
      bio
    });
    loadMyProfile();
    document.getElementById('editProfileModal').classList.remove('active');
  };

  // –ß–∞—Ç–∏ (–æ–Ω–æ–≤–ª–µ–Ω—ñ –∑ userId)
  async function loadChatList() {
    const list = document.getElementById('chatList');
    list.innerHTML = '';
    const q = query(collection(db, "chats"), where("participants", "array-contains", currentUser.uid), orderBy("updatedAt", "desc"));
    onSnapshot(q, async (snapshot) => {
      list.innerHTML = '';
      for (const docSnap of snapshot.docs) {
        const chat = docSnap.data();
        const otherUid = chat.participants.find(uid => uid !== currentUser.uid);
        const userSnap = await getDoc(doc(db, "users", otherUid));
        const user = userSnap.data();
        const unread = chat.unread?.[currentUser.uid] || 0;
        const lastMsg = chat.lastMessage || '';
        const time = chat.updatedAt ? new Date(chat.updatedAt.seconds * 1000).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }) : '';
        
        const item = document.createElement('div');
        item.className = `chat-item ${unread > 0 ? 'unread' : ''}`;
        item.dataset.chatId = docSnap.id;
        item.dataset.otherUid = otherUid;
        item.innerHTML = `
          <div class="chat-avatar" style="background-image:url(${user.avatar || ''})"></div>
          <div class="chat-info">
            <div class="chat-name">${user.nickname} <span class="chat-userid">${user.userId || ''}</span></div>
            <div class="chat-last">${lastMsg}</div>
          </div>
          <div class="chat-meta">
            <div class="chat-time">${time}</div>
            ${unread > 0 ? `<div class="chat-badge">${unread}</div>` : ''}
          </div>
        `;
        item.onclick = () => openChatFromList(docSnap.id, otherUid, user.nickname, user.userId, user.avatar);
        list.appendChild(item);
      }
    });
  }

  async function openChatFromList(chatId, otherUid, otherName, otherUserId, otherAvatar) {
    currentChatPartner = otherUid;
    document.getElementById('chatWindow').style.display = 'flex';
    document.getElementById('chatName').textContent = otherName;
    document.getElementById('chatUserId').textContent = otherUserId || '';
    document.getElementById('chatAvatar').style.backgroundImage = `url(${otherAvatar || ''})`;
    const chatRef = doc(db, "chats", chatId);
    await updateDoc(chatRef, { [`unread.${currentUser.uid}`]: 0 });
    subscribeToChat(chatId);
  }

  function openChat(otherName, otherUid, otherUserId) {
    currentChatPartner = otherUid;
    document.getElementById('chatWindow').style.display = 'flex';
    document.getElementById('chatName').textContent = otherName;
    document.getElementById('chatUserId').textContent = otherUserId || '';
    getDoc(doc(db, "users", otherUid)).then(snap => {
      if (snap.exists()) {
        document.getElementById('chatAvatar').style.backgroundImage = `url(${snap.data().avatar || ''})`;
      }
    });
    const chatId = getChatId(currentUser.uid, otherUid);
    const chatRef = doc(db, "chats", chatId);
    getDoc(chatRef).then(async (docSnap) => {
      if (!docSnap.exists()) {
        await setDoc(chatRef, {
          participants: [currentUser.uid, otherUid],
          createdAt: serverTimestamp(),
          updatedAt: serverTimestamp(),
          lastMessage: '',
          unread: { [currentUser.uid]: 0, [otherUid]: 0 }
        });
      } else {
        await updateDoc(chatRef, { [`unread.${currentUser.uid}`]: 0 });
      }
      subscribeToChat(chatId);
    });
  }

  function subscribeToChat(chatId) {
    if (unsubscribeChat) unsubscribeChat();
    const q = query(collection(db, `chats/${chatId}/messages`), orderBy("createdAt"));
    unsubscribeChat = onSnapshot(q, (snap) => {
      const messages = document.getElementById('chatMessages');
      messages.innerHTML = '';
      snap.forEach(m => {
        const msg = m.data();
        const div = document.createElement('div');
        div.className = `message ${msg.from === currentUser.uid ? 'sent' : 'received'}`;
        div.textContent = msg.text;
        messages.appendChild(div);
      });
      messages.scrollTop = messages.scrollHeight;
    });
  }

  document.getElementById('sendMessage').onclick = async () => {
    const text = document.getElementById('chatText').value.trim();
    if (!text || !currentChatPartner) return;
    const chatId = getChatId(currentUser.uid, currentChatPartner);
    const chatRef = doc(db, "chats", chatId);
    const messageRef = collection(db, `chats/${chatId}/messages`);
    await addDoc(messageRef, { from: currentUser.uid, text, createdAt: serverTimestamp() });
    await updateDoc(chatRef, {
      lastMessage: text,
      updatedAt: serverTimestamp(),
      [`unread.${currentChatPartner}`]: increment(1)
    });
    document.getElementById('chatText').value = '';
  };

  // –¢–µ–º–∞
  document.getElementById('toggleTheme').onclick = () => {
    document.body.classList.toggle('light');
    localStorage.setItem('theme', document.body.classList.contains('light') ? 'light' : 'dark');
  };
  if (localStorage.getItem('theme') === 'light') document.body.classList.add('light');

  // –í–∏—Ö—ñ–¥
  document.getElementById('logoutBtn').onclick = () => signOut(auth);

  // –ü—Ä–∏—Ö–æ–≤–∞—Ç–∏ —á–∞—Ç —Å–ø–æ—á–∞—Ç–∫—É
  document.getElementById('chatWindow').style.display = 'none';
</script>
</body>
</html>

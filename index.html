<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>FANTASYAS</title>
  <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@500;600;700;800&display=swap" rel="stylesheet"/>
  <script src="https://unpkg.com/@lottiefiles/lottie-player@latest/dist/lottie-player.js"></script>
  
  <style>
    :root {
      --bg: #000;
      --text: #ffffff;
      --text-secondary: #cccccc;
      --card-bg: rgba(255,255,255,0.06);
      --card-border: rgba(255,255,255,0.12);
      --input-bg: rgba(255,255,255,0.08);
      --input-border: rgba(255,255,255,0.18);
      --btn-bg: linear-gradient(to right, #333, #555);
      --btn-hover: linear-gradient(to right, #444, #666);
      --accent: #0af;
    }

    body.light {
      --bg: #ffffff;
      --text: #111111;
      --text-secondary: #555555;
      --card-bg: rgba(0,0,0,0.04);
      --card-border: rgba(0,0,0,0.10);
      --input-bg: #ffffff;
      --input-border: #d0d0d0;
      --btn-bg: linear-gradient(to right, #ddd, #bbb);
      --btn-hover: linear-gradient(to right, #ccc, #aaa);
      --accent: #0066cc;
    }

    * { margin:0; padding:0; box-sizing:border-box; font-family:'Manrope',sans-serif; }
    body { background:var(--bg); color:var(--text); min-height:100vh; transition:background 0.4s, color 0.4s; }

    .top-bar { position:fixed; top:0; left:0; right:0; height:70px; display:flex; align-items:center; justify-content:space-between; padding:0 20px; background:rgba(0,0,0,0.6); backdrop-filter:blur(8px); z-index:1000; transition:background 0.3s; }
    body.light .top-bar { background:rgba(255,255,255,0.92); }

    .site-name { font-size:1.8rem; font-weight:800; background:linear-gradient(90deg,#ffffff,#bbbbbb); -webkit-background-clip:text; background-clip:text; color:transparent; -webkit-text-fill-color:transparent; }
    body.light .site-name { background:linear-gradient(90deg,#111111,#444444); -webkit-background-clip:text; background-clip:text; color:transparent; -webkit-text-fill-color:transparent; }

    .burger { width:32px; height:24px; display:flex; flex-direction:column; justify-content:space-between; cursor:pointer; }
    .burger span { height:3px; width:100%; background:var(--text); border-radius:2px; transition:all 0.35s ease; }
    .burger.active span:nth-child(1) { transform:rotate(45deg) translate(7px,7px); }
    .burger.active span:nth-child(2) { opacity:0; }
    .burger.active span:nth-child(3) { transform:rotate(-45deg) translate(6px,-6px); }

    .sidebar { position:fixed; top:0; left:-300px; width:280px; height:100%; background:rgba(0,0,0,0.5); backdrop-filter:blur(12px); padding:90px 28px; border-right:1px solid var(--card-border); transition:left 0.4s ease; z-index:900; }
    body.light .sidebar { background:rgba(255,255,255,0.5); }
    .sidebar.active { left:0; }

    .sidebar a { display:block; color:var(--text-secondary); text-decoration:none; font-size:1.22rem; font-weight:600; margin:1.4rem 0; transition:all 0.25s; }
    .sidebar a:hover { color:var(--text); transform:translateX(8px); }

    .main-content { margin-top:90px; padding:20px; max-width:720px; margin-left:auto; margin-right:auto; }

    .section { display:none; opacity:0; transform:translateY(12px); transition:opacity 0.35s, transform 0.35s; }
    .section.active { display:block; opacity:1; transform:translateY(0); }

    .card { background:var(--card-bg); border:1px solid var(--card-border); border-radius:14px; padding:20px; margin-bottom:20px; transition:all 0.2s; }

    input, textarea { width:100%; padding:12px 14px; border-radius:10px; border:1px solid var(--input-border); background:var(--input-bg); color:var(--text); font-size:1rem; outline:none; transition:border-color 0.2s; }
    input:focus, textarea:focus { border-color:var(--accent); }
    textarea { resize:vertical; min-height:96px; }
    ::placeholder { color:var(--text-secondary); opacity:0.7; }

    button { padding:11px 20px; border:none; border-radius:10px; background:var(--btn-bg); color:white; font-weight:700; cursor:pointer; transition:all 0.22s; box-shadow:0 2px 8px rgba(0,0,0,0.2); }
    button:hover { background:var(--btn-hover); opacity:0.92; transform:scale(1.03); }
    button:active { transform:scale(0.97); }

    .feed { display:flex; flex-direction:column; gap:18px; }

    .post { background:var(--card-bg); border:1px solid var(--card-border); border-radius:12px; padding:16px; opacity:0; transform:translateY(24px); transition:opacity 0.5s, transform 0.5s; }
    .post.show { opacity:1; transform:translateY(0); }

    .post-header { display:flex; align-items:center; gap:12px; margin-bottom:12px; }

    .avatar { width:48px; height:48px; border-radius:50%; background:#555; background-size:cover; background-position:center; flex-shrink:0; border:1px solid var(--card-border); }
    body.light .avatar { background:#ccc; }

    .username { font-weight:700; font-size:1.05rem; }

    .post-content { line-height:1.5; word-break:break-word; color:var(--text); }

    .post-media img, .post-media video { width:100%; border-radius:12px; margin-top:12px; }

    .post-footer { display:flex; gap:24px; margin-top:12px; }
    .post-footer button { background:none; color:var(--text-secondary); font-size:0.95rem; padding:0; box-shadow:none; }
    .post-footer button:hover { color:var(--text); transform:scale(1.1); }
    .post-footer .like-btn { display:flex; align-items:center; gap:4px; }
    .post-footer .like-btn.pulsed lottie-player { animation: pulse 0.5s; }

    @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.3); } 100% { transform: scale(1); } }

    .modal { position:fixed; inset:0; background:rgba(0,0,0,0.75); display:none; align-items:center; justify-content:center; z-index:2000; }
    body.light .modal { background:rgba(255,255,255,0.75); }
    .modal.active { display:flex; }

    .modal-content { background:var(--card-bg); border:1px solid var(--card-border); color:var(--text); width:92%; max-width:520px; border-radius:16px; padding:28px 24px; position:relative; }

    .modal-content h2 { color:var(--text); margin-bottom:20px; }

    .close-modal { position:absolute; top:16px; right:20px; font-size:2rem; cursor:pointer; color:var(--text-secondary); }

    .profile-header { display:flex; flex-wrap:wrap; gap:24px; align-items:flex-start; margin-bottom:32px; }

    .profile-avatar { width:110px; height:110px; border-radius:50%; background:#444; background-size:cover; background-position:center; border:2px solid var(--card-border); cursor:pointer; transition:transform 0.2s; }
    .profile-avatar:hover { transform:scale(1.05); }
    body.light .profile-avatar { background:#ddd; }

    .search-input { margin-bottom:20px; }
    .user-list { display:flex; flex-direction:column; gap:12px; }
    .user-item { display:flex; align-items:center; gap:12px; padding:8px; border-radius:10px; background:var(--card-bg); border:1px solid var(--card-border); cursor:pointer; }
    .user-item:hover { background:var(--input-bg); }
    .user-item .avatar { width:50px; height:50px; }
    .user-item .name { font-weight:600; }
    .user-item .follow-btn { margin-left:auto; padding:6px 12px; font-size:0.9rem; background:var(--accent); color:white; border-radius:8px; }

    .chat-list { display:flex; flex-direction:column; gap:12px; }
    .chat-item { display:flex; align-items:center; gap:12px; padding:8px; border-radius:10px; background:var(--card-bg); border:1px solid var(--card-border); cursor:pointer; }
    .chat-item:hover { background:var(--input-bg); }

    .chat-window { display:none; flex-direction:column; height:400px; border:1px solid var(--card-border); border-radius:12px; overflow:hidden; }
    .chat-header { padding:12px; border-bottom:1px solid var(--card-border); display:flex; align-items:center; gap:8px; }
    .chat-messages { flex:1; padding:12px; overflow-y:auto; display:flex; flex-direction:column; gap:8px; }
    .message { padding:8px 12px; border-radius:10px; max-width:80%; }
    .message.sent { background:var(--accent); color:white; align-self:flex-end; }
    .message.received { background:var(--input-bg); align-self:flex-start; }
    .chat-input { display:flex; padding:12px; border-top:1px solid var(--card-border); }
    .chat-input input { flex:1; margin-right:8px; }
    .chat-input button { display:flex; align-items:center; gap:4px; }

    @media (max-width:900px) {
      .sidebar { width:100%; left:-100%; border-right:none; }
      .main-content { padding:16px; margin-top:80px; }
      .profile-header { flex-direction:column; align-items:center; text-align:center; }
    }
  </style>
</head>
<body>

<div class="top-bar">
  <div class="burger" id="burger"><span></span><span></span><span></span></div>
  <div class="site-name">FANTASYAS</div>
</div>

<nav class="sidebar" id="sidebar">
  <a data-section="home">–ì–æ–ª–æ–≤–Ω–∞</a>
  <a data-section="search">–ü–æ—à—É–∫</a>
  <a data-section="profile">–ü—Ä–æ—Ñ—ñ–ª—å</a>
  <a data-section="chats">–ß–∞—Ç–∏</a>
  <a data-section="settings">–ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è</a>
</nav>

<main class="main-content">

  <div id="home" class="section active">
    <div class="card" id="authBox">
      <div id="loginForm">
        <input type="text" id="loginNickname" placeholder="–ü—Å–µ–≤–¥–æ–Ω—ñ–º" autocomplete="off"/>
        <input type="password" id="loginPassword" placeholder="–ü–∞—Ä–æ–ª—å"/>
        <button id="loginBtn">–£–≤—ñ–π—Ç–∏</button>
        <button id="googleLoginBtn" style="background:#4285F4; color:white; margin-top:12px; width:100%; padding:12px; border:none; border-radius:10px;">–£–≤—ñ–π—Ç–∏ —á–µ—Ä–µ–∑ Google</button>
        <button id="appleLoginBtn" style="background:black; color:white; margin-top:12px; width:100%; padding:12px; border:none; border-radius:10px;">–£–≤—ñ–π—Ç–∏ —á–µ—Ä–µ–∑ Apple</button>
        <p style="margin-top:12px;">–ù–µ–º–∞—î –∞–∫–∞—É–Ω—Ç–∞? <span id="toRegister" style="color:var(--accent);cursor:pointer;">–ó–∞—Ä–µ—î—Å—Ç—Ä—É–≤–∞—Ç–∏—Å—è</span></p>
      </div>

      <div id="registerForm" style="display:none;">
        <input type="text" id="registerNickname" placeholder="–ü—Å–µ–≤–¥–æ–Ω—ñ–º" autocomplete="off"/>
        <input type="password" id="registerPassword" placeholder="–ü–∞—Ä–æ–ª—å"/>
        <button id="registerBtn">–ó–∞—Ä–µ—î—Å—Ç—Ä—É–≤–∞—Ç–∏—Å—è</button>
        <p style="margin-top:12px;">–í–∂–µ —î –∞–∫–∞—É–Ω—Ç? <span id="toLogin" style="color:var(--accent);cursor:pointer;">–£–≤—ñ–π—Ç–∏</span></p>
      </div>
    </div>

    <div class="card" id="newPostBox" style="display:none;">
      <textarea id="postText" placeholder="–©–æ —É —Ç–µ–±–µ –Ω–∞ –¥—É–º—Ü—ñ?..."></textarea>
      <input type="file" id="postMedia" accept="image/*,video/*" style="margin:12px 0; display:block;"/>
      <button id="addPost">–û–ø—É–±–ª—ñ–∫—É–≤–∞—Ç–∏</button>
    </div>

    <div class="feed" id="feed"></div>
  </div>

  <div id="search" class="section">
    <input type="text" id="searchInput" class="search-input" placeholder="–ü–æ—à—É–∫ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ–≤..."/>
    <div class="user-list" id="userList"></div>
  </div>

  <div id="profile" class="section">
    <div class="card profile-header">
      <div class="profile-avatar" id="profileAvatar"></div>
      <input type="file" id="avatarInput" accept="image/*" style="display:none;"/>
      <div style="flex:1;">
        <h2 id="profileUsernameDisplay"></h2>
        <p id="profileBio" style="margin:8px 0;color:var(--text-secondary);">–ù–µ–º–∞—î –æ–ø–∏—Å—É</p>
        <p id="profileStatus" style="margin:8px 0;color:var(--accent);">–û–Ω–ª–∞–π–Ω</p>
        <div style="display:flex;gap:20px;font-weight:600;color:var(--text-secondary);">
          <span id="postsCount">–ü–æ—Å—Ç–∏: 0</span>
          <span id="followersCount">–ü—ñ–¥–ø–∏—Å–Ω–∏–∫–∏: 0</span>
          <span id="followingCount">–ü—ñ–¥–ø–∏—Å–∫–∏: 0</span>
        </div>
      </div>
      <button id="editProfileBtn">–†–µ–¥–∞–≥—É–≤–∞—Ç–∏ –ø—Ä–æ—Ñ—ñ–ª—å</button>
    </div>
  </div>

  <div id="chats" class="section">
    <div class="chat-list" id="chatList"></div>
    <div class="chat-window" id="chatWindow" style="display:none;">
      <div class="chat-header" id="chatHeader"></div>
      <div class="chat-messages" id="chatMessages"></div>
      <div class="chat-input">
        <input type="text" id="chatText" placeholder="–ù–∞–ø–∏—à—ñ—Ç—å –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è..."/>
        <button id="sendMessage">
          <lottie-player src="https://lottie.host/4c45f979-7b26-4d5b-a930-90d4f5a1f7a6/5W9G0tXg7x.json" background="transparent" speed="1" style="width:24px; height:24px;" hover></lottie-player>
          –í—ñ–¥–ø—Ä–∞–≤–∏—Ç–∏
        </button>
      </div>
    </div>
  </div>

  <div id="settings" class="section card">
    <h2>–ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è</h2>
    <button id="toggleTheme" style="margin:16px 0;">–ü–µ—Ä–µ–º–∫–Ω—É—Ç–∏ —Ç–µ–º—É</button>
    <button id="logoutBtn" style="margin:16px 0;">–í–∏–π—Ç–∏</button>
  </div>

</main>

<div class="modal" id="editProfileModal">
  <div class="modal-content">
    <span class="close-modal" id="closeModal">√ó</span>
    <h2>–†–µ–¥–∞–≥—É–≤–∞—Ç–∏ –ø—Ä–æ—Ñ—ñ–ª—å</h2>
    <input type="text" id="editNickname" placeholder="–ü—Å–µ–≤–¥–æ–Ω—ñ–º"/>
    <textarea id="editBio" placeholder="–†–æ–∑–∫–∞–∂–∏ –ø—Ä–æ —Å–µ–±–µ..." rows="5"></textarea>
    <button id="saveProfileEdit" style="margin-top:16px;">–ó–±–µ—Ä–µ–≥—Ç–∏</button>
  </div>
</div>

<script type="module">
  // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  // Firebase SDK (–º–æ–¥—É–ª—å–Ω–∏–π, —Å–∞–º–µ —Ç–æ–π config, —â–æ —Ç–∏ —Å–∫–∏–Ω—É–≤)
  // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js";
  import {
    getAuth,
    createUserWithEmailAndPassword,
    signInWithEmailAndPassword,
    onAuthStateChanged,
    signOut,
    GoogleAuthProvider,
    OAuthProvider,
    signInWithPopup
  } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-auth.js";
  import {
    getFirestore,
    doc,
    setDoc,
    getDoc,
    getDocs,
    updateDoc,
    collection,
    addDoc,
    query,
    where,
    onSnapshot,
    orderBy,
    serverTimestamp,
    arrayUnion,
    arrayRemove
  } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore.js";
  import {
    getStorage,
    ref,
    uploadBytes,
    getDownloadURL
  } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-storage.js";

  const firebaseConfig = {
    apiKey: "AIzaSyDRzC-QDE0-UXd-XL0i3iqayFiKcc6wmvc",
    authDomain: "fantasyasapp.firebaseapp.com",
    projectId: "fantasyasapp",
    storageBucket: "fantasyasapp.firebasestorage.app",
    messagingSenderId: "721763921060",
    appId: "1:721763921060:web:3d61044ea2424e8176ca31"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);
  const storage = getStorage(app);

  let currentUser = null;
  let currentChatPartner = null;
  let unsubscribeFeed = null;
  let unsubscribeChat = null;

  // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  // Burger + sidebar
  // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  document.getElementById('burger').onclick = () => {
    document.getElementById('burger').classList.toggle('active');
    document.getElementById('sidebar').classList.toggle('active');
  };

  document.querySelectorAll('[data-section]').forEach(link => {
    link.onclick = () => {
      document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
      document.getElementById(link.dataset.section).classList.add('active');
      document.getElementById('sidebar').classList.remove('active');
      document.getElementById('burger').classList.remove('active');
      if (link.dataset.section === 'search') loadSearchUsers();
      if (link.dataset.section === 'chats') loadChatList();
      if (link.dataset.section === 'profile') loadProfile();
    };
  });

  // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  // –ü–µ—Ä–µ–º–∏–∫–∞–Ω–Ω—è —Ñ–æ—Ä–º
  // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  document.getElementById('toRegister').onclick = () => {
    document.getElementById('loginForm').style.display = 'none';
    document.getElementById('registerForm').style.display = 'block';
  };

  document.getElementById('toLogin').onclick = () => {
    document.getElementById('registerForm').style.display = 'none';
    document.getElementById('loginForm').style.display = 'block';
  };

  // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  // –†–µ—î—Å—Ç—Ä–∞—Ü—ñ—è (–ø—Å–µ–≤–¥–æ–Ω—ñ–º ‚Üí email)
  // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  document.getElementById('registerBtn').onclick = async () => {
    const nickname = document.getElementById('registerNickname').value.trim();
    const password = document.getElementById('registerPassword').value.trim();

    if (!nickname) return alert('–í–≤–µ–¥—ñ—Ç—å –ø—Å–µ–≤–¥–æ–Ω—ñ–º');
    if (password.length < 6) return alert('–ü–∞—Ä–æ–ª—å –º—ñ–Ω—ñ–º—É–º 6 —Å–∏–º–≤–æ–ª—ñ–≤');

    try {
      const safeNick = nickname.toLowerCase().replace(/[^a-z0-9]/g, '');
      const email = `${safeNick}@fantasyas.local`;

      const cred = await createUserWithEmailAndPassword(auth, email, password);
      const uid = cred.user.uid;

      await setDoc(doc(db, "users", uid), {
        nickname,
        bio: "",
        avatar: "",
        posts: [],
        followers: [],
        following: [],
        createdAt: serverTimestamp()
      });

      alert('–†–µ—î—Å—Ç—Ä–∞—Ü—ñ—è —É—Å–ø—ñ—à–Ω–∞! –£–≤—ñ–π–¥—ñ—Ç—å.');
      document.getElementById('toLogin').click();
      document.getElementById('loginNickname').value = nickname;
    } catch (e) {
      if (e.code === 'auth/email-already-in-use') alert('–¢–∞–∫–∏–π –ø—Å–µ–≤–¥–æ–Ω—ñ–º –≤–∂–µ –∑–∞–π–Ω—è—Ç–∏–π');
      else alert(e.message || '–ü–æ–º–∏–ª–∫–∞');
    }
  };

  // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  // –í—Ö—ñ–¥ (–ø—Å–µ–≤–¥–æ–Ω—ñ–º + –ø–∞—Ä–æ–ª—å)
  // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  document.getElementById('loginBtn').onclick = async () => {
    const nickname = document.getElementById('loginNickname').value.trim();
    const password = document.getElementById('loginPassword').value.trim();

    if (!nickname || !password) return alert('–ó–∞–ø–æ–≤–Ω—ñ—Ç—å –ø–æ–ª—è');

    try {
      const safeNick = nickname.toLowerCase().replace(/[^a-z0-9]/g, '');
      const email = `${safeNick}@fantasyas.local`;

      await signInWithEmailAndPassword(auth, email, password);
    } catch (e) {
      alert('–ù–µ–≤—ñ—Ä–Ω–∏–π –ø—Å–µ–≤–¥–æ–Ω—ñ–º –∞–±–æ –ø–∞—Ä–æ–ª—å');
    }
  };

  // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  // Google Login
  // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  document.getElementById('googleLoginBtn').onclick = async () => {
    const provider = new GoogleAuthProvider();
    try {
      const result = await signInWithPopup(auth, provider);
      const user = result.user;

      const userDoc = await getDoc(doc(db, "users", user.uid));
      if (!userDoc.exists()) {
        await setDoc(doc(db, "users", user.uid), {
          nickname: user.displayName || user.email.split('@')[0],
          bio: "",
          avatar: user.photoURL || "",
          posts: [],
          followers: [],
          following: [],
          createdAt: serverTimestamp()
        });
      }
    } catch (e) {
      alert('–ü–æ–º–∏–ª–∫–∞ Google: ' + e.message);
    }
  };

  // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  // Apple Login
  // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  document.getElementById('appleLoginBtn').onclick = async () => {
    const provider = new OAuthProvider('apple.com');
    provider.addScope('email name');
    try {
      const result = await signInWithPopup(auth, provider);
      const user = result.user;

      const userDoc = await getDoc(doc(db, "users", user.uid));
      if (!userDoc.exists()) {
        await setDoc(doc(db, "users", user.uid), {
          nickname: user.displayName || user.email.split('@')[0],
          bio: "",
          avatar: user.photoURL || "",
          posts: [],
          followers: [],
          following: [],
          createdAt: serverTimestamp()
        });
      }
    } catch (e) {
      alert('–ü–æ–º–∏–ª–∫–∞ Apple: ' + e.message);
    }
  };

  // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  // –°–ª—É—Ö–∞—á –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü—ñ—ó
  // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  onAuthStateChanged(auth, async (user) => {
    if (user) {
      currentUser = user;
      document.getElementById('authBox').style.display = 'none';
      document.getElementById('newPostBox').style.display = 'block';

      subscribeToFeed();
      loadProfile();
    } else {
      currentUser = null;
      document.getElementById('authBox').style.display = 'block';
      document.getElementById('newPostBox').style.display = 'none';
      if (unsubscribeFeed) unsubscribeFeed();
    }
  });

  // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  // –ü—É–±–ª—ñ–∫–∞—Ü—ñ—è –ø–æ—Å—Ç–∞ –∑ –º–µ–¥—ñ–∞
  // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  document.getElementById('addPost').onclick = async () => {
    if (!currentUser) return alert('–°–ø–æ—á–∞—Ç–∫—É —É–≤—ñ–π–¥—ñ—Ç—å');

    const text = document.getElementById('postText').value.trim();
    const file = document.getElementById('postMedia').files[0];

    if (!text && !file) return alert('–î–æ–¥–∞–π—Ç–µ —Ç–µ–∫—Å—Ç –∞–±–æ –º–µ–¥—ñ–∞');

    try {
      let mediaUrl = '';
      if (file) {
        const storageRef = ref(storage, `posts/${currentUser.uid}/${Date.now()}_${file.name}`);
        await uploadBytes(storageRef, file);
        mediaUrl = await getDownloadURL(storageRef);
      }

      const postRef = await addDoc(collection(db, "posts"), {
        author: currentUser.uid,
        text,
        mediaUrl,
        mediaType: file ? file.type.split('/')[0] : '',
        createdAt: serverTimestamp(),
        likes: [],
        comments: []
      });

      await updateDoc(doc(db, "users", currentUser.uid), {
        posts: arrayUnion(postRef.id)
      });

      document.getElementById('postText').value = '';
      document.getElementById('postMedia').value = '';
      alert('–ü–æ—Å—Ç –æ–ø—É–±–ª—ñ–∫–æ–≤–∞–Ω–æ!');
    } catch (e) {
      alert('–ü–æ–º–∏–ª–∫–∞: ' + e.message);
    }
  };

  // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  // –°—Ç—Ä—ñ—á–∫–∞ –ø–æ—Å—Ç—ñ–≤
  // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  function subscribeToFeed() {
    if (unsubscribeFeed) unsubscribeFeed();

    const q = query(collection(db, "posts"), orderBy("createdAt", "desc"));
    unsubscribeFeed = onSnapshot(q, async (snapshot) => {
      const feed = document.getElementById('feed');
      feed.innerHTML = '';
      let delay = 0;

      for (const docSnap of snapshot.docs) {
        const post = docSnap.data();
        const authorSnap = await getDoc(doc(db, "users", post.author));
        const author = authorSnap.exists() ? authorSnap.data() : { nickname: '–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á' };
        const id = docSnap.id;
        const isOwn = post.author === currentUser?.uid;
        const liked = post.likes?.includes(currentUser?.uid) || false;

        const postEl = document.createElement('div');
        postEl.className = 'post';
        postEl.innerHTML = `
          <div class="post-header">
            <div class="avatar" style="background-image:url(${author.avatar || ''})"></div>
            <div class="username">@${author.nickname}</div>
            ${isOwn ? `<button class="menu-btn" data-post-id="${id}">‚ãØ</button>` : ''}
          </div>
          <div class="post-content">${post.text.replace(/\n/g, '<br>')}</div>
          ${post.mediaUrl ? `
            ${post.mediaType === 'image' ? `<img src="${post.mediaUrl}" class="post-media">` : 
              `<video src="${post.mediaUrl}" controls class="post-media"></video>`}
          ` : ''}
          <div class="post-footer">
            <button class="like-btn ${liked ? 'liked' : ''}" data-post-id="${id}">
              <lottie-player id="like-player-${id}" src="https://lottie.host/4c45f979-7b26-4d5b-a930-90d4f5a1f7a6/5W9G0tXg7x.json" background="transparent" speed="1" style="width:24px; height:24px;"></lottie-player>
              ${post.likes?.length || 0}
            </button>
            <button>üí¨ ${post.comments?.length || 0}</button>
            <button>üîó –ü–æ–¥—ñ–ª–∏—Ç–∏—Å—è</button>
            <button>üòÄ –ï–º–æ–¥–∂—ñ</button>
          </div>
        `;

        feed.appendChild(postEl);
        setTimeout(() => postEl.classList.add('show'), delay);
        delay += 80;
      }
    });
  }

  // Event delegation for likes and menu
  document.getElementById('feed').addEventListener('click', async (e) => {
    if (e.target.closest('.like-btn')) {
      const btn = e.target.closest('.like-btn');
      const postId = btn.dataset.postId;
      const player = document.getElementById(`like-player-${postId}`);
      player.play();
      btn.classList.add('pulsed');
      setTimeout(() => btn.classList.remove('pulsed'), 500);
      await toggleLike(postId);
    } else if (e.target.closest('.menu-btn')) {
      const postId = e.target.closest('.menu-btn').dataset.postId;
      if (confirm('–í–∏–¥–∞–ª–∏—Ç–∏ –ø–æ—Å—Ç?')) {
        await deleteDoc(doc(db, "posts", postId));
        await updateDoc(doc(db, "users", currentUser.uid), { posts: arrayRemove(postId) });
      }
    }
  });

  async function toggleLike(postId) {
    const postRef = doc(db, "posts", postId);
    const snap = await getDoc(postRef);
    const likes = snap.data().likes || [];
    if (likes.includes(currentUser.uid)) {
      await updateDoc(postRef, { likes: arrayRemove(currentUser.uid) });
    } else {
      await updateDoc(postRef, { likes: arrayUnion(currentUser.uid) });
    }
  }

  // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  // –ü—Ä–æ—Ñ—ñ–ª—å —Ç–∞ –∞–≤–∞—Ç–∞—Ä
  // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  document.getElementById('profileAvatar').onclick = () => {
    if (!currentUser) return alert('–£–≤—ñ–π–¥—ñ—Ç—å');
    document.getElementById('avatarInput').click();
  };

  document.getElementById('avatarInput').onchange = async (e) => {
    const file = e.target.files[0];
    if (!file) return;

    try {
      const storageRef = ref(storage, `avatars/${currentUser.uid}`);
      await uploadBytes(storageRef, file);
      const url = await getDownloadURL(storageRef);

      await updateDoc(doc(db, "users", currentUser.uid), { avatar: url });
      document.getElementById('profileAvatar').style.backgroundImage = `url(${url})`;
    } catch (err) {
      alert('–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è');
    }
  };

  async function loadProfile() {
    if (!currentUser) return;
    const userRef = doc(db, "users", currentUser.uid);
    const snap = await getDoc(userRef);
    if (snap.exists()) {
      const data = snap.data();
      document.getElementById('profileUsernameDisplay').textContent = data.nickname;
      document.getElementById('profileBio').textContent = data.bio || '–ù–µ–º–∞—î –æ–ø–∏—Å—É';
      document.getElementById('profileAvatar').style.backgroundImage = `url(${data.avatar || ''})`;
      document.getElementById('postsCount').textContent = `–ü–æ—Å—Ç–∏: ${data.posts?.length || 0}`;
      document.getElementById('followersCount').textContent = `–ü—ñ–¥–ø–∏—Å–Ω–∏–∫–∏: ${data.followers?.length || 0}`;
      document.getElementById('followingCount').textContent = `–ü—ñ–¥–ø–∏—Å–∫–∏: ${data.following?.length || 0}`;
    }
  }

  // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  // –ü–æ—à—É–∫ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ–≤
  // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  function debounce(fn, ms) {
    let t;
    return () => {
      clearTimeout(t);
      t = setTimeout(fn, ms);
    };
  }

  async function loadSearchUsers() {
    const input = document.getElementById('searchInput');
    const userList = document.getElementById('userList');

    const myRef = doc(db, "users", currentUser.uid);
    const mySnap = await getDoc(myRef);
    const myFollowing = mySnap.data().following || [];

    input.oninput = debounce(async () => {
      const val = input.value.trim().toLowerCase();
      if (!val) {
        userList.innerHTML = '';
        return;
      }

      const q = query(collection(db, "users"), where("nickname", ">=", val), where("nickname", "<=", val + '\uf8ff'));
      const snap = await getDocs(q);
      userList.innerHTML = '';

      snap.forEach((docSnap) => {
        if (docSnap.id === currentUser.uid) return;
        const data = docSnap.data();
        const isFollowing = myFollowing.includes(docSnap.id);
        const item = document.createElement('div');
        item.className = 'user-item';
        item.innerHTML = `
          <div class="avatar" style="background-image:url(${data.avatar || ''})"></div>
          <div class="name">@${data.nickname}</div>
          <button class="follow-btn">${isFollowing ? '–í—ñ–¥–ø–∏—Å–∞—Ç–∏—Å—è' : '–ü—ñ–¥–ø–∏—Å–∞—Ç–∏—Å—è'}</button>
        `;
        item.querySelector('.follow-btn').onclick = async () => {
          await toggleFollow(docSnap.id);
          loadSearchUsers();
        };
        item.onclick = () => openChat(data.nickname, docSnap.id);
        userList.appendChild(item);
      });
    }, 300);
  }

  async function toggleFollow(targetUid) {
    const myRef = doc(db, "users", currentUser.uid);
    const targetRef = doc(db, "users", targetUid);

    const mySnap = await getDoc(myRef);
    const following = mySnap.data().following || [];

    if (following.includes(targetUid)) {
      await updateDoc(myRef, { following: arrayRemove(targetUid) });
      await updateDoc(targetRef, { followers: arrayRemove(currentUser.uid) });
    } else {
      await updateDoc(myRef, { following: arrayUnion(targetUid) });
      await updateDoc(targetRef, { followers: arrayUnion(currentUser.uid) });
    }
  }

  // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  // –ß–∞—Ç–∏ (1-–Ω–∞-1)
  // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  function getChatId(uid1, uid2) {
    return [uid1, uid2].sort().join('_');
  }

  async function loadChatList() {
    const chatList = document.getElementById('chatList');
    chatList.innerHTML = '';

    // –ü—Ä–∏–∫–ª–∞–¥: –ø–æ–∫–∞–∑—É—î–º–æ –≤—Å—ñ—Ö –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ–≤ (–º–æ–∂–Ω–∞ –æ–ø—Ç–∏–º—ñ–∑—É–≤–∞—Ç–∏)
    const q = query(collection(db, "users"));
    onSnapshot(q, snapshot => {
      chatList.innerHTML = '';
      snapshot.forEach(docSnap => {
        if (docSnap.id === currentUser.uid) return;
        const data = docSnap.data();
        const item = document.createElement('div');
        item.className = 'chat-item';
        item.innerHTML = `
          <div class="avatar" style="background-image:url(${data.avatar || ''})"></div>
          <div><div class="name">@${data.nickname}</div></div>
        `;
        item.onclick = () => openChat(data.nickname, docSnap.id);
        chatList.appendChild(item);
      });
    });
  }

  function openChat(name, uid) {
    currentChatPartner = uid;
    document.getElementById('chatWindow').style.display = 'flex';
    document.getElementById('chatHeader').innerHTML = `<div class="name">@${name}</div>`;
    subscribeToChat(uid);
  }

  function subscribeToChat(otherUid) {
    if (unsubscribeChat) unsubscribeChat();

    const chatId = getChatId(currentUser.uid, otherUid);
    const q = query(collection(db, `messages/${chatId}/chat`), orderBy("createdAt"));

    unsubscribeChat = onSnapshot(q, snap => {
      const messages = document.getElementById('chatMessages');
      messages.innerHTML = '';
      snap.forEach(m => {
        const msg = m.data();
        const div = document.createElement('div');
        div.className = `message ${msg.from === currentUser.uid ? 'sent' : 'received'}`;
        div.textContent = msg.text;
        messages.appendChild(div);
      });
      messages.scrollTop = messages.scrollHeight;
    });
  }

  document.getElementById('sendMessage').onclick = async () => {
    const text = document.getElementById('chatText').value.trim();
    if (!text || !currentChatPartner) return;

    const chatId = getChatId(currentUser.uid, currentChatPartner);
    await addDoc(collection(db, `messages/${chatId}/chat`), {
      from: currentUser.uid,
      text,
      createdAt: serverTimestamp()
    });
    document.getElementById('chatText').value = '';
  };

  // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  // –Ü–Ω—à—ñ —Ñ—É–Ω–∫—Ü—ñ—ó (—Ç–µ–º–∞, –≤–∏—Ö—ñ–¥, —Ä–µ–¥–∞–≥—É–≤–∞–Ω–Ω—è –±—ñ–æ)
  // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  document.getElementById('toggleTheme').onclick = () => {
    document.body.classList.toggle('light');
    localStorage.setItem('theme', document.body.classList.contains('light') ? 'light' : 'dark');
  };

  if (localStorage.getItem('theme') === 'light') document.body.classList.add('light');

  document.getElementById('logoutBtn').onclick = () => signOut(auth);

  // –†–µ–¥–∞–≥—É–≤–∞–Ω–Ω—è –ø—Ä–æ—Ñ—ñ–ª—é (–±—ñ–æ + —ñ–º'—è)
  document.getElementById('editProfileBtn').onclick = () => {
    document.getElementById('editNickname').value = document.getElementById('profileUsernameDisplay').textContent;
    document.getElementById('editBio').value = document.getElementById('profileBio').textContent !== '–ù–µ–º–∞—î –æ–ø–∏—Å—É' ? document.getElementById('profileBio').textContent : '';
    document.getElementById('editProfileModal').classList.add('active');
  };
  document.getElementById('closeModal').onclick = () => document.getElementById('editProfileModal').classList.remove('active');

  document.getElementById('saveProfileEdit').onclick = async () => {
    const nickname = document.getElementById('editNickname').value.trim();
    const bio = document.getElementById('editBio').value.trim();
    if (!nickname) return alert('–ü—Å–µ–≤–¥–æ–Ω—ñ–º –Ω–µ –º–æ–∂–µ –±—É—Ç–∏ –ø–æ—Ä–æ–∂–Ω—ñ–º');
    await updateDoc(doc(db, "users", currentUser.uid), { nickname, bio });
    loadProfile();
    document.getElementById('editProfileModal').classList.remove('active');
  };

</script>
</body>
</html>

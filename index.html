<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
  <title>FANTASYAS Â· TV Edition</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet"/>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Inter', sans-serif;
      -webkit-tap-highlight-color: transparent;
    }

    body {
      --bg: #ffffff;
      --surface: #f5f5f5;
      --card: #ffffff;
      --border: #e0e0e0;
      --text-primary: #000000;
      --text-secondary: #333333;
      --text-tertiary: #666666;
      --accent: #000000;
      --accent-hover: #333333;
      --danger: #ff0000;
      --success: #00aa00;
      --like: #ff3040;
      --save: #fbbf24;
      --shadow-lg: 0 8px 24px rgba(0,0,0,0.12);
      --sidebar-width: 240px;
      --header-height: 64px;
      --radius-md: 12px;
      --radius-lg: 16px;
    }

    body.dark-theme {
      --bg: #000000;
      --surface: #1a1a1a;
      --card: #222222;
      --border: #333333;
      --text-primary: #ffffff;
      --text-secondary: #cccccc;
      --text-tertiary: #999999;
      --accent: #ffffff;
      --accent-hover: #cccccc;
      --danger: #ff4444;
      --success: #4caf50;
      --like: #ff6b7c;
      --save: #fcd34d;
    }

    body {
      background: var(--bg);
      color: var(--text-primary);
      min-height: 100vh;
      font-size: 18px; /* Ğ—Ğ±Ñ–Ğ»ÑŒÑˆĞµĞ½Ğ¾ Ğ´Ğ»Ñ TV */
      line-height: 1.5;
    }

    .app {
      display: flex;
      height: 100vh;
      overflow: hidden;
    }

    /* Ğ‘Ğ¾ĞºĞ¾Ğ²Ğµ Ğ¼ĞµĞ½Ñ */
    .sidebar {
      width: var(--sidebar-width);
      background: var(--card);
      border-right: 1px solid var(--border);
      display: flex;
      flex-direction: column;
      padding: 20px 0;
      position: fixed;
      left: 0;
      top: 0;
      bottom: 0;
      transform: translateX(-100%);
      transition: transform 0.3s ease;
      z-index: 1000;
      box-shadow: var(--shadow-lg);
    }

    .sidebar.open {
      transform: translateX(0);
    }

    .sidebar-backdrop {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.7);
      z-index: 999;
    }

    .sidebar-backdrop.active {
      display: block;
    }

    .sidebar-header {
      padding: 0 20px 20px;
      border-bottom: 1px solid var(--border);
    }

    .logo {
      font-size: 2rem;
      font-weight: 700;
      color: var(--text-primary);
    }

    .nav {
      flex: 1;
      display: flex;
      flex-direction: column;
      padding: 20px 0;
    }

    .nav-item {
      display: flex;
      align-items: center;
      gap: 16px;
      padding: 16px 20px;
      margin: 4px 12px;
      border-radius: var(--radius-md);
      color: var(--text-secondary);
      cursor: pointer;
      font-weight: 500;
      font-size: 1.1rem;
    }

    .nav-item.active {
      background: var(--accent);
      color: var(--bg);
    }

    .nav-item .icon {
      width: 24px;
      height: 24px;
      stroke: currentColor;
      stroke-width: 1.8;
      fill: none;
    }

    .nav-item .badge {
      margin-left: auto;
      background: var(--accent);
      color: var(--bg);
      padding: 4px 12px;
      border-radius: 40px;
      font-size: 0.9rem;
    }

    .sidebar-footer {
      border-top: 1px solid var(--border);
      padding-top: 16px;
    }

    /* ĞÑĞ½Ğ¾Ğ²Ğ½Ğ¸Ğ¹ ĞºĞ¾Ğ½Ñ‚ĞµĞ½Ñ‚ */
    .main {
      flex: 1;
      display: flex;
      flex-direction: column;
      overflow: hidden;
      background: var(--bg);
      width: 100%;
    }

    .top-bar {
      height: var(--header-height);
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      padding: 0 24px;
      gap: 16px;
      background: var(--bg);
    }

    .menu-toggle {
      display: flex;
      width: 48px;
      height: 36px;
      flex-direction: column;
      justify-content: space-between;
      cursor: pointer;
      padding: 8px 0;
    }

    .menu-toggle span {
      height: 3px;
      width: 100%;
      background: var(--text-primary);
      border-radius: 3px;
      transition: transform 0.3s, opacity 0.2s;
    }

    .menu-toggle.active span:nth-child(1) { transform: rotate(45deg) translate(10px, 10px); }
    .menu-toggle.active span:nth-child(2) { opacity: 0; }
    .menu-toggle.active span:nth-child(3) { transform: rotate(-45deg) translate(10px, -10px); }

    .top-bar-title {
      font-size: 1.8rem;
      font-weight: 600;
      color: var(--text-primary);
    }

    .content {
      flex: 1;
      overflow-y: auto;
      padding: 24px;
    }

    .section {
      display: none;
    }

    .section.active {
      display: block;
    }

    /* ========== Ğ¦Ğ•ĞĞ¢Ğ ĞĞ’ĞĞĞ˜Ğ™ Ğ•ĞœĞĞ”Ğ–Ğ†-ĞŸĞ†ĞšĞ•Ğ  ========== */
    .emoji-picker-container {
      position: relative;
      display: inline-block;
    }

    .emoji-button {
      background: none;
      border: none;
      font-size: 3rem; /* Ğ’ĞµĞ»Ğ¸ĞºĞ¸Ğ¹ Ğ´Ğ»Ñ TV */
      cursor: pointer;
      padding: 12px;
      color: var(--text-primary);
      min-width: 70px;
      min-height: 70px;
      border-radius: 50%;
      transition: background 0.2s;
    }

    .emoji-button:hover {
      background: var(--surface);
    }

    /* Ğ—Ğ°Ñ‚ĞµĞ¼Ğ½ĞµĞ½Ğ¸Ğ¹ Ñ„Ğ¾Ğ½ Ğ´Ğ»Ñ Ğ¼Ğ¾Ğ´Ğ°Ğ»ÑŒĞ½Ğ¾Ğ³Ğ¾ Ğ²Ñ–ĞºĞ½Ğ° */
    .emoji-modal-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.8);
      backdrop-filter: blur(4px);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 3000;
    }

    .emoji-modal-backdrop.active {
      display: flex;
    }

    /* Ğ¦ĞµĞ½Ñ‚Ñ€Ğ¾Ğ²Ğ°Ğ½Ğµ Ğ¼Ğ¾Ğ´Ğ°Ğ»ÑŒĞ½Ğµ Ğ²Ñ–ĞºĞ½Ğ¾ Ğ· ĞµĞ¼Ğ¾Ğ´Ğ·Ñ– */
    .emoji-modal {
      background: var(--card);
      border: 2px solid var(--border);
      border-radius: 32px;
      width: 90%;
      max-width: 800px;
      max-height: 80vh;
      padding: 24px;
      display: flex;
      flex-direction: column;
      box-shadow: var(--shadow-lg);
    }

    .emoji-modal .emoji-search {
      width: 100%;
      padding: 16px 20px;
      border: 2px solid var(--border);
      border-radius: 60px;
      background: var(--surface);
      color: var(--text-primary);
      margin-bottom: 20px;
      font-size: 1.5rem;
    }

    .emoji-modal .emoji-categories {
      display: flex;
      gap: 12px;
      overflow-x: auto;
      padding-bottom: 16px;
      margin-bottom: 16px;
      border-bottom: 2px solid var(--border);
    }

    .emoji-modal .emoji-category {
      padding: 12px 24px;
      background: var(--surface);
      border-radius: 60px;
      font-size: 2rem;
      cursor: pointer;
      white-space: nowrap;
      color: var(--text-secondary);
      border: 2px solid transparent;
    }

    .emoji-modal .emoji-category.active {
      background: var(--accent);
      color: var(--bg);
      border-color: var(--accent);
    }

    .emoji-modal .emoji-grid {
      display: grid;
      grid-template-columns: repeat(8, 1fr);
      gap: 12px;
      overflow-y: auto;
      padding: 8px 0;
      max-height: 400px;
    }

    .emoji-modal .emoji-grid span {
      font-size: 3rem;
      text-align: center;
      cursor: pointer;
      padding: 12px;
      border-radius: 16px;
      transition: background 0.2s, transform 0.1s;
    }

    .emoji-modal .emoji-grid span:hover,
    .emoji-modal .emoji-grid span:focus {
      background: var(--surface);
      transform: scale(1.2);
      outline: 3px solid var(--accent);
    }

    /* Ğ†Ğ½ÑˆÑ– ÑÑ‚Ğ¸Ğ»Ñ– */
    .card {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 24px;
      padding: 24px;
      margin-bottom: 24px;
    }

    .input {
      width: 100%;
      padding: 18px 24px;
      border-radius: 40px;
      border: 1px solid var(--border);
      background: var(--surface);
      color: var(--text-primary);
      font-size: 1.2rem;
      outline: none;
    }

    textarea.input {
      resize: vertical;
      min-height: 100px;
    }

    .btn {
      padding: 16px 32px;
      border-radius: 40px;
      background: var(--surface);
      border: 1px solid var(--border);
      color: var(--text-primary);
      font-weight: 500;
      cursor: pointer;
      font-size: 1.2rem;
      min-height: 60px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }

    .btn-primary {
      background: var(--accent);
      color: var(--bg);
      border-color: var(--accent);
    }

    .btn-primary:hover {
      background: var(--accent-hover);
    }

    .btn-icon {
      padding: 16px;
      min-width: 60px;
    }

    .avatar {
      width: 70px;
      height: 70px;
      border-radius: 50%;
      background: var(--surface);
      background-size: cover;
      background-position: center;
      border: 2px solid var(--border);
      flex-shrink: 0;
    }

    .avatar.small {
      width: 60px;
      height: 60px;
    }

    .avatar.large {
      width: 100px;
      height: 100px;
    }

    .online-indicator {
      width: 14px;
      height: 14px;
      background: var(--success);
      border-radius: 50%;
      display: inline-block;
      margin-left: 8px;
    }

    /* Ğ§Ğ°Ñ‚Ğ¸ */
    .chat-item {
      display: flex;
      align-items: center;
      gap: 20px;
      padding: 20px;
      border-radius: 24px;
      background: var(--card);
      border: 1px solid var(--border);
      cursor: pointer;
      margin-bottom: 12px;
      transition: background 0.2s;
    }

    .chat-item:hover {
      background: var(--surface);
    }

    .chat-item.unread {
      border-left: 6px solid var(--accent);
    }

    .chat-info {
      flex: 1;
    }

    .chat-name {
      font-weight: 600;
      font-size: 1.3rem;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .chat-last {
      color: var(--text-tertiary);
      font-size: 1.1rem;
      margin-top: 4px;
    }

    .chat-time {
      color: var(--text-tertiary);
      font-size: 1rem;
    }

    .chat-badge {
      background: var(--accent);
      color: var(--bg);
      border-radius: 50%;
      min-width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.1rem;
      font-weight: 600;
    }

    .chat-window {
      display: flex;
      flex-direction: column;
      height: 100%;
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 24px;
      overflow: hidden;
    }

    .chat-header {
      padding: 20px;
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      gap: 16px;
      background: var(--surface);
    }

    .chat-messages {
      flex: 1;
      padding: 20px;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .message-wrapper {
      display: flex;
      flex-direction: column;
    }

    .message-wrapper.sent {
      align-items: flex-end;
    }

    .message-wrapper.received {
      align-items: flex-start;
    }

    .message-bubble {
      max-width: 70%;
      padding: 16px 20px;
      border-radius: 24px;
      background: var(--surface);
      color: var(--text-primary);
      border: 1px solid var(--border);
      font-size: 1.1rem;
    }

    .message-bubble.sent {
      background: var(--accent);
      color: var(--bg);
      border-color: var(--accent);
    }

    .message-time {
      font-size: 0.9rem;
      color: var(--text-tertiary);
      margin-top: 4px;
      text-align: right;
    }

    .chat-input-area {
      display: flex;
      padding: 16px;
      border-top: 1px solid var(--border);
      gap: 12px;
      background: var(--surface);
      align-items: center;
    }

    .chat-input-area input {
      flex: 1;
      padding: 16px 20px;
      border: 1px solid var(--border);
      border-radius: 40px;
      background: var(--bg);
      color: var(--text-primary);
      font-size: 1.2rem;
    }

    /* ĞŸĞ¾ÑÑ‚Ğ¸ */
    .post {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 24px;
      padding: 24px;
      margin-bottom: 20px;
    }

    .post-header {
      display: flex;
      gap: 16px;
      margin-bottom: 16px;
      align-items: center;
    }

    .post-author {
      font-weight: 600;
      font-size: 1.3rem;
    }

    .post-time {
      color: var(--text-tertiary);
      font-size: 1rem;
    }

    .post-content {
      font-size: 1.2rem;
      margin-bottom: 16px;
      white-space: pre-wrap;
    }

    .post-footer {
      display: flex;
      gap: 20px;
      padding-top: 16px;
      border-top: 1px solid var(--border);
    }

    .post-footer button {
      background: none;
      border: none;
      display: flex;
      align-items: center;
      gap: 8px;
      color: var(--text-secondary);
      font-size: 1.2rem;
      cursor: pointer;
    }

    .post-footer button.liked {
      color: var(--like);
    }

    .post-footer button.saved {
      color: var(--save);
    }

    /* ĞŸÑ€Ğ¾Ñ„Ñ–Ğ»ÑŒ */
    .profile-header {
      display: flex;
      gap: 24px;
      margin-bottom: 24px;
      align-items: center;
      flex-wrap: wrap;
    }

    .profile-stats {
      display: flex;
      gap: 24px;
      margin: 16px 0;
      font-size: 1.2rem;
    }

    .profile-tabs {
      display: flex;
      gap: 12px;
      border-bottom: 2px solid var(--border);
      padding-bottom: 12px;
      margin-bottom: 24px;
    }

    .profile-tab {
      padding: 12px 24px;
      border-radius: 40px;
      cursor: pointer;
      font-size: 1.2rem;
      color: var(--text-secondary);
    }

    .profile-tab.active {
      background: var(--accent);
      color: var(--bg);
    }

    /* ĞšĞ¾Ğ¼ĞµĞ½Ñ‚Ğ°Ñ€Ñ– */
    .comments-section {
      margin-top: 20px;
      border-top: 1px solid var(--border);
      padding-top: 20px;
    }

    .comment {
      margin-bottom: 20px;
    }

    .comment-main {
      display: flex;
      gap: 12px;
    }

    .comment-avatar {
      width: 50px;
      height: 50px;
      border-radius: 50%;
      background-size: cover;
      background-position: center;
      border: 1px solid var(--border);
    }

    .comment-content {
      flex: 1;
      background: var(--surface);
      padding: 12px 16px;
      border-radius: 20px;
    }

    .comment-author {
      font-weight: 600;
      font-size: 1.1rem;
    }

    .comment-text {
      font-size: 1.1rem;
      margin-top: 4px;
    }

    .comment-time {
      font-size: 0.9rem;
      color: var(--text-tertiary);
      margin-top: 4px;
    }

    .comment-actions {
      display: flex;
      gap: 16px;
      margin-top: 8px;
      margin-left: 62px;
    }

    .comment-actions button {
      background: none;
      border: none;
      color: var(--text-tertiary);
      font-size: 1rem;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .reply-form {
      display: flex;
      gap: 8px;
      margin-top: 12px;
      margin-left: 62px;
    }

    .reply-input {
      flex: 1;
      padding: 12px 16px;
      border-radius: 30px;
      border: 1px solid var(--border);
      background: var(--surface);
      color: var(--text-primary);
      font-size: 1rem;
    }

    .replies {
      margin-left: 62px;
      margin-top: 12px;
      border-left: 2px solid var(--border);
      padding-left: 16px;
    }

    /* ĞœĞ¾Ğ´Ğ°Ğ»ÑŒĞ½Ñ– Ğ²Ñ–ĞºĞ½Ğ° */
    .modal {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.8);
      backdrop-filter: blur(4px);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 2000;
      padding: 20px;
    }

    .modal.active {
      display: flex;
    }

    .modal-content {
      background: var(--card);
      border-radius: 32px;
      padding: 24px;
      max-width: 500px;
      width: 100%;
      max-height: 80vh;
      overflow-y: auto;
      border: 1px solid var(--border);
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }

    .modal-close {
      font-size: 2.5rem;
      cursor: pointer;
      color: var(--text-secondary);
    }

    /* Ğ¡Ğ¿Ğ¾Ğ²Ñ–Ñ‰ĞµĞ½Ğ½Ñ */
    #toast {
      position: fixed;
      bottom: 20px;
      left: 20px;
      right: 20px;
      background: var(--accent);
      color: var(--bg);
      padding: 16px 24px;
      border-radius: 60px;
      font-weight: 500;
      text-align: center;
      z-index: 3000;
      opacity: 0;
      transition: opacity 0.3s;
      pointer-events: none;
      font-size: 1.2rem;
    }

    #toast.show {
      opacity: 1;
    }

    .skeleton {
      background: linear-gradient(90deg, var(--surface) 25%, var(--border) 50%, var(--surface) 75%);
      background-size: 200% 100%;
      animation: skeleton-loading 1.5s infinite;
      border-radius: var(--radius-md);
      height: 100px;
    }

    @keyframes skeleton-loading {
      0% { background-position: 200% 0; }
      100% { background-position: -200% 0; }
    }

    @media (max-width: 768px) {
      body { font-size: 16px; }
      .sidebar { width: 100%; max-width: 300px; }
      .emoji-modal { width: 95%; padding: 16px; }
      .emoji-modal .emoji-grid { grid-template-columns: repeat(6, 1fr); }
      .emoji-modal .emoji-grid span { font-size: 2.5rem; }
    }
  </style>
</head>
<body>
<div class="app">
  <div class="sidebar-backdrop" id="sidebarBackdrop"></div>
  <aside class="sidebar" id="sidebar">
    <div class="sidebar-header">
      <div class="logo">FANTASYAS</div>
    </div>
    <nav class="nav">
      <div class="nav-item active" data-section="home">
        <svg class="icon" viewBox="0 0 24 24"><path d="M3 10l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>
        <span>Ğ“Ğ¾Ğ»Ğ¾Ğ²Ğ½Ğ°</span>
      </div>
      <div class="nav-item" data-section="search">
        <svg class="icon" viewBox="0 0 24 24"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>
        <span>ĞŸĞ¾ÑˆÑƒĞº</span>
      </div>
      <div class="nav-item" data-section="hashtags">
        <svg class="icon" viewBox="0 0 24 24"><path d="M4 9h16M4 15h16M10 3L8 21M16 3l-2 21"/></svg>
        <span>Ğ¥ĞµÑˆÑ‚ĞµĞ³Ğ¸</span>
      </div>
      <div class="nav-item" data-section="profile">
        <svg class="icon" viewBox="0 0 24 24"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
        <span>ĞŸÑ€Ğ¾Ñ„Ñ–Ğ»ÑŒ</span>
      </div>
      <div class="nav-item" data-section="chats">
        <svg class="icon" viewBox="0 0 24 24"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>
        <span>Ğ§Ğ°Ñ‚Ğ¸</span>
        <span class="badge" id="unreadBadge" style="display:none;">0</span>
      </div>
    </nav>
    <div class="sidebar-footer">
      <div class="nav-item" data-section="settings">
        <svg class="icon" viewBox="0 0 24 24"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H5.78a1.65 1.65 0 0 0-1.51 1 1.65 1.65 0 0 0 .33 1.82l.07.07A10 10 0 0 0 12 17.66a10 10 0 0 0 6.26-2.26z"/></svg>
        <span>ĞĞ°Ğ»Ğ°ÑˆÑ‚ÑƒĞ²Ğ°Ğ½Ğ½Ñ</span>
      </div>
    </div>
  </aside>

  <main class="main">
    <div class="top-bar">
      <div class="menu-toggle" id="menuToggle">
        <span></span><span></span><span></span>
      </div>
      <div class="top-bar-title" id="pageTitle">Ğ“Ğ¾Ğ»Ğ¾Ğ²Ğ½Ğ°</div>
    </div>

    <div class="content" id="content">
      <!-- Ğ“Ğ¾Ğ»Ğ¾Ğ²Ğ½Ğ° -->
      <div id="home" class="section active">
        <div class="card" id="authBox">
          <div id="loginForm">
            <input type="text" id="loginNickname" class="input" placeholder="ĞŸÑĞµĞ²Ğ´Ğ¾Ğ½Ñ–Ğ¼ (Ğ±ĞµĞ· @)" autocomplete="off">
            <input type="password" id="loginPassword" class="input" placeholder="ĞŸĞ°Ñ€Ğ¾Ğ»ÑŒ">
            <button class="btn btn-primary" id="loginBtn" style="width:100%; margin-top:16px;">Ğ£Ğ²Ñ–Ğ¹Ñ‚Ğ¸</button>
            <div style="display:flex; gap:12px; margin-top:16px;">
              <button class="btn" id="googleLoginBtn" style="flex:1;">Google</button>
              <button class="btn" id="appleLoginBtn" style="flex:1;">Apple</button>
            </div>
            <p style="margin-top:20px;"><span>ĞĞµĞ¼Ğ°Ñ” Ğ°ĞºĞ°ÑƒĞ½Ñ‚Ğ°?</span> <span id="toRegister" style="color:var(--text-primary);cursor:pointer;">Ğ—Ğ°Ñ€ĞµÑ”ÑÑ‚Ñ€ÑƒĞ²Ğ°Ñ‚Ğ¸ÑÑ</span></p>
            <p><a href="#" id="forgotPassword" style="color:var(--text-primary);">Ğ—Ğ°Ğ±ÑƒĞ»Ğ¸ Ğ¿Ğ°Ñ€Ğ¾Ğ»ÑŒ?</a></p>
          </div>
          <div id="registerForm" style="display:none;">
            <input type="text" id="registerNickname" class="input" placeholder="ĞŸÑĞµĞ²Ğ´Ğ¾Ğ½Ñ–Ğ¼ (Ğ±ĞµĞ· @)">
            <input type="password" id="registerPassword" class="input" placeholder="ĞŸĞ°Ñ€Ğ¾Ğ»ÑŒ">
            <button class="btn btn-primary" id="registerBtn" style="width:100%; margin-top:16px;">Ğ—Ğ°Ñ€ĞµÑ”ÑÑ‚Ñ€ÑƒĞ²Ğ°Ñ‚Ğ¸ÑÑ</button>
            <p style="margin-top:20px;"><span>Ğ’Ğ¶Ğµ Ñ” Ğ°ĞºĞ°ÑƒĞ½Ñ‚?</span> <span id="toLogin" style="color:var(--text-primary);cursor:pointer;">Ğ£Ğ²Ñ–Ğ¹Ñ‚Ğ¸</span></p>
          </div>
        </div>

        <div class="card" id="newPostBox" style="display:none;">
          <div style="display: flex; gap: 16px; align-items: flex-start;">
            <textarea id="postText" class="input" placeholder="Ğ©Ğ¾ Ğ½Ğ¾Ğ²Ğ¾Ğ³Ğ¾? #Ñ…ĞµÑˆÑ‚ĞµĞ³" rows="3" style="flex:1;"></textarea>
            <button class="emoji-button" id="postEmojiBtn">ğŸ˜Š</button>
          </div>
          <div class="file-input-wrapper" style="margin:16px 0;">
            <input type="file" id="postMedia" accept="image/*,video/*" style="display:none;">
            <button class="btn" id="attachMediaBtn">ğŸ“ ĞĞ±Ñ€Ğ°Ñ‚Ğ¸ Ğ¼ĞµĞ´Ñ–Ğ°</button>
          </div>
          <img id="postMediaPreview" class="file-preview" style="max-width:100%; max-height:200px; display:none; margin-top:12px;">
          <button class="btn btn-primary" id="addPost" style="margin-top:16px;">ĞĞ¿ÑƒĞ±Ğ»Ñ–ĞºÑƒĞ²Ğ°Ñ‚Ğ¸</button>
        </div>

        <div class="feed-header" style="display:flex; gap:12px; margin-bottom:24px;">
          <button class="btn" id="feedNewBtn" style="flex:1;">ĞĞ¾Ğ²Ñ–</button>
          <button class="btn" id="feedPopularBtn" style="flex:1;">ĞŸĞ¾Ğ¿ÑƒĞ»ÑÑ€Ğ½Ñ–</button>
        </div>

        <div class="feed" id="feed"></div>
        <div class="feed-end-sentinel" id="feedSentinel"></div>
      </div>

      <!-- ĞŸĞ¾ÑˆÑƒĞº -->
      <div id="search" class="section">
        <input type="text" id="searchInput" class="input" placeholder="ĞŸĞ¾ÑˆÑƒĞº Ğ·Ğ° @id, Ñ–Ğ¼'ÑĞ¼ Ğ°Ğ±Ğ¾ #Ñ…ĞµÑˆÑ‚ĞµĞ³Ğ¾Ğ¼...">
        <div class="user-list" id="userList" style="margin-top:24px;"></div>
      </div>

      <!-- Ğ¥ĞµÑˆÑ‚ĞµĞ³Ğ¸ -->
      <div id="hashtags" class="section">
        <h2 style="margin-bottom:20px;">ĞŸĞ¾Ğ¿ÑƒĞ»ÑÑ€Ğ½Ñ– Ñ…ĞµÑˆÑ‚ĞµĞ³Ğ¸</h2>
        <div class="hashtag-list" id="hashtagList"></div>
      </div>

      <!-- ĞŸÑ€Ğ¾Ñ„Ñ–Ğ»ÑŒ -->
      <div id="profile" class="section">
        <div class="profile-header" id="profileHeader"></div>
        <div class="profile-stats" id="profileStats"></div>
        <div class="profile-tabs" id="profileTabs">
          <div class="profile-tab active" data-tab="posts">ĞŸĞ¾ÑÑ‚Ğ¸</div>
          <div class="profile-tab" data-tab="likes">Ğ›Ğ°Ğ¹ĞºĞ¸</div>
          <div class="profile-tab" data-tab="media">ĞœĞµĞ´Ñ–Ğ°</div>
          <div class="profile-tab" data-tab="saved">Ğ—Ğ±ĞµÑ€ĞµĞ¶ĞµĞ½Ğµ</div>
        </div>
        <div class="feed" id="profileFeed"></div>
      </div>

      <!-- Ğ§Ğ°Ñ‚Ğ¸ -->
      <div id="chats" class="section">
        <div class="chat-search-container" style="margin-bottom:20px;">
          <input type="text" id="chatSearchInput" class="input" placeholder="ĞŸĞ¾ÑˆÑƒĞº ĞºĞ¾Ñ€Ğ¸ÑÑ‚ÑƒĞ²Ğ°Ñ‡Ñ–Ğ²...">
          <div id="chatSearchResults" class="user-list" style="margin-top:16px; display:none;"></div>
        </div>
        <div class="chat-list" id="chatList"></div>
        <div class="chat-window" id="chatWindow" style="display:none;">
          <div class="chat-header">
            <div class="avatar small" id="chatAvatar"></div>
            <div style="flex:1">
              <div style="display:flex; align-items:center; gap:8px;">
                <span id="chatName" style="font-size:1.5rem; font-weight:600;"></span>
                <span class="online-indicator" id="onlineIndicator" style="display:none;"></span>
              </div>
              <div id="lastSeenText" style="color:var(--text-tertiary); font-size:1rem;"></div>
            </div>
          </div>
          <div class="chat-messages" id="chatMessages"></div>
          <div class="typing-indicator" id="typingIndicator" style="display:none; padding:8px 20px; color:var(--text-tertiary);">Ğ´Ñ€ÑƒĞºÑƒÑ”...</div>
          <div class="chat-input-area">
            <input type="file" id="chatFileInput" style="display:none;" multiple>
            <button class="emoji-button" id="attachChatFileBtn">ğŸ“</button>
            <input type="text" id="chatText" placeholder="ĞĞ°Ğ¿Ğ¸ÑˆÑ–Ñ‚ÑŒ Ğ¿Ğ¾Ğ²Ñ–Ğ´Ğ¾Ğ¼Ğ»ĞµĞ½Ğ½Ñ...">
            <button class="emoji-button" id="chatEmojiBtn">ğŸ˜Š</button>
            <button class="btn btn-primary btn-icon" id="sendMessage">â¤</button>
          </div>
        </div>
      </div>

      <!-- ĞĞ°Ğ»Ğ°ÑˆÑ‚ÑƒĞ²Ğ°Ğ½Ğ½Ñ -->
      <div id="settings" class="section card">
        <h2 style="margin-bottom:20px;">ĞĞ°Ğ»Ğ°ÑˆÑ‚ÑƒĞ²Ğ°Ğ½Ğ½Ñ</h2>
        <div class="language-selector" style="margin-bottom:20px;">
          <span style="font-size:1.2rem;">ĞœĞ¾Ğ²Ğ°:</span>
          <select id="languageSelect" class="input" style="width:auto; margin-left:16px;">
            <option value="uk">Ğ£ĞºÑ€Ğ°Ñ—Ğ½ÑÑŒĞºĞ°</option>
            <option value="ru">Ğ ÑƒÑÑĞºĞ¸Ğ¹</option>
            <option value="en">English</option>
          </select>
        </div>
        <button class="btn" id="toggleTheme" style="width:100%; margin-bottom:16px;">
          <span>Ğ¢ĞµĞ¼Ğ°</span>
        </button>
        <button class="btn" id="privacyPolicyBtn" style="width:100%; margin-bottom:16px;">ĞŸĞ¾Ğ»Ñ–Ñ‚Ğ¸ĞºĞ° ĞºĞ¾Ğ½Ñ„Ñ–Ğ´ĞµĞ½Ñ†Ñ–Ğ¹Ğ½Ğ¾ÑÑ‚Ñ–</button>
        <button class="btn" id="logoutBtn" style="width:100%;">Ğ’Ğ¸Ğ¹Ñ‚Ğ¸</button>
      </div>

      <!-- Ğ—Ğ±ĞµÑ€ĞµĞ¶ĞµĞ½Ğµ (Ğ¾ĞºÑ€ĞµĞ¼Ğ¸Ğ¹ Ñ€Ğ¾Ğ·Ğ´Ñ–Ğ», Ğ°Ğ»Ğµ Ğ² Ğ½Ğ°Ğ²Ñ–Ğ³Ğ°Ñ†Ñ–Ñ— Ğ½ĞµĞ¼Ğ°Ñ”) -->
      <div id="saved" class="section">
        <h2 style="margin-bottom:20px;">Ğ—Ğ±ĞµÑ€ĞµĞ¶ĞµĞ½Ğµ</h2>
        <div class="feed" id="savedFeed"></div>
      </div>
    </div>
  </main>
</div>

<!-- Ğ—Ğ°Ñ‚ĞµĞ¼Ğ½ĞµĞ½Ğ¸Ğ¹ Ñ„Ğ¾Ğ½ Ğ´Ğ»Ñ ĞµĞ¼Ğ¾Ğ´Ğ·Ñ– (ĞĞ”Ğ˜Ğ Ğ½Ğ° Ğ²ĞµÑÑŒ ÑĞ°Ğ¹Ñ‚) -->
<div class="emoji-modal-backdrop" id="emojiModalBackdrop">
  <div class="emoji-modal" id="emojiModal">
    <input type="text" class="emoji-search" id="emojiSearch" placeholder="ğŸ” ĞŸĞ¾ÑˆÑƒĞº ĞµĞ¼Ğ¾Ğ´Ğ·Ñ–">
    <div class="emoji-categories" id="emojiCategories"></div>
    <div class="emoji-grid" id="emojiGrid"></div>
  </div>
</div>

<!-- ĞœĞ¾Ğ´Ğ°Ğ»ÑŒĞ½Ñ– Ğ²Ñ–ĞºĞ½Ğ° -->
<div class="modal" id="editProfileModal">
  <div class="modal-content">
    <div class="modal-header">
      <h3>Ğ ĞµĞ´Ğ°Ğ³ÑƒĞ²Ğ°Ñ‚Ğ¸ Ğ¿Ñ€Ğ¾Ñ„Ñ–Ğ»ÑŒ</h3>
      <span class="modal-close" id="closeModal">&times;</span>
    </div>
    <input type="text" id="editNickname" class="input" placeholder="ĞŸÑĞµĞ²Ğ´Ğ¾Ğ½Ñ–Ğ¼">
    <textarea id="editBio" class="input" placeholder="ĞŸÑ€Ğ¾ ÑĞµĞ±Ğµ" rows="3" style="margin:12px 0;"></textarea>
    <div class="file-input-wrapper" style="margin:12px 0;">
      <input type="file" id="editAvatar" accept="image/*" style="display:none;">
      <button class="btn" id="editAvatarBtn">ĞĞ±Ñ€Ğ°Ñ‚Ğ¸ Ğ°Ğ²Ğ°Ñ‚Ğ°Ñ€</button>
    </div>
    <img id="editAvatarPreview" class="file-preview" style="max-width:100%; max-height:200px; display:none; margin-top:12px;">
    <button class="btn btn-primary" id="saveProfileEdit" style="margin-top:16px;">Ğ—Ğ±ĞµÑ€ĞµĞ³Ñ‚Ğ¸</button>
  </div>
</div>

<div class="modal" id="editPostModal">
  <div class="modal-content">
    <div class="modal-header">
      <h3>Ğ ĞµĞ´Ğ°Ğ³ÑƒĞ²Ğ°Ñ‚Ğ¸ Ğ¿Ğ¾ÑÑ‚</h3>
      <span class="modal-close" id="closeEditPostModal">&times;</span>
    </div>
    <textarea id="editPostText" class="input" placeholder="Ğ¢ĞµĞºÑÑ‚ Ğ¿Ğ¾ÑÑ‚Ñƒ" rows="3"></textarea>
    <div class="file-input-wrapper" style="margin:12px 0;">
      <input type="file" id="editPostMedia" accept="image/*,video/*" style="display:none;">
      <button class="btn" id="editPostMediaBtn">Ğ—Ğ¼Ñ–Ğ½Ğ¸Ñ‚Ğ¸ Ğ¼ĞµĞ´Ñ–Ğ°</button>
    </div>
    <img id="editPostMediaPreview" class="file-preview" style="max-width:100%; max-height:200px; display:none; margin-top:12px;">
    <button class="btn btn-primary" id="savePostEdit" style="margin-top:16px;">Ğ—Ğ±ĞµÑ€ĞµĞ³Ñ‚Ğ¸</button>
    <button class="btn btn-danger" id="deletePostBtn" style="margin-top:12px;">Ğ’Ğ¸Ğ´Ğ°Ğ»Ğ¸Ñ‚Ğ¸ Ğ¿Ğ¾ÑÑ‚</button>
  </div>
</div>

<div class="modal" id="followersModal">
  <div class="modal-content">
    <div class="modal-header">
      <h3>ĞŸÑ–Ğ´Ğ¿Ğ¸ÑĞ½Ğ¸ĞºĞ¸</h3>
      <span class="modal-close" id="closeFollowersModal">&times;</span>
    </div>
    <div id="followersList" class="user-list" style="max-height: 400px; overflow-y: auto;"></div>
  </div>
</div>

<div class="modal" id="followingModal">
  <div class="modal-content">
    <div class="modal-header">
      <h3>ĞŸÑ–Ğ´Ğ¿Ğ¸ÑĞºĞ¸</h3>
      <span class="modal-close" id="closeFollowingModal">&times;</span>
    </div>
    <div id="followingList" class="user-list" style="max-height: 400px; overflow-y: auto;"></div>
  </div>
</div>

<div class="modal" id="privacyPolicyModal">
  <div class="modal-content">
    <div class="modal-header">
      <h3>ĞŸĞ¾Ğ»Ñ–Ñ‚Ğ¸ĞºĞ° ĞºĞ¾Ğ½Ñ„Ñ–Ğ´ĞµĞ½Ñ†Ñ–Ğ¹Ğ½Ğ¾ÑÑ‚Ñ–</h3>
      <span class="modal-close" id="closePrivacyModal">&times;</span>
    </div>
    <div style="max-height: 60vh; overflow-y: auto; padding-right: 8px;">
      <p><strong>ĞÑÑ‚Ğ°Ğ½Ğ½Ñ” Ğ¾Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ½Ñ:</strong> 18 Ğ»ÑÑ‚Ğ¾Ğ³Ğ¾ 2026</p>
      <p>FANTASYAS Ğ¿Ğ¾Ğ²Ğ°Ğ¶Ğ°Ñ” ĞºĞ¾Ğ½Ñ„Ñ–Ğ´ĞµĞ½Ñ†Ñ–Ğ¹Ğ½Ñ–ÑÑ‚ÑŒ Ğ½Ğ°ÑˆĞ¸Ñ… ĞºĞ¾Ñ€Ğ¸ÑÑ‚ÑƒĞ²Ğ°Ñ‡Ñ–Ğ². Ğ¦Ñ ĞŸĞ¾Ğ»Ñ–Ñ‚Ğ¸ĞºĞ° Ğ¿Ğ¾ÑÑĞ½ÑÑ”, ÑĞºÑ– Ğ´Ğ°Ğ½Ñ– Ğ¼Ğ¸ Ğ·Ğ±Ğ¸Ñ€Ğ°Ñ”Ğ¼Ğ¾, ÑĞº Ñ—Ñ… Ğ²Ğ¸ĞºĞ¾Ñ€Ğ¸ÑÑ‚Ğ¾Ğ²ÑƒÑ”Ğ¼Ğ¾ Ñ‚Ğ° Ğ·Ğ°Ñ…Ğ¸Ñ‰Ğ°Ñ”Ğ¼Ğ¾.</p>
      <h4>1. Ğ¯ĞºÑ– Ğ´Ğ°Ğ½Ñ– Ğ¼Ğ¸ Ğ·Ğ±Ğ¸Ñ€Ğ°Ñ”Ğ¼Ğ¾</h4>
      <p>â€¢ Ğ†Ğ¼â€™Ñ ĞºĞ¾Ñ€Ğ¸ÑÑ‚ÑƒĞ²Ğ°Ñ‡Ğ°, Ğ°Ğ´Ñ€ĞµÑĞ° ĞµĞ»ĞµĞºÑ‚Ñ€Ğ¾Ğ½Ğ½Ğ¾Ñ— Ğ¿Ğ¾ÑˆÑ‚Ğ¸ (Ğ´Ğ»Ñ Ğ²Ñ…Ğ¾Ğ´Ñƒ), Ğ°Ğ²Ğ°Ñ‚Ğ°Ñ€, Ğ±Ñ–Ğ¾Ğ³Ñ€Ğ°Ñ„Ñ–Ñ.<br>
      â€¢ Ğ†Ğ½Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ†Ñ–Ñ Ğ¿Ñ€Ğ¾ Ğ°ĞºÑ‚Ğ¸Ğ²Ğ½Ñ–ÑÑ‚ÑŒ: Ğ¿Ğ¾ÑÑ‚Ğ¸, Ğ»Ğ°Ğ¹ĞºĞ¸, ĞºĞ¾Ğ¼ĞµĞ½Ñ‚Ğ°Ñ€Ñ–, Ğ¿Ñ–Ğ´Ğ¿Ğ¸ÑĞºĞ¸.<br>
      â€¢ Ğ¢ĞµÑ…Ğ½Ñ–Ñ‡Ğ½Ñ– Ğ´Ğ°Ğ½Ñ–: IP-Ğ°Ğ´Ñ€ĞµÑĞ°, Ñ‚Ğ¸Ğ¿ Ğ¿Ñ€Ğ¸ÑÑ‚Ñ€Ğ¾Ñ, Ñ„Ğ°Ğ¹Ğ»Ğ¸ cookie.</p>
      <h4>2. Ğ¯Ğº Ğ¼Ğ¸ Ğ²Ğ¸ĞºĞ¾Ñ€Ğ¸ÑÑ‚Ğ¾Ğ²ÑƒÑ”Ğ¼Ğ¾ Ğ´Ğ°Ğ½Ñ–</h4>
      <p>Ğ”Ğ»Ñ Ğ½Ğ°Ğ´Ğ°Ğ½Ğ½Ñ Ñ„ÑƒĞ½ĞºÑ†Ñ–Ğ¾Ğ½Ğ°Ğ»Ñƒ ÑĞ¾Ñ†Ñ–Ğ°Ğ»ÑŒĞ½Ğ¾Ñ— Ğ¼ĞµÑ€ĞµĞ¶Ñ–, Ğ¿ĞµÑ€ÑĞ¾Ğ½Ğ°Ğ»Ñ–Ğ·Ğ°Ñ†Ñ–Ñ— ĞºĞ¾Ğ½Ñ‚ĞµĞ½Ñ‚Ñƒ, Ğ¿Ğ¾ĞºÑ€Ğ°Ñ‰ĞµĞ½Ğ½Ñ ÑĞµÑ€Ğ²Ñ–ÑÑƒ, Ğ·Ğ²â€™ÑĞ·ĞºÑƒ Ğ· Ğ²Ğ°Ğ¼Ğ¸.</p>
      <h4>3. ĞŸĞµÑ€ĞµĞ´Ğ°Ñ‡Ğ° Ğ´Ğ°Ğ½Ğ¸Ñ… Ñ‚Ñ€ĞµÑ‚Ñ–Ğ¼ Ğ¾ÑĞ¾Ğ±Ğ°Ğ¼</h4>
      <p>ĞœĞ¸ Ğ½Ğµ Ğ¿Ñ€Ğ¾Ğ´Ğ°Ñ”Ğ¼Ğ¾ Ğ²Ğ°ÑˆÑ– Ğ´Ğ°Ğ½Ñ–. Ğ”ĞµÑĞºÑ– Ğ´Ğ°Ğ½Ñ– Ğ¼Ğ¾Ğ¶ÑƒÑ‚ÑŒ Ğ¿ĞµÑ€ĞµĞ´Ğ°Ğ²Ğ°Ñ‚Ğ¸ÑÑ Firebase (Google) Ğ´Ğ»Ñ Ğ·Ğ±ĞµÑ€Ñ–Ğ³Ğ°Ğ½Ğ½Ñ Ñ‚Ğ° Ğ¾Ğ±Ñ€Ğ¾Ğ±ĞºĞ¸.</p>
      <h4>4. Ğ’Ğ°ÑˆÑ– Ğ¿Ñ€Ğ°Ğ²Ğ°</h4>
      <p>Ğ’Ğ¸ Ğ¼Ğ¾Ğ¶ĞµÑ‚Ğµ Ğ²Ğ¸Ğ´Ğ°Ğ»Ğ¸Ñ‚Ğ¸ ÑĞ²Ñ–Ğ¹ Ğ°ĞºĞ°ÑƒĞ½Ñ‚, ĞµĞºÑĞ¿Ğ¾Ñ€Ñ‚ÑƒĞ²Ğ°Ñ‚Ğ¸ Ğ´Ğ°Ğ½Ñ– Ğ°Ğ±Ğ¾ Ğ·Ğ²ĞµÑ€Ğ½ÑƒÑ‚Ğ¸ÑÑ Ğ´Ğ¾ Ğ½Ğ°Ñ Ñ‡ĞµÑ€ĞµĞ· Ñ„Ğ¾Ñ€Ğ¼Ñƒ Ğ·Ğ²Ğ¾Ñ€Ğ¾Ñ‚Ğ½Ğ¾Ğ³Ğ¾ Ğ·Ğ²â€™ÑĞ·ĞºÑƒ.</p>
      <h4>5. ĞšĞ¾Ğ½Ñ‚Ğ°ĞºÑ‚Ğ¸</h4>
      <p>support@fantasyas.app</p>
    </div>
  </div>
</div>

<div id="toast"></div>

<script type="module">
  // Ğ†Ğ¼Ğ¿Ğ¾Ñ€Ñ‚Ğ¸ Firebase
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js";
  import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut, GoogleAuthProvider, OAuthProvider, signInWithPopup, sendPasswordResetEmail } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-auth.js";
  import { getFirestore, doc, setDoc, getDoc, updateDoc, collection, addDoc, query, where, onSnapshot, orderBy, serverTimestamp, arrayUnion, arrayRemove, deleteDoc, getDocs, increment, limit, startAfter, writeBatch } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore.js";
  import { getStorage, ref, uploadBytes, getDownloadURL, deleteObject } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-storage.js";

  const firebaseConfig = {
    apiKey: "AIzaSyDRzC-QDE0-UXd-XL0i3iqayFiKcc6wmvc",
    authDomain: "fantasyasapp.firebaseapp.com",
    projectId: "fantasyasapp",
    storageBucket: "fantasyasapp.appspot.com",
    messagingSenderId: "721763921060",
    appId: "1:721763921060:web:3d61044ea2424e8176ca31"
  };
  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);
  const storage = getStorage(app);

  // Ğ“Ğ»Ğ¾Ğ±Ğ°Ğ»ÑŒĞ½Ñ– Ğ·Ğ¼Ñ–Ğ½Ğ½Ñ–
  let currentUser = null;
  let currentChatPartner = null;
  let currentChatPartnerName = '';
  let currentChatId = null;
  let currentProfileUid = null;
  let currentEditingPost = null;
  
  let unsubscribeFeed = null;
  let unsubscribeChat = null;
  let unsubscribeChatList = null;
  let unsubscribeTyping = null;
  let unsubscribeOnlineStatus = null;
  let lastOnlineInterval = null;

  let unreadCount = 0;
  let currentFeedType = 'new';
  let lastVisible = null;
  let loading = false;
  let hasMore = true;

  const viewedPosts = new Set();

  // ================= ĞœĞĞ’ĞĞ† ĞŸĞ•Ğ Ğ•ĞšĞ›ĞĞ”Ğ˜ =================
  const translations = {
    uk: {
      home: 'Ğ“Ğ¾Ğ»Ğ¾Ğ²Ğ½Ğ°', search: 'ĞŸĞ¾ÑˆÑƒĞº', hashtags: 'Ğ¥ĞµÑˆÑ‚ĞµĞ³Ğ¸', profile: 'ĞŸÑ€Ğ¾Ñ„Ñ–Ğ»ÑŒ', chats: 'Ğ§Ğ°Ñ‚Ğ¸',
      saved: 'Ğ—Ğ±ĞµÑ€ĞµĞ¶ĞµĞ½Ğµ', settings: 'ĞĞ°Ğ»Ğ°ÑˆÑ‚ÑƒĞ²Ğ°Ğ½Ğ½Ñ', logout: 'Ğ’Ğ¸Ğ¹Ñ‚Ğ¸', login: 'Ğ£Ğ²Ñ–Ğ¹Ñ‚Ğ¸',
      register: 'Ğ—Ğ°Ñ€ĞµÑ”ÑÑ‚Ñ€ÑƒĞ²Ğ°Ñ‚Ğ¸ÑÑ', noAccount: 'ĞĞµĞ¼Ğ°Ñ” Ğ°ĞºĞ°ÑƒĞ½Ñ‚Ğ°?', haveAccount: 'Ğ’Ğ¶Ğµ Ñ” Ğ°ĞºĞ°ÑƒĞ½Ñ‚?',
      registerLink: 'Ğ—Ğ°Ñ€ĞµÑ”ÑÑ‚Ñ€ÑƒĞ²Ğ°Ñ‚Ğ¸ÑÑ', loginLink: 'Ğ£Ğ²Ñ–Ğ¹Ñ‚Ğ¸', forgotPassword: 'Ğ—Ğ°Ğ±ÑƒĞ»Ğ¸ Ğ¿Ğ°Ñ€Ğ¾Ğ»ÑŒ?',
      loginPlaceholder: 'ĞŸÑĞµĞ²Ğ´Ğ¾Ğ½Ñ–Ğ¼ (Ğ±ĞµĞ· @)', passwordPlaceholder: 'ĞŸĞ°Ñ€Ğ¾Ğ»ÑŒ',
      newPostPlaceholder: 'Ğ©Ğ¾ Ğ½Ğ¾Ğ²Ğ¾Ğ³Ğ¾? #Ñ…ĞµÑˆÑ‚ĞµĞ³', chooseMedia: 'ĞĞ±Ñ€Ğ°Ñ‚Ğ¸ Ñ„Ğ¾Ñ‚Ğ¾/Ğ²Ñ–Ğ´ĞµĞ¾',
      publish: 'ĞĞ¿ÑƒĞ±Ğ»Ñ–ĞºÑƒĞ²Ğ°Ñ‚Ğ¸', new: 'ĞĞ¾Ğ²Ñ–', popular: 'ĞŸĞ¾Ğ¿ÑƒĞ»ÑÑ€Ğ½Ñ–',
      searchPlaceholder: 'ĞŸĞ¾ÑˆÑƒĞº Ğ·Ğ° @id, Ñ–Ğ¼\'ÑĞ¼ Ğ°Ğ±Ğ¾ #Ñ…ĞµÑˆÑ‚ĞµĞ³Ğ¾Ğ¼...', popularHashtags: 'ĞŸĞ¾Ğ¿ÑƒĞ»ÑÑ€Ğ½Ñ– Ñ…ĞµÑˆÑ‚ĞµĞ³Ğ¸',
      posts: 'ĞŸĞ¾ÑÑ‚Ğ¸', likes: 'Ğ›Ğ°Ğ¹ĞºĞ¸', media: 'ĞœĞµĞ´Ñ–Ğ°', theme: 'Ğ¢ĞµĞ¼Ğ°',
      privacyPolicy: 'ĞŸĞ¾Ğ»Ñ–Ñ‚Ğ¸ĞºĞ° ĞºĞ¾Ğ½Ñ„Ñ–Ğ´ĞµĞ½Ñ†Ñ–Ğ¹Ğ½Ğ¾ÑÑ‚Ñ–', editProfile: 'Ğ ĞµĞ´Ğ°Ğ³ÑƒĞ²Ğ°Ñ‚Ğ¸ Ğ¿Ñ€Ğ¾Ñ„Ñ–Ğ»ÑŒ',
      nickname: 'ĞŸÑĞµĞ²Ğ´Ğ¾Ğ½Ñ–Ğ¼', bio: 'ĞŸÑ€Ğ¾ ÑĞµĞ±Ğµ', chooseAvatar: 'ĞĞ±Ñ€Ğ°Ñ‚Ğ¸ Ğ°Ğ²Ğ°Ñ‚Ğ°Ñ€', save: 'Ğ—Ğ±ĞµÑ€ĞµĞ³Ñ‚Ğ¸',
      editPost: 'Ğ ĞµĞ´Ğ°Ğ³ÑƒĞ²Ğ°Ñ‚Ğ¸ Ğ¿Ğ¾ÑÑ‚', postText: 'Ğ¢ĞµĞºÑÑ‚ Ğ¿Ğ¾ÑÑ‚Ñƒ', changeMedia: 'Ğ—Ğ¼Ñ–Ğ½Ğ¸Ñ‚Ğ¸ Ğ¼ĞµĞ´Ñ–Ğ°',
      deletePost: 'Ğ’Ğ¸Ğ´Ğ°Ğ»Ğ¸Ñ‚Ğ¸ Ğ¿Ğ¾ÑÑ‚', followers: 'ĞŸÑ–Ğ´Ğ¿Ğ¸ÑĞ½Ğ¸ĞºĞ¸', following: 'ĞŸÑ–Ğ´Ğ¿Ğ¸ÑĞºĞ¸',
      language: 'ĞœĞ¾Ğ²Ğ°', typing: 'Ğ´Ñ€ÑƒĞºÑƒÑ”...', messagePlaceholder: 'ĞĞ°Ğ¿Ğ¸ÑˆÑ–Ñ‚ÑŒ Ğ¿Ğ¾Ğ²Ñ–Ğ´Ğ¾Ğ¼Ğ»ĞµĞ½Ğ½Ñ...',
      searchUsers: 'ĞŸĞ¾ÑˆÑƒĞº ĞºĞ¾Ñ€Ğ¸ÑÑ‚ÑƒĞ²Ğ°Ñ‡Ñ–Ğ²...', online: 'Ğ² Ğ¼ĞµÑ€ĞµĞ¶Ñ–', lastSeen: 'Ğ²Ğ¾ÑÑ‚Ğ°Ğ½Ğ½Ñ” Ğ±ÑƒĞ²',
      justNow: 'Ñ‰Ğ¾Ğ¹Ğ½Ğ¾', minutes: 'Ñ…Ğ²', hours: 'Ğ³Ğ¾Ğ´', days: 'Ğ´Ğ½', follow: 'ĞŸÑ–Ğ´Ğ¿Ğ¸ÑĞ°Ñ‚Ğ¸ÑÑ',
      unfollow: 'Ğ’Ñ–Ğ´Ğ¿Ğ¸ÑĞ°Ñ‚Ğ¸ÑÑ', noChats: 'ĞĞµĞ¼Ğ°Ñ” Ñ‡Ğ°Ñ‚Ñ–Ğ²', noSaved: 'ĞĞµĞ¼Ğ°Ñ” Ğ·Ğ±ĞµÑ€ĞµĞ¶ĞµĞ½Ğ¸Ñ… Ğ¿Ğ¾ÑÑ‚Ñ–Ğ²',
      noFollowers: 'ĞĞµĞ¼Ğ°Ñ” Ğ¿Ñ–Ğ´Ğ¿Ğ¸ÑĞ½Ğ¸ĞºÑ–Ğ²', noFollowing: 'ĞÑ– Ğ½Ğ° ĞºĞ¾Ğ³Ğ¾ Ğ½Ğµ Ğ¿Ñ–Ğ´Ğ¿Ğ¸ÑĞ°Ğ½Ğ¸Ğ¹',
      today: 'Ğ¡ÑŒĞ¾Ğ³Ğ¾Ğ´Ğ½Ñ–', yesterday: 'Ğ’Ñ‡Ğ¾Ñ€Ğ°', reply: 'Ğ’Ñ–Ğ´Ğ¿Ğ¾Ğ²Ñ–ÑÑ‚Ğ¸', likeComment: 'Ğ›Ğ°Ğ¹Ğº'
    },
    ru: {
      home: 'Ğ“Ğ»Ğ°Ğ²Ğ½Ğ°Ñ', search: 'ĞŸĞ¾Ğ¸ÑĞº', hashtags: 'Ğ¥ĞµÑˆÑ‚ĞµĞ³Ğ¸', profile: 'ĞŸÑ€Ğ¾Ñ„Ğ¸Ğ»ÑŒ', chats: 'Ğ§Ğ°Ñ‚Ñ‹',
      saved: 'Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½ĞµĞ½Ğ½Ğ¾Ğµ', settings: 'ĞĞ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ¸', logout: 'Ğ’Ñ‹Ğ¹Ñ‚Ğ¸', login: 'Ğ’Ğ¾Ğ¹Ñ‚Ğ¸',
      register: 'Ğ—Ğ°Ñ€ĞµĞ³Ğ¸ÑÑ‚Ñ€Ğ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒÑÑ', noAccount: 'ĞĞµÑ‚ Ğ°ĞºĞºĞ°ÑƒĞ½Ñ‚Ğ°?', haveAccount: 'Ğ£Ğ¶Ğµ ĞµÑÑ‚ÑŒ Ğ°ĞºĞºĞ°ÑƒĞ½Ñ‚?',
      registerLink: 'Ğ—Ğ°Ñ€ĞµĞ³Ğ¸ÑÑ‚Ñ€Ğ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒÑÑ', loginLink: 'Ğ’Ğ¾Ğ¹Ñ‚Ğ¸', forgotPassword: 'Ğ—Ğ°Ğ±Ñ‹Ğ»Ğ¸ Ğ¿Ğ°Ñ€Ğ¾Ğ»ÑŒ?',
      loginPlaceholder: 'ĞŸÑĞµĞ²Ğ´Ğ¾Ğ½Ğ¸Ğ¼ (Ğ±ĞµĞ· @)', passwordPlaceholder: 'ĞŸĞ°Ñ€Ğ¾Ğ»ÑŒ',
      newPostPlaceholder: 'Ğ§Ñ‚Ğ¾ Ğ½Ğ¾Ğ²Ğ¾Ğ³Ğ¾? #Ñ…ĞµÑˆÑ‚ĞµĞ³', chooseMedia: 'Ğ’Ñ‹Ğ±Ñ€Ğ°Ñ‚ÑŒ Ñ„Ğ¾Ñ‚Ğ¾/Ğ²Ğ¸Ğ´ĞµĞ¾',
      publish: 'ĞĞ¿ÑƒĞ±Ğ»Ğ¸ĞºĞ¾Ğ²Ğ°Ñ‚ÑŒ', new: 'ĞĞ¾Ğ²Ñ‹Ğµ', popular: 'ĞŸĞ¾Ğ¿ÑƒĞ»ÑÑ€Ğ½Ñ‹Ğµ',
      searchPlaceholder: 'ĞŸĞ¾Ğ¸ÑĞº Ğ¿Ğ¾ @id, Ğ¸Ğ¼ĞµĞ½Ğ¸ Ğ¸Ğ»Ğ¸ #Ñ…ĞµÑˆÑ‚ĞµĞ³Ñƒ...', popularHashtags: 'ĞŸĞ¾Ğ¿ÑƒĞ»ÑÑ€Ğ½Ñ‹Ğµ Ñ…ĞµÑˆÑ‚ĞµĞ³Ğ¸',
      posts: 'ĞŸĞ¾ÑÑ‚Ñ‹', likes: 'Ğ›Ğ°Ğ¹ĞºĞ¸', media: 'ĞœĞµĞ´Ğ¸Ğ°', theme: 'Ğ¢ĞµĞ¼Ğ°',
      privacyPolicy: 'ĞŸĞ¾Ğ»Ğ¸Ñ‚Ğ¸ĞºĞ° ĞºĞ¾Ğ½Ñ„Ğ¸Ğ´ĞµĞ½Ñ†Ğ¸Ğ°Ğ»ÑŒĞ½Ğ¾ÑÑ‚Ğ¸', editProfile: 'Ğ ĞµĞ´Ğ°ĞºÑ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ Ğ¿Ñ€Ğ¾Ñ„Ğ¸Ğ»ÑŒ',
      nickname: 'ĞŸÑĞµĞ²Ğ´Ğ¾Ğ½Ğ¸Ğ¼', bio: 'Ğ ÑĞµĞ±Ğµ', chooseAvatar: 'Ğ’Ñ‹Ğ±Ñ€Ğ°Ñ‚ÑŒ Ğ°Ğ²Ğ°Ñ‚Ğ°Ñ€', save: 'Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½Ğ¸Ñ‚ÑŒ',
      editPost: 'Ğ ĞµĞ´Ğ°ĞºÑ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ Ğ¿Ğ¾ÑÑ‚', postText: 'Ğ¢ĞµĞºÑÑ‚ Ğ¿Ğ¾ÑÑ‚Ğ°', changeMedia: 'Ğ˜Ğ·Ğ¼ĞµĞ½Ğ¸Ñ‚ÑŒ Ğ¼ĞµĞ´Ğ¸Ğ°',
      deletePost: 'Ğ£Ğ´Ğ°Ğ»Ğ¸Ñ‚ÑŒ Ğ¿Ğ¾ÑÑ‚', followers: 'ĞŸĞ¾Ğ´Ğ¿Ğ¸ÑÑ‡Ğ¸ĞºĞ¸', following: 'ĞŸĞ¾Ğ´Ğ¿Ğ¸ÑĞºĞ¸',
      language: 'Ğ¯Ğ·Ñ‹Ğº', typing: 'Ğ¿ĞµÑ‡Ğ°Ñ‚Ğ°ĞµÑ‚...', messagePlaceholder: 'ĞĞ°Ğ¿Ğ¸ÑˆĞ¸Ñ‚Ğµ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğµ...',
      searchUsers: 'ĞŸĞ¾Ğ¸ÑĞº Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ĞµĞ¹...', online: 'Ğ² ÑĞµÑ‚Ğ¸', lastSeen: 'Ğ±Ñ‹Ğ»(Ğ°)',
      justNow: 'Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ Ñ‡Ñ‚Ğ¾', minutes: 'Ğ¼Ğ¸Ğ½', hours: 'Ñ‡', days: 'Ğ´Ğ½', follow: 'ĞŸĞ¾Ğ´Ğ¿Ğ¸ÑĞ°Ñ‚ÑŒÑÑ',
      unfollow: 'ĞÑ‚Ğ¿Ğ¸ÑĞ°Ñ‚ÑŒÑÑ', noChats: 'ĞĞµÑ‚ Ñ‡Ğ°Ñ‚Ğ¾Ğ²', noSaved: 'ĞĞµÑ‚ ÑĞ¾Ñ…Ñ€Ğ°Ğ½ĞµĞ½Ğ½Ñ‹Ñ… Ğ¿Ğ¾ÑÑ‚Ğ¾Ğ²',
      noFollowers: 'ĞĞµÑ‚ Ğ¿Ğ¾Ğ´Ğ¿Ğ¸ÑÑ‡Ğ¸ĞºĞ¾Ğ²', noFollowing: 'ĞĞ¸ Ğ½Ğ° ĞºĞ¾Ğ³Ğ¾ Ğ½Ğµ Ğ¿Ğ¾Ğ´Ğ¿Ğ¸ÑĞ°Ğ½',
      today: 'Ğ¡ĞµĞ³Ğ¾Ğ´Ğ½Ñ', yesterday: 'Ğ’Ñ‡ĞµÑ€Ğ°', reply: 'ĞÑ‚Ğ²ĞµÑ‚Ğ¸Ñ‚ÑŒ', likeComment: 'ĞÑ€Ğ°Ğ²Ğ¸Ñ‚ÑÑ'
    },
    en: {
      home: 'Home', search: 'Search', hashtags: 'Hashtags', profile: 'Profile', chats: 'Chats',
      saved: 'Saved', settings: 'Settings', logout: 'Logout', login: 'Login',
      register: 'Register', noAccount: 'No account?', haveAccount: 'Already have an account?',
      registerLink: 'Register', loginLink: 'Login', forgotPassword: 'Forgot password?',
      loginPlaceholder: 'Nickname (without @)', passwordPlaceholder: 'Password',
      newPostPlaceholder: 'What\'s new? #hashtag', chooseMedia: 'Choose photo/video',
      publish: 'Publish', new: 'New', popular: 'Popular',
      searchPlaceholder: 'Search by @id, name or #hashtag...', popularHashtags: 'Popular hashtags',
      posts: 'Posts', likes: 'Likes', media: 'Media', theme: 'Theme',
      privacyPolicy: 'Privacy Policy', editProfile: 'Edit Profile',
      nickname: 'Nickname', bio: 'Bio', chooseAvatar: 'Choose avatar', save: 'Save',
      editPost: 'Edit Post', postText: 'Post text', changeMedia: 'Change media',
      deletePost: 'Delete post', followers: 'Followers', following: 'Following',
      language: 'Language', typing: 'typing...', messagePlaceholder: 'Write a message...',
      searchUsers: 'Search users...', online: 'online', lastSeen: 'last seen',
      justNow: 'just now', minutes: 'min', hours: 'h', days: 'd', follow: 'Follow',
      unfollow: 'Unfollow', noChats: 'No chats', noSaved: 'No saved posts',
      noFollowers: 'No followers', noFollowing: 'Not following anyone',
      today: 'Today', yesterday: 'Yesterday', reply: 'Reply', likeComment: 'Like'
    }
  };

  let currentLanguage = localStorage.getItem('language') || 'uk';

  function applyLanguage() {
    document.querySelectorAll('[data-i18n]').forEach(el => {
      const key = el.getAttribute('data-i18n');
      if (translations[currentLanguage] && translations[currentLanguage][key]) {
        el.textContent = translations[currentLanguage][key];
      }
    });
    document.querySelectorAll('[data-i18n-placeholder]').forEach(el => {
      const key = el.getAttribute('data-i18n-placeholder');
      if (translations[currentLanguage] && translations[currentLanguage][key]) {
        el.placeholder = translations[currentLanguage][key];
      }
    });
    const activeNav = document.querySelector('.nav-item.active');
    if (activeNav) {
      const key = activeNav.querySelector('span:not(.badge)')?.getAttribute('data-i18n');
      if (key) document.getElementById('pageTitle').textContent = translations[currentLanguage][key] || '';
    }
    updateLastSeenTexts();
  }

  document.getElementById('languageSelect').addEventListener('change', (e) => {
    currentLanguage = e.target.value;
    localStorage.setItem('language', currentLanguage);
    applyLanguage();
  });

  // ================= Ğ”Ğ¾Ğ¿Ğ¾Ğ¼Ñ–Ğ¶Ğ½Ñ– Ñ„ÑƒĞ½ĞºÑ†Ñ–Ñ— =================
  const showToast = (msg) => {
    const toast = document.getElementById('toast');
    if (!toast) return;
    toast.textContent = msg;
    toast.classList.add('show');
    setTimeout(() => toast.classList.remove('show'), 3000);
  };

  const vibrate = (ms) => { if (navigator.vibrate) navigator.vibrate(ms); };

  const updateUnreadBadge = () => {
    const badge = document.getElementById('unreadBadge');
    if (!badge) return;
    if (unreadCount > 0) {
      badge.textContent = unreadCount > 99 ? '99+' : unreadCount;
      badge.style.display = 'inline-block';
    } else {
      badge.style.display = 'none';
    }
  };

  const cleanupListeners = () => {
    if (unsubscribeFeed) { unsubscribeFeed(); unsubscribeFeed = null; }
    if (unsubscribeChat) { unsubscribeChat(); unsubscribeChat = null; }
    if (unsubscribeChatList) { unsubscribeChatList(); unsubscribeChatList = null; }
    if (unsubscribeTyping) { unsubscribeTyping(); unsubscribeTyping = null; }
    if (unsubscribeOnlineStatus) { unsubscribeOnlineStatus(); unsubscribeOnlineStatus = null; }
    if (lastOnlineInterval) { clearInterval(lastOnlineInterval); lastOnlineInterval = null; }
  };

  // ================= Ğ¤ÑƒĞ½ĞºÑ†Ñ–Ñ— Ğ´Ğ»Ñ ÑĞºĞ°Ñ€Ğ³, Ğ¼ÑÑ‚Ñƒ, Ğ±Ğ»Ğ¾ĞºÑƒĞ²Ğ°Ğ½Ğ½Ñ =================
  async function reportUser(targetUid, reason = '') {
    if (!currentUser) return;
    try {
      await addDoc(collection(db, "reports"), {
        reportedUserId: targetUid,
        reporterId: currentUser.uid,
        reason: reason || 'Ğ‘ĞµĞ· Ğ¿Ñ€Ğ¸Ñ‡Ğ¸Ğ½Ğ¸',
        timestamp: serverTimestamp()
      });
      showToast('Ğ¡ĞºĞ°Ñ€Ğ³Ñƒ Ğ½Ğ°Ğ´Ñ–ÑĞ»Ğ°Ğ½Ğ¾');
    } catch (e) {
      showToast('ĞŸĞ¾Ğ¼Ğ¸Ğ»ĞºĞ°: ' + e.message);
    }
  }

  async function muteUser(targetUid) {
    if (!currentUser) return;
    const userRef = doc(db, "users", currentUser.uid);
    try {
      await updateDoc(userRef, { mutedUsers: arrayUnion(targetUid) });
      showToast('ĞšĞ¾Ñ€Ğ¸ÑÑ‚ÑƒĞ²Ğ°Ñ‡Ğ° Ğ·Ğ°Ğ¼ÑƒÑ‡ĞµĞ½Ğ¾');
    } catch (e) {
      showToast('ĞŸĞ¾Ğ¼Ğ¸Ğ»ĞºĞ°: ' + e.message);
    }
  }

  async function unmuteUser(targetUid) {
    if (!currentUser) return;
    const userRef = doc(db, "users", currentUser.uid);
    try {
      await updateDoc(userRef, { mutedUsers: arrayRemove(targetUid) });
      showToast('ĞšĞ¾Ñ€Ğ¸ÑÑ‚ÑƒĞ²Ğ°Ñ‡Ğ° Ñ€Ğ¾Ğ·Ğ¼ÑƒÑ‡ĞµĞ½Ğ¾');
    } catch (e) {
      showToast('ĞŸĞ¾Ğ¼Ğ¸Ğ»ĞºĞ°: ' + e.message);
    }
  }

  async function blockUser(targetUid) {
    if (!currentUser) return;
    const userRef = doc(db, "users", currentUser.uid);
    try {
      await updateDoc(userRef, { blockedUsers: arrayUnion(targetUid) });
      showToast('ĞšĞ¾Ñ€Ğ¸ÑÑ‚ÑƒĞ²Ğ°Ñ‡Ğ° Ğ·Ğ°Ğ±Ğ»Ğ¾ĞºĞ¾Ğ²Ğ°Ğ½Ğ¾');
    } catch (e) {
      showToast('ĞŸĞ¾Ğ¼Ğ¸Ğ»ĞºĞ°: ' + e.message);
    }
  }

  async function unblockUser(targetUid) {
    if (!currentUser) return;
    const userRef = doc(db, "users", currentUser.uid);
    try {
      await updateDoc(userRef, { blockedUsers: arrayRemove(targetUid) });
      showToast('ĞšĞ¾Ñ€Ğ¸ÑÑ‚ÑƒĞ²Ğ°Ñ‡Ğ° Ñ€Ğ¾Ğ·Ğ±Ğ»Ğ¾ĞºĞ¾Ğ²Ğ°Ğ½Ğ¾');
    } catch (e) {
      showToast('ĞŸĞ¾Ğ¼Ğ¸Ğ»ĞºĞ°: ' + e.message);
    }
  }

  // ================= ĞĞĞ’Ğ†Ğ“ĞĞ¦Ğ†Ğ¯ ĞŸĞ Ğ ĞĞ—Ğ”Ğ†Ğ›ĞĞ¥ =================
  const sections = ['home','search','hashtags','profile','chats','settings','saved'];
  const navItems = document.querySelectorAll('.nav-item');
  navItems.forEach((item) => {
    item.addEventListener('click', () => {
      const section = item.dataset.section;
      if (!section) return;
      navItems.forEach(n => n.classList.remove('active'));
      item.classList.add('active');
      sections.forEach(s => document.getElementById(s)?.classList.remove('active'));
      const sectionEl = document.getElementById(section);
      if (sectionEl) sectionEl.classList.add('active');
      
      const titleKey = item.querySelector('span:not(.badge)')?.getAttribute('data-i18n') || section;
      document.getElementById('pageTitle').textContent = translations[currentLanguage][titleKey] || section;
      
      cleanupListeners();
      
      if (section === 'home' && currentUser) resetPagination();
      if (section === 'search' && currentUser) loadSearchUsers();
      if (section === 'hashtags' && currentUser) loadHashtags();
      if (section === 'chats' && currentUser) {
        document.getElementById('chatWindow').style.display = 'none';
        loadChatList();
        document.getElementById('chatSearchResults').style.display = 'none';
        document.getElementById('chatSearchInput').value = '';
      }
      if (section === 'profile' && currentUser) {
        viewProfile(currentUser.uid);
      }
      if (section === 'saved' && currentUser) {
        loadSavedFeed();
      }
      
      closeSidebar();
    });
  });

  const sidebar = document.getElementById('sidebar');
  const menuToggle = document.getElementById('menuToggle');
  const backdrop = document.getElementById('sidebarBackdrop');

  function openSidebar() {
    sidebar.classList.add('open');
    menuToggle.classList.add('active');
    backdrop.classList.add('active');
  }

  function closeSidebar() {
    sidebar.classList.remove('open');
    menuToggle.classList.remove('active');
    backdrop.classList.remove('active');
  }

  menuToggle.addEventListener('click', (e) => {
    e.stopPropagation();
    if (sidebar.classList.contains('open')) {
      closeSidebar();
    } else {
      openSidebar();
    }
  });

  backdrop.addEventListener('click', closeSidebar);

  // ================= Ğ¦Ğ•ĞĞ¢Ğ ĞĞ’ĞĞĞ˜Ğ™ Ğ•ĞœĞĞ”Ğ–Ğ†-ĞŸĞ†ĞšĞ•Ğ  =================
  const emojiCategories = {
    smileys: ['ğŸ˜€','ğŸ˜ƒ','ğŸ˜„','ğŸ˜','ğŸ˜†','ğŸ˜…','ğŸ˜‚','ğŸ¤£','ğŸ˜Š','ğŸ˜‡','ğŸ™‚','ğŸ™ƒ','ğŸ˜‰','ğŸ˜Œ','ğŸ˜','ğŸ¥°','ğŸ˜˜','ğŸ˜—','ğŸ˜™','ğŸ˜š','ğŸ˜‹','ğŸ˜›','ğŸ˜','ğŸ˜œ','ğŸ¤ª','ğŸ¤¨','ğŸ§','ğŸ¤“','ğŸ˜','ğŸ¥¸','ğŸ¤©','ğŸ¥³','ğŸ˜','ğŸ˜’','ğŸ˜','ğŸ˜”','ğŸ˜Ÿ','ğŸ˜•','ğŸ™','â˜¹ï¸','ğŸ˜£','ğŸ˜–','ğŸ˜«','ğŸ˜©','ğŸ¥º','ğŸ˜¢','ğŸ˜­','ğŸ˜¤','ğŸ˜ ','ğŸ˜¡','ğŸ¤¬','ğŸ¤¯','ğŸ˜³','ğŸ¥µ','ğŸ¥¶','ğŸ˜±','ğŸ˜¨','ğŸ˜°','ğŸ˜¥','ğŸ˜“','ğŸ¤—','ğŸ¤”','ğŸ¤­','ğŸ¤«','ğŸ¤¥','ğŸ˜¶','ğŸ˜','ğŸ˜‘','ğŸ˜¬','ğŸ™„','ğŸ˜¯','ğŸ˜¦','ğŸ˜§','ğŸ˜®','ğŸ˜²','ğŸ¥±','ğŸ˜´','ğŸ¤¤','ğŸ˜ª','ğŸ˜µ','ğŸ¤','ğŸ¥´','ğŸ¤¢','ğŸ¤®','ğŸ¤§','ğŸ˜·','ğŸ¤’','ğŸ¤•','ğŸ¤‘','ğŸ¤ ','ğŸ˜ˆ','ğŸ‘¿','ğŸ‘¹','ğŸ‘º','ğŸ¤¡','ğŸ’©','ğŸ‘»','ğŸ’€','â˜ ï¸','ğŸ‘½','ğŸ‘¾','ğŸ¤–','ğŸƒ','ğŸ˜º','ğŸ˜¸','ğŸ˜¹','ğŸ˜»','ğŸ˜¼','ğŸ˜½','ğŸ™€','ğŸ˜¿','ğŸ˜¾'],
    nature: ['ğŸ¶','ğŸ±','ğŸ­','ğŸ¹','ğŸ°','ğŸ¦Š','ğŸ»','ğŸ¼','ğŸ¨','ğŸ¯','ğŸ¦','ğŸ®','ğŸ·','ğŸ¸','ğŸ™','ğŸ¦‘','ğŸ¦','ğŸ¦','ğŸ ','ğŸŸ','ğŸ¡','ğŸ¬','ğŸ³','ğŸ‹','ğŸ¦ˆ','ğŸŠ','ğŸ…','ğŸ†','ğŸ¦“','ğŸ¦','ğŸ¦§','ğŸ˜','ğŸ¦›','ğŸ¦','ğŸª','ğŸ«','ğŸ¦’','ğŸ¦˜','ğŸƒ','ğŸ‚','ğŸ„','ğŸ','ğŸ–','ğŸ','ğŸ‘','ğŸ¦™','ğŸ','ğŸ¦Œ','ğŸ•','ğŸ©','ğŸˆ','ğŸ“','ğŸ¦ƒ','ğŸ¦š','ğŸ¦œ','ğŸ¦¢','ğŸ¦©','ğŸ•Šï¸','ğŸ‡','ğŸ¦','ğŸ¦¨','ğŸ¦¡','ğŸ¦¦','ğŸ¦¥','ğŸ','ğŸ€','ğŸ¿ï¸','ğŸ¦”','ğŸ¾'],
    food: ['ğŸ','ğŸ','ğŸŠ','ğŸ‹','ğŸŒ','ğŸ‰','ğŸ‡','ğŸ“','ğŸ«','ğŸˆ','ğŸ’','ğŸ‘','ğŸ¥­','ğŸ','ğŸ¥¥','ğŸ¥','ğŸ…','ğŸ†','ğŸ¥‘','ğŸ¥¦','ğŸ¥¬','ğŸ¥’','ğŸŒ¶ï¸','ğŸ«‘','ğŸŒ½','ğŸ¥•','ğŸ«’','ğŸ§„','ğŸ§…','ğŸ¥”','ğŸ ','ğŸ¥','ğŸ¥¯','ğŸ','ğŸ¥–','ğŸ¥¨','ğŸ§€','ğŸ¥š','ğŸ³','ğŸ§ˆ','ğŸ¥','ğŸ§‡','ğŸ¥“','ğŸ¥©','ğŸ—','ğŸ–','ğŸ¦´','ğŸŒ­','ğŸ”','ğŸŸ','ğŸ•','ğŸ«“','ğŸ¥ª','ğŸ¥™','ğŸ§†','ğŸŒ®','ğŸŒ¯','ğŸ«”','ğŸ¥—','ğŸ¥˜','ğŸ«•','ğŸ¥«','ğŸ','ğŸœ','ğŸ²','ğŸ›','ğŸ£','ğŸ±','ğŸ¥Ÿ','ğŸ¦ª','ğŸ¤','ğŸ™','ğŸš','ğŸ˜','ğŸ¥','ğŸ¥ ','ğŸ¥®','ğŸ¢','ğŸ¡','ğŸ§','ğŸ¨','ğŸ¦','ğŸ¥§','ğŸ§','ğŸ°','ğŸ‚','ğŸ®','ğŸ­','ğŸ¬','ğŸ«','ğŸ¿','ğŸ©','ğŸª','ğŸŒ°','ğŸ¥œ','ğŸ¯','ğŸ¥›','ğŸ¼','â˜•','ğŸ«–','ğŸµ','ğŸ§ƒ','ğŸ¥¤','ğŸ§‹','ğŸ¶','ğŸº','ğŸ»','ğŸ¥‚','ğŸ·','ğŸ¥ƒ','ğŸ¸','ğŸ¹','ğŸ§‰','ğŸ¾','ğŸ§Š','ğŸ¥„','ğŸ´','ğŸ¥£'],
    symbols: ['â¤ï¸','ğŸ§¡','ğŸ’›','ğŸ’š','ğŸ’™','ğŸ’œ','ğŸ–¤','ğŸ¤','ğŸ¤','ğŸ’”','â¤ï¸â€ğŸ”¥','â¤ï¸â€ğŸ©¹','â£ï¸','ğŸ’•','ğŸ’','ğŸ’“','ğŸ’—','ğŸ’–','ğŸ’˜','ğŸ’','ğŸ’Ÿ','â˜®ï¸','âœï¸','â˜ªï¸','ğŸ•‰ï¸','â˜¸ï¸','âœ¡ï¸','ğŸ”¯','ğŸ•','â˜¯ï¸','â˜¦ï¸','ğŸ›','â›','â™ˆ','â™‰','â™Š','â™‹','â™Œ','â™','â™','â™','â™','â™‘','â™’','â™“','ğŸ†”','âš›ï¸','ğŸ‰‘','â˜¢ï¸','â˜£ï¸','ğŸ“´','ğŸ“³','ğŸˆ¶','ğŸˆš','ğŸˆ¸','ğŸˆº','ğŸˆ·ï¸','âœ´ï¸','ğŸ†š','ğŸ’®','ğŸ‰','ãŠ™ï¸','ãŠ—ï¸','ğŸˆ´','ğŸˆµ','ğŸˆ¹','ğŸˆ²','ğŸ…°ï¸','ğŸ…±ï¸','ğŸ†','ğŸ†‘','ğŸ…¾ï¸','ğŸ†˜','âŒ','â­•','ğŸ›‘','â›”','ğŸ“›','ğŸš«','ğŸ’¢','â™¨ï¸','ğŸš·','ğŸš¯','ğŸš³','ğŸš±','ğŸ”','ğŸ“µ','ğŸš­','â—','â•','â“','â”','â€¼ï¸','â‰ï¸','ğŸ”…','ğŸ”†','ã€½ï¸','âš ï¸','ğŸš¸','ğŸ”±','âšœï¸','ğŸ”°','â™»ï¸','âœ…','ğŸˆ¯ï¸','ğŸ’¹','â‡ï¸','âœ³ï¸','â','ğŸŒ','ğŸ’ ','â“‚ï¸','ğŸŒ€','ğŸ’¤','ğŸ§','ğŸš¾','â™¿','ğŸ…¿ï¸','ğŸ›—','ğŸˆ³','ğŸˆ‚ï¸','ğŸ›‚','ğŸ›ƒ','ğŸ›„','ğŸ›…','ğŸš¹','ğŸšº','ğŸš¼','âš§','ğŸš»','ğŸš®','ğŸ¦','ğŸ“¶','ğŸˆ','ğŸ”¤','ğŸ†’','ğŸ†“','ğŸ†•','ğŸ†–','ğŸ†—','ğŸ†™','ğŸ','ğŸš©','ğŸŒ','ğŸ´','ğŸ³ï¸','ğŸ³ï¸â€ğŸŒˆ','ğŸ³ï¸â€âš§ï¸','ğŸ´â€â˜ ï¸','ğŸ”´','ğŸŸ ','ğŸŸ¡','ğŸŸ¢','ğŸ”µ','ğŸŸ£','ğŸŸ¤','âš«','âšª','â¬›','â¬œ']
  };

  const emojiBackdrop = document.getElementById('emojiModalBackdrop');
  const emojiModal = document.getElementById('emojiModal');
  const emojiSearch = document.getElementById('emojiSearch');
  const emojiCategoriesDiv = document.getElementById('emojiCategories');
  const emojiGrid = document.getElementById('emojiGrid');

  let activeInputElement = null;
  let currentEmojiCategory = 'smileys';
  let currentEmojiSearch = '';

  function renderEmojis() {
    let emojis = emojiCategories[currentEmojiCategory] || [];
    if (currentEmojiSearch) {
      emojis = emojis.filter(e => e.includes(currentEmojiSearch));
    }
    emojiGrid.innerHTML = '';
    emojis.forEach(emoji => {
      const span = document.createElement('span');
      span.textContent = emoji;
      span.setAttribute('tabindex', '0');
      span.onclick = () => {
        if (activeInputElement) {
          activeInputElement.value += emoji;
        }
        emojiBackdrop.classList.remove('active');
      };
      span.onkeydown = (e) => {
        if (e.key === 'Enter' || e.key === ' ') {
          e.preventDefault();
          span.click();
        }
      };
      emojiGrid.appendChild(span);
    });
  }

  function setupEmojiCategories() {
    emojiCategoriesDiv.innerHTML = '';
    Object.keys(emojiCategories).forEach(cat => {
      const btn = document.createElement('span');
      btn.className = 'emoji-category';
      btn.textContent = cat === 'smileys' ? 'ğŸ˜Š' : cat === 'nature' ? 'ğŸ¶' : cat === 'food' ? 'ğŸ”' : 'ğŸ”£';
      btn.dataset.category = cat;
      btn.onclick = () => {
        document.querySelectorAll('.emoji-category').forEach(c => c.classList.remove('active'));
        btn.classList.add('active');
        currentEmojiCategory = cat;
        renderEmojis();
      };
      emojiCategoriesDiv.appendChild(btn);
    });
    emojiCategoriesDiv.firstChild?.classList.add('active');
  }

  emojiSearch.addEventListener('input', (e) => {
    currentEmojiSearch = e.target.value;
    renderEmojis();
  });

  setupEmojiCategories();
  renderEmojis();

  function openEmojiPicker(inputElement) {
    activeInputElement = inputElement;
    emojiBackdrop.classList.add('active');
  }

  emojiBackdrop.addEventListener('click', (e) => {
    if (e.target === emojiBackdrop) {
      emojiBackdrop.classList.remove('active');
    }
  });

  // ĞŸÑ–Ğ´ĞºĞ»ÑÑ‡Ğ°Ñ”Ğ¼Ğ¾ ĞºĞ½Ğ¾Ğ¿ĞºĞ¸ Ğ´Ğ¾ Ğ¿Ğ¾Ğ»Ñ–Ğ²
  document.getElementById('postEmojiBtn').onclick = () => openEmojiPicker(document.getElementById('postText'));

  // Ğ”Ğ»Ñ ĞºĞ¾Ğ¼ĞµĞ½Ñ‚Ğ°Ñ€Ñ–Ğ² Ğ´Ğ¸Ğ½Ğ°Ğ¼Ñ–Ñ‡Ğ½Ğ¾ Ğ´Ğ¾Ğ´Ğ°Ğ¼Ğ¾ Ğ¾Ğ±Ñ€Ğ¾Ğ±Ğ½Ğ¸ĞºĞ¸ Ğ¿Ñ–ÑĞ»Ñ Ñ€ĞµĞ½Ğ´ĞµÑ€Ñƒ
  function setupCommentEmojiButtons() {
    document.querySelectorAll('.comment-emoji-btn').forEach(btn => {
      btn.onclick = (e) => {
        const inputId = btn.dataset.inputId;
        const input = document.getElementById(inputId);
        if (input) openEmojiPicker(input);
      };
    });
  }

  // ================= ĞĞ’Ğ¢ĞĞ Ğ˜Ğ—ĞĞ¦Ğ†Ğ¯ =================
  document.getElementById('toRegister').onclick = () => {
    document.getElementById('loginForm').style.display = 'none';
    document.getElementById('registerForm').style.display = 'block';
  };
  document.getElementById('toLogin').onclick = () => {
    document.getElementById('registerForm').style.display = 'none';
    document.getElementById('loginForm').style.display = 'block';
  };

  document.getElementById('registerBtn').onclick = async () => {
    const nickname = document.getElementById('registerNickname').value.trim();
    const password = document.getElementById('registerPassword').value.trim();
    if (!nickname) return alert('Ğ’Ğ²ĞµĞ´Ñ–Ñ‚ÑŒ Ğ¿ÑĞµĞ²Ğ´Ğ¾Ğ½Ñ–Ğ¼');
    if (password.length < 6) return alert('ĞœÑ–Ğ½Ñ–Ğ¼ÑƒĞ¼ 6 ÑĞ¸Ğ¼Ğ²Ğ¾Ğ»Ñ–Ğ²');
    
    const userId = `@${nickname.toLowerCase()}`;
    const q = query(collection(db, "users"), where("userId", "==", userId));
    const snap = await getDocs(q);
    if (!snap.empty) return alert('Ğ¦ĞµĞ¹ ID Ğ²Ğ¶Ğµ Ğ·Ğ°Ğ¹Ğ½ÑÑ‚Ğ¸Ğ¹');
    
    try {
      const safeNick = nickname.toLowerCase().replace(/[^a-z0-9]/g, '');
      const randomSuffix = Math.floor(Math.random() * 10000);
      const email = `${safeNick}_${randomSuffix}@fantasyas.local`;
      
      const cred = await createUserWithEmailAndPassword(auth, email, password);
      
      await setDoc(doc(db, "users", cred.user.uid), {
        nickname,
        userId,
        nickname_lower: nickname.toLowerCase(),
        bio: '',
        avatar: '',
        posts: [],
        likedPosts: [],
        savedPosts: [],
        followers: [],
        following: [],
        mutedUsers: [],
        blockedUsers: [],
        createdAt: serverTimestamp(),
        lastOnline: serverTimestamp(),
        email: email
      });
      
      showToast('Ğ ĞµÑ”ÑÑ‚Ñ€Ğ°Ñ†Ñ–Ñ ÑƒÑĞ¿Ñ–ÑˆĞ½Ğ°');
      document.getElementById('toLogin').click();
    } catch (e) { showToast(e.message); }
  };

  document.getElementById('loginBtn').onclick = async () => {
    const nickname = document.getElementById('loginNickname').value.trim();
    const password = document.getElementById('loginPassword').value.trim();
    if (!nickname || !password) return alert('Ğ—Ğ°Ğ¿Ğ¾Ğ²Ğ½Ñ–Ñ‚ÑŒ Ğ¿Ğ¾Ğ»Ñ');
    try {
      const userId = `@${nickname.toLowerCase()}`;
      const q = query(collection(db, "users"), where("userId", "==", userId));
      const snap = await getDocs(q);
      if (snap.empty) return alert('ĞšĞ¾Ñ€Ğ¸ÑÑ‚ÑƒĞ²Ğ°Ñ‡Ğ° Ğ½Ğµ Ğ·Ğ½Ğ°Ğ¹Ğ´ĞµĞ½Ğ¾');
      
      const userDoc = snap.docs[0];
      const userData = userDoc.data();
      const email = userData.email;
      
      if (!email) {
        return alert('Ğ”Ğ»Ñ Ñ†ÑŒĞ¾Ğ³Ğ¾ Ğ°ĞºĞ°ÑƒĞ½Ñ‚Ñƒ Ğ½Ğµ Ğ²ÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¾ email. Ğ£Ğ²Ñ–Ğ¹Ğ´Ñ–Ñ‚ÑŒ Ñ‡ĞµÑ€ĞµĞ· Google Ğ°Ğ±Ğ¾ Apple, Ğ°Ğ±Ğ¾ ÑÑ‚Ğ²Ğ¾Ñ€Ñ–Ñ‚ÑŒ Ğ½Ğ¾Ğ²Ğ¸Ğ¹ Ğ°ĞºĞ°ÑƒĞ½Ñ‚.');
      }
      
      await signInWithEmailAndPassword(auth, email, password);
      showToast('Ğ›Ğ°ÑĞºĞ°Ğ²Ğ¾ Ğ¿Ñ€Ğ¾ÑĞ¸Ğ¼Ğ¾!');
    } catch (err) {
      alert('ĞĞµĞ²Ñ–Ñ€Ğ½Ğ¸Ğ¹ Ğ¿ÑĞµĞ²Ğ´Ğ¾Ğ½Ñ–Ğ¼ Ğ°Ğ±Ğ¾ Ğ¿Ğ°Ñ€Ğ¾Ğ»ÑŒ');
    }
  };

  document.getElementById('googleLoginBtn').onclick = async () => {
    const provider = new GoogleAuthProvider();
    try {
      const result = await signInWithPopup(auth, provider);
      const user = result.user;
      const userDoc = await getDoc(doc(db, "users", user.uid));
      if (!userDoc.exists()) {
        const nickname = user.displayName || user.email?.split('@')[0] || 'user';
        let userId = `@${nickname.toLowerCase()}`;
        const q = query(collection(db, "users"), where("userId", "==", userId));
        const snap = await getDocs(q);
        if (!snap.empty) userId = `@${nickname.toLowerCase()}${Math.floor(Math.random()*1000)}`;
        await setDoc(doc(db, "users", user.uid), {
          nickname,
          userId,
          nickname_lower: nickname.toLowerCase(),
          bio: '',
          avatar: user.photoURL || '',
          posts: [],
          likedPosts: [],
          savedPosts: [],
          followers: [],
          following: [],
          mutedUsers: [],
          blockedUsers: [],
          createdAt: serverTimestamp(),
          lastOnline: serverTimestamp(),
          email: user.email
        });
      }
      showToast('Ğ’Ñ…Ñ–Ğ´ Ñ‡ĞµÑ€ĞµĞ· Google ÑƒÑĞ¿Ñ–ÑˆĞ½Ğ¸Ğ¹');
    } catch (error) {
      showToast('ĞŸĞ¾Ğ¼Ğ¸Ğ»ĞºĞ°: ' + error.message);
    }
  };

  document.getElementById('appleLoginBtn').onclick = async () => {
    const provider = new OAuthProvider('apple.com');
    provider.addScope('email');
    provider.addScope('name');
    try {
      const result = await signInWithPopup(auth, provider);
      const user = result.user;
      const userDoc = await getDoc(doc(db, "users", user.uid));
      if (!userDoc.exists()) {
        const nickname = user.displayName || user.email?.split('@')[0] || 'user';
        let userId = `@${nickname.toLowerCase()}`;
        const q = query(collection(db, "users"), where("userId", "==", userId));
        const snap = await getDocs(q);
        if (!snap.empty) userId = `@${nickname.toLowerCase()}${Math.floor(Math.random()*1000)}`;
        await setDoc(doc(db, "users", user.uid), {
          nickname,
          userId,
          nickname_lower: nickname.toLowerCase(),
          bio: '',
          avatar: user.photoURL || '',
          posts: [],
          likedPosts: [],
          savedPosts: [],
          followers: [],
          following: [],
          mutedUsers: [],
          blockedUsers: [],
          createdAt: serverTimestamp(),
          lastOnline: serverTimestamp(),
          email: user.email
        });
      }
      showToast('Ğ’Ñ…Ñ–Ğ´ Ñ‡ĞµÑ€ĞµĞ· Apple ÑƒÑĞ¿Ñ–ÑˆĞ½Ğ¸Ğ¹');
    } catch (error) {
      showToast('ĞŸĞ¾Ğ¼Ğ¸Ğ»ĞºĞ°: ' + error.message);
    }
  };

  document.getElementById('forgotPassword').onclick = async (e) => {
    e.preventDefault();
    const nickname = prompt('Ğ’Ğ²ĞµĞ´Ñ–Ñ‚ÑŒ Ğ²Ğ°Ñˆ Ğ¿ÑĞµĞ²Ğ´Ğ¾Ğ½Ñ–Ğ¼ (Ğ±ĞµĞ· @)');
    if (!nickname) return;
    
    const userId = `@${nickname.toLowerCase()}`;
    const q = query(collection(db, "users"), where("userId", "==", userId));
    const snap = await getDocs(q);
    if (snap.empty) return alert('ĞšĞ¾Ñ€Ğ¸ÑÑ‚ÑƒĞ²Ğ°Ñ‡Ğ° Ğ½Ğµ Ğ·Ğ½Ğ°Ğ¹Ğ´ĞµĞ½Ğ¾');
    
    const userData = snap.docs[0].data();
    const email = userData.email;
    if (!email) return alert('Ğ”Ğ»Ñ Ñ†ÑŒĞ¾Ğ³Ğ¾ Ğ°ĞºĞ°ÑƒĞ½Ñ‚Ñƒ Ğ½Ğµ Ğ²ĞºĞ°Ğ·Ğ°Ğ½Ğ¾ email. Ğ£Ğ²Ñ–Ğ¹Ğ´Ñ–Ñ‚ÑŒ Ñ‡ĞµÑ€ĞµĞ· Google/Apple Ğ°Ğ±Ğ¾ ÑÑ‚Ğ²Ğ¾Ñ€Ñ–Ñ‚ÑŒ Ğ½Ğ¾Ğ²Ğ¸Ğ¹ Ğ°ĞºĞ°ÑƒĞ½Ñ‚.');
    
    try {
      await sendPasswordResetEmail(auth, email);
      showToast('Ğ›Ğ¸ÑÑ‚ Ğ´Ğ»Ñ ÑĞºĞ¸Ğ´Ğ°Ğ½Ğ½Ñ Ğ¿Ğ°Ñ€Ğ¾Ğ»Ñ Ğ²Ñ–Ğ´Ğ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¾');
    } catch (err) {
      showToast('ĞŸĞ¾Ğ¼Ğ¸Ğ»ĞºĞ°: ' + err.message);
    }
  };

  // ================= ĞĞ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ½Ñ ÑÑ‚Ğ°Ğ½Ñƒ ĞºĞ¾Ñ€Ğ¸ÑÑ‚ÑƒĞ²Ğ°Ñ‡Ğ° =================
  onAuthStateChanged(auth, (user) => {
    cleanupListeners();
    
    if (user) {
      currentUser = user;
      currentProfileUid = user.uid;
      const authBox = document.getElementById('authBox');
      if (authBox) authBox.style.display = 'none';
      const newPostBox = document.getElementById('newPostBox');
      if (newPostBox) newPostBox.style.display = 'block';
      
      lastOnlineInterval = setInterval(() => {
        updateDoc(doc(db, "users", currentUser.uid), { lastOnline: serverTimestamp() }).catch(console.error);
      }, 30000);

      resetPagination();
      loadMyProfile();
      
      const q = query(collection(db, "chats"), where("participants", "array-contains", currentUser.uid));
      unsubscribeChatList = onSnapshot(q, (snapshot) => {
        let totalUnread = 0;
        snapshot.forEach(doc => {
          const data = doc.data();
          if (data.unread && data.unread[currentUser.uid]) {
            totalUnread += data.unread[currentUser.uid];
          }
        });
        unreadCount = totalUnread;
        updateUnreadBadge();
        if (document.getElementById('chats')?.classList.contains('active')) {
          loadChatList();
        }
      }, (error) => {
        console.error('Chat list snapshot error:', error);
        showToast('ĞŸĞ¾Ğ¼Ğ¸Ğ»ĞºĞ° Ğ¾Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ½Ñ ÑĞ¿Ğ¸ÑĞºÑƒ Ñ‡Ğ°Ñ‚Ñ–Ğ². ĞŸĞµÑ€ĞµĞ²Ñ–Ñ€Ñ‚Ğµ Ñ–Ğ½Ğ´ĞµĞºÑĞ¸ Firestore.');
      });

      setupFileInput('postMedia', 'attachMediaBtn', 'postMediaPreview');
      setupFileInput('editAvatar', 'editAvatarBtn', 'editAvatarPreview');
      setupFileInput('editPostMedia', 'editPostMediaBtn', 'editPostMediaPreview');

    } else {
      currentUser = null;
      const authBox = document.getElementById('authBox');
      if (authBox) authBox.style.display = 'block';
      const newPostBox = document.getElementById('newPostBox');
      if (newPostBox) newPostBox.style.display = 'none';
      unreadCount = 0;
      updateUnreadBadge();
    }
  });

  // ================= ĞšĞ°ÑÑ‚Ğ¾Ğ¼Ğ½Ğ¸Ğ¹ Ğ²Ğ¸Ğ±Ñ–Ñ€ Ñ„Ğ°Ğ¹Ğ»Ñƒ =================
  function setupFileInput(inputId, buttonId, previewId) {
    const input = document.getElementById(inputId);
    const button = document.getElementById(buttonId);
    const preview = document.getElementById(previewId);
    if (!input || !button) return;

    button.addEventListener('click', () => input.click());

    input.addEventListener('change', function() {
      if (this.files && this.files[0]) {
        const file = this.files[0];
        button.textContent = file.name.length > 30 ? file.name.substring(0,30)+'â€¦' : file.name;
        
        if (preview) {
          if (file.type.startsWith('image/')) {
            const reader = new FileReader();
            reader.onload = (e) => {
              preview.src = e.target.result;
              preview.style.display = 'block';
            };
            reader.readAsDataURL(file);
          } else if (file.type.startsWith('video/')) {
            preview.src = '';
            preview.style.display = 'none';
          }
        }
      } else {
        button.textContent = inputId.includes('Avatar') ? 'ĞĞ±Ñ€Ğ°Ñ‚Ğ¸ Ğ°Ğ²Ğ°Ñ‚Ğ°Ñ€' : 'ğŸ“ ĞĞ±Ñ€Ğ°Ñ‚Ğ¸ Ğ¼ĞµĞ´Ñ–Ğ°';
        if (preview) preview.style.display = 'none';
      }
    });
  }

  // ================= Ğ¤ÑƒĞ½ĞºÑ†Ñ–Ñ— Ğ´Ğ»Ñ Ñ…ĞµÑˆÑ‚ĞµĞ³Ñ–Ğ² =================
  function extractHashtags(text) {
    const regex = /#(\w+)/g;
    const matches = text.match(regex);
    return matches ? matches.map(tag => tag.toLowerCase()) : [];
  }

  async function loadHashtags() {
    const list = document.getElementById('hashtagList');
    if (!list) return;
    list.innerHTML = '<div class="skeleton" style="height:50px;"></div>';

    try {
      const postsSnap = await getDocs(collection(db, "posts"));
      const tagCount = new Map();
      postsSnap.forEach(doc => {
        const tags = doc.data().hashtags || [];
        tags.forEach(tag => {
          tagCount.set(tag, (tagCount.get(tag) || 0) + 1);
        });
      });

      const sortedTags = Array.from(tagCount.entries()).sort((a, b) => b[1] - a[1]).slice(0, 20);
      
      list.innerHTML = '';
      if (sortedTags.length === 0) {
        list.innerHTML = '<p style="text-align:center; padding:16px;">' + (translations[currentLanguage]?.popularHashtags || 'ĞŸĞ¾ĞºĞ¸ Ğ½ĞµĞ¼Ğ°Ñ” Ñ…ĞµÑˆÑ‚ĞµĞ³Ñ–Ğ²') + '</p>';
        return;
      }

      sortedTags.forEach(([tag, count]) => {
        const div = document.createElement('div');
        div.className = 'hashtag-item';
        div.innerHTML = `
          <span class="hashtag-name">${tag}</span>
          <span class="hashtag-count">${count} ${translations[currentLanguage]?.posts || 'Ğ¿Ğ¾ÑÑ‚Ñ–Ğ²'}</span>
        `;
        div.onclick = () => searchHashtag(tag);
        list.appendChild(div);
      });
    } catch (e) {
      console.error('Error loading hashtags:', e);
      list.innerHTML = '<p style="text-align:center; padding:16px;">' + (translations[currentLanguage]?.error || 'ĞŸĞ¾Ğ¼Ğ¸Ğ»ĞºĞ° Ğ·Ğ°Ğ²Ğ°Ğ½Ñ‚Ğ°Ğ¶ĞµĞ½Ğ½Ñ') + '</p>';
    }
  }

  function searchHashtag(tag) {
    const searchInput = document.getElementById('searchInput');
    if (searchInput) {
      searchInput.value = '#' + tag;
      document.querySelector('[data-section="search"]').click();
      loadSearchUsers();
    }
  }

  // ================= Ğ¡Ñ‚Ñ€Ñ–Ñ‡ĞºĞ° =================
  document.getElementById('feedNewBtn').onclick = () => {
    if (currentFeedType === 'new') return;
    currentFeedType = 'new';
    resetPagination();
  };
  document.getElementById('feedPopularBtn').onclick = () => {
    if (currentFeedType === 'popular') return;
    currentFeedType = 'popular';
    resetPagination();
  };

  function resetPagination() {
    lastVisible = null;
    hasMore = true;
    const feed = document.getElementById('feed');
    if (feed) feed.innerHTML = '';
    loadMorePosts();
  }

  document.getElementById('addPost').onclick = async () => {
    if (!currentUser) return alert('Ğ£Ğ²Ñ–Ğ¹Ğ´Ñ–Ñ‚ÑŒ');
    const text = document.getElementById('postText').value.trim();
    const file = document.getElementById('postMedia').files[0];
    if (!text && !file) return alert('Ğ”Ğ¾Ğ´Ğ°Ğ¹Ñ‚Ğµ Ñ‚ĞµĞºÑÑ‚ Ğ°Ğ±Ğ¾ Ğ¼ĞµĞ´Ñ–Ğ°');
    try {
      let mediaUrl = '', mediaType = '';
      if (file) {
        const storageRef = ref(storage, `posts/${currentUser.uid}/${Date.now()}_${file.name}`);
        await uploadBytes(storageRef, file);
        mediaUrl = await getDownloadURL(storageRef);
        mediaType = file.type.split('/')[0];
      }
      const userSnap = await getDoc(doc(db, "users", currentUser.uid));
      const userData = userSnap.data();
      
      const hashtags = extractHashtags(text);
      
      const postDoc = await addDoc(collection(db, "posts"), {
        author: currentUser.uid,
        authorType: 'user',
        authorName: userData.nickname,
        authorUserId: userData.userId,
        authorAvatar: userData.avatar || '',
        text,
        mediaUrl,
        mediaType,
        createdAt: serverTimestamp(),
        likes: [],
        likesCount: 0,
        commentsCount: 0,
        saves: [],
        views: 0,
        hashtags: hashtags
      });
      await updateDoc(doc(db, "users", currentUser.uid), { posts: arrayUnion(postDoc.id) });
      document.getElementById('postText').value = '';
      document.getElementById('postMedia').value = '';
      document.getElementById('attachMediaBtn').textContent = 'ğŸ“ ĞĞ±Ñ€Ğ°Ñ‚Ğ¸ Ğ¼ĞµĞ´Ñ–Ğ°';
      document.getElementById('postMediaPreview').style.display = 'none';
      showToast('ĞŸĞ¾ÑÑ‚ Ğ¾Ğ¿ÑƒĞ±Ğ»Ñ–ĞºĞ¾Ğ²Ğ°Ğ½Ğ¾!');
    } catch (e) { showToast(e.message); }
  };

  async function loadMorePosts() {
    if (!currentUser || loading || !hasMore) return;
    loading = true;
    const skeleton = document.getElementById('skeletonContainer');
    if (skeleton) skeleton.style.display = 'block';
    
    try {
      let q;
      if (currentFeedType === 'new') {
        q = query(collection(db, "posts"), orderBy("createdAt", "desc"), limit(10));
      } else {
        q = query(collection(db, "posts"), orderBy("likesCount", "desc"), orderBy("createdAt", "desc"), limit(10));
      }
      if (lastVisible) q = query(q, startAfter(lastVisible));
      
      const snapshot = await getDocs(q);
      if (snapshot.empty) { hasMore = false; return; }
      
      lastVisible = snapshot.docs[snapshot.docs.length - 1];
      renderPosts(snapshot.docs);
    } catch (e) {
      console.error("ĞŸĞ¾Ğ¼Ğ¸Ğ»ĞºĞ° Ğ·Ğ°Ğ²Ğ°Ğ½Ñ‚Ğ°Ğ¶ĞµĞ½Ğ½Ñ Ğ¿Ğ¾ÑÑ‚Ñ–Ğ²:", e);
      showToast("ĞŸĞ¾Ğ¼Ğ¸Ğ»ĞºĞ° Ğ·Ğ°Ğ²Ğ°Ğ½Ñ‚Ğ°Ğ¶ĞµĞ½Ğ½Ñ. ĞŸĞµÑ€ĞµĞ²Ñ–Ñ€Ñ‚Ğµ Ñ–Ğ½Ğ´ĞµĞºÑĞ¸ Firestore.");
    } finally {
      if (skeleton) skeleton.style.display = 'none';
      loading = false;
    }
  }

  // ================= Ğ¤Ğ£ĞĞšĞ¦Ğ†Ğ‡ Ğ”Ğ›Ğ¯ ĞšĞĞœĞ•ĞĞ¢ĞĞ Ğ†Ğ’ =================
  async function loadComments(postId, container) {
    const q = query(collection(db, `posts/${postId}/comments`), orderBy("createdAt", "asc"));
    const snapshot = await getDocs(q);
    container.innerHTML = '';
    for (const docSnap of snapshot.docs) {
      const comment = docSnap.data();
      const commentId = docSnap.id;
      const commentEl = document.createElement('div');
      commentEl.className = 'comment';
      commentEl.dataset.commentId = commentId;
      
      const repliesSnapshot = await getDocs(query(collection(db, `posts/${postId}/comments/${commentId}/replies`), orderBy("createdAt", "asc")));
      const replies = [];
      repliesSnapshot.forEach(r => replies.push({ id: r.id, ...r.data() }));

      const liked = comment.likes?.includes(currentUser?.uid) || false;
      
      commentEl.innerHTML = `
        <div class="comment-main">
          <div class="comment-avatar" style="background-image:url(${comment.authorAvatar || ''})" data-uid="${comment.author}"></div>
          <div class="comment-content">
            <div>
              <span class="comment-author" data-uid="${comment.author}">${comment.authorName}</span>
              <span class="comment-time">${new Date(comment.createdAt?.seconds * 1000).toLocaleString()}</span>
            </div>
            <div class="comment-text">${comment.text}</div>
          </div>
        </div>
        <div class="comment-actions">
          <button class="like-comment-btn ${liked ? 'liked' : ''}" data-post-id="${postId}" data-comment-id="${commentId}">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/></svg>
            <span>${comment.likesCount || 0}</span>
          </button>
          <button class="reply-btn" data-post-id="${postId}" data-comment-id="${commentId}">${translations[currentLanguage]?.reply || 'Ğ’Ñ–Ğ´Ğ¿Ğ¾Ğ²Ñ–ÑÑ‚Ğ¸'}</button>
        </div>
        <div class="replies" id="replies-${postId}-${commentId}">
          ${replies.map(r => `
            <div class="reply">
              <div class="comment-avatar" style="background-image:url(${r.authorAvatar || ''})" data-uid="${r.author}"></div>
              <div class="comment-content">
                <div>
                  <span class="comment-author" data-uid="${r.author}">${r.authorName}</span>
                  <span class="comment-time">${new Date(r.createdAt?.seconds * 1000).toLocaleString()}</span>
                </div>
                <div class="comment-text">${r.text}</div>
              </div>
            </div>
          `).join('')}
        </div>
        <div class="reply-form" id="reply-form-${postId}-${commentId}" style="display: none;">
          <input type="text" class="reply-input" placeholder="Ğ’Ğ°ÑˆĞ° Ğ²Ñ–Ğ´Ğ¿Ğ¾Ğ²Ñ–Ğ´ÑŒ..." id="reply-input-${postId}-${commentId}">
          <button class="btn btn-primary btn-icon send-reply" data-post-id="${postId}" data-comment-id="${commentId}">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></svg>
          </button>
        </div>
      `;
      container.appendChild(commentEl);
    }

    // Ğ”Ğ¾Ğ´Ğ°Ñ”Ğ¼Ğ¾ Ğ¾Ğ±Ñ€Ğ¾Ğ±Ğ½Ğ¸ĞºĞ¸ Ğ´Ğ»Ñ ĞºĞ½Ğ¾Ğ¿Ğ¾Ğº Ğ²Ñ–Ğ´Ğ¿Ğ¾Ğ²Ñ–Ğ´Ñ–
    document.querySelectorAll('.reply-btn').forEach(btn => {
      btn.addEventListener('click', (e) => {
        const postId = btn.dataset.postId;
        const commentId = btn.dataset.commentId;
        const form = document.getElementById(`reply-form-${postId}-${commentId}`);
        form.style.display = form.style.display === 'none' ? 'flex' : 'none';
      });
    });

    // ĞĞ±Ñ€Ğ¾Ğ±Ğ½Ğ¸ĞºĞ¸ Ğ´Ğ»Ñ Ğ½Ğ°Ğ´ÑĞ¸Ğ»Ğ°Ğ½Ğ½Ñ Ğ²Ñ–Ğ´Ğ¿Ğ¾Ğ²Ñ–Ğ´Ñ–
    document.querySelectorAll('.send-reply').forEach(btn => {
      btn.addEventListener('click', async (e) => {
        const postId = btn.dataset.postId;
        const commentId = btn.dataset.commentId;
        const input = document.getElementById(`reply-input-${postId}-${commentId}`);
        const text = input.value.trim();
        if (!text) return;

        try {
          const userSnap = await getDoc(doc(db, "users", currentUser.uid));
          const user = userSnap.data();
          const replyRef = collection(db, `posts/${postId}/comments/${commentId}/replies`);
          await addDoc(replyRef, {
            author: currentUser.uid,
            authorName: user.nickname,
            authorAvatar: user.avatar || '',
            text: text,
            createdAt: serverTimestamp()
          });
          input.value = '';
          document.getElementById(`reply-form-${postId}-${commentId}`).style.display = 'none';
          const commentsContainer = document.getElementById(`comments-list-${postId}`);
          await loadComments(postId, commentsContainer);
        } catch (error) {
          console.error('Error sending reply:', error);
          showToast('ĞŸĞ¾Ğ¼Ğ¸Ğ»ĞºĞ° Ğ¿Ñ€Ğ¸ Ğ²Ñ–Ğ´Ğ¿Ğ¾Ğ²Ñ–Ğ´Ñ–');
        }
      });
    });

    // ĞĞ±Ñ€Ğ¾Ğ±Ğ½Ğ¸ĞºĞ¸ Ğ´Ğ»Ñ Ğ»Ğ°Ğ¹ĞºÑ–Ğ² ĞºĞ¾Ğ¼ĞµĞ½Ñ‚Ğ°Ñ€Ñ–Ğ²
    document.querySelectorAll('.like-comment-btn').forEach(btn => {
      btn.addEventListener('click', async (e) => {
        e.stopPropagation();
        const postId = btn.dataset.postId;
        const commentId = btn.dataset.commentId;
        const liked = btn.classList.contains('liked');
        const countSpan = btn.querySelector('span');
        const oldCount = parseInt(countSpan.textContent);
        
        btn.classList.toggle('liked');
        countSpan.textContent = liked ? oldCount - 1 : oldCount + 1;
        
        try {
          const commentRef = doc(db, `posts/${postId}/comments`, commentId);
          if (liked) {
            await updateDoc(commentRef, { likes: arrayRemove(currentUser.uid), likesCount: increment(-1) });
          } else {
            await updateDoc(commentRef, { likes: arrayUnion(currentUser.uid), likesCount: increment(1) });
          }
        } catch (error) {
          btn.classList.toggle('liked');
          countSpan.textContent = oldCount;
          showToast('ĞŸĞ¾Ğ¼Ğ¸Ğ»ĞºĞ°');
        }
      });
    });
  }

  async function addComment(postId, text) {
    if (!currentUser || !text.trim()) return;
    const userSnap = await getDoc(doc(db, "users", currentUser.uid));
    const user = userSnap.data();
    const commentRef = collection(db, `posts/${postId}/comments`);
    await addDoc(commentRef, {
      author: currentUser.uid,
      authorName: user.nickname,
      authorAvatar: user.avatar || '',
      text: text.trim(),
      createdAt: serverTimestamp(),
      likes: [],
      likesCount: 0
    });
    await updateDoc(doc(db, "posts", postId), { commentsCount: increment(1) });
  }

  async function incrementPostView(postId) {
    if (!currentUser) return;
    if (viewedPosts.has(postId)) return;
    viewedPosts.add(postId);
    try {
      await updateDoc(doc(db, "posts", postId), { views: increment(1) });
    } catch (e) {
      console.warn("ĞĞµ Ğ²Ğ´Ğ°Ğ»Ğ¾ÑÑ Ğ¾Ğ½Ğ¾Ğ²Ğ¸Ñ‚Ğ¸ Ğ¿ĞµÑ€ĞµĞ³Ğ»ÑĞ´Ğ¸:", e);
    }
  }

  function renderPosts(docs, container = null) {
    const feed = container || document.getElementById('feed');
    if (!feed) return;
    docs.forEach(docSnap => {
      const post = { id: docSnap.id, ...docSnap.data() };
      const liked = post.likes?.includes(currentUser?.uid) || false;
      const saved = post.saves?.includes(currentUser?.uid) || false;
      const postTime = post.createdAt ? new Date(post.createdAt.seconds * 1000).toLocaleString() : '';
      const isAuthor = currentUser && post.author === currentUser.uid;
      const postEl = document.createElement('div');
      postEl.className = 'post';
      postEl.dataset.postId = post.id;
      
      let actionsHtml = '';
      if (isAuthor) {
        actionsHtml = `
          <div class="post-actions">
            <button class="edit-post-btn" title="Ğ ĞµĞ´Ğ°Ğ³ÑƒĞ²Ğ°Ñ‚Ğ¸ Ğ¿Ğ¾ÑÑ‚">â‹¯</button>
          </div>
        `;
      }
      
      let contentHtml = post.text || '';
      const hashtagRegex = /#(\w+)/g;
      contentHtml = contentHtml.replace(hashtagRegex, '<span class="hashtag" data-tag="$1">#$1</span>');
      
      postEl.innerHTML = `
        ${actionsHtml}
        <div class="post-header">
          <div class="avatar small" style="background-image:url(${post.authorAvatar || ''})" data-uid="${post.author}"></div>
          <div class="post-author-info">
            <div>
              <span class="post-author" data-uid="${post.author}">${post.authorName || 'ĞĞµĞ²Ñ–Ğ´Ğ¾Ğ¼Ğ¾'}</span>
              <span class="post-meta">${post.authorUserId || ''}</span>
            </div>
            <div class="post-time">${postTime}</div>
          </div>
        </div>
        <div class="post-content">${contentHtml}</div>
        ${post.mediaUrl ? (post.mediaType==='image' ? `<img src="${post.mediaUrl}" class="post-media" loading="lazy">` : `<video src="${post.mediaUrl}" controls class="post-media"></video>`) : ''}
        <div class="post-footer">
          <button class="like-btn ${liked ? 'liked' : ''}" data-post-id="${post.id}">
            <svg viewBox="0 0 24 24" width="24" height="24"><path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/></svg>
            <span>${post.likesCount || 0}</span>
          </button>
          <button class="comment-toggle-btn" data-post-id="${post.id}">
            <svg viewBox="0 0 24 24" width="24" height="24"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>
            <span>${post.commentsCount || 0}</span>
          </button>
          <button class="save-btn ${saved ? 'saved' : ''}" data-post-id="${post.id}">
            <svg viewBox="0 0 24 24" width="24" height="24"><path d="M19 21l-7-5-7 5V5a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2z"/></svg>
          </button>
          <span class="view-count" title="ĞŸĞµÑ€ĞµĞ³Ğ»ÑĞ´Ğ¸">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><circle cx="12" cy="12" r="2"/><path d="M22 12c-2.667 4.667-6 7-10 7s-7.333-2.333-10-7c2.667-4.667 6-7 10-7s7.333 2.333 10 7z"/></svg>
            ${post.views || 0}
          </span>
        </div>
        <div class="comments-section" id="comments-${post.id}" style="display: none;">
          <div class="comments-list" id="comments-list-${post.id}"></div>
          <div class="comment-form">
            <input type="text" id="comment-input-${post.id}" class="comment-input" placeholder="ĞĞ°Ğ¿Ğ¸ÑˆÑ–Ñ‚ÑŒ ĞºĞ¾Ğ¼ĞµĞ½Ñ‚Ğ°Ñ€...">
            <div class="emoji-picker-container" style="position: relative; display:inline-block;">
              <button class="emoji-button comment-emoji-btn" data-input-id="comment-input-${post.id}">ğŸ˜Š</button>
            </div>
            <button class="btn btn-primary btn-icon" id="submit-comment-${post.id}">
              <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></svg>
            </button>
          </div>
        </div>
      `;
      feed.appendChild(postEl);

      incrementPostView(post.id);

      if (isAuthor) {
        postEl.querySelector('.edit-post-btn').onclick = () => openEditPostModal(post);
      }

      postEl.querySelectorAll('.hashtag').forEach(span => {
        span.onclick = (e) => {
          e.stopPropagation();
          const tag = span.dataset.tag;
          searchHashtag(tag);
        };
      });

      const commentInput = document.getElementById(`comment-input-${post.id}`);
      if (commentInput) {
        // Ğ•Ğ¼Ğ¾Ğ´Ğ¶Ñ– Ğ´Ğ»Ñ ĞºĞ¾Ğ¼ĞµĞ½Ñ‚Ğ°Ñ€Ñ–Ğ² Ğ±ÑƒĞ´Ğµ Ğ¿Ñ–Ğ´ĞºĞ»ÑÑ‡ĞµĞ½Ğ¾ Ñ‡ĞµÑ€ĞµĞ· Ğ·Ğ°Ğ³Ğ°Ğ»ÑŒĞ½Ğ¸Ğ¹ Ğ¾Ğ±Ñ€Ğ¾Ğ±Ğ½Ğ¸Ğº
      }

      const toggleBtn = postEl.querySelector('.comment-toggle-btn');
      const commentsSection = postEl.querySelector('.comments-section');
      toggleBtn.onclick = async () => {
        if (commentsSection.style.display === 'none') {
          commentsSection.style.display = 'block';
          const commentsList = document.getElementById(`comments-list-${post.id}`);
          if (commentsList) await loadComments(post.id, commentsList);
        } else {
          commentsSection.style.display = 'none';
        }
      };

      const submitBtn = document.getElementById(`submit-comment-${post.id}`);
      if (submitBtn) {
        submitBtn.onclick = async () => {
          const text = commentInput.value.trim();
          if (!text) return;
          try {
            await addComment(post.id, text);
            commentInput.value = '';
            const commentsList = document.getElementById(`comments-list-${post.id}`);
            if (commentsList) await loadComments(post.id, commentsList);
            const countSpan = toggleBtn.querySelector('span');
            if (countSpan) countSpan.textContent = parseInt(countSpan.textContent) + 1;
            showToast('ĞšĞ¾Ğ¼ĞµĞ½Ñ‚Ğ°Ñ€ Ğ´Ğ¾Ğ´Ğ°Ğ½Ğ¾');
          } catch (error) {
            console.error('Error adding comment:', error);
            showToast('ĞŸĞ¾Ğ¼Ğ¸Ğ»ĞºĞ°: ' + error.message);
          }
        };
      }
    });

    // ĞŸÑ–ÑĞ»Ñ Ñ€ĞµĞ½Ğ´ĞµÑ€Ñƒ Ğ¿Ñ–Ğ´ĞºĞ»ÑÑ‡Ğ°Ñ”Ğ¼Ğ¾ ĞµĞ¼Ğ¾Ğ´Ğ¶Ñ– Ğ´Ğ»Ñ Ğ²ÑÑ–Ñ… ĞºĞ¾Ğ¼ĞµĞ½Ñ‚Ğ°Ñ€Ñ–Ğ²
    setupCommentEmojiButtons();
  }

  // ================= Ğ ĞµĞ´Ğ°Ğ³ÑƒĞ²Ğ°Ğ½Ğ½Ñ Ğ¿Ğ¾ÑÑ‚Ğ° =================
  function openEditPostModal(post) {
    currentEditingPost = post;
    document.getElementById('editPostText').value = post.text || '';
    document.getElementById('editPostMedia').value = '';
    document.getElementById('editPostMediaBtn').textContent = 'Ğ—Ğ¼Ñ–Ğ½Ğ¸Ñ‚Ğ¸ Ğ¼ĞµĞ´Ñ–Ğ°';
    const preview = document.getElementById('editPostMediaPreview');
    preview.style.display = 'none';
    if (post.mediaUrl) {
      if (post.mediaType === 'image') {
        preview.src = post.mediaUrl;
        preview.style.display = 'block';
      }
    }
    document.getElementById('editPostModal').classList.add('active');
  }

  document.getElementById('closeEditPostModal').onclick = () => {
    document.getElementById('editPostModal').classList.remove('active');
    currentEditingPost = null;
  };

  document.getElementById('savePostEdit').onclick = async () => {
    if (!currentEditingPost || !currentUser) return;
    const newText = document.getElementById('editPostText').value.trim();
    const file = document.getElementById('editPostMedia').files[0];
    try {
      const postRef = doc(db, "posts", currentEditingPost.id);
      let updateData = { text: newText };
      updateData.hashtags = extractHashtags(newText);
      if (file) {
        if (currentEditingPost.mediaUrl) {
          try {
            const oldMediaRef = ref(storage, currentEditingPost.mediaUrl);
            await deleteObject(oldMediaRef);
          } catch (e) {}
        }
        const storageRef = ref(storage, `posts/${currentUser.uid}/${Date.now()}_${file.name}`);
        await uploadBytes(storageRef, file);
        const mediaUrl = await getDownloadURL(storageRef);
        const mediaType = file.type.split('/')[0];
        updateData.mediaUrl = mediaUrl;
        updateData.mediaType = mediaType;
      }
      await updateDoc(postRef, updateData);
      showToast('ĞŸĞ¾ÑÑ‚ Ğ¾Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¾');
      document.getElementById('editPostModal').classList.remove('active');
    } catch (e) {
      showToast('ĞŸĞ¾Ğ¼Ğ¸Ğ»ĞºĞ°: ' + e.message);
    }
  };

  document.getElementById('deletePostBtn').onclick = async () => {
    if (!currentEditingPost || !currentUser) return;
    if (!confirm('Ğ’Ğ¸Ğ´Ğ°Ğ»Ğ¸Ñ‚Ğ¸ Ğ¿Ğ¾ÑÑ‚?')) return;
    try {
      if (currentEditingPost.mediaUrl) {
        try {
          const mediaRef = ref(storage, currentEditingPost.mediaUrl);
          await deleteObject(mediaRef);
        } catch (e) {}
      }
      await deleteDoc(doc(db, "posts", currentEditingPost.id));
      await updateDoc(doc(db, "users", currentUser.uid), { posts: arrayRemove(currentEditingPost.id) });
      showToast('ĞŸĞ¾ÑÑ‚ Ğ²Ğ¸Ğ´Ğ°Ğ»ĞµĞ½Ğ¾');
      document.getElementById('editPostModal').classList.remove('active');
    } catch (e) {
      showToast('ĞŸĞ¾Ğ¼Ğ¸Ğ»ĞºĞ°: ' + e.message);
    }
  };

  // ================= ĞŸĞ¾ÑˆÑƒĞº =================
  async function loadSearchUsers() {
    if (!currentUser) return;
    const val = document.getElementById('searchInput').value.trim().toLowerCase();
    const userList = document.getElementById('userList');
    if (!val) { userList.innerHTML = ''; return; }

    if (val.startsWith('#')) {
      const tag = val.substring(1);
      const q = query(collection(db, "posts"), where("hashtags", "array-contains", tag));
      const snapshot = await getDocs(q);
      userList.innerHTML = '<h3 style="margin-bottom:12px;">' + (translations[currentLanguage]?.posts || 'ĞŸĞ¾ÑÑ‚Ğ¸ Ğ· Ñ‚ĞµĞ³Ğ¾Ğ¼') + '</h3>';
      if (snapshot.empty) {
        userList.innerHTML += '<p>' + (translations[currentLanguage]?.noPosts || 'ĞĞµĞ¼Ğ°Ñ” Ğ¿Ğ¾ÑÑ‚Ñ–Ğ² Ğ· Ñ†Ğ¸Ğ¼ Ñ‚ĞµĞ³Ğ¾Ğ¼') + '</p>';
      } else {
        const feedDiv = document.createElement('div');
        feedDiv.className = 'feed';
        userList.appendChild(feedDiv);
        renderPosts(snapshot.docs, feedDiv);
      }
      return;
    }
    
    const mySnap = await getDoc(doc(db, "users", currentUser.uid));
    const myFollowing = mySnap.data().following || [];
    
    const q1 = query(collection(db, "users"), where("userId", ">=", val.startsWith('@') ? val : `@${val}`), where("userId", "<=", (val.startsWith('@') ? val : `@${val}`) + '\uf8ff'));
    const q2 = query(collection(db, "users"), where("nickname_lower", ">=", val), where("nickname_lower", "<=", val + '\uf8ff'));
    
    const [snap1, snap2] = await Promise.all([getDocs(q1), getDocs(q2)]);
    const usersMap = new Map();
    snap1.forEach(d => usersMap.set(d.id, d.data()));
    snap2.forEach(d => usersMap.set(d.id, d.data()));
    
    userList.innerHTML = '';
    usersMap.forEach((data, uid) => {
      if (uid === currentUser.uid) return;
      const isFollowing = myFollowing.includes(uid);
      const div = document.createElement('div');
      div.className = 'chat-item';
      div.innerHTML = `
        <div class="avatar small" style="background-image:url(${data.avatar || ''})" data-uid="${uid}"></div>
        <div class="chat-info">
          <div class="chat-name">${data.nickname}</div>
          <div class="chat-last">${data.userId}</div>
        </div>
        <button class="btn follow-btn">${isFollowing ? (translations[currentLanguage]?.unfollow || 'Ğ’Ñ–Ğ´Ğ¿Ğ¸ÑĞ°Ñ‚Ğ¸ÑÑ') : (translations[currentLanguage]?.follow || 'ĞŸÑ–Ğ´Ğ¿Ğ¸ÑĞ°Ñ‚Ğ¸ÑÑ')}</button>
      `;
      const followBtn = div.querySelector('.follow-btn');
      followBtn.onclick = async (e) => {
        e.stopPropagation();
        const wasFollowing = followBtn.textContent === (translations[currentLanguage]?.unfollow || 'Ğ’Ñ–Ğ´Ğ¿Ğ¸ÑĞ°Ñ‚Ğ¸ÑÑ');
        followBtn.textContent = wasFollowing 
          ? (translations[currentLanguage]?.follow || 'ĞŸÑ–Ğ´Ğ¿Ğ¸ÑĞ°Ñ‚Ğ¸ÑÑ')
          : (translations[currentLanguage]?.unfollow || 'Ğ’Ñ–Ğ´Ğ¿Ğ¸ÑĞ°Ñ‚Ğ¸ÑÑ');
        try {
          await toggleFollow(uid);
        } catch {
          followBtn.textContent = wasFollowing 
            ? (translations[currentLanguage]?.unfollow || 'Ğ’Ñ–Ğ´Ğ¿Ğ¸ÑĞ°Ñ‚Ğ¸ÑÑ')
            : (translations[currentLanguage]?.follow || 'ĞŸÑ–Ğ´Ğ¿Ğ¸ÑĞ°Ñ‚Ğ¸ÑÑ');
          showToast('ĞŸĞ¾Ğ¼Ğ¸Ğ»ĞºĞ°');
        }
      };
      div.onclick = () => viewProfile(uid);
      userList.appendChild(div);
    });
  }
  document.getElementById('searchInput').addEventListener('input', loadSearchUsers);

  async function toggleFollow(targetUid) {
    if (!currentUser) return;
    const myRef = doc(db, "users", currentUser.uid);
    const targetRef = doc(db, "users", targetUid);
    const mySnap = await getDoc(myRef);
    const following = mySnap.data().following || [];
    if (following.includes(targetUid)) {
      await updateDoc(myRef, { following: arrayRemove(targetUid) });
      await updateDoc(targetRef, { followers: arrayRemove(currentUser.uid) });
    } else {
      await updateDoc(myRef, { following: arrayUnion(targetUid) });
      await updateDoc(targetRef, { followers: arrayUnion(currentUser.uid) });
    }
  }

  // ================= ĞŸÑ€Ğ¾Ñ„Ñ–Ğ»ÑŒ =================
  async function loadMyProfile() {
    if (!currentUser) return;
    const snap = await getDoc(doc(db, "users", currentUser.uid));
    if (snap.exists()) renderProfile(snap.data(), currentUser.uid, true);
  }

  function viewProfile(uid) {
    currentProfileUid = uid;
    document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
    const profileNav = document.querySelector('[data-section="profile"]');
    if (profileNav) profileNav.classList.add('active');
    sections.forEach(s => document.getElementById(s).classList.remove('active'));
    const profileSection = document.getElementById('profile');
    if (profileSection) profileSection.classList.add('active');
    document.getElementById('pageTitle').textContent = translations[currentLanguage]?.profile || 'ĞŸÑ€Ğ¾Ñ„Ñ–Ğ»ÑŒ';
    
    if (uid === currentUser?.uid) {
      loadMyProfile();
    } else {
      loadUserProfile(uid);
    }
    
    closeSidebar();
  }

  async function loadUserProfile(uid) {
    if (!currentUser) return;
    const snap = await getDoc(doc(db, "users", uid));
    if (snap.exists()) renderProfile(snap.data(), uid, uid === currentUser.uid);
  }

  function renderProfile(data, uid, isOwn) {
    const header = document.getElementById('profileHeader');
    const stats = document.getElementById('profileStats');
    if (!header || !stats) return;

    if (!isOwn && currentUser && data.blockedUsers?.includes(currentUser.uid)) {
      header.innerHTML = `
        <div class="avatar large" style="background-image:url(${data.avatar || ''})" data-uid="${uid}"></div>
        <div>
          <h2>${data.nickname}</h2>
          <p class="text-danger">${translations[currentLanguage]?.userBlocked || 'Ğ¦ĞµĞ¹ ĞºĞ¾Ñ€Ğ¸ÑÑ‚ÑƒĞ²Ğ°Ñ‡ Ğ²Ğ°Ñ Ğ·Ğ°Ğ±Ğ»Ğ¾ĞºÑƒĞ²Ğ°Ğ²'}</p>
        </div>
      `;
      return;
    }

    const isFollowing = !isOwn && currentUser ? (data.followers?.includes(currentUser.uid) || false) : false;

    header.innerHTML = `
      <div class="avatar large" style="background-image:url(${data.avatar || ''})" data-uid="${uid}"></div>
      <div style="flex:1">
        <h2>${data.nickname}</h2>
        <div class="user-id">${data.userId}</div>
        <p>${data.bio || ''}</p>
        ${!isOwn && currentUser ? `
          <div style="display:flex; gap:12px; margin-top:16px;">
            <button class="btn" id="profileFollowBtn">${isFollowing ? (translations[currentLanguage]?.unfollow || 'Ğ’Ñ–Ğ´Ğ¿Ğ¸ÑĞ°Ñ‚Ğ¸ÑÑ') : (translations[currentLanguage]?.follow || 'ĞŸÑ–Ğ´Ğ¿Ğ¸ÑĞ°Ñ‚Ğ¸ÑÑ')}</button>
            <button class="btn" id="profileMessageBtn">${translations[currentLanguage]?.message || 'ĞĞ°Ğ¿Ğ¸ÑĞ°Ñ‚Ğ¸'}</button>
          </div>
        ` : ''}
        ${isOwn ? '<button class="btn" id="editProfileBtn">' + (translations[currentLanguage]?.editProfile || 'Ğ ĞµĞ´Ğ°Ğ³ÑƒĞ²Ğ°Ñ‚Ğ¸') + '</button>' : ''}
      </div>
    `;

    stats.innerHTML = `
      <span id="followersCount" data-uid="${uid}">${data.followers?.length || 0} ${translations[currentLanguage]?.followers || 'Ğ¿Ñ–Ğ´Ğ¿Ğ¸ÑĞ½Ğ¸ĞºÑ–Ğ²'}</span>
      <span id="followingCount" data-uid="${uid}">${data.following?.length || 0} ${translations[currentLanguage]?.following || 'Ğ¿Ñ–Ğ´Ğ¿Ğ¸ÑĞ¾Ğº'}</span>
      <span>${data.posts?.length || 0} ${translations[currentLanguage]?.posts || 'Ğ¿Ğ¾ÑÑ‚Ñ–Ğ²'}</span>
    `;

    document.getElementById('followersCount').style.cursor = 'pointer';
    document.getElementById('followersCount').onclick = () => openFollowersList(uid);
    document.getElementById('followingCount').style.cursor = 'pointer';
    document.getElementById('followingCount').onclick = () => openFollowingList(uid);

    if (!isOwn && currentUser) {
      const profileFollowBtn = document.getElementById('profileFollowBtn');
      if (profileFollowBtn) {
        profileFollowBtn.onclick = async (e) => {
          e.stopPropagation();
          const wasFollowing = profileFollowBtn.textContent === (translations[currentLanguage]?.unfollow || 'Ğ’Ñ–Ğ´Ğ¿Ğ¸ÑĞ°Ñ‚Ğ¸ÑÑ');
          profileFollowBtn.textContent = wasFollowing 
            ? (translations[currentLanguage]?.follow || 'ĞŸÑ–Ğ´Ğ¿Ğ¸ÑĞ°Ñ‚Ğ¸ÑÑ')
            : (translations[currentLanguage]?.unfollow || 'Ğ’Ñ–Ğ´Ğ¿Ğ¸ÑĞ°Ñ‚Ğ¸ÑÑ');
          
          const followersSpan = document.getElementById('followersCount');
          if (followersSpan) {
            let count = parseInt(followersSpan.textContent.split(' ')[0]);
            followersSpan.innerHTML = `${wasFollowing ? count - 1 : count + 1} ${translations[currentLanguage]?.followers || 'Ğ¿Ñ–Ğ´Ğ¿Ğ¸ÑĞ½Ğ¸ĞºÑ–Ğ²'}`;
          }
          
          try {
            await toggleFollow(uid);
          } catch (error) {
            profileFollowBtn.textContent = wasFollowing 
              ? (translations[currentLanguage]?.unfollow || 'Ğ’Ñ–Ğ´Ğ¿Ğ¸ÑĞ°Ñ‚Ğ¸ÑÑ')
              : (translations[currentLanguage]?.follow || 'ĞŸÑ–Ğ´Ğ¿Ğ¸ÑĞ°Ñ‚Ğ¸ÑÑ');
            if (followersSpan) {
              let count = parseInt(followersSpan.textContent.split(' ')[0]);
              followersSpan.innerHTML = `${wasFollowing ? count + 1 : count - 1} ${translations[currentLanguage]?.followers || 'Ğ¿Ñ–Ğ´Ğ¿Ğ¸ÑĞ½Ğ¸ĞºÑ–Ğ²'}`;
            }
            showToast('ĞŸĞ¾Ğ¼Ğ¸Ğ»ĞºĞ°, ÑĞ¿Ñ€Ğ¾Ğ±ÑƒĞ¹Ñ‚Ğµ Ñ‰Ğµ');
          }
        };
      }
      const profileMessageBtn = document.getElementById('profileMessageBtn');
      if (profileMessageBtn) {
        profileMessageBtn.onclick = () => {
          openChat(data.nickname, uid, data.userId);
        };
      }
    }
    if (isOwn) {
      const editProfileBtn = document.getElementById('editProfileBtn');
      if (editProfileBtn) {
        editProfileBtn.onclick = () => {
          document.getElementById('editNickname').value = data.nickname;
          document.getElementById('editBio').value = data.bio || '';
          document.getElementById('editAvatar').value = '';
          document.getElementById('editAvatarBtn').textContent = 'ĞĞ±Ñ€Ğ°Ñ‚Ğ¸ Ğ°Ğ²Ğ°Ñ‚Ğ°Ñ€';
          document.getElementById('editAvatarPreview').style.display = 'none';
          document.getElementById('editProfileModal').classList.add('active');
        };
      }
    }
    
    const tabs = document.getElementById('profileTabs');
    if (tabs) {
      tabs.innerHTML = `
        <div class="profile-tab active" data-tab="posts" data-i18n="posts">${translations[currentLanguage]?.posts || 'ĞŸĞ¾ÑÑ‚Ğ¸'}</div>
        <div class="profile-tab" data-tab="likes" data-i18n="likes">${translations[currentLanguage]?.likes || 'Ğ›Ğ°Ğ¹ĞºĞ¸'}</div>
        <div class="profile-tab" data-tab="media" data-i18n="media">${translations[currentLanguage]?.media || 'ĞœĞµĞ´Ñ–Ğ°'}</div>
        <div class="profile-tab" data-tab="saved" data-i18n="saved">${translations[currentLanguage]?.saved || 'Ğ—Ğ±ĞµÑ€ĞµĞ¶ĞµĞ½Ğµ'}</div>
      `;
      document.querySelectorAll('.profile-tab').forEach(tab => {
        tab.onclick = () => {
          document.querySelectorAll('.profile-tab').forEach(t => t.classList.remove('active'));
          tab.classList.add('active');
          loadProfileFeed(uid, tab.dataset.tab);
        };
      });
    }
    loadProfileFeed(uid, 'posts');
  }

  async function openFollowersList(uid) {
    const modal = document.getElementById('followersModal');
    const list = document.getElementById('followersList');
    if (!modal || !list) return;
    list.innerHTML = '<div class="skeleton" style="height:50px;"></div>';
    modal.classList.add('active');
    
    const userSnap = await getDoc(doc(db, "users", uid));
    const followersIds = userSnap.data().followers || [];
    const followers = [];
    for (const id of followersIds) {
      const snap = await getDoc(doc(db, "users", id));
      if (snap.exists()) followers.push({ id, ...snap.data() });
    }
    
    list.innerHTML = '';
    if (followers.length === 0) {
      list.innerHTML = '<p style="text-align:center; padding:16px;">' + (translations[currentLanguage]?.noFollowers || 'ĞĞµĞ¼Ğ°Ñ” Ğ¿Ñ–Ğ´Ğ¿Ğ¸ÑĞ½Ğ¸ĞºÑ–Ğ²') + '</p>';
    } else {
      followers.forEach(user => {
        const div = document.createElement('div');
        div.className = 'chat-item';
        div.innerHTML = `
          <div class="avatar small" style="background-image:url(${user.avatar || ''})" data-uid="${user.id}"></div>
          <div class="chat-info">
            <div class="chat-name">${user.nickname}</div>
            <div class="chat-last">${user.userId}</div>
          </div>
        `;
        div.onclick = () => {
          viewProfile(user.id);
          modal.classList.remove('active');
        };
        list.appendChild(div);
      });
    }
  }

  async function openFollowingList(uid) {
    const modal = document.getElementById('followingModal');
    const list = document.getElementById('followingList');
    if (!modal || !list) return;
    list.innerHTML = '<div class="skeleton" style="height:50px;"></div>';
    modal.classList.add('active');
    
    const userSnap = await getDoc(doc(db, "users", uid));
    const followingIds = userSnap.data().following || [];
    const following = [];
    for (const id of followingIds) {
      const snap = await getDoc(doc(db, "users", id));
      if (snap.exists()) following.push({ id, ...snap.data() });
    }
    
    list.innerHTML = '';
    if (following.length === 0) {
      list.innerHTML = '<p style="text-align:center; padding:16px;">' + (translations[currentLanguage]?.noFollowing || 'ĞÑ– Ğ½Ğ° ĞºĞ¾Ğ³Ğ¾ Ğ½Ğµ Ğ¿Ñ–Ğ´Ğ¿Ğ¸ÑĞ°Ğ½Ğ¸Ğ¹') + '</p>';
    } else {
      following.forEach(user => {
        const div = document.createElement('div');
        div.className = 'chat-item';
        div.innerHTML = `
          <div class="avatar small" style="background-image:url(${user.avatar || ''})" data-uid="${user.id}"></div>
          <div class="chat-info">
            <div class="chat-name">${user.nickname}</div>
            <div class="chat-last">${user.userId}</div>
          </div>
        `;
        div.onclick = () => {
          viewProfile(user.id);
          modal.classList.remove('active');
        };
        list.appendChild(div);
      });
    }
  }

  document.getElementById('closeFollowersModal').onclick = () => {
    document.getElementById('followersModal').classList.remove('active');
  };
  document.getElementById('closeFollowingModal').onclick = () => {
    document.getElementById('followingModal').classList.remove('active');
  };

  async function loadProfileFeed(uid, tab) {
    if (!currentUser) return;
    const feed = document.getElementById('profileFeed');
    if (!feed) return;
    feed.innerHTML = '';
    let posts = [];
    const userSnap = await getDoc(doc(db, "users", uid));
    const userData = userSnap.data();
    
    if (tab === 'posts') {
      const postIds = userData.posts || [];
      for (const id of postIds.slice(0, 20)) {
        const postSnap = await getDoc(doc(db, "posts", id));
        if (postSnap.exists()) posts.push({ id, ...postSnap.data() });
      }
    } else if (tab === 'likes') {
      const likedIds = userData.likedPosts || [];
      for (const id of likedIds.slice(0, 20)) {
        const postSnap = await getDoc(doc(db, "posts", id));
        if (postSnap.exists()) posts.push({ id, ...postSnap.data() });
      }
    } else if (tab === 'media') {
      const q = query(collection(db, "posts"), where("author", "==", uid), where("mediaUrl", "!=", ""));
      const snap = await getDocs(q);
      snap.forEach(d => posts.push({ id: d.id, ...d.data() }));
    } else if (tab === 'saved') {
      const savedIds = userData.savedPosts || [];
      for (const id of savedIds.slice(0, 20)) {
        const postSnap = await getDoc(doc(db, "posts", id));
        if (postSnap.exists()) posts.push({ id, ...postSnap.data() });
      }
    }
    
    posts.sort((a, b) => (b.createdAt?.seconds || 0) - (a.createdAt?.seconds || 0));
    
    if (posts.length) {
      const docs = posts.map(p => ({ id: p.id, data: () => p }));
      renderPosts(docs, feed);
    } else {
      feed.innerHTML = '<p style="text-align:center; padding:16px;">' + (translations[currentLanguage]?.noPosts || 'ĞĞµĞ¼Ğ°Ñ” Ğ¿Ğ¾ÑÑ‚Ñ–Ğ²') + '</p>';
    }
  }

  document.getElementById('closeModal').onclick = () => {
    document.getElementById('editProfileModal').classList.remove('active');
  };
  
  document.getElementById('saveProfileEdit').onclick = async () => {
    if (!currentUser) return;
    const nickname = document.getElementById('editNickname').value.trim();
    const bio = document.getElementById('editBio').value.trim();
    const avatarFile = document.getElementById('editAvatar').files[0];
    if (!nickname) return alert('ĞŸÑĞµĞ²Ğ´Ğ¾Ğ½Ñ–Ğ¼ Ğ¾Ğ±Ğ¾Ğ²â€™ÑĞ·ĞºĞ¾Ğ²Ğ¸Ğ¹');
    
    const newUserId = `@${nickname.toLowerCase()}`;
    const q = query(collection(db, "users"), where("userId", "==", newUserId));
    const snap = await getDocs(q);
    if (!snap.empty && snap.docs[0].id !== currentUser.uid) return alert('Ğ¦ĞµĞ¹ ID Ğ²Ğ¶Ğµ Ğ·Ğ°Ğ¹Ğ½ÑÑ‚Ğ¸Ğ¹');
    
    try {
      let avatarUrl;
      if (avatarFile) {
        const storageRef = ref(storage, `avatars/${currentUser.uid}/${Date.now()}_${avatarFile.name}`);
        await uploadBytes(storageRef, avatarFile);
        avatarUrl = await getDownloadURL(storageRef);
      }
      
      const updateData = { 
        nickname, 
        userId: newUserId, 
        nickname_lower: nickname.toLowerCase(), 
        bio 
      };
      if (avatarUrl) updateData.avatar = avatarUrl;
      
      await updateDoc(doc(db, "users", currentUser.uid), updateData);
      loadMyProfile();
      document.getElementById('editProfileModal').classList.remove('active');
      showToast('ĞŸÑ€Ğ¾Ñ„Ñ–Ğ»ÑŒ Ğ¾Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¾');
    } catch (e) {
      showToast('ĞŸĞ¾Ğ¼Ğ¸Ğ»ĞºĞ°: ' + e.message);
    }
  };

  // ================= Ğ§ĞĞ¢Ğ˜ =================
  const getChatId = (uid1, uid2) => [uid1, uid2].sort().join('_');

  async function loadChatList() {
    if (!currentUser) return;
    const list = document.getElementById('chatList');
    if (!list) return;
    list.innerHTML = '';

    try {
      const q = query(collection(db, "chats"), where("participants", "array-contains", currentUser.uid));
      const snapshot = await getDocs(q);

      if (snapshot.empty) {
        list.innerHTML = '<p style="text-align:center; padding:16px;">' + (translations[currentLanguage]?.noChats || 'ĞĞµĞ¼Ğ°Ñ” Ñ‡Ğ°Ñ‚Ñ–Ğ²') + '</p>';
        return;
      }

      const chatItems = [];
      for (const docSnap of snapshot.docs) {
        const chat = docSnap.data();
        const otherUid = chat.participants.find(uid => uid !== currentUser.uid);
        if (!otherUid) continue;

        const userSnap = await getDoc(doc(db, "users", otherUid));
        const user = userSnap.data();
        if (!user) continue;

        const unread = chat.unread?.[currentUser.uid] || 0;
        const lastMsg = chat.lastMessage || '';
        const updatedAt = chat.updatedAt?.seconds || 0;
        const time = updatedAt ? new Date(updatedAt * 1000).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }) : '';
        const lastOnline = user.lastOnline?.seconds || 0;
        const isOnline = (Date.now() / 1000 - lastOnline) < 60;

        chatItems.push({
          chatId: docSnap.id,
          otherUid,
          user,
          unread,
          lastMsg,
          time,
          isOnline,
          updatedAt,
          lastOnline
        });
      }

      chatItems.sort((a, b) => b.updatedAt - a.updatedAt);

      if (chatItems.length === 0) {
        list.innerHTML = '<p style="text-align:center; padding:16px;">' + (translations[currentLanguage]?.noChats || 'ĞĞµĞ¼Ğ°Ñ” Ñ‡Ğ°Ñ‚Ñ–Ğ²') + '</p>';
        return;
      }

      chatItems.forEach(item => {
        const div = document.createElement('div');
        div.className = `chat-item ${item.unread > 0 ? 'unread' : ''}`;
        div.dataset.chatId = item.chatId;
        div.dataset.otherUid = item.otherUid;
        
        const lastSeenText = getLastSeenText(item.lastOnline);
        
        div.innerHTML = `
          <div class="avatar small" style="background-image:url(${item.user.avatar || ''})"></div>
          <div class="chat-info">
            <div class="chat-name">
              ${item.user.nickname} 
              ${item.isOnline ? '<span class="online-indicator"></span>' : ''}
              <span class="last-seen">${!item.isOnline ? lastSeenText : ''}</span>
            </div>
            <div class="chat-last">${item.lastMsg}</div>
          </div>
          <div class="chat-time">${item.time}</div>
          ${item.unread > 0 ? `<div class="chat-badge">${item.unread}</div>` : ''}
        `;
        div.onclick = () => openChatFromList(item.chatId, item.otherUid, item.user.nickname, item.user.userId, item.user.avatar);
        list.appendChild(div);
      });
    } catch (error) {
      console.error('Error loading chat list:', error);
      showToast('ĞŸĞ¾Ğ¼Ğ¸Ğ»ĞºĞ° Ğ·Ğ°Ğ²Ğ°Ğ½Ñ‚Ğ°Ğ¶ĞµĞ½Ğ½Ñ ÑĞ¿Ğ¸ÑĞºÑƒ Ñ‡Ğ°Ñ‚Ñ–Ğ².');
    }
  }

  function getLastSeenText(seconds) {
    if (!seconds) return '';
    const now = Date.now() / 1000;
    const diff = now - seconds;
    if (diff < 60) return translations[currentLanguage]?.justNow || 'Ñ‰Ğ¾Ğ¹Ğ½Ğ¾';
    if (diff < 3600) return `${Math.floor(diff/60)} ${translations[currentLanguage]?.minutes || 'Ñ…Ğ²'}`;
    if (diff < 86400) return `${Math.floor(diff/3600)} ${translations[currentLanguage]?.hours || 'Ğ³Ğ¾Ğ´'}`;
    return `${Math.floor(diff/86400)} ${translations[currentLanguage]?.days || 'Ğ´Ğ½'}`;
  }

  function updateLastSeenTexts() {
    if (currentChatPartner) {
      getDoc(doc(db, "users", currentChatPartner)).then(snap => {
        if (snap.exists()) {
          const lastOnline = snap.data().lastOnline?.seconds || 0;
          const isOnline = (Date.now()/1000 - lastOnline) < 60;
          const lastSeenEl = document.getElementById('lastSeenText');
          if (lastSeenEl) {
            lastSeenEl.textContent = isOnline ? (translations[currentLanguage]?.online || 'Ğ² Ğ¼ĞµÑ€ĞµĞ¶Ñ–') : (translations[currentLanguage]?.lastSeen || 'Ğ²Ğ¾ÑÑ‚Ğ°Ğ½Ğ½Ñ” Ğ±ÑƒĞ²') + ' ' + getLastSeenText(lastOnline);
          }
        }
      });
    }
  }

  async function openChatFromList(chatId, otherUid, otherName, otherUserId, otherAvatar) {
    if (!currentUser) return;
    currentChatPartner = otherUid;
    currentChatPartnerName = otherName;
    currentChatId = chatId;
    
    const chatWindow = document.getElementById('chatWindow');
    if (chatWindow) chatWindow.style.display = 'flex';
    const chatName = document.getElementById('chatName');
    if (chatName) chatName.textContent = otherName;
    const chatUserId = document.getElementById('chatUserId');
    if (chatUserId) chatUserId.textContent = otherUserId || '';
    const chatAvatar = document.getElementById('chatAvatar');
    if (chatAvatar) chatAvatar.style.backgroundImage = `url(${otherAvatar || ''})`;
    
    const chatRef = doc(db, "chats", chatId);
    await updateDoc(chatRef, { [`unread.${currentUser.uid}`]: 0 }).catch(console.error);
    
    setTimeout(() => {
      subscribeToChat(chatId).catch(err => {
        console.error('Error subscribing to chat:', err);
        showToast('ĞŸĞ¾Ğ¼Ğ¸Ğ»ĞºĞ° Ğ·Ğ°Ğ²Ğ°Ğ½Ñ‚Ğ°Ğ¶ĞµĞ½Ğ½Ñ Ğ¿Ğ¾Ğ²Ñ–Ğ´Ğ¾Ğ¼Ğ»ĞµĞ½ÑŒ');
      });
    }, 100);
    
    if (unsubscribeOnlineStatus) unsubscribeOnlineStatus();
    unsubscribeOnlineStatus = onSnapshot(doc(db, "users", otherUid), (snap) => {
      const lastOnline = snap.data()?.lastOnline?.seconds || 0;
      const isOnline = (Date.now()/1000 - lastOnline) < 60;
      const indicator = document.getElementById('onlineIndicator');
      if (indicator) indicator.style.display = isOnline ? 'inline-block' : 'none';
      const lastSeenEl = document.getElementById('lastSeenText');
      if (lastSeenEl) {
        lastSeenEl.textContent = isOnline ? (translations[currentLanguage]?.online || 'Ğ² Ğ¼ĞµÑ€ĞµĞ¶Ñ–') : (translations[currentLanguage]?.lastSeen || 'Ğ²Ğ¾ÑÑ‚Ğ°Ğ½Ğ½Ñ” Ğ±ÑƒĞ²') + ' ' + getLastSeenText(lastOnline);
      }
    }, (error) => {
      console.error('Online status error:', error);
    });
  }

  function openChat(otherName, otherUid, otherUserId) {
    if (!currentUser) return;
    currentChatPartner = otherUid;
    currentChatPartnerName = otherName;
    
    document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
    const chatsNav = document.querySelector('[data-section="chats"]');
    if (chatsNav) chatsNav.classList.add('active');
    sections.forEach(s => document.getElementById(s).classList.remove('active'));
    const chatsSection = document.getElementById('chats');
    if (chatsSection) chatsSection.classList.add('active');
    document.getElementById('pageTitle').textContent = translations[currentLanguage]?.chats || 'Ğ§Ğ°Ñ‚Ğ¸';
    
    const chatWindow = document.getElementById('chatWindow');
    if (chatWindow) chatWindow.style.display = 'flex';
    const chatName = document.getElementById('chatName');
    if (chatName) chatName.textContent = otherName;
    const chatUserId = document.getElementById('chatUserId');
    if (chatUserId) chatUserId.textContent = otherUserId || '';
    
    getDoc(doc(db, "users", otherUid)).then(snap => {
      if (snap.exists()) {
        const chatAvatar = document.getElementById('chatAvatar');
        if (chatAvatar) chatAvatar.style.backgroundImage = `url(${snap.data().avatar || ''})`;
        const lastOnline = snap.data().lastOnline?.seconds || 0;
        const isOnline = (Date.now()/1000 - lastOnline) < 60;
        const indicator = document.getElementById('onlineIndicator');
        if (indicator) indicator.style.display = isOnline ? 'inline-block' : 'none';
        const lastSeenEl = document.getElementById('lastSeenText');
        if (lastSeenEl) {
          lastSeenEl.textContent = isOnline ? (translations[currentLanguage]?.online || 'Ğ² Ğ¼ĞµÑ€ĞµĞ¶Ñ–') : (translations[currentLanguage]?.lastSeen || 'Ğ²Ğ¾ÑÑ‚Ğ°Ğ½Ğ½Ñ” Ğ±ÑƒĞ²') + ' ' + getLastSeenText(lastOnline);
        }
      }
    }).catch(console.error);
    
    if (unsubscribeOnlineStatus) unsubscribeOnlineStatus();
    unsubscribeOnlineStatus = onSnapshot(doc(db, "users", otherUid), (snap) => {
      const lastOnline = snap.data()?.lastOnline?.seconds || 0;
      const isOnline = (Date.now()/1000 - lastOnline) < 60;
      const indicator = document.getElementById('onlineIndicator');
      if (indicator) indicator.style.display = isOnline ? 'inline-block' : 'none';
      const lastSeenEl = document.getElementById('lastSeenText');
      if (lastSeenEl) {
        lastSeenEl.textContent = isOnline ? (translations[currentLanguage]?.online || 'Ğ² Ğ¼ĞµÑ€ĞµĞ¶Ñ–') : (translations[currentLanguage]?.lastSeen || 'Ğ²Ğ¾ÑÑ‚Ğ°Ğ½Ğ½Ñ” Ğ±ÑƒĞ²') + ' ' + getLastSeenText(lastOnline);
      }
    }, (error) => {
      console.error('Online status error:', error);
    });
    
    const chatId = getChatId(currentUser.uid, otherUid);
    currentChatId = chatId;
    const chatRef = doc(db, "chats", chatId);
    getDoc(chatRef).then(async (docSnap) => {
      try {
        if (!docSnap.exists()) {
          await setDoc(chatRef, {
            participants: [currentUser.uid, otherUid],
            createdAt: serverTimestamp(),
            updatedAt: serverTimestamp(),
            lastMessage: '',
            unread: { [currentUser.uid]: 0, [otherUid]: 0 }
          });
        } else {
          await updateDoc(chatRef, { [`unread.${currentUser.uid}`]: 0 });
        }
        setTimeout(() => {
          subscribeToChat(chatId).catch(err => {
            console.error('Error subscribing to chat:', err);
            showToast('ĞŸĞ¾Ğ¼Ğ¸Ğ»ĞºĞ° Ğ·Ğ°Ğ²Ğ°Ğ½Ñ‚Ğ°Ğ¶ĞµĞ½Ğ½Ñ Ğ¿Ğ¾Ğ²Ñ–Ğ´Ğ¾Ğ¼Ğ»ĞµĞ½ÑŒ');
          });
        }, 100);
        loadChatList();
      } catch (error) {
        console.error('Error opening chat:', error);
        showToast('ĞŸĞ¾Ğ¼Ğ¸Ğ»ĞºĞ° Ğ²Ñ–Ğ´ĞºÑ€Ğ¸Ñ‚Ñ‚Ñ Ñ‡Ğ°Ñ‚Ñƒ');
      }
    }).catch(error => {
      console.error('Error getting chat doc:', error);
      showToast('ĞŸĞ¾Ğ¼Ğ¸Ğ»ĞºĞ° Ğ´Ğ¾ÑÑ‚ÑƒĞ¿Ñƒ Ğ´Ğ¾ Ñ‡Ğ°Ñ‚Ñƒ');
    });
  }

  function formatMessageTime(timestamp) {
    if (!timestamp) return '';
    const date = timestamp.toDate ? timestamp.toDate() : new Date(timestamp.seconds * 1000);
    return date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
  }

  function formatMessageDate(timestamp) {
    if (!timestamp) return '';
    const date = timestamp.toDate ? timestamp.toDate() : new Date(timestamp.seconds * 1000);
    const today = new Date();
    const yesterday = new Date(today);
    yesterday.setDate(yesterday.getDate() - 1);
    
    if (date.toDateString() === today.toDateString()) return translations[currentLanguage]?.today || 'Ğ¡ÑŒĞ¾Ğ³Ğ¾Ğ´Ğ½Ñ–';
    if (date.toDateString() === yesterday.toDateString()) return translations[currentLanguage]?.yesterday || 'Ğ’Ñ‡Ğ¾Ñ€Ğ°';
    return date.toLocaleDateString();
  }

  async function markMessagesAsSeen(chatId) {
    if (!currentUser || !currentChatPartner) return;
    const q = query(collection(db, `chats/${chatId}/messages`), where("from", "==", currentChatPartner), where("seen", "==", false));
    const snapshot = await getDocs(q);
    if (snapshot.empty) return;
    const batch = writeBatch(db);
    snapshot.forEach(doc => batch.update(doc.ref, { seen: true }));
    await batch.commit();
  }

  async function subscribeToChat(chatId) {
    if (!currentUser) throw new Error('No current user');
    if (unsubscribeChat) unsubscribeChat();
    if (unsubscribeTyping) unsubscribeTyping();

    const messagesContainer = document.getElementById('chatMessages');
    if (!messagesContainer) {
      throw new Error('chatMessages container not found');
    }

    const otherUserSnap = await getDoc(doc(db, "users", currentChatPartner));
    const otherUser = otherUserSnap.data();

    const q = query(collection(db, `chats/${chatId}/messages`), orderBy("createdAt"));
    let lastDate = '';
    unsubscribeChat = onSnapshot(q, async (snap) => {
      messagesContainer.innerHTML = '';
      let hasNewFromOther = false;
      snap.forEach(doc => {
        const msg = doc.data();
        const msgDate = formatMessageDate(msg.createdAt);
        if (msgDate !== lastDate) {
          lastDate = msgDate;
          const divider = document.createElement('div');
          divider.className = 'date-divider';
          divider.textContent = msgDate;
          messagesContainer.appendChild(divider);
        }

        const wrapper = document.createElement('div');
        wrapper.className = `message-wrapper ${msg.from === currentUser.uid ? 'sent' : 'received'}`;

        const bubble = document.createElement('div');
        bubble.className = `message-bubble ${msg.from === currentUser.uid ? 'sent' : 'received'}`;

        if (msg.from !== currentUser.uid) {
          const senderDiv = document.createElement('div');
          senderDiv.className = 'message-sender';
          senderDiv.innerHTML = `
            <div class="message-sender-avatar" style="background-image:url(${otherUser?.avatar || ''})"></div>
            <span>${currentChatPartnerName}</span>
          `;
          bubble.appendChild(senderDiv);
          if (!msg.seen) hasNewFromOther = true;
        }

        if (msg.fileUrl) {
          if (msg.fileType === 'image') {
            const img = document.createElement('img');
            img.src = msg.fileUrl;
            img.style.maxWidth = '100%';
            img.style.borderRadius = 'var(--radius-sm)';
            bubble.appendChild(img);
          } else if (msg.fileType === 'audio') {
            const audio = document.createElement('audio');
            audio.src = msg.fileUrl;
            audio.controls = true;
            audio.classList.add('audio-player');
            bubble.appendChild(audio);
          } else {
            const fileCard = document.createElement('div');
            fileCard.className = 'file-card';
            const fileExt = msg.fileName?.split('.').pop() || 'file';
            fileCard.innerHTML = `
              <div class="file-icon">ğŸ“„</div>
              <div class="file-info">
                <div class="file-name">${msg.fileName || 'Ğ¤Ğ°Ğ¹Ğ»'}</div>
                <div class="file-meta">${msg.fileSize ? (msg.fileSize/1024).toFixed(1) + ' KB' : ''}</div>
              </div>
              <a href="${msg.fileUrl}" download class="download-btn" target="_blank">â¬‡ï¸</a>
            `;
            bubble.appendChild(fileCard);
          }
        }

        if (msg.text) {
          const textDiv = document.createElement('div');
          textDiv.textContent = msg.text;
          bubble.appendChild(textDiv);
        }

        const timeDiv = document.createElement('div');
        timeDiv.className = 'message-time';
        timeDiv.innerHTML = formatMessageTime(msg.createdAt);
        if (msg.from === currentUser.uid) {
          const seenIcon = document.createElement('span');
          seenIcon.className = 'seen-indicator';
          seenIcon.textContent = msg.seen ? 'âœ“âœ“' : 'âœ“';
          timeDiv.appendChild(seenIcon);
        }
        bubble.appendChild(timeDiv);

        wrapper.appendChild(bubble);
        messagesContainer.appendChild(wrapper);
      });
      
      messagesContainer.scrollTo({ top: messagesContainer.scrollHeight, behavior: 'smooth' });

      if (hasNewFromOther) {
        await markMessagesAsSeen(chatId);
      }
    }, (error) => {
      console.error('Error in messages snapshot:', error);
      showToast('ĞŸĞ¾Ğ¼Ğ¸Ğ»ĞºĞ° Ğ¾Ñ‚Ñ€Ğ¸Ğ¼Ğ°Ğ½Ğ½Ñ Ğ¿Ğ¾Ğ²Ñ–Ğ´Ğ¾Ğ¼Ğ»ĞµĞ½ÑŒ');
    });
    
    if (currentChatPartner) {
      const typingRef = doc(db, `chats/${chatId}/typing/${currentChatPartner}`);
      unsubscribeTyping = onSnapshot(typingRef, (docSnap) => {
        const indicator = document.getElementById('typingIndicator');
        if (indicator) {
          if (docSnap.exists() && docSnap.data().isTyping) {
            indicator.style.display = 'flex';
          } else {
            indicator.style.display = 'none';
          }
        }
      }, (error) => {
        console.error('Typing indicator error:', error);
      });
    }
  }

  document.getElementById('chatText').addEventListener('input', () => {
    if (!currentUser || !currentChatPartner || !currentChatId) return;
    const typingRef = doc(db, `chats/${currentChatId}/typing/${currentUser.uid}`);
    setDoc(typingRef, { isTyping: true }, { merge: true }).catch(console.error);
    clearTimeout(window.typingTimeout);
    window.typingTimeout = setTimeout(() => setDoc(typingRef, { isTyping: false }, { merge: true }).catch(console.error), 2000);
  });

  document.getElementById('sendMessage').onclick = async () => {
    await sendMessage();
  };

  document.getElementById('chatText').addEventListener('keypress', (e) => {
    if (e.key === 'Enter' && !e.shiftKey) {
      e.preventDefault();
      sendMessage();
    }
  });

  async function sendMessage() {
    const text = document.getElementById('chatText').value.trim();
    const fileInput = document.getElementById('chatFileInput');
    const files = fileInput.files;
    if (!text && (!files || files.length === 0)) return;
    if (!currentUser || !currentChatPartner || !currentChatId) return;

    const sendBtn = document.getElementById('sendMessage');
    sendBtn.classList.add('sending');
    setTimeout(() => sendBtn.classList.remove('sending'), 200);

    const chatRef = doc(db, "chats", currentChatId);
    const messageRef = collection(db, `chats/${currentChatId}/messages`);

    try {
      if (files && files.length > 0) {
        for (let file of files) {
          const storageRef = ref(storage, `chat_files/${currentChatId}/${Date.now()}_${file.name}`);
          await uploadBytes(storageRef, file);
          const fileUrl = await getDownloadURL(storageRef);
          const fileType = file.type.split('/')[0];
          await addDoc(messageRef, {
            from: currentUser.uid,
            text: '',
            fileUrl,
            fileType,
            fileName: file.name,
            fileSize: file.size,
            createdAt: serverTimestamp(),
            seen: false
          });
        }
        fileInput.value = '';
      }
      
      if (text) {
        await addDoc(messageRef, {
          from: currentUser.uid,
          text,
          createdAt: serverTimestamp(),
          seen: false
        });
      }

      await updateDoc(chatRef, {
        lastMessage: text || (files.length ? 'ğŸ“ Ğ¤Ğ°Ğ¹Ğ»' : ''),
        updatedAt: serverTimestamp(),
        [`unread.${currentChatPartner}`]: increment(1)
      });

      document.getElementById('chatText').value = '';
      
      const typingRef = doc(db, `chats/${currentChatId}/typing/${currentUser.uid}`);
      await setDoc(typingRef, { isTyping: false }, { merge: true });

      loadChatList();
    } catch (error) {
      console.error('Send message error:', error);
      showToast('ĞŸĞ¾Ğ¼Ğ¸Ğ»ĞºĞ° Ğ²Ñ–Ğ´Ğ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ½Ñ Ğ¿Ğ¾Ğ²Ñ–Ğ´Ğ¾Ğ¼Ğ»ĞµĞ½Ğ½Ñ');
    }
  }

  document.getElementById('attachChatFileBtn').addEventListener('click', () => {
    document.getElementById('chatFileInput').click();
  });

  // ================= ĞŸĞĞ¨Ğ£Ğš ĞšĞĞ Ğ˜Ğ¡Ğ¢Ğ£Ğ’ĞĞ§Ğ†Ğ’ Ğ£ Ğ§ĞĞ¢ĞĞ¥ =================
  let searchTimeout;
  document.getElementById('chatSearchInput').addEventListener('input', (e) => {
    clearTimeout(searchTimeout);
    const val = e.target.value.trim();
    if (!val) {
      document.getElementById('chatSearchResults').style.display = 'none';
      return;
    }
    searchTimeout = setTimeout(() => searchUsersForChat(val), 300);
  });

  async function searchUsersForChat(queryText) {
    if (!currentUser) return;
    const val = queryText.toLowerCase();
    const resultsContainer = document.getElementById('chatSearchResults');
    if (!resultsContainer) return;
    resultsContainer.innerHTML = '';
    
    const q1 = query(collection(db, "users"), where("userId", ">=", val.startsWith('@') ? val : `@${val}`), where("userId", "<=", (val.startsWith('@') ? val : `@${val}`) + '\uf8ff'));
    const q2 = query(collection(db, "users"), where("nickname_lower", ">=", val), where("nickname_lower", "<=", val + '\uf8ff'));
    
    const [snap1, snap2] = await Promise.all([getDocs(q1), getDocs(q2)]);
    const usersMap = new Map();
    snap1.forEach(d => usersMap.set(d.id, d.data()));
    snap2.forEach(d => usersMap.set(d.id, d.data()));
    
    if (usersMap.size === 0) {
      resultsContainer.style.display = 'none';
      return;
    }
    
    resultsContainer.style.display = 'block';
    usersMap.forEach((data, uid) => {
      if (uid === currentUser.uid) return;
      const div = document.createElement('div');
      div.className = 'chat-item';
      div.innerHTML = `
        <div class="avatar small" style="background-image:url(${data.avatar || ''})"></div>
        <div class="chat-info">
          <div class="chat-name">${data.nickname}</div>
          <div class="chat-last">${data.userId}</div>
        </div>
        <button class="btn">${translations[currentLanguage]?.message || 'ĞĞ°Ğ¿Ğ¸ÑĞ°Ñ‚Ğ¸'}</button>
      `;
      div.onclick = () => {
        openChat(data.nickname, uid, data.userId);
        resultsContainer.style.display = 'none';
        document.getElementById('chatSearchInput').value = '';
      };
      const btn = div.querySelector('button');
      if (btn) {
        btn.onclick = (e) => {
          e.stopPropagation();
          openChat(data.nickname, uid, data.userId);
          resultsContainer.style.display = 'none';
          document.getElementById('chatSearchInput').value = '';
        };
      }
      resultsContainer.appendChild(div);
    });
  }

  // ================= Ğ—Ğ‘Ğ•Ğ Ğ•Ğ–Ğ•ĞĞ• =================
  async function loadSavedFeed() {
    if (!currentUser) return;
    const feed = document.getElementById('savedFeed');
    if (!feed) return;
    feed.innerHTML = '';
    const userSnap = await getDoc(doc(db, "users", currentUser.uid));
    const savedIds = userSnap.data().savedPosts || [];
    const posts = [];
    for (const id of savedIds.slice(0, 20)) {
      const postSnap = await getDoc(doc(db, "posts", id));
      if (postSnap.exists()) posts.push({ id, ...postSnap.data() });
    }
    posts.sort((a, b) => (b.createdAt?.seconds || 0) - (a.createdAt?.seconds || 0));
    if (posts.length === 0) {
      feed.innerHTML = '<p style="text-align:center; padding:16px;">' + (translations[currentLanguage]?.noSaved || 'ĞĞµĞ¼Ğ°Ñ” Ğ·Ğ±ĞµÑ€ĞµĞ¶ĞµĞ½Ğ¸Ñ… Ğ¿Ğ¾ÑÑ‚Ñ–Ğ²') + '</p>';
      return;
    }
    const docs = posts.map(p => ({ id: p.id, data: () => p }));
    renderPosts(docs, feed);
  }

  // ================= ĞĞ°Ğ»Ğ°ÑˆÑ‚ÑƒĞ²Ğ°Ğ½Ğ½Ñ =================
  document.getElementById('toggleTheme').onclick = toggleTheme;

  function initTheme() {
    const savedTheme = localStorage.getItem('theme');
    if (savedTheme === 'dark') {
      document.body.classList.add('dark-theme');
    } else {
      document.body.classList.remove('dark-theme');
    }
  }

  function toggleTheme() {
    document.body.classList.toggle('dark-theme');
    const isDark = document.body.classList.contains('dark-theme');
    localStorage.setItem('theme', isDark ? 'dark' : 'light');
  }

  initTheme();

  document.getElementById('privacyPolicyBtn').onclick = () => {
    document.getElementById('privacyPolicyModal').classList.add('active');
  };
  document.getElementById('closePrivacyModal').onclick = () => {
    document.getElementById('privacyPolicyModal').classList.remove('active');
  };

  document.getElementById('logoutBtn').onclick = () => {
    cleanupListeners();
    signOut(auth);
  };

  // ================= Ğ†Ğ½ÑˆÑ– Ğ¾Ğ±Ñ€Ğ¾Ğ±Ğ½Ğ¸ĞºĞ¸ =================
  const sentinel = document.getElementById('feedSentinel');
  if (sentinel) {
    const observer = new IntersectionObserver((entries) => {
      if (entries[0].isIntersecting) loadMorePosts();
    }, { threshold: 0.5 });
    observer.observe(sentinel);
  }

  document.addEventListener('click', async (e) => {
    if (!currentUser) return;
    const target = e.target.closest('button');
    if (!target) return;
    
    if (target.classList.contains('like-btn')) {
      const postId = target.dataset.postId;
      const liked = target.classList.contains('liked');
      const countSpan = target.querySelector('span');
      const oldCount = parseInt(countSpan.textContent);
      target.classList.toggle('liked');
      countSpan.textContent = liked ? oldCount - 1 : oldCount + 1;
      try {
        const postRef = doc(db, "posts", postId);
        if (liked) {
          await updateDoc(postRef, { likes: arrayRemove(currentUser.uid), likesCount: increment(-1) });
          await updateDoc(doc(db, "users", currentUser.uid), { likedPosts: arrayRemove(postId) });
        } else {
          await updateDoc(postRef, { likes: arrayUnion(currentUser.uid), likesCount: increment(1) });
          await updateDoc(doc(db, "users", currentUser.uid), { likedPosts: arrayUnion(postId) });
          vibrate(30);
        }
      } catch {
        target.classList.toggle('liked');
        countSpan.textContent = oldCount;
      }
    }
    
    if (target.classList.contains('save-btn')) {
      const postId = target.dataset.postId;
      const saved = target.classList.contains('saved');
      target.classList.toggle('saved');
      try {
        const userRef = doc(db, "users", currentUser.uid);
        const postRef = doc(db, "posts", postId);
        if (saved) {
          await updateDoc(userRef, { savedPosts: arrayRemove(postId) });
          await updateDoc(postRef, { saves: arrayRemove(currentUser.uid) });
        } else {
          await updateDoc(userRef, { savedPosts: arrayUnion(postId) });
          await updateDoc(postRef, { saves: arrayUnion(currentUser.uid) });
        }
      } catch { target.classList.toggle('saved'); }
    }
  });

  document.addEventListener('click', (e) => {
    const uidElement = e.target.closest('[data-uid]');
    if (uidElement) {
      const uid = uidElement.dataset.uid;
      viewProfile(uid);
    }
  });

  document.getElementById('languageSelect').value = currentLanguage;
  applyLanguage();
</script>
</body>
</html>

<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>FANTASYAS</title>
  <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@500;600;700;800&display=swap" rel="stylesheet"/>
  <script src="https://unpkg.com/@lottiefiles/lottie-player@latest/dist/lottie-player.js"></script>
  
  <style>
    :root {
      --bg: #000;
      --text: #ffffff;
      --text-secondary: #cccccc;
      --card-bg: rgba(255,255,255,0.06);
      --card-border: rgba(255,255,255,0.12);
      --input-bg: rgba(255,255,255,0.08);
      --input-border: rgba(255,255,255,0.18);
      --btn-bg: linear-gradient(to right, #333, #555);
      --btn-hover: linear-gradient(to right, #444, #666);
      --accent: #0af;
    }

    body.light {
      --bg: #ffffff;
      --text: #111111;
      --text-secondary: #555555;
      --card-bg: rgba(0,0,0,0.04);
      --card-border: rgba(0,0,0,0.10);
      --input-bg: #ffffff;
      --input-border: #d0d0d0;
      --btn-bg: linear-gradient(to right, #ddd, #bbb);
      --btn-hover: linear-gradient(to right, #ccc, #aaa);
      --accent: #0066cc;
    }

    * { margin:0; padding:0; box-sizing:border-box; font-family:'Manrope',sans-serif; }
    body { background:var(--bg); color:var(--text); min-height:100vh; transition:background 0.4s, color 0.4s; }

    .top-bar { position:fixed; top:0; left:0; right:0; height:70px; display:flex; align-items:center; justify-content:space-between; padding:0 20px; background:rgba(0,0,0,0.6); backdrop-filter:blur(8px); z-index:1000; }
    body.light .top-bar { background:rgba(255,255,255,0.92); }

    .site-name { font-size:1.8rem; font-weight:800; background:linear-gradient(90deg,#ffffff,#bbbbbb); -webkit-background-clip:text; background-clip:text; color:transparent; }
    body.light .site-name { background:linear-gradient(90deg,#111111,#444444); -webkit-background-clip:text; background-clip:text; color:transparent; }

    .burger { width:32px; height:24px; display:flex; flex-direction:column; justify-content:space-between; cursor:pointer; }
    .burger span { height:3px; width:100%; background:var(--text); border-radius:2px; transition:all 0.35s ease; }
    .burger.active span:nth-child(1) { transform:rotate(45deg) translate(7px,7px); }
    .burger.active span:nth-child(2) { opacity:0; }
    .burger.active span:nth-child(3) { transform:rotate(-45deg) translate(6px,-6px); }

    .sidebar { position:fixed; top:0; left:-300px; width:280px; height:100%; background:rgba(0,0,0,0.5); backdrop-filter:blur(12px); padding:90px 28px; border-right:1px solid var(--card-border); transition:left 0.4s ease; z-index:900; }
    body.light .sidebar { background:rgba(255,255,255,0.5); }
    .sidebar.active { left:0; }

    .sidebar a { display:block; color:var(--text-secondary); text-decoration:none; font-size:1.22rem; font-weight:600; margin:1.4rem 0; transition:all 0.25s; cursor:pointer; }
    .sidebar a:hover { color:var(--text); transform:translateX(8px); }

    .main-content { margin-top:90px; padding:20px; max-width:720px; margin-left:auto; margin-right:auto; }

    .section { display:none; opacity:0; transform:translateY(12px); transition:opacity 0.35s, transform 0.35s; }
    .section.active { display:block; opacity:1; transform:translateY(0); }

    .card { background:var(--card-bg); border:1px solid var(--card-border); border-radius:14px; padding:20px; margin-bottom:20px; }

    input, textarea { width:100%; padding:12px 14px; border-radius:10px; border:1px solid var(--input-border); background:var(--input-bg); color:var(--text); font-size:1rem; outline:none; transition:border-color 0.2s; }
    input:focus, textarea:focus { border-color:var(--accent); }
    textarea { resize:vertical; min-height:96px; }
    ::placeholder { color:var(--text-secondary); opacity:0.7; }

    button { padding:11px 20px; border:none; border-radius:10px; background:var(--btn-bg); color:white; font-weight:700; cursor:pointer; transition:all 0.22s; box-shadow:0 2px 8px rgba(0,0,0,0.2); }
    button:hover { background:var(--btn-hover); transform:scale(1.03); }

    .feed { display:flex; flex-direction:column; gap:18px; }

    .post { background:var(--card-bg); border:1px solid var(--card-border); border-radius:12px; padding:16px; opacity:0; transform:translateY(24px); transition:opacity 0.5s, transform 0.5s; }
    .post.show { opacity:1; transform:translateY(0); }

    .post-header { display:flex; align-items:center; gap:12px; margin-bottom:12px; }
    .avatar { width:48px; height:48px; border-radius:50%; background:#555; background-size:cover; background-position:center; flex-shrink:0; border:1px solid var(--card-border); cursor:pointer; }
    .username { font-weight:700; font-size:1.05rem; cursor:pointer; color:var(--accent); }

    .post-content { line-height:1.5; word-break:break-word; }
    .post-media img, .post-media video { width:100%; border-radius:12px; margin-top:12px; }

    .post-footer { display:flex; gap:24px; margin-top:12px; flex-wrap:wrap; }
    .post-footer button { background:none; color:var(--text-secondary); font-size:0.95rem; padding:0; }
    .post-footer button:hover { color:var(--text); }

    .chat-list, .user-list { display:flex; flex-direction:column; gap:12px; }
    .chat-item, .user-item { display:flex; align-items:center; gap:12px; padding:12px; border-radius:12px; background:var(--card-bg); border:1px solid var(--card-border); cursor:pointer; transition:0.2s; }
    .chat-item:hover, .user-item:hover { background:rgba(255,255,255,0.08); }
    .chat-item .last-msg { font-size:0.9rem; color:var(--text-secondary); margin-top:3px; }

    .profile-header { display:flex; flex-wrap:wrap; gap:24px; align-items:flex-start; margin-bottom:32px; }
    .profile-avatar { width:110px; height:110px; border-radius:50%; background:#444; background-size:cover; border:2px solid var(--card-border); cursor:pointer; }
    body.light .profile-avatar { background:#ddd; }

    .modal { position:fixed; inset:0; background:rgba(0,0,0,0.75); display:none; align-items:center; justify-content:center; z-index:2000; }
    .modal.active { display:flex; }
    .modal-content { background:var(--card-bg); border:1px solid var(--card-border); width:92%; max-width:520px; border-radius:16px; padding:28px 24px; position:relative; }
    .close-modal { position:absolute; top:16px; right:20px; font-size:2.2rem; cursor:pointer; color:var(--text-secondary); }

    @media (max-width:900px) {
      .sidebar { width:100%; left:-100%; }
      .main-content { padding:16px; margin-top:80px; }
      .profile-header { flex-direction:column; align-items:center; text-align:center; }
    }
  </style>
</head>
<body>

<div class="top-bar">
  <div class="burger" id="burger"><span></span><span></span><span></span></div>
  <div class="site-name">FANTASYAS</div>
</div>

<nav class="sidebar" id="sidebar">
  <a data-section="home">–ì–æ–ª–æ–≤–Ω–∞</a>
  <a data-section="search">–ü–æ—à—É–∫</a>
  <a data-section="profile">–ú—ñ–π –ø—Ä–æ—Ñ—ñ–ª—å</a>
  <a data-section="chats">–ß–∞—Ç–∏</a>
  <a data-section="settings">–ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è</a>
</nav>

<main class="main-content">

  <div id="home" class="section active">
    <div class="card" id="authBox">
      <div id="loginForm">
        <input type="text" id="loginNickname" placeholder="–ü—Å–µ–≤–¥–æ–Ω—ñ–º –∞–±–æ email" autocomplete="off"/>
        <input type="password" id="loginPassword" placeholder="–ü–∞—Ä–æ–ª—å"/>
        <button id="loginBtn">–£–≤—ñ–π—Ç–∏</button>
        <button id="googleLoginBtn" style="background:#4285F4; margin:12px 0 8px; width:100%;">Google</button>
        <button id="appleLoginBtn" style="background:#000; margin:0; width:100%;">Apple</button>
        <p style="margin-top:16px; text-align:center;">–ù–µ–º–∞—î –∞–∫–∞—É–Ω—Ç–∞? <span id="toRegister" style="color:var(--accent);cursor:pointer;">–ó–∞—Ä–µ—î—Å—Ç—Ä—É–≤–∞—Ç–∏—Å—è</span></p>
      </div>

      <div id="registerForm" style="display:none;">
        <input type="text" id="registerNickname" placeholder="–ü—Å–µ–≤–¥–æ–Ω—ñ–º (—É–Ω—ñ–∫–∞–ª—å–Ω–∏–π)" autocomplete="off"/>
        <input type="email" id="registerEmail" placeholder="Email (–æ–ø—Ü—ñ–æ–Ω–∞–ª—å–Ω–æ)"/>
        <input type="password" id="registerPassword" placeholder="–ü–∞—Ä–æ–ª—å (–º—ñ–Ω. 6 —Å–∏–º–≤–æ–ª—ñ–≤)"/>
        <button id="registerBtn">–ó–∞—Ä–µ—î—Å—Ç—Ä—É–≤–∞—Ç–∏—Å—è</button>
        <p style="margin-top:16px; text-align:center;">–í–∂–µ —î –∞–∫–∞—É–Ω—Ç? <span id="toLogin" style="color:var(--accent);cursor:pointer;">–£–≤—ñ–π—Ç–∏</span></p>
      </div>
    </div>

    <div class="card" id="newPostBox" style="display:none;">
      <textarea id="postText" placeholder="–©–æ —É —Ç–µ–±–µ –Ω–∞ –¥—É–º—Ü—ñ?..."></textarea>
      <input type="file" id="postMedia" accept="image/*,video/*" style="margin:12px 0; display:block;"/>
      <button id="addPost">–û–ø—É–±–ª—ñ–∫—É–≤–∞—Ç–∏</button>
    </div>

    <div class="feed" id="feed"></div>
  </div>

  <div id="search" class="section">
    <input type="text" id="searchInput" class="search-input" placeholder="–ü–æ—à—É–∫ –∑–∞ @–Ω—ñ–∫–æ–º..."/>
    <div class="user-list" id="userList"></div>
  </div>

  <div id="profile" class="section">
    <div class="card profile-header" id="profileContent"></div>
  </div>

  <div id="chats" class="section">
    <div class="chat-list" id="chatList"></div>
    <div class="chat-window" id="chatWindow" style="display:none; margin-top:20px;">
      <div class="chat-header" id="chatHeader"></div>
      <div class="chat-messages" id="chatMessages" style="height:380px; overflow-y:auto; padding:12px; background:var(--card-bg); border-radius:0 0 12px 12px;"></div>
      <div class="chat-input" style="display:flex; padding:12px; border-top:1px solid var(--card-border);">
        <input type="text" id="chatText" placeholder="–ù–∞–ø–∏—à—ñ—Ç—å –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è..." style="flex:1; margin-right:8px;"/>
        <button id="sendMessage">‚Üí</button>
      </div>
    </div>
  </div>

  <div id="settings" class="section card">
    <h2>–ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è</h2>
    <button id="toggleTheme" style="margin:16px 0;">–ü–µ—Ä–µ–º–∫–Ω—É—Ç–∏ —Ç–µ–º—É</button>
    <button id="logoutBtn" style="margin:16px 0;">–í–∏–π—Ç–∏</button>
  </div>

</main>

<div class="modal" id="editProfileModal">
  <div class="modal-content">
    <span class="close-modal" id="closeModal">√ó</span>
    <h2>–†–µ–¥–∞–≥—É–≤–∞—Ç–∏ –ø—Ä–æ—Ñ—ñ–ª—å</h2>
    <input type="text" id="editNickname" placeholder="–ü—Å–µ–≤–¥–æ–Ω—ñ–º"/>
    <textarea id="editBio" placeholder="–ü—Ä–æ —Å–µ–±–µ..." rows="4"></textarea>
    <button id="saveProfileEdit" style="margin-top:16px; width:100%;">–ó–±–µ—Ä–µ–≥—Ç–∏</button>
  </div>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js";
  import {
    getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword,
    onAuthStateChanged, signOut, GoogleAuthProvider, OAuthProvider, signInWithPopup,
    updateProfile
  } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-auth.js";
  import {
    getFirestore, doc, setDoc, getDoc, updateDoc, collection, addDoc,
    query, where, onSnapshot, orderBy, serverTimestamp, arrayUnion, arrayRemove,
    runTransaction
  } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore.js";
  import {
    getStorage, ref, uploadBytes, getDownloadURL
  } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-storage.js";

  const firebaseConfig = {
    apiKey: "AIzaSyDRzC-QDE0-UXd-XL0i3iqayFiKcc6wmvc",
    authDomain: "fantasyasapp.firebaseapp.com",
    projectId: "fantasyasapp",
    storageBucket: "fantasyasapp.firebasestorage.app",
    messagingSenderId: "721763921060",
    appId: "1:721763921060:web:3d61044ea2424e8176ca31"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);
  const storage = getStorage(app);

  let currentUser = null;
  let currentChatPartner = null;
  let currentChatId = null;
  let unsubscribeFeed = null;
  let unsubscribeChats = null;
  let unsubscribeChat = null;

  // ‚îÄ‚îÄ‚îÄ Burger & Navigation ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  document.getElementById('burger').onclick = () => {
    document.getElementById('burger').classList.toggle('active');
    document.getElementById('sidebar').classList.toggle('active');
  };

  document.querySelectorAll('[data-section]').forEach(a => {
    a.onclick = () => {
      document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
      document.getElementById(a.dataset.section).classList.add('active');
      document.getElementById('sidebar').classList.remove('active');
      document.getElementById('burger').classList.remove('active');

      if (a.dataset.section === 'search') loadSearchUsers();
      if (a.dataset.section === 'chats') loadChatList();
      if (a.dataset.section === 'profile') loadMyProfile();
    };
  });

  // ‚îÄ‚îÄ‚îÄ Auth Forms Toggle ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  document.getElementById('toRegister').onclick = () => {
    document.getElementById('loginForm').style.display = 'none';
    document.getElementById('registerForm').style.display = 'block';
  };
  document.getElementById('toLogin').onclick = () => {
    document.getElementById('registerForm').style.display = 'none';
    document.getElementById('loginForm').style.display = 'block';
  };

  // ‚îÄ‚îÄ‚îÄ Registration ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  document.getElementById('registerBtn').onclick = async () => {
    const nick = document.getElementById('registerNickname').value.trim();
    const email = document.getElementById('registerEmail').value.trim() || null;
    const pass = document.getElementById('registerPassword').value;

    if (!nick) return alert("–í–∫–∞–∂—ñ—Ç—å –ø—Å–µ–≤–¥–æ–Ω—ñ–º");
    if (pass.length < 6) return alert("–ü–∞—Ä–æ–ª—å –º—ñ–Ω—ñ–º—É–º 6 —Å–∏–º–≤–æ–ª—ñ–≤");

    try {
      let cred;
      if (email) {
        cred = await createUserWithEmailAndPassword(auth, email, pass);
      } else {
        const fakeEmail = `${nick.toLowerCase().replace(/[^a-z0-9]/g,'')}@fantasy.local`;
        cred = await createUserWithEmailAndPassword(auth, fakeEmail, pass);
      }

      const uid = cred.user.uid;

      // –£–Ω—ñ–∫–∞–ª—å–Ω—ñ—Å—Ç—å –Ω—ñ–∫—É
      await runTransaction(db, async (transaction) => {
        const usernameRef = doc(db, "usernames", nick.toLowerCase());
        if ((await transaction.get(usernameRef)).exists()) {
          throw new Error("–¢–∞–∫–∏–π –ø—Å–µ–≤–¥–æ–Ω—ñ–º –≤–∂–µ –∑–∞–π–Ω—è—Ç–∏–π");
        }
        transaction.set(usernameRef, { uid });
      });

      await setDoc(doc(db, "users", uid), {
        nickname: nick,
        nickname_lower: nick.toLowerCase(),
        email: cred.user.email,
        bio: "",
        avatar: "",
        posts: [],
        followers: [],
        following: [],
        createdAt: serverTimestamp()
      });

      alert("–†–µ—î—Å—Ç—Ä–∞—Ü—ñ—è —É—Å–ø—ñ—à–Ω–∞!");
      document.getElementById('toLogin').click();
    } catch (e) {
      alert(e.message.includes("–∑–∞–π–Ω—è—Ç–∏–π") ? "–ü—Å–µ–≤–¥–æ–Ω—ñ–º –≤–∂–µ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î—Ç—å—Å—è" : e.message);
    }
  };

  // ‚îÄ‚îÄ‚îÄ Login ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  document.getElementById('loginBtn').onclick = async () => {
    let identifier = document.getElementById('loginNickname').value.trim();
    const pass = document.getElementById('loginPassword').value;

    if (!identifier || !pass) return alert("–ó–∞–ø–æ–≤–Ω—ñ—Ç—å –ø–æ–ª—è");

    try {
      let email = identifier;
      if (!identifier.includes("@")) {
        const q = query(collection(db, "users"), where("nickname_lower", "==", identifier.toLowerCase()));
        const snap = await getDocs(q);
        if (snap.empty) throw new Error("–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ");
        email = snap.docs[0].data().email;
      }
      await signInWithEmailAndPassword(auth, email, pass);
    } catch (e) {
      alert("–ù–µ–≤—ñ—Ä–Ω–∏–π –ª–æ–≥—ñ–Ω/–ø–∞—Ä–æ–ª—å –∞–±–æ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ");
    }
  };

  // Google & Apple
  document.getElementById('googleLoginBtn').onclick = async () => {
    const provider = new GoogleAuthProvider();
    try {
      const result = await signInWithPopup(auth, provider);
      await handleSocialLogin(result.user);
    } catch (e) { alert("Google: " + e.message); }
  };

  document.getElementById('appleLoginBtn').onclick = async () => {
    const provider = new OAuthProvider('apple.com');
    try {
      const result = await signInWithPopup(auth, provider);
      await handleSocialLogin(result.user);
    } catch (e) { alert("Apple: " + e.message); }
  };

  async function handleSocialLogin(user) {
    const userRef = doc(db, "users", user.uid);
    const snap = await getDoc(userRef);
    if (!snap.exists()) {
      const nick = user.displayName?.split(" ")[0] || user.email.split("@")[0];
      let finalNick = nick;
      let counter = 1;
      while (true) {
        const usernameRef = doc(db, "usernames", finalNick.toLowerCase());
        if (!(await getDoc(usernameRef)).exists()) break;
        finalNick = `${nick}${counter++}`;
      }

      await runTransaction(db, async t => {
        t.set(doc(db, "usernames", finalNick.toLowerCase()), { uid: user.uid });
      });

      await setDoc(userRef, {
        nickname: finalNick,
        nickname_lower: finalNick.toLowerCase(),
        email: user.email,
        bio: "",
        avatar: user.photoURL || "",
        posts: [],
        followers: [],
        following: [],
        createdAt: serverTimestamp()
      });
    }
  }

  onAuthStateChanged(auth, user => {
    currentUser = user;
    if (user) {
      document.getElementById('authBox').style.display = 'none';
      document.getElementById('newPostBox').style.display = 'block';
      subscribeToFeed();
      loadMyProfile();
    } else {
      document.getElementById('authBox').style.display = 'block';
      document.getElementById('newPostBox').style.display = 'none';
      if (unsubscribeFeed) unsubscribeFeed();
    }
  });

  // ‚îÄ‚îÄ‚îÄ Feed ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  function subscribeToFeed() {
    if (unsubscribeFeed) unsubscribeFeed();
    const q = query(collection(db, "posts"), orderBy("createdAt", "desc"));
    unsubscribeFeed = onSnapshot(q, async snap => {
      const feed = document.getElementById('feed');
      feed.innerHTML = '';
      let delay = 0;
      for (const d of snap.docs) {
        const post = d.data();
        const authorSnap = await getDoc(doc(db, "users", post.author));
        const author = authorSnap.exists() ? authorSnap.data() : { nickname:"‚Äî", avatar:"" };

        const postEl = document.createElement('div');
        postEl.className = 'post';
        postEl.innerHTML = `
          <div class="post-header">
            <div class="avatar" style="background-image:url(${author.avatar})" data-uid="${post.author}"></div>
            <div class="username" data-uid="${post.author}">@${author.nickname}</div>
          </div>
          <div class="post-content">${(post.text||'').replace(/\n/g,'<br>')}</div>
          ${post.mediaUrl ? (post.mediaType==='image' ? `<img src="${post.mediaUrl}" class="post-media">` : `<video src="${post.mediaUrl}" controls class="post-media"></video>`) : ''}
          <div class="post-footer">
            <button>‚ù§Ô∏è ${post.likes?.length || 0}</button>
            <button>üí¨ ${post.comments?.length || 0}</button>
          </div>
        `;

        feed.appendChild(postEl);
        setTimeout(() => postEl.classList.add('show'), delay);
        delay += 80;
      }
    });
  }

  // ‚îÄ‚îÄ‚îÄ Profile (my & others) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  document.getElementById('feed').addEventListener('click', e => {
    const uid = e.target.dataset.uid;
    if (uid) openProfile(uid);
  });

  async function openProfile(uid) {
    if (uid === currentUser?.uid) {
      loadMyProfile();
      document.querySelector('[data-section="profile"]').click();
      return;
    }

    const userSnap = await getDoc(doc(db, "users", uid));
    if (!userSnap.exists()) return alert("–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ");

    const data = userSnap.data();
    renderProfile(data, uid, false);
  }

  async function loadMyProfile() {
    if (!currentUser) return;
    const snap = await getDoc(doc(db, "users", currentUser.uid));
    if (snap.exists()) renderProfile(snap.data(), currentUser.uid, true);
  }

  function renderProfile(data, uid, isOwn) {
    const container = document.getElementById('profileContent');
    container.innerHTML = `
      <div class="profile-avatar" id="profileAvatar" style="background-image:url(${data.avatar||''})"></div>
      <div style="flex:1;">
        <h2>@${data.nickname}</h2>
        <p style="margin:8px 0; color:var(--text-secondary);">${data.bio || '–ù–µ–º–∞—î –æ–ø–∏—Å—É'}</p>
        <div style="display:flex; gap:24px; font-weight:600; color:var(--text-secondary);">
          <span>–ü–æ—Å—Ç–∏: ${data.posts?.length || 0}</span>
          <span>–ü—ñ–¥–ø–∏—Å–Ω–∏–∫–∏: ${data.followers?.length || 0}</span>
          <span>–ü—ñ–¥–ø–∏—Å–∫–∏: ${data.following?.length || 0}</span>
        </div>
      </div>
      ${isOwn ? `<button id="editProfileBtn">–†–µ–¥–∞–≥—É–≤–∞—Ç–∏</button>` : `<button id="followBtn">${data.followers?.includes(currentUser?.uid) ? '–í—ñ–¥–ø–∏—Å–∞—Ç–∏—Å—è' : '–ü—ñ–¥–ø–∏—Å–∞—Ç–∏—Å—è'}</button>`}
    `;

    if (isOwn) {
      document.getElementById('profileAvatar').onclick = () => document.getElementById('avatarInput')?.click?.();
      document.getElementById('editProfileBtn').onclick = () => {
        document.getElementById('editNickname').value = data.nickname;
        document.getElementById('editBio').value = data.bio || '';
        document.getElementById('editProfileModal').classList.add('active');
      };
    } else {
      document.getElementById('followBtn').onclick = () => toggleFollow(uid);
    }
  }

  // ‚îÄ‚îÄ‚îÄ Edit Profile ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  document.getElementById('saveProfileEdit').onclick = async () => {
    const nick = document.getElementById('editNickname').value.trim();
    const bio = document.getElementById('editBio').value.trim();

    if (!nick) return alert("–ü—Å–µ–≤–¥–æ–Ω—ñ–º –Ω–µ –º–æ–∂–µ –±—É—Ç–∏ –ø–æ—Ä–æ–∂–Ω—ñ–º");

    try {
      if (nick.toLowerCase() !== currentUser.displayName?.toLowerCase()) {
        await runTransaction(db, async t => {
          const oldRef = doc(db, "usernames", currentUser.displayName?.toLowerCase() || "");
          const newRef = doc(db, "usernames", nick.toLowerCase());
          if ((await t.get(newRef)).exists()) throw new Error("–ù—ñ–∫ –∑–∞–π–Ω—è—Ç–∏–π");
          if (oldRef.id) t.delete(oldRef);
          t.set(newRef, { uid: currentUser.uid });
        });
      }

      await updateDoc(doc(db, "users", currentUser.uid), { nickname: nick, nickname_lower: nick.toLowerCase(), bio });
      document.getElementById('editProfileModal').classList.remove('active');
      loadMyProfile();
    } catch (e) {
      alert(e.message.includes("–∑–∞–π–Ω—è—Ç–∏–π") ? "–¢–∞–∫–∏–π –ø—Å–µ–≤–¥–æ–Ω—ñ–º –≤–∂–µ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î—Ç—å—Å—è" : e.message);
    }
  };

  document.getElementById('closeModal').onclick = () => document.getElementById('editProfileModal').classList.remove('active');

  // ‚îÄ‚îÄ‚îÄ Follow / Unfollow ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  async function toggleFollow(targetUid) {
    if (!currentUser) return alert("–£–≤—ñ–π–¥—ñ—Ç—å");
    const myRef = doc(db, "users", currentUser.uid);
    const targetRef = doc(db, "users", targetUid);

    const mySnap = await getDoc(myRef);
    const following = mySnap.data().following || [];

    if (following.includes(targetUid)) {
      await updateDoc(myRef, { following: arrayRemove(targetUid) });
      await updateDoc(targetRef, { followers: arrayRemove(currentUser.uid) });
    } else {
      await updateDoc(myRef, { following: arrayUnion(targetUid) });
      await updateDoc(targetRef, { followers: arrayUnion(currentUser.uid) });
    }

    // –æ–Ω–æ–≤–ª—é—î–º–æ –ø—Ä–æ—Ñ—ñ–ª—å, —è–∫—â–æ –≤—ñ–¥–∫—Ä–∏—Ç–∏–π
    if (document.getElementById('profile').classList.contains('active')) {
      openProfile(targetUid);
    }
  }

  // ‚îÄ‚îÄ‚îÄ Search ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  function debounce(fn, ms = 350) {
    let timer;
    return (...args) => { clearTimeout(timer); timer = setTimeout(() => fn(...args), ms); };
  }

  const searchHandler = debounce(async () => {
    const val = document.getElementById('searchInput').value.trim().toLowerCase();
    const list = document.getElementById('userList');
    list.innerHTML = '';

    if (val.length < 2) return;

    const q = query(
      collection(db, "users"),
      where("nickname_lower", ">=", val),
      where("nickname_lower", "<=", val + '\uf8ff')
    );

    const snap = await getDocs(q);
    snap.forEach(d => {
      if (d.id === currentUser?.uid) return;
      const data = d.data();
      const item = document.createElement('div');
      item.className = 'user-item';
      item.innerHTML = `
        <div class="avatar" style="background-image:url(${data.avatar||''})" data-uid="${d.id}"></div>
        <div>@${data.nickname}</div>
        <button style="margin-left:auto; padding:6px 14px; font-size:0.9rem;" data-uid="${d.id}">
          ${data.followers?.includes(currentUser?.uid) ? '–í—ñ–¥–ø–∏—Å–∞—Ç–∏—Å—è' : '–ü—ñ–¥–ø–∏—Å–∞—Ç–∏—Å—è'}
        </button>
      `;
      item.querySelector('button').onclick = e => {
        e.stopPropagation();
        toggleFollow(d.id);
      };
      item.onclick = () => openProfile(d.id);
      list.appendChild(item);
    });
  });

  document.getElementById('searchInput').oninput = searchHandler;

  // ‚îÄ‚îÄ‚îÄ Chats ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  async function loadChatList() {
    if (unsubscribeChats) unsubscribeChats();

    const myChatsQ = query(
      collection(db, "chats"),
      where("participants", "array-contains", currentUser.uid),
      orderBy("lastMessageTime", "desc")
    );

    unsubscribeChats = onSnapshot(myChatsQ, async snap => {
      const container = document.getElementById('chatList');
      container.innerHTML = '';

      if (snap.empty) {
        container.innerHTML = '<p style="text-align:center; color:var(--text-secondary);">–©–µ –Ω–µ–º–∞—î —á–∞—Ç—ñ–≤</p>';
        return;
      }

      for (const d of snap.docs) {
        const chat = d.data();
        const otherId = chat.participants.find(id => id !== currentUser.uid);
        const otherSnap = await getDoc(doc(db, "users", otherId));
        const other = otherSnap.exists() ? otherSnap.data() : { nickname:"‚Äî", avatar:"" };

        const item = document.createElement('div');
        item.className = 'chat-item';
        item.innerHTML = `
          <div class="avatar" style="background-image:url(${other.avatar})"></div>
          <div>
            <div>@${other.nickname}</div>
            <div class="last-msg">${(chat.lastMessage?.text || "–ù–µ–º–∞—î –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω—å").substring(0,38)}${(chat.lastMessage?.text?.length > 38)?'...':''}</div>
          </div>
        `;
        item.onclick = () => openChat(other.nickname, otherId, d.id);
        container.appendChild(item);
      }
    });
  }

  function openChat(name, uid, chatId) {
    currentChatPartner = uid;
    currentChatId = chatId;
    document.getElementById('chatWindow').style.display = 'block';
    document.getElementById('chatHeader').textContent = `@${name}`;

    if (unsubscribeChat) unsubscribeChat();

    const msgQ = query(collection(db, `chats/${chatId}/messages`), orderBy("createdAt"));
    unsubscribeChat = onSnapshot(msgQ, snap => {
      const container = document.getElementById('chatMessages');
      container.innerHTML = '';
      snap.forEach(m => {
        const msg = m.data();
        const div = document.createElement('div');
        div.style.cssText = `
          align-self: ${msg.from === currentUser.uid ? 'flex-end' : 'flex-start'};
          background: ${msg.from === currentUser.uid ? 'var(--accent)' : 'var(--input-bg)'};
          color: ${msg.from === currentUser.uid ? '#fff' : 'var(--text)'};
          padding: 9px 14px;
          border-radius: 18px;
          max-width: 76%;
          margin: 4px 0;
        `;
        div.textContent = msg.text;
        container.appendChild(div);
      });
      container.scrollTop = container.scrollHeight;
    });
  }

  document.getElementById('sendMessage').onclick = async () => {
    const text = document.getElementById('chatText').value.trim();
    if (!text || !currentChatId) return;

    const msgRef = collection(db, `chats/${currentChatId}/messages`);
    await addDoc(msgRef, {
      from: currentUser.uid,
      text,
      createdAt: serverTimestamp()
    });

    await updateDoc(doc(db, "chats", currentChatId), {
      lastMessage: { text, from: currentUser.uid, createdAt: serverTimestamp() },
      lastMessageTime: serverTimestamp()
    });

    document.getElementById('chatText').value = '';
  };

  // ‚îÄ‚îÄ‚îÄ New Post ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  document.getElementById('addPost').onclick = async () => {
    if (!currentUser) return;

    const text = document.getElementById('postText').value.trim();
    const file = document.getElementById('postMedia').files[0];

    if (!text && !file) return alert("–î–æ–¥–∞–π—Ç–µ —Ç–µ–∫—Å—Ç –∞–±–æ –º–µ–¥—ñ–∞");

    let mediaUrl = '';
    if (file) {
      const r = ref(storage, `posts/${currentUser.uid}/${Date.now()}_${file.name}`);
      await uploadBytes(r, file);
      mediaUrl = await getDownloadURL(r);
    }

    const postRef = await addDoc(collection(db, "posts"), {
      author: currentUser.uid,
      text,
      mediaUrl,
      mediaType: file ? file.type.split('/')[0] : '',
      createdAt: serverTimestamp(),
      likes: [],
      comments: []
    });

    await updateDoc(doc(db, "users", currentUser.uid), {
      posts: arrayUnion(postRef.id)
    });

    document.getElementById('postText').value = '';
    document.getElementById('postMedia').value = '';
  };

  // ‚îÄ‚îÄ‚îÄ Theme & Logout ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  document.getElementById('toggleTheme').onclick = () => {
    document.body.classList.toggle('light');
    localStorage.setItem('theme', document.body.classList.contains('light') ? 'light' : 'dark');
  };
  if (localStorage.getItem('theme') === 'light') document.body.classList.add('light');

  document.getElementById('logoutBtn').onclick = () => signOut(auth);

  // –ü–æ—á–∞—Ç–∫–æ–≤–µ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –ø—Ä–æ—Ñ—ñ–ª—é –ø—ñ—Å–ª—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü—ñ—ó
  loadMyProfile();
</script>
</body>
</html>

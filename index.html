<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>FANTASYAS</title>
  <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@500;600;700;800&display=swap" rel="stylesheet"/>
  
  <style>
    :root {
      --bg: #000;
      --text: #ffffff;
      --text-secondary: #cccccc;
      --card-bg: rgba(255,255,255,0.06);
      --card-border: rgba(255,255,255,0.12);
      --input-bg: rgba(255,255,255,0.08);
      --input-border: rgba(255,255,255,0.18);
      --btn-bg: #555;
      --accent: #0af;
    }

    body.light {
      --bg: #ffffff;
      --text: #111111;
      --text-secondary: #555555;
      --card-bg: rgba(0,0,0,0.04);
      --card-border: rgba(0,0,0,0.10);
      --input-bg: #ffffff;
      --input-border: #d0d0d0;
      --btn-bg: #444444;
      --accent: #0066cc;
    }

    * { margin:0; padding:0; box-sizing:border-box; font-family:'Manrope',sans-serif; }
    body { background:var(--bg); color:var(--text); min-height:100vh; transition:background 0.4s, color 0.4s; }

    .top-bar { position:fixed; top:0; left:0; right:0; height:70px; display:flex; align-items:center; justify-content:space-between; padding:0 20px; background:rgba(0,0,0,0.6); backdrop-filter:blur(8px); z-index:1000; transition:background 0.3s; }
    body.light .top-bar { background:rgba(255,255,255,0.92); }

    .site-name { font-size:1.8rem; font-weight:800; background:linear-gradient(90deg,#ffffff,#bbbbbb); -webkit-background-clip:text; background-clip:text; color:transparent; -webkit-text-fill-color:transparent; }
    body.light .site-name { background:linear-gradient(90deg,#111111,#444444); -webkit-background-clip:text; background-clip:text; color:transparent; -webkit-text-fill-color:transparent; }

    .burger { width:32px; height:24px; display:flex; flex-direction:column; justify-content:space-between; cursor:pointer; }
    .burger span { height:3px; width:100%; background:var(--text); border-radius:2px; transition:all 0.35s ease; }
    .burger.active span:nth-child(1) { transform:rotate(45deg) translate(7px,7px); }
    .burger.active span:nth-child(2) { opacity:0; }
    .burger.active span:nth-child(3) { transform:rotate(-45deg) translate(6px,-6px); }

    .sidebar { position:fixed; top:0; left:-300px; width:280px; height:100%; background:rgba(0,0,0,0.5); backdrop-filter:blur(12px); padding:90px 28px; border-right:1px solid var(--card-border); transition:left 0.4s ease; z-index:900; }
    body.light .sidebar { background:rgba(255,255,255,0.5); }
    .sidebar.active { left:0; }

    .sidebar a { display:block; color:var(--text-secondary); text-decoration:none; font-size:1.22rem; font-weight:600; margin:1.4rem 0; transition:all 0.25s; }
    .sidebar a:hover { color:var(--text); transform:translateX(8px); }

    .main-content { margin-top:90px; padding:20px; max-width:720px; margin-left:auto; margin-right:auto; }

    .section { display:none; opacity:0; transform:translateY(12px); transition:opacity 0.35s, transform 0.35s; }
    .section.active { display:block; opacity:1; transform:translateY(0); }

    .card { background:var(--card-bg); border:1px solid var(--card-border); border-radius:14px; padding:20px; margin-bottom:20px; transition:all 0.2s; }

    input, textarea { width:100%; padding:12px 14px; border-radius:10px; border:1px solid var(--input-border); background:var(--input-bg); color:var(--text); font-size:1rem; outline:none; transition:border-color 0.2s; }
    input:focus, textarea:focus { border-color:var(--accent); }
    textarea { resize:vertical; min-height:96px; }
    ::placeholder { color:var(--text-secondary); opacity:0.7; }

    button { padding:11px 20px; border:none; border-radius:10px; background:var(--btn-bg); color:white; font-weight:700; cursor:pointer; transition:all 0.22s; }
    button:hover { opacity:0.92; transform:scale(1.03); }

    .feed { display:flex; flex-direction:column; gap:18px; }

    .post { background:var(--card-bg); border:1px solid var(--card-border); border-radius:12px; padding:16px; opacity:0; transform:translateY(24px); transition:opacity 0.5s, transform 0.5s; }
    .post.show { opacity:1; transform:translateY(0); }

    .post-header { display:flex; align-items:center; gap:12px; margin-bottom:12px; }

    .avatar { width:48px; height:48px; border-radius:50%; background:#555; background-size:cover; background-position:center; flex-shrink:0; border:1px solid var(--card-border); }
    body.light .avatar { background:#ccc; }

    .username { font-weight:700; font-size:1.05rem; }

    .post-content { line-height:1.5; word-break:break-word; color:var(--text); }

    .post-media img, .post-media video { width:100%; border-radius:12px; margin-top:12px; }

    .post-footer { display:flex; gap:24px; margin-top:12px; }
    .post-footer button { background:none; color:var(--text-secondary); font-size:0.95rem; padding:0; cursor:pointer; }
    .post-footer button:hover { color:var(--text); }

    .modal { position:fixed; inset:0; background:rgba(0,0,0,0.75); display:none; align-items:center; justify-content:center; z-index:2000; }
    body.light .modal { background:rgba(255,255,255,0.75); }
    .modal.active { display:flex; }

    .modal-content { background:var(--card-bg); border:1px solid var(--card-border); color:var(--text); width:92%; max-width:520px; border-radius:16px; padding:28px 24px; position:relative; }

    .modal-content h2 { color:var(--text); margin-bottom:20px; }

    .close-modal { position:absolute; top:16px; right:20px; font-size:2rem; cursor:pointer; color:var(--text-secondary); }

    .profile-header { display:flex; flex-wrap:wrap; gap:24px; align-items:flex-start; margin-bottom:32px; }

    .profile-avatar { width:110px; height:110px; border-radius:50%; background:#444; background-size:cover; background-position:center; border:2px solid var(--card-border); cursor:pointer; }
    body.light .profile-avatar { background:#ddd; }

    .search-input { margin-bottom:20px; }
    .user-list { display:flex; flex-direction:column; gap:12px; }
    .user-item { display:flex; align-items:center; gap:12px; padding:8px; border-radius:10px; background:var(--card-bg); border:1px solid var(--card-border); cursor:pointer; }
    .user-item:hover { background:var(--input-bg); }
    .user-item .avatar { width:50px; height:50px; }
    .user-item .name { font-weight:600; }
    .user-item .status { color:var(--text-secondary); font-size:0.9rem; }

    .chat-list { display:flex; flex-direction:column; gap:12px; }
    .chat-item { display:flex; align-items:center; gap:12px; padding:8px; border-radius:10px; background:var(--card-bg); border:1px solid var(--card-border); cursor:pointer; }
    .chat-item:hover { background:var(--input-bg); }

    .chat-window { display:none; flex-direction:column; height:400px; border:1px solid var(--card-border); border-radius:12px; overflow:hidden; }
    .chat-header { padding:12px; border-bottom:1px solid var(--card-border); display:flex; align-items:center; gap:8px; }
    .chat-messages { flex:1; padding:12px; overflow-y:auto; display:flex; flex-direction:column; gap:8px; }
    .message { padding:8px 12px; border-radius:10px; max-width:80%; }
    .message.sent { background:var(--accent); color:white; align-self:flex-end; }
    .message.received { background:var(--input-bg); align-self:flex-start; }
    .chat-input { display:flex; padding:12px; border-top:1px solid var(--card-border); }
    .chat-input input { flex:1; margin-right:8px; }

    @media (max-width:900px) {
      .sidebar { width:100%; left:-100%; border-right:none; }
      .main-content { padding:16px; margin-top:80px; }
      .profile-header { flex-direction:column; align-items:center; text-align:center; }
    }
  </style>
</head>
<body>

<div class="top-bar">
  <div class="burger" id="burger"><span></span><span></span><span></span></div>
  <div class="site-name">FANTASYAS</div>
</div>

<nav class="sidebar" id="sidebar">
  <a data-section="home">–ì–æ–ª–æ–≤–Ω–∞</a>
  <a data-section="search">–ü–æ—à—É–∫</a>
  <a data-section="profile">–ü—Ä–æ—Ñ—ñ–ª—å</a>
  <a data-section="chats">–ß–∞—Ç–∏</a>
  <a data-section="settings">–ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è</a>
</nav>

<main class="main-content">

  <div id="home" class="section active">
    <div class="card" id="authBox">
      <div id="loginForm">
        <input type="text" id="loginNickname" placeholder="–ü—Å–µ–≤–¥–æ–Ω—ñ–º" autocomplete="off"/>
        <input type="password" id="loginPassword" placeholder="–ü–∞—Ä–æ–ª—å"/>
        <button id="loginBtn">–£–≤—ñ–π—Ç–∏</button>
        <p style="margin-top:12px;">–ù–µ–º–∞—î –∞–∫–∞—É–Ω—Ç–∞? <span id="toRegister" style="color:var(--accent);cursor:pointer;">–ó–∞—Ä–µ—î—Å—Ç—Ä—É–≤–∞—Ç–∏—Å—è</span></p>
      </div>

      <div id="registerForm" style="display:none;">
        <input type="text" id="registerNickname" placeholder="–ü—Å–µ–≤–¥–æ–Ω—ñ–º" autocomplete="off"/>
        <input type="password" id="registerPassword" placeholder="–ü–∞—Ä–æ–ª—å"/>
        <button id="registerBtn">–ó–∞—Ä–µ—î—Å—Ç—Ä—É–≤–∞—Ç–∏—Å—è</button>
        <p style="margin-top:12px;">–í–∂–µ —î –∞–∫–∞—É–Ω—Ç? <span id="toLogin" style="color:var(--accent);cursor:pointer;">–£–≤—ñ–π—Ç–∏</span></p>
      </div>
    </div>

    <div class="card" id="newPostBox" style="display:none;">
      <textarea id="postText" placeholder="–©–æ —É —Ç–µ–±–µ –Ω–∞ –¥—É–º—Ü—ñ?..."></textarea>
      <input type="file" id="postMedia" accept="image/*,video/*" style="margin:12px 0; display:block;"/>
      <button id="addPost">–û–ø—É–±–ª—ñ–∫—É–≤–∞—Ç–∏</button>
    </div>

    <div class="feed" id="feed"></div>
  </div>

  <div id="search" class="section">
    <input type="text" id="searchInput" class="search-input" placeholder="–ü–æ—à—É–∫ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ–≤..."/>
    <div class="user-list" id="userList"></div>
  </div>

  <div id="profile" class="section">
    <div class="card profile-header">
      <div class="profile-avatar" id="profileAvatar"></div>
      <input type="file" id="avatarInput" accept="image/*" style="display:none;"/>
      <div style="flex:1;">
        <h2 id="profileUsernameDisplay"></h2>
        <p id="profileBio" style="margin:8px 0;color:var(--text-secondary);">–ù–µ–º–∞—î –æ–ø–∏—Å—É</p>
        <p id="profileStatus" style="margin:8px 0;color:var(--accent);">–û–Ω–ª–∞–π–Ω</p>
        <div style="display:flex;gap:20px;font-weight:600;color:var(--text-secondary);">
          <span id="postsCount">–ü–æ—Å—Ç–∏: 0</span>
          <span id="followersCount">–ü—ñ–¥–ø–∏—Å–Ω–∏–∫–∏: 0</span>
          <span id="followingCount">–ü—ñ–¥–ø–∏—Å–∫–∏: 0</span>
        </div>
      </div>
      <button id="editProfileBtn">–†–µ–¥–∞–≥—É–≤–∞—Ç–∏ –ø—Ä–æ—Ñ—ñ–ª—å</button>
    </div>
  </div>

  <div id="chats" class="section">
    <div class="chat-list" id="chatList"></div>
    <div class="chat-window" id="chatWindow" style="display:none;">
      <div class="chat-header" id="chatHeader"></div>
      <div class="chat-messages" id="chatMessages"></div>
      <div class="chat-input">
        <input type="text" id="chatText" placeholder="–ù–∞–ø–∏—à—ñ—Ç—å –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è..."/>
        <button id="sendMessage">–í—ñ–¥–ø—Ä–∞–≤–∏—Ç–∏</button>
      </div>
    </div>
  </div>

  <div id="settings" class="section card">
    <h2>–ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è</h2>
    <button id="toggleTheme" style="margin:16px 0;">–ü–µ—Ä–µ–º–∫–Ω—É—Ç–∏ —Ç–µ–º—É</button>
    <button id="logoutBtn" style="margin:16px 0;">–í–∏–π—Ç–∏</button>
  </div>

</main>

<div class="modal" id="editProfileModal">
  <div class="modal-content">
    <span class="close-modal" id="closeModal">√ó</span>
    <h2>–†–µ–¥–∞–≥—É–≤–∞—Ç–∏ –ø—Ä–æ—Ñ—ñ–ª—å</h2>
    <textarea id="editBio" placeholder="–†–æ–∑–∫–∞–∂–∏ –ø—Ä–æ —Å–µ–±–µ..." rows="5"></textarea>
    <button id="saveProfileEdit" style="margin-top:16px;">–ó–±–µ—Ä–µ–≥—Ç–∏</button>
  </div>
</div>

<script type="module">
  // Firebase —ñ–º–ø–æ—Ä—Ç–∏ (10.14.1 ‚Äî —Å—Ç–∞–±—ñ–ª—å–Ω–∞ –≤–µ—Ä—Å—ñ—è)
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js";
  import {
    getAuth,
    createUserWithEmailAndPassword,
    signInWithEmailAndPassword,
    onAuthStateChanged,
    signOut
  } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-auth.js";
  import {
    getFirestore,
    doc,
    setDoc,
    getDoc,
    updateDoc,
    collection,
    addDoc,
    query,
    where,
    getDocs,
    onSnapshot,
    orderBy,
    serverTimestamp,
    arrayUnion,
    arrayRemove,
    limit
  } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore.js";
  import {
    getStorage,
    ref,
    uploadBytes,
    getDownloadURL
  } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-storage.js";

  const firebaseConfig = {
    apiKey: "AIzaSyDRzC-QDE0-UXd-XL0i3iqayFiKcc6wmvc",
    authDomain: "fantasyasapp.firebaseapp.com",
    projectId: "fantasyasapp",
    storageBucket: "fantasyasapp.firebasestorage.app",
    messagingSenderId: "721763921060",
    appId: "1:721763921060:web:3d61044ea2424e8176ca31"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);
  const storage = getStorage(app);

  let currentUser = null;
  let unsubscribeFeed = null;
  let unsubscribeChat = null;
  let currentChatPartner = null;

  // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  // Burger + sidebar (–±–µ–∑ –∑–º—ñ–Ω)
  // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  document.getElementById('burger').onclick = () => {
    document.getElementById('burger').classList.toggle('active');
    document.getElementById('sidebar').classList.toggle('active');
  };

  document.querySelectorAll('[data-section]').forEach(link => {
    link.onclick = () => {
      document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
      document.getElementById(link.dataset.section).classList.add('active');
      document.getElementById('sidebar').classList.remove('active');
      document.getElementById('burger').classList.remove('active');
      if (link.dataset.section === 'search') loadSearchUsers();
      if (link.dataset.section === 'chats') loadChatList();
      if (link.dataset.section === 'profile') loadProfile();
    };
  });

  // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  // –ü–µ—Ä–µ–º–∏–∫–∞–Ω–Ω—è —Ñ–æ—Ä–º
  // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  document.getElementById('toRegister').onclick = () => {
    document.getElementById('loginForm').style.display = 'none';
    document.getElementById('registerForm').style.display = 'block';
  };

  document.getElementById('toLogin').onclick = () => {
    document.getElementById('registerForm').style.display = 'none';
    document.getElementById('loginForm').style.display = 'block';
  };

  // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  // –†–µ—î—Å—Ç—Ä–∞—Ü—ñ—è
  // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  document.getElementById('registerBtn').onclick = async () => {
    const nickname = document.getElementById('registerNickname').value.trim();
    const password = document.getElementById('registerPassword').value.trim();

    if (!nickname) return alert('–í–≤–µ–¥—ñ—Ç—å –ø—Å–µ–≤–¥–æ–Ω—ñ–º');
    if (password.length < 6) return alert('–ü–∞—Ä–æ–ª—å –º—ñ–Ω—ñ–º—É–º 6 —Å–∏–º–≤–æ–ª—ñ–≤');

    try {
      const safeNick = nickname.toLowerCase().replace(/[^a-z0-9]/g, '');
      if (!safeNick) return alert('–ü—Å–µ–≤–¥–æ–Ω—ñ–º –º–æ–∂–µ –º—ñ—Å—Ç–∏—Ç–∏ —Ç—ñ–ª—å–∫–∏ –ª–∞—Ç–∏–Ω—Å—å–∫—ñ –ª—ñ—Ç–µ—Ä–∏ —Ç–∞ —Ü–∏—Ñ—Ä–∏');
      const email = `${safeNick}@fantasyas.local`;

      const cred = await createUserWithEmailAndPassword(auth, email, password);
      const uid = cred.user.uid;

      await setDoc(doc(db, "users", uid), {
        nickname,
        bio: "",
        avatar: "",
        posts: [],
        followers: [],
        following: [],
        createdAt: serverTimestamp()
      });

      alert('–†–µ—î—Å—Ç—Ä–∞—Ü—ñ—è —É—Å–ø—ñ—à–Ω–∞! –£–≤—ñ–π–¥—ñ—Ç—å.');
      document.getElementById('toLogin').click();
      document.getElementById('loginNickname').value = nickname;
    } catch (e) {
      if (e.code === 'auth/email-already-in-use') alert('–¢–∞–∫–∏–π –ø—Å–µ–≤–¥–æ–Ω—ñ–º –≤–∂–µ –∑–∞–π–Ω—è—Ç–∏–π');
      else alert(e.message || '–ü–æ–º–∏–ª–∫–∞ —Ä–µ—î—Å—Ç—Ä–∞—Ü—ñ—ó');
    }
  };

  // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  // –í—Ö—ñ–¥
  // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  document.getElementById('loginBtn').onclick = async () => {
    const nickname = document.getElementById('loginNickname').value.trim();
    const password = document.getElementById('loginPassword').value.trim();

    if (!nickname || !password) return alert('–ó–∞–ø–æ–≤–Ω—ñ—Ç—å –ø–æ–ª—è');

    try {
      const safeNick = nickname.toLowerCase().replace(/[^a-z0-9]/g, '');
      const email = `${safeNick}@fantasyas.local`;

      await signInWithEmailAndPassword(auth, email, password);
    } catch (e) {
      alert('–ù–µ–≤—ñ—Ä–Ω–∏–π –ø—Å–µ–≤–¥–æ–Ω—ñ–º –∞–±–æ –ø–∞—Ä–æ–ª—å');
    }
  };

  // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  // –°–ª—É—Ö–∞—á –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü—ñ—ó
  // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  onAuthStateChanged(auth, async (user) => {
    if (user) {
      currentUser = user;
      document.getElementById('authBox').style.display = 'none';
      document.getElementById('newPostBox').style.display = 'block';

      const userSnap = await getDoc(doc(db, "users", user.uid));
      if (userSnap.exists()) {
        const data = userSnap.data();
        document.getElementById('profileUsernameDisplay').textContent = data.nickname;
        document.getElementById('profileBio').textContent = data.bio || '–ù–µ–º–∞—î –æ–ø–∏—Å—É';
        if (data.avatar) document.getElementById('profileAvatar').style.backgroundImage = `url(${data.avatar})`;
      }

      subscribeToFeed();
    } else {
      currentUser = null;
      document.getElementById('authBox').style.display = 'block';
      document.getElementById('newPostBox').style.display = 'none';
      if (unsubscribeFeed) unsubscribeFeed();
      if (unsubscribeChat) unsubscribeChat();
    }
  });

  // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  // –ü—É–±–ª—ñ–∫–∞—Ü—ñ—è –ø–æ—Å—Ç–∞
  // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  document.getElementById('addPost').onclick = async () => {
    if (!currentUser) return alert('–°–ø–æ—á–∞—Ç–∫—É —É–≤—ñ–π–¥—ñ—Ç—å');

    const text = document.getElementById('postText').value.trim();
    const file = document.getElementById('postMedia').files[0];

    if (!text && !file) return alert('–î–æ–¥–∞–π—Ç–µ —Ç–µ–∫—Å—Ç –∞–±–æ –º–µ–¥—ñ–∞');

    try {
      let mediaUrl = '';
      let mediaType = '';
      if (file) {
        const storageRef = ref(storage, `posts/${currentUser.uid}/${Date.now()}_${file.name}`);
        await uploadBytes(storageRef, file);
        mediaUrl = await getDownloadURL(storageRef);
        mediaType = file.type.split('/')[0];
      }

      await addDoc(collection(db, "posts"), {
        author: currentUser.uid,
        text,
        mediaUrl,
        mediaType,
        createdAt: serverTimestamp(),
        likes: [],
        comments: []
      });

      document.getElementById('postText').value = '';
      document.getElementById('postMedia').value = '';
    } catch (e) {
      alert('–ü–æ–º–∏–ª–∫–∞ –ø—É–±–ª—ñ–∫–∞—Ü—ñ—ó: ' + e.message);
    }
  };

  // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  // –°—Ç—Ä—ñ—á–∫–∞ –ø–æ—Å—Ç—ñ–≤ (–≤—Å—ñ—Ö –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ–≤)
  // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  function subscribeToFeed() {
    if (unsubscribeFeed) unsubscribeFeed();

    const q = query(collection(db, "posts"), orderBy("createdAt", "desc"), limit(50));

    unsubscribeFeed = onSnapshot(q, async (snapshot) => {
      const feed = document.getElementById('feed');
      feed.innerHTML = '';

      let index = 0;
      for (const docSnap of snapshot.docs) {
        const post = docSnap.data();
        const authorSnap = await getDoc(doc(db, "users", post.author));
        const author = authorSnap.exists() ? authorSnap.data() : { nickname: '–ê–Ω–æ–Ω—ñ–º' };

        const postEl = document.createElement('div');
        postEl.className = 'post';
        postEl.innerHTML = `
          <div class="post-header">
            <div class="avatar" style="background-image:url('${author.avatar || ''}')"></div>
            <div class="username">@${author.nickname}</div>
          </div>
          <div class="post-content">${(post.text || '').replace(/\n/g, '<br>')}</div>
          ${post.mediaUrl ? `
            ${post.mediaType === 'image' ? `<img src="${post.mediaUrl}" class="post-media">` : 
              `<video src="${post.mediaUrl}" controls class="post-media"></video>`}
          ` : ''}
          <div class="post-footer">
            <button class="like-btn" data-id="${docSnap.id}">
              ‚ù§Ô∏è ${post.likes?.length || 0}
            </button>
            <button class="comment-btn" data-id="${docSnap.id}">
              üí¨ ${post.comments?.length || 0}
            </button>
          </div>
        `;

        feed.appendChild(postEl);
        setTimeout(() => postEl.classList.add('show'), 60 * index++);

        // –õ–∞–π–∫
        postEl.querySelector('.like-btn').onclick = async (e) => {
          const postId = e.target.dataset.id;
          const postRef = doc(db, "posts", postId);
          const postSnap = await getDoc(postRef);
          const likes = postSnap.data().likes || [];

          if (likes.includes(currentUser.uid)) {
            await updateDoc(postRef, { likes: arrayRemove(currentUser.uid) });
          } else {
            await updateDoc(postRef, { likes: arrayUnion(currentUser.uid) });
          }
        };

        // –ö–æ–º–µ–Ω—Ç–∞—Ä (—Å–ø—Ä–æ—â–µ–Ω–æ)
        postEl.querySelector('.comment-btn').onclick = async (e) => {
          const postId = e.target.dataset.id;
          const text = prompt('–í–∞—à –∫–æ–º–µ–Ω—Ç–∞—Ä:');
          if (!text) return;

          const postRef = doc(db, "posts", postId);
          await updateDoc(postRef, {
            comments: arrayUnion({
              user: currentUser.uid,
              text,
              createdAt: serverTimestamp()
            })
          });
        };
      }
    });
  }

  // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  // –ü–æ—à—É–∫ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ–≤
  // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  async function loadSearchUsers(term = '') {
    const list = document.getElementById('userList');
    list.innerHTML = '';

    try {
      let q = query(collection(db, "users"), limit(20));
      if (term.trim()) {
        const start = term.toLowerCase();
        q = query(collection(db, "users"),
          where("nickname", ">=", start),
          where("nickname", "<=", start + '\uf8ff'),
          limit(20)
        );
      }

      const snap = await getDocs(q);
      if (snap.empty) {
        list.innerHTML = '<p>–ù—ñ—á–æ–≥–æ –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ</p>';
        return;
      }

      snap.forEach(docSnap => {
        if (docSnap.id === currentUser?.uid) return;
        const data = docSnap.data();
        const item = document.createElement('div');
        item.className = 'user-item';
        item.innerHTML = `
          <div class="avatar" style="background-image:url('${data.avatar || ''}')"></div>
          <div>
            <div class="name">@${data.nickname}</div>
          </div>
        `;
        item.onclick = () => alert(`–ß–∞—Ç –∑ @${data.nickname} (–ø–æ–∫–∏ —â–æ –ø—Ä–æ—Å—Ç–æ alert)`);
        list.appendChild(item);
      });
    } catch (e) {
      console.error(e);
      list.innerHTML = '<p>–ü–æ–º–∏–ª–∫–∞ –ø–æ—à—É–∫—É</p>';
    }
  }

  document.getElementById('searchInput').oninput = e => loadSearchUsers(e.target.value);

  // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  // –ü—Ä–æ—Ñ—ñ–ª—å
  // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  async function loadProfile() {
    if (!currentUser) return;
    const snap = await getDoc(doc(db, "users", currentUser.uid));
    if (snap.exists()) {
      const data = snap.data();
      document.getElementById('profileUsernameDisplay').textContent = data.nickname;
      document.getElementById('profileBio').textContent = data.bio || '–ù–µ–º–∞—î –æ–ø–∏—Å—É';
      document.getElementById('profileAvatar').style.backgroundImage = data.avatar ? `url(${data.avatar})` : '';
    }
  }

  document.getElementById('profileAvatar').onclick = () => {
    if (!currentUser) return alert('–£–≤—ñ–π–¥—ñ—Ç—å');
    document.getElementById('avatarInput').click();
  };

  document.getElementById('avatarInput').onchange = async (e) => {
    const file = e.target.files[0];
    if (!file) return;

    try {
      const refFile = ref(storage, `avatars/${currentUser.uid}`);
      await uploadBytes(refFile, file);
      const url = await getDownloadURL(refFile);
      await updateDoc(doc(db, "users", currentUser.uid), { avatar: url });
      document.getElementById('profileAvatar').style.backgroundImage = `url(${url})`;
    } catch (err) {
      alert('–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è');
    }
  };

  // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  // –†–µ–¥–∞–≥—É–≤–∞–Ω–Ω—è –±—ñ–æ
  // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  document.getElementById('editProfileBtn').onclick = () => document.getElementById('editProfileModal').classList.add('active');
  document.getElementById('closeModal').onclick = () => document.getElementById('editProfileModal').classList.remove('active');

  document.getElementById('saveProfileEdit').onclick = async () => {
    const bio = document.getElementById('editBio').value.trim();
    if (currentUser) {
      await updateDoc(doc(db, "users", currentUser.uid), { bio });
      document.getElementById('profileBio').textContent = bio || '–ù–µ–º–∞—î –æ–ø–∏—Å—É';
    }
    document.getElementById('editProfileModal').classList.remove('active');
  };

  // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  // –ß–∞—Ç–∏ (–ø–æ–∫–∏ —Å–ø—Ä–æ—â–µ–Ω–æ)
  // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  async function loadChatList() {
    const list = document.getElementById('chatList');
    list.innerHTML = '<p>–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —á–∞—Ç—ñ–≤...</p>';

    // –ü–æ–∫–∞–∑—É—î–º–æ –≤—Å—ñ—Ö –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ–≤ —è–∫ –ø—Ä–∏–∫–ª–∞–¥
    const q = query(collection(db, "users"), limit(20));
    const snap = await getDocs(q);
    list.innerHTML = '';

    snap.forEach(docSnap => {
      if (docSnap.id === currentUser?.uid) return;
      const data = docSnap.data();
      const item = document.createElement('div');
      item.className = 'chat-item';
      item.innerHTML = `
        <div class="avatar" style="background-image:url('${data.avatar || ''}')"></div>
        <div><div class="name">@${data.nickname}</div></div>
      `;
      item.onclick = () => {
        alert(`–ß–∞—Ç –∑ @${data.nickname} ‚Äî —Ñ—É–Ω–∫—Ü—ñ–æ–Ω–∞–ª –≤ —Ä–æ–∑—Ä–æ–±—Ü—ñ`);
      };
      list.appendChild(item);
    });
  }

  // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  // –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è
  // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  document.getElementById('toggleTheme').onclick = () => {
    document.body.classList.toggle('light');
    localStorage.setItem('theme', document.body.classList.contains('light') ? 'light' : 'dark');
  };

  if (localStorage.getItem('theme') === 'light') document.body.classList.add('light');

  document.getElementById('logoutBtn').onclick = () => signOut(auth);

</script>
</body>
</html>

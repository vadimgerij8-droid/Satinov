<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=yes"/>
  <title>FANTASYAS ¬∑ –ü—ñ–¥–ø–∏—Å–∫–∏ + Google TV</title>
  <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;500;600;700;800&display=swap" rel="stylesheet"/>
  <style>
    /* ========== –ì–õ–û–ë–ê–õ–¨–ù–Ü –°–¢–ò–õ–Ü ========== */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Manrope', sans-serif;
      -webkit-tap-highlight-color: transparent;
    }

    :root {
      --bg: #ffffff;
      --surface: #f5f5f7;
      --card: #ffffff;
      --border: #e0e0e0;
      --text-primary: #1c1c1e;
      --text-secondary: #6c6c70;
      --text-tertiary: #8e8e93;
      --accent: #000000;
      --accent-hover: #333333;
      --danger: #ff3040;
      --danger-hover: #e02b38;
      --warning: #f5a623;
      --success: #4caf50;
      --shadow-sm: 0 2px 8px rgba(0,0,0,0.04);
      --shadow-md: 0 4px 16px rgba(0,0,0,0.08);
      --shadow-lg: 0 8px 24px rgba(0,0,0,0.12);
      --transition: 0.2s ease;
      --radius-sm: 12px;
      --radius-md: 16px;
      --radius-lg: 24px;
      --sidebar-width: 280px;
      --header-height: 60px;
    }

    body.dark {
      --bg: #000000;
      --surface: #1c1c1e;
      --card: #2c2c2e;
      --border: #3a3a3c;
      --text-primary: #ffffff;
      --text-secondary: #8e8e93;
      --text-tertiary: #666668;
      --accent: #ffffff;
      --accent-hover: #e0e0e0;
      --danger: #ff3040;
      --danger-hover: #e02b38;
      --shadow-sm: 0 2px 8px rgba(255,255,255,0.04);
      --shadow-md: 0 4px 16px rgba(255,255,255,0.08);
      --shadow-lg: 0 8px 24px rgba(255,255,255,0.12);
    }

    body {
      background: var(--bg);
      color: var(--text-primary);
      min-height: 100vh;
      transition: background var(--transition), color var(--transition);
      font-size: 16px;
      line-height: 1.5;
    }

    .focused {
      outline: 4px solid var(--accent) !important;
      outline-offset: 4px;
      box-shadow: 0 0 0 4px var(--bg), 0 0 20px var(--accent) !important;
      transform: scale(1.02);
      transition: all 0.15s ease;
      z-index: 100;
      animation: pulse 1.5s infinite;
    }

    @keyframes pulse {
      0% { box-shadow: 0 0 0 4px var(--bg), 0 0 20px var(--accent); }
      50% { box-shadow: 0 0 0 4px var(--bg), 0 0 30px var(--accent); }
      100% { box-shadow: 0 0 0 4px var(--bg), 0 0 20px var(--accent); }
    }

    #tvCursor {
      position: fixed;
      width: 32px;
      height: 32px;
      background: transparent;
      display: none;
      z-index: 9999;
      pointer-events: none;
      transition: all 0.1s ease;
      filter: drop-shadow(0 4px 6px rgba(0,0,0,0.3));
    }
    #tvCursor svg {
      width: 100%;
      height: 100%;
      fill: var(--accent);
      stroke: var(--bg);
      stroke-width: 1.5;
    }

    .sidebar-backdrop {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.5);
      backdrop-filter: blur(4px);
      z-index: 999;
      opacity: 0;
      transition: opacity 0.3s ease;
    }
    .sidebar-backdrop.active {
      display: block;
      opacity: 1;
    }

    .app {
      display: flex;
      height: 100vh;
      overflow: hidden;
    }

    .sidebar {
      width: var(--sidebar-width);
      background: var(--surface);
      border-right: 1px solid var(--border);
      display: flex;
      flex-direction: column;
      padding: 20px 0;
      overflow-y: auto;
      transition: transform 0.3s cubic-bezier(0.2, 0.9, 0.3, 1);
      z-index: 1000;
    }

    .sidebar-header {
      padding: 0 20px 20px;
      border-bottom: 1px solid var(--border);
    }

    .logo {
      font-size: 1.8rem;
      font-weight: 800;
      letter-spacing: -0.5px;
      color: var(--text-primary);
    }

    .nav-item {
      display: flex;
      align-items: center;
      gap: 14px;
      padding: 12px 20px;
      margin: 4px 8px;
      border-radius: var(--radius-md);
      color: var(--text-secondary);
      transition: all var(--transition);
      cursor: pointer;
      font-weight: 500;
    }

    .nav-item:hover {
      background: var(--card);
      color: var(--text-primary);
    }

    .nav-item.active {
      background: var(--accent);
      color: var(--bg);
    }

    .nav-item .icon {
      width: 24px;
      height: 24px;
      stroke: currentColor;
      stroke-width: 1.8;
      fill: none;
    }

    .nav-item .badge {
      margin-left: auto;
      background: var(--accent);
      color: var(--bg);
      padding: 2px 8px;
      border-radius: 20px;
      font-size: 0.75rem;
      font-weight: 600;
    }

    .main {
      flex: 1;
      display: flex;
      flex-direction: column;
      overflow: hidden;
      background: var(--bg);
    }

    .top-bar {
      height: var(--header-height);
      background: var(--surface);
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      padding: 0 20px;
      gap: 16px;
    }

    .menu-toggle {
      display: none;
      width: 28px;
      height: 20px;
      flex-direction: column;
      justify-content: space-between;
      cursor: pointer;
      position: relative;
      z-index: 1001;
    }

    .menu-toggle span {
      height: 2px;
      width: 100%;
      background: var(--text-primary);
      border-radius: 2px;
      transition: transform 0.3s ease, opacity 0.2s ease;
    }

    .menu-toggle.active span:nth-child(1) { transform: rotate(45deg) translate(6px, 5px); }
    .menu-toggle.active span:nth-child(2) { opacity: 0; }
    .menu-toggle.active span:nth-child(3) { transform: rotate(-45deg) translate(6px, -5px); }

    .top-bar-title {
      font-size: 1.4rem;
      font-weight: 700;
    }

    .content {
      flex: 1;
      overflow-y: auto !important;
      padding: 20px;
      scroll-behavior: smooth;
      height: 100%;
      max-height: 100%;
      outline: none;
    }

    .section {
      display: none;
    }
    .section.active {
      display: block;
    }

    @media (max-width: 768px) {
      .sidebar {
        position: fixed;
        left: 0;
        top: 0;
        bottom: 0;
        transform: translateX(-100%);
        box-shadow: var(--shadow-lg);
      }
      .sidebar.open {
        transform: translateX(0);
      }
      .menu-toggle {
        display: flex;
      }
    }

    .card {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: var(--radius-lg);
      padding: 20px;
      box-shadow: var(--shadow-sm);
      transition: box-shadow var(--transition), transform var(--transition);
    }

    .card:hover {
      box-shadow: var(--shadow-md);
    }

    .avatar {
      width: 48px;
      height: 48px;
      border-radius: 50%;
      background: var(--surface);
      background-size: cover;
      background-position: center;
      border: 2px solid var(--border);
      cursor: pointer;
      transition: border-color var(--transition);
    }

    .avatar.small {
      width: 32px;
      height: 32px;
    }

    .avatar.large {
      width: 80px;
      height: 80px;
    }

    .online-indicator {
      display: inline-block;
      width: 12px;
      height: 12px;
      background: #4caf50;
      border-radius: 50%;
      border: 2px solid var(--card);
      margin-left: 8px;
    }

    .btn {
      padding: 10px 18px;
      border-radius: var(--radius-md);
      background: var(--surface);
      border: 1px solid var(--border);
      color: var(--text-primary);
      font-weight: 600;
      cursor: pointer;
      transition: all var(--transition);
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      position: relative;
      overflow: hidden;
    }

    .btn::after {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      width: 5px;
      height: 5px;
      background: rgba(255,255,255,0.3);
      opacity: 0;
      border-radius: 100%;
      transform: scale(1, 1) translate(-50%);
      transform-origin: 50% 50%;
    }

    .btn:active::after {
      animation: ripple 0.3s ease-out;
    }

    @keyframes ripple {
      0% { transform: scale(0, 0); opacity: 0.5; }
      100% { transform: scale(20, 20); opacity: 0; }
    }

    .btn:hover, .btn.focused {
      background: var(--accent);
      color: var(--bg);
      border-color: var(--accent);
    }

    .btn-primary {
      background: var(--accent);
      color: var(--bg);
      border-color: var(--accent);
    }

    .btn-primary:hover, .btn-primary.focused {
      background: var(--accent-hover);
    }

    .btn-danger {
      background: var(--danger);
      color: white;
      border-color: var(--danger);
    }
    .btn-danger:hover {
      background: var(--danger-hover);
    }

    .btn-icon {
      padding: 10px;
    }

    .btn-follow {
      background: transparent;
      border: 1px solid var(--accent);
      color: var(--accent);
      padding: 4px 12px;
      font-size: 0.85rem;
      border-radius: 20px;
      margin-left: 8px;
    }
    .btn-follow.following {
      background: var(--accent);
      color: var(--bg);
    }

    .input {
      width: 100%;
      padding: 14px 18px;
      border-radius: var(--radius-md);
      border: 1px solid var(--border);
      background: var(--surface);
      color: var(--text-primary);
      font-size: 1rem;
      outline: none;
      transition: border-color var(--transition);
    }

    .input:focus, .input.focused {
      border-color: var(--accent);
    }

    .file-input-wrapper {
      position: relative;
      display: inline-block;
      width: 100%;
    }
    .file-input-wrapper input[type="file"] {
      position: absolute;
      top: 0;
      left: 0;
      opacity: 0;
      width: 100%;
      height: 100%;
      cursor: pointer;
      z-index: 2;
    }
    .file-input-button {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      width: 100%;
      padding: 12px;
      background: var(--surface);
      border: 1px dashed var(--border);
      border-radius: var(--radius-md);
      color: var(--text-secondary);
      transition: all var(--transition);
    }
    .file-input-button:hover {
      border-color: var(--accent);
      color: var(--accent);
    }
    .file-preview {
      margin-top: 8px;
      max-width: 100%;
      max-height: 200px;
      border-radius: var(--radius-sm);
      object-fit: cover;
      display: none;
    }
    .file-preview.show {
      display: block;
    }

    .feed {
      display: flex;
      flex-direction: column;
      gap: 24px;
    }

    .post {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: var(--radius-lg);
      padding: 16px 16px 12px;
      box-shadow: var(--shadow-sm);
      transition: transform 0.15s ease, box-shadow 0.15s ease;
      animation: fadeIn 0.3s ease;
      position: relative;
    }
    .post:hover, .post.focused {
      box-shadow: var(--shadow-md);
      transform: scale(1.01);
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .post-header {
      display: flex;
      gap: 12px;
      margin-bottom: 12px;
      align-items: center;
      flex-wrap: wrap;
    }
    .post-header .avatar {
      width: 42px;
      height: 42px;
    }
    .post-author-info {
      flex: 1;
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      gap: 6px;
    }
    .post-author {
      font-weight: 700;
      cursor: pointer;
      display: inline-block;
      margin-right: 6px;
    }
    .post-author:hover {
      text-decoration: underline;
    }
    .post-meta {
      color: var(--text-tertiary);
      font-size: 0.85rem;
    }
    .post-time {
      color: var(--text-tertiary);
      font-size: 0.75rem;
      margin-left: auto;
    }

    .post-actions {
      position: absolute;
      top: 16px;
      right: 16px;
      display: flex;
      gap: 8px;
    }
    .post-actions button {
      background: none;
      border: none;
      color: var(--text-secondary);
      cursor: pointer;
      font-size: 1.2rem;
      padding: 4px;
      border-radius: 50%;
      transition: background var(--transition);
    }
    .post-actions button:hover, .post-actions button.focused {
      background: var(--surface);
    }

    .post-content {
      margin-bottom: 14px;
      white-space: pre-wrap;
      font-size: 1rem;
      line-height: 1.5;
    }

    .hashtag {
      color: var(--accent);
      font-weight: 600;
      cursor: pointer;
      display: inline-block;
      margin-right: 4px;
    }
    .hashtag:hover {
      text-decoration: underline;
    }

    .post-media {
      width: 100%;
      border-radius: var(--radius-md);
      margin: 10px 0;
      cursor: pointer;
      max-height: 500px;
      object-fit: cover;
    }

    .post-footer {
      display: flex;
      gap: 20px;
      flex-wrap: wrap;
      padding-top: 8px;
      border-top: 1px solid var(--border);
      align-items: center;
    }

    .post-footer button {
      background: none;
      border: none;
      display: flex;
      align-items: center;
      gap: 6px;
      color: var(--text-secondary);
      font-weight: 600;
      cursor: pointer;
      transition: color var(--transition);
      font-size: 0.9rem;
    }

    .post-footer button:hover, .post-footer button.focused {
      color: var(--accent);
    }

    .post-footer button.liked {
      color: #ff3040;
    }
    .post-footer button.liked svg {
      fill: #ff3040;
    }

    .post-footer button.saved {
      color: #f5a623;
    }
    .post-footer button.saved svg {
      fill: #f5a623;
    }

    .view-count {
      display: flex;
      align-items: center;
      gap: 4px;
      color: var(--text-tertiary);
      font-size: 0.9rem;
      margin-left: auto;
    }

    .follow-btn-post {
      background: transparent;
      border: 1px solid var(--accent);
      color: var(--accent);
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 0.8rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.1s;
      margin-left: 8px;
    }
    .follow-btn-post.following {
      background: var(--accent);
      color: var(--bg);
    }

    .comments-section {
      margin-top: 16px;
      border-top: 1px solid var(--border);
      padding-top: 16px;
    }

    .comment {
      display: flex;
      gap: 10px;
      margin-bottom: 12px;
    }

    .comment-avatar {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      background-size: cover;
      background-position: center;
      flex-shrink: 0;
    }

    .comment-content {
      flex: 1;
      background: var(--surface);
      padding: 8px 12px;
      border-radius: var(--radius-md);
    }

    .comment-author {
      font-weight: 600;
      font-size: 0.9rem;
      cursor: pointer;
      display: inline-block;
      margin-right: 8px;
    }

    .comment-text {
      font-size: 0.95rem;
      word-break: break-word;
    }

    .comment-time {
      font-size: 0.75rem;
      color: var(--text-tertiary);
      margin-top: 4px;
    }

    .comment-form {
      display: flex;
      gap: 8px;
      margin-top: 16px;
      align-items: center;
    }

    .comment-input {
      flex: 1;
      padding: 10px 14px;
      border-radius: var(--radius-md);
      border: 1px solid var(--border);
      background: var(--surface);
      color: var(--text-primary);
    }

    .emoji-picker-container {
      position: relative;
      display: inline-block;
    }

    .emoji-button {
      background: none;
      border: none;
      font-size: 1.5rem;
      cursor: pointer;
      padding: 4px 8px;
      color: var(--text-secondary);
      transition: transform 0.1s;
    }
    .emoji-button:hover {
      transform: scale(1.2);
    }

    .emoji-picker {
      position: absolute;
      bottom: 100%;
      right: 0;
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: var(--radius-md);
      padding: 8px;
      display: grid;
      grid-template-columns: repeat(8, 1fr);
      gap: 6px;
      z-index: 100;
      box-shadow: var(--shadow-lg);
      width: 280px;
      max-height: 220px;
      overflow-y: auto;
      margin-bottom: 8px;
    }

    .emoji-picker button {
      font-size: 1.8rem;
      cursor: pointer;
      text-align: center;
      padding: 4px;
      border-radius: var(--radius-sm);
      transition: background 0.1s;
      line-height: 1;
      border: none;
      background: transparent;
      color: inherit;
    }
    .emoji-picker button:hover,
    .emoji-picker button.focused {
      background: var(--surface);
      transform: scale(1.1);
    }

    .chat-list {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .chat-item {
      display: flex;
      align-items: center;
      gap: 14px;
      padding: 12px;
      border-radius: var(--radius-md);
      background: var(--card);
      border: 1px solid var(--border);
      cursor: pointer;
      transition: background var(--transition);
    }

    .chat-item:hover, .chat-item.focused {
      background: var(--surface);
    }

    .chat-item.unread {
      border-left: 3px solid var(--accent);
    }

    .chat-info {
      flex: 1;
    }

    .chat-name {
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .chat-last {
      color: var(--text-tertiary);
      font-size: 0.9rem;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .chat-time {
      color: var(--text-tertiary);
      font-size: 0.8rem;
    }

    .chat-badge {
      background: var(--accent);
      color: var(--bg);
      border-radius: 50%;
      min-width: 22px;
      height: 22px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.8rem;
      font-weight: 600;
    }

    .chat-window {
      display: flex;
      flex-direction: column;
      height: 100%;
      background: var(--card);
      border-radius: var(--radius-lg);
      border: 1px solid var(--border);
      overflow: hidden;
    }

    .chat-header {
      padding: 16px;
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .chat-messages {
      flex: 1;
      padding: 16px;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .message-wrapper {
      display: flex;
      flex-direction: column;
      animation: messageAppear 0.2s ease;
    }

    @keyframes messageAppear {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .message-wrapper.sent {
      align-items: flex-end;
    }

    .message-wrapper.received {
      align-items: flex-start;
    }

    .message-bubble {
      max-width: 70%;
      padding: 10px 14px;
      border-radius: 20px;
      word-break: break-word;
      position: relative;
    }

    .message-bubble.sent {
      background: var(--accent);
      color: var(--bg);
      border-bottom-right-radius: 4px;
    }

    .message-bubble.received {
      background: var(--surface);
      color: var(--text-primary);
      border-bottom-left-radius: 4px;
    }

    .message-sender {
      font-weight: 600;
      font-size: 0.85rem;
      margin-bottom: 2px;
      color: var(--text-secondary);
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .message-sender-avatar {
      width: 20px;
      height: 20px;
      border-radius: 50%;
      background-size: cover;
    }

    .message-time {
      font-size: 0.7rem;
      color: var(--text-tertiary);
      margin-top: 2px;
      text-align: right;
    }

    .date-divider {
      text-align: center;
      margin: 16px 0;
      font-size: 0.8rem;
      color: var(--text-tertiary);
      position: relative;
    }

    .date-divider::before,
    .date-divider::after {
      content: '';
      position: absolute;
      top: 50%;
      width: 30%;
      height: 1px;
      background: var(--border);
    }

    .date-divider::before {
      left: 0;
    }

    .date-divider::after {
      right: 0;
    }

    .typing-indicator {
      color: var(--text-tertiary);
      font-size: 0.9rem;
      padding: 4px 8px;
      font-style: italic;
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .chat-input-area {
      display: flex;
      padding: 12px;
      border-top: 1px solid var(--border);
      gap: 8px;
      align-items: center;
    }

    .chat-input-area input {
      flex: 1;
    }

    .profile-header {
      display: flex;
      gap: 24px;
      margin-bottom: 24px;
      flex-wrap: wrap;
      align-items: flex-start;
    }

    .profile-stats {
      display: flex;
      gap: 24px;
      margin: 16px 0;
    }
    .profile-stats span {
      cursor: pointer;
      transition: opacity 0.2s;
    }
    .profile-stats span:hover {
      opacity: 0.7;
    }

    .profile-tabs {
      display: flex;
      gap: 8px;
      border-bottom: 1px solid var(--border);
      padding-bottom: 8px;
      margin-bottom: 20px;
    }

    .profile-tab {
      padding: 8px 16px;
      border-radius: var(--radius-md);
      cursor: pointer;
      font-weight: 600;
      color: var(--text-secondary);
    }

    .profile-tab.active, .profile-tab.focused {
      background: var(--accent);
      color: var(--bg);
    }

    .profile-menu {
      position: relative;
      display: inline-block;
      margin-left: auto;
    }

    .profile-menu-btn {
      background: none;
      border: none;
      font-size: 1.8rem;
      cursor: pointer;
      padding: 0 8px;
      color: var(--text-secondary);
    }

    .profile-menu-dropdown {
      position: absolute;
      right: 0;
      top: 100%;
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: var(--radius-md);
      min-width: 200px;
      box-shadow: var(--shadow-lg);
      z-index: 100;
      display: none;
    }

    .profile-menu-dropdown.show {
      display: block;
    }

    .profile-menu-item {
      padding: 12px 16px;
      cursor: pointer;
      transition: background var(--transition);
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .profile-menu-item:hover {
      background: var(--surface);
    }

    .hashtag-list {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    .hashtag-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 12px;
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: var(--radius-md);
      cursor: pointer;
    }
    .hashtag-item:hover {
      background: var(--surface);
    }
    .hashtag-name {
      font-weight: 600;
      color: var(--accent);
    }
    .hashtag-count {
      color: var(--text-tertiary);
    }

    .modal {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.5);
      backdrop-filter: blur(8px);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 2000;
    }

    .modal.active {
      display: flex;
    }

    .modal-content {
      background: var(--card);
      border-radius: var(--radius-lg);
      padding: 24px;
      max-width: 480px;
      width: 90%;
      max-height: 90vh;
      overflow-y: auto;
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
    }

    .modal-close {
      font-size: 2rem;
      line-height: 1;
      cursor: pointer;
    }

    #toast {
      position: fixed;
      bottom: 30px;
      left: 50%;
      transform: translateX(-50%);
      background: var(--accent);
      color: var(--bg);
      padding: 12px 24px;
      border-radius: 40px;
      font-weight: 500;
      box-shadow: var(--shadow-lg);
      z-index: 3000;
      opacity: 0;
      transition: opacity 0.3s;
      pointer-events: none;
    }
    #toast.show {
      opacity: 1;
    }

    .skeleton {
      background: linear-gradient(90deg, var(--surface) 25%, var(--card) 50%, var(--surface) 75%);
      background-size: 200% 100%;
      animation: skeleton-loading 1.5s infinite;
      border-radius: var(--radius-md);
    }
    @keyframes skeleton-loading {
      0% { background-position: 200% 0; }
      100% { background-position: -200% 0; }
    }

    .text-danger { color: var(--danger); }
    .text-warning { color: var(--warning); }
    .text-success { color: var(--success); }
  </style>
</head>
<body>
<div class="app">
  <div class="sidebar-backdrop" id="sidebarBackdrop"></div>

  <aside class="sidebar" id="sidebar">
    <div class="sidebar-header">
      <div class="logo">FANTASYAS</div>
    </div>
    <nav class="nav">
      <div class="nav-item active" data-section="home" tabindex="0">
        <svg class="icon" viewBox="0 0 24 24"><path d="M3 10l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>
        –ì–æ–ª–æ–≤–Ω–∞
      </div>
      <div class="nav-item" data-section="search" tabindex="0">
        <svg class="icon" viewBox="0 0 24 24"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>
        –ü–æ—à—É–∫
      </div>
      <div class="nav-item" data-section="hashtags" tabindex="0">
        <svg class="icon" viewBox="0 0 24 24"><path d="M4 9h16M4 15h16M10 3L8 21M16 3l-2 18"/></svg>
        –•–µ—à—Ç–µ–≥–∏
      </div>
      <div class="nav-item" data-section="profile" tabindex="0">
        <svg class="icon" viewBox="0 0 24 24"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
        –ü—Ä–æ—Ñ—ñ–ª—å
      </div>
      <div class="nav-item" data-section="chats" tabindex="0">
        <svg class="icon" viewBox="0 0 24 24"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>
        –ß–∞—Ç–∏
        <span class="badge" id="unreadBadge" style="display:none;">0</span>
      </div>
      <div class="nav-item" data-section="settings" tabindex="0">
        <svg class="icon" viewBox="0 0 24 24"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H5.78a1.65 1.65 0 0 0-1.51 1 1.65 1.65 0 0 0 .33 1.82l.07.07A10 10 0 0 0 12 17.66a10 10 0 0 0 6.26-2.26z"/></svg>
        –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è
      </div>
    </nav>
  </aside>

  <main class="main">
    <div class="top-bar">
      <div class="menu-toggle" id="menuToggle">
        <span></span><span></span><span></span>
      </div>
      <div class="top-bar-title" id="pageTitle">–ì–æ–ª–æ–≤–Ω–∞</div>
    </div>

    <div class="content" id="content">
      <div id="home" class="section active">
        <div class="card" id="authBox">
          <div id="loginForm">
            <input type="text" id="loginNickname" class="input" placeholder="–ü—Å–µ–≤–¥–æ–Ω—ñ–º (–±–µ–∑ @)" autocomplete="off" tabindex="0"/>
            <input type="password" id="loginPassword" class="input" placeholder="–ü–∞—Ä–æ–ª—å" tabindex="0"/>
            <button class="btn btn-primary" id="loginBtn" style="width:100%; margin-top:12px;" tabindex="0">–£–≤—ñ–π—Ç–∏</button>
            <div style="display:flex; gap:10px; margin-top:15px;">
              <button class="btn" id="googleLoginBtn" style="flex:1;" tabindex="0">Google</button>
              <button class="btn" id="appleLoginBtn" style="flex:1;" tabindex="0">Apple</button>
            </div>
            <p style="margin-top:18px;">–ù–µ–º–∞—î –∞–∫–∞—É–Ω—Ç–∞? <span id="toRegister" style="color:var(--accent);cursor:pointer;" tabindex="0">–ó–∞—Ä–µ—î—Å—Ç—Ä—É–≤–∞—Ç–∏—Å—è</span></p>
            <p><a href="#" id="forgotPassword" style="color:var(--accent);" tabindex="0">–ó–∞–±—É–ª–∏ –ø–∞—Ä–æ–ª—å?</a></p>
          </div>
          <div id="registerForm" style="display:none;">
            <input type="text" id="registerNickname" class="input" placeholder="–ü—Å–µ–≤–¥–æ–Ω—ñ–º (–±–µ–∑ @)" tabindex="0"/>
            <input type="password" id="registerPassword" class="input" placeholder="–ü–∞—Ä–æ–ª—å" tabindex="0"/>
            <button class="btn btn-primary" id="registerBtn" style="width:100%; margin-top:12px;" tabindex="0">–ó–∞—Ä–µ—î—Å—Ç—Ä—É–≤–∞—Ç–∏—Å—è</button>
            <p style="margin-top:18px;">–í–∂–µ —î –∞–∫–∞—É–Ω—Ç? <span id="toLogin" style="color:var(--accent);cursor:pointer;" tabindex="0">–£–≤—ñ–π—Ç–∏</span></p>
          </div>
        </div>

        <div class="card" id="newPostBox" style="display:none;">
          <div style="display: flex; gap: 8px; align-items: center; margin-bottom: 10px;">
            <textarea id="postText" class="input" placeholder="–©–æ –Ω–æ–≤–æ–≥–æ? #—Ö–µ—à—Ç–µ–≥" rows="3" style="flex:1;" tabindex="0"></textarea>
            <div class="emoji-picker-container">
              <button class="emoji-button" id="postEmojiBtn" tabindex="0">üòä</button>
              <div class="emoji-picker" id="postEmojiPicker" style="display: none;"></div>
            </div>
          </div>
          
          <div class="file-input-wrapper">
            <input type="file" id="postMedia" accept="image/*,video/*">
            <div class="file-input-button">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="2" y="2" width="20" height="20" rx="2.18"/><circle cx="7.5" cy="7.5" r="1.5"/><polyline points="21 15 16 10 5 21"/></svg>
              <span id="postMediaLabel">–û–±—Ä–∞—Ç–∏ —Ñ–æ—Ç–æ/–≤—ñ–¥–µ–æ</span>
            </div>
          </div>
          <img id="postMediaPreview" class="file-preview" />
          
          <button class="btn btn-primary" id="addPost" style="margin-top:12px;" tabindex="0">–û–ø—É–±–ª—ñ–∫—É–≤–∞—Ç–∏</button>
        </div>

        <div class="feed-header" style="display:flex; gap:10px; margin-bottom:20px;">
          <button class="btn" id="feedNewBtn" tabindex="0">–ù–æ–≤—ñ</button>
          <button class="btn" id="feedPopularBtn" tabindex="0">–ü–æ–ø—É–ª—è—Ä–Ω—ñ</button>
        </div>

        <div class="feed" id="feed"></div>
        <div class="feed-end-sentinel" id="feedSentinel"></div>
        <div id="skeletonContainer" style="display:none;">
          <div class="skeleton" style="height:200px; margin-bottom:20px;"></div>
          <div class="skeleton" style="height:200px;"></div>
        </div>
      </div>

      <div id="search" class="section">
        <input type="text" id="searchInput" class="input" placeholder="–ü–æ—à—É–∫ –∑–∞ @id, —ñ–º'—è–º –∞–±–æ #—Ö–µ—à—Ç–µ–≥–æ–º..." tabindex="0"/>
        <div class="user-list" id="userList" style="margin-top:20px;"></div>
      </div>

      <div id="hashtags" class="section">
        <h2 style="margin-bottom:16px;">–ü–æ–ø—É–ª—è—Ä–Ω—ñ —Ö–µ—à—Ç–µ–≥–∏</h2>
        <div class="hashtag-list" id="hashtagList"></div>
      </div>

      <div id="profile" class="section">
        <div class="profile-header" id="profileHeader"></div>
        <div class="profile-tabs" id="profileTabs"></div>
        <div class="feed" id="profileFeed"></div>
      </div>

      <div id="chats" class="section">
        <div class="chat-search-container" style="padding: 0 0 12px 0;">
          <input type="text" id="chatSearchInput" class="input" placeholder="–ü–æ—à—É–∫ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ–≤..." tabindex="0">
          <div id="chatSearchResults" class="user-list" style="margin-top:10px; display:none;"></div>
        </div>
        <div class="chat-list" id="chatList"></div>
        <div class="chat-window" id="chatWindow" style="display:none;">
          <div class="chat-header">
            <div class="avatar" id="chatAvatar"></div>
            <div>
              <div id="chatName"></div>
              <div class="chat-meta" id="chatUserId"></div>
            </div>
            <span id="onlineIndicator" class="online-indicator" style="display:none;"></span>
          </div>
          <div class="chat-messages" id="chatMessages"></div>
          <div class="typing-indicator" id="typingIndicator" style="display:none;">
            <span></span> –¥—Ä—É–∫—É—î...
          </div>
          <div class="chat-input-area">
            <input type="text" id="chatText" class="input" placeholder="–ù–∞–ø–∏—à—ñ—Ç—å –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è..." tabindex="0"/>
            <div class="emoji-picker-container">
              <button class="emoji-button" id="chatEmojiBtn" tabindex="0">üòä</button>
              <div class="emoji-picker" id="chatEmojiPicker" style="display: none;"></div>
            </div>
            <button class="btn btn-primary btn-icon" id="sendMessage" tabindex="0">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></svg>
            </button>
          </div>
        </div>
      </div>

      <div id="settings" class="section card">
        <h2>–ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è</h2>
        <button class="btn" id="toggleTheme" style="margin:18px 0;" tabindex="0">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/></svg>
          –¢–µ–º–∞
        </button>
        <button class="btn" id="privacyPolicyBtn" style="margin:18px 0;" tabindex="0">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg>
          –ü–æ–ª—ñ—Ç–∏–∫–∞ –∫–æ–Ω—Ñ—ñ–¥–µ–Ω—Ü—ñ–π–Ω–æ—Å—Ç—ñ
        </button>

        <div style="margin-top:20px; border-top:1px solid var(--border); padding-top:20px;">
          <h3>–¢–µ–ª–µ–≤—ñ–∑–æ—Ä</h3>
          <div style="display:flex; flex-direction:column; gap:10px; margin-top:10px;">
            <button class="btn" id="tvNavToggle">TV-–Ω–∞–≤—ñ–≥–∞—Ü—ñ—è: —É–≤—ñ–º–∫–Ω–µ–Ω–æ</button>
            <button class="btn" id="remoteNavToggle">–ù–∞–≤—ñ–≥–∞—Ü—ñ—è –∑ –ø—É–ª—å—Ç–∞: —É–≤—ñ–º–∫–Ω–µ–Ω–æ</button>
            <button class="btn" id="focusOptimizeToggle">–û–ø—Ç–∏–º—ñ–∑–∞—Ü—ñ—è —Ñ–æ–∫—É—Å—É: —É–≤—ñ–º–∫–Ω–µ–Ω–æ</button>
            <button class="btn" id="tvCursorToggle">TV-—Å—Ç—Ä—ñ–ª–æ—á–∫–∞: –≤–∏–º–∫–Ω–µ–Ω–æ</button>
          </div>
        </div>

        <button class="btn" id="logoutBtn" style="margin-top:20px;" tabindex="0">–í–∏–π—Ç–∏</button>
      </div>
    </div>
  </main>
</div>

<!-- –ú–æ–¥–∞–ª–∫–∏ -->
<div class="modal" id="editProfileModal">
  <div class="modal-content">
    <div class="modal-header">
      <h3>–†–µ–¥–∞–≥—É–≤–∞—Ç–∏ –ø—Ä–æ—Ñ—ñ–ª—å</h3>
      <span class="modal-close" id="closeModal" tabindex="0">&times;</span>
    </div>
    <input type="text" id="editNickname" class="input" placeholder="–ü—Å–µ–≤–¥–æ–Ω—ñ–º" tabindex="0"/>
    <textarea id="editBio" class="input" placeholder="–ü—Ä–æ —Å–µ–±–µ" rows="4" style="margin:14px 0;" tabindex="0"></textarea>
    <div class="file-input-wrapper" style="margin:14px 0;">
      <input type="file" id="editAvatar" accept="image/*">
      <div class="file-input-button">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="2" y="2" width="20" height="20" rx="2.18"/><circle cx="7.5" cy="7.5" r="1.5"/><polyline points="21 15 16 10 5 21"/></svg>
        <span id="editAvatarLabel">–û–±—Ä–∞—Ç–∏ –∞–≤–∞—Ç–∞—Ä</span>
      </div>
    </div>
    <img id="editAvatarPreview" class="file-preview" />
    <button class="btn btn-primary" id="saveProfileEdit" tabindex="0">–ó–±–µ—Ä–µ–≥—Ç–∏</button>
  </div>
</div>

<div class="modal" id="editPostModal">
  <div class="modal-content">
    <div class="modal-header">
      <h3>–†–µ–¥–∞–≥—É–≤–∞—Ç–∏ –ø–æ—Å—Ç</h3>
      <span class="modal-close" id="closeEditPostModal" tabindex="0">&times;</span>
    </div>
    <textarea id="editPostText" class="input" placeholder="–¢–µ–∫—Å—Ç –ø–æ—Å—Ç—É" rows="4" tabindex="0"></textarea>
    <div class="file-input-wrapper" style="margin:14px 0;">
      <input type="file" id="editPostMedia" accept="image/*,video/*">
      <div class="file-input-button">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="2" y="2" width="20" height="20" rx="2.18"/><circle cx="7.5" cy="7.5" r="1.5"/><polyline points="21 15 16 10 5 21"/></svg>
        <span id="editPostMediaLabel">–ó–º—ñ–Ω–∏—Ç–∏ –º–µ–¥—ñ–∞</span>
      </div>
    </div>
    <img id="editPostMediaPreview" class="file-preview" />
    <button class="btn btn-primary" id="savePostEdit" tabindex="0">–ó–±–µ—Ä–µ–≥—Ç–∏</button>
    <button class="btn btn-danger" id="deletePostBtn" style="margin-top:10px;" tabindex="0">–í–∏–¥–∞–ª–∏—Ç–∏ –ø–æ—Å—Ç</button>
  </div>
</div>

<div class="modal" id="followersModal">
  <div class="modal-content">
    <div class="modal-header">
      <h3>–ü—ñ–¥–ø–∏—Å–Ω–∏–∫–∏</h3>
      <span class="modal-close" id="closeFollowersModal" tabindex="0">&times;</span>
    </div>
    <div id="followersList" class="user-list" style="max-height: 400px; overflow-y: auto;"></div>
  </div>
</div>

<div class="modal" id="followingModal">
  <div class="modal-content">
    <div class="modal-header">
      <h3>–ü—ñ–¥–ø–∏—Å–∫–∏</h3>
      <span class="modal-close" id="closeFollowingModal" tabindex="0">&times;</span>
    </div>
    <div id="followingList" class="user-list" style="max-height: 400px; overflow-y: auto;"></div>
  </div>
</div>

<!-- –ü–æ–∫—Ä–∞—â–µ–Ω–∞ –º–æ–¥–∞–ª–∫–∞ –ø–æ–ª—ñ—Ç–∏–∫–∏ –∫–æ–Ω—Ñ—ñ–¥–µ–Ω—Ü—ñ–π–Ω–æ—Å—Ç—ñ -->
<div class="modal" id="privacyPolicyModal">
  <div class="modal-content">
    <div class="modal-header">
      <h3>–ü–æ–ª—ñ—Ç–∏–∫–∞ –∫–æ–Ω—Ñ—ñ–¥–µ–Ω—Ü—ñ–π–Ω–æ—Å—Ç—ñ</h3>
      <span class="modal-close" id="closePrivacyModal" tabindex="0">&times;</span>
    </div>
    <div style="max-height: 60vh; overflow-y: auto; padding-right: 10px; text-align: left;">
      <p><strong>–û—Å—Ç–∞–Ω–Ω—î –æ–Ω–æ–≤–ª–µ–Ω–Ω—è:</strong> 19 –ª—é—Ç–æ–≥–æ 2026</p>
      
      <h4>1. –Ø–∫—ñ –¥–∞–Ω—ñ –º–∏ –∑–±–∏—Ä–∞—î–º–æ</h4>
      <p>–ú–∏ –∑–±–∏—Ä–∞—î–º–æ –º—ñ–Ω—ñ–º–∞–ª—å–Ω–æ –Ω–µ–æ–±—Ö—ñ–¥–Ω—É —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—é –¥–ª—è —Ä–æ–±–æ—Ç–∏ —Å–µ—Ä–≤—ñ—Å—É:</p>
      <ul>
        <li>–û–±–ª—ñ–∫–æ–≤—ñ –¥–∞–Ω—ñ (–ø—Å–µ–≤–¥–æ–Ω—ñ–º, –µ–ª–µ–∫—Ç—Ä–æ–Ω–Ω–∞ –ø–æ—à—Ç–∞, –ø–∞—Ä–æ–ª—å —É –∑–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–æ–º—É –≤–∏–≥–ª—è–¥—ñ).</li>
        <li>–Ü–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—è –ø—Ä–æ—Ñ—ñ–ª—é (–∞–≤–∞—Ç–∞—Ä, –±—ñ–æ–≥—Ä–∞—Ñ—ñ—è), —è–∫—É –≤–∏ –Ω–∞–¥–∞—î—Ç–µ –¥–æ–±—Ä–æ–≤—ñ–ª—å–Ω–æ.</li>
        <li>–í–∞—à—ñ –ø—É–±–ª—ñ–∫–∞—Ü—ñ—ó, –∫–æ–º–µ–Ω—Ç–∞—Ä—ñ, –≤–ø–æ–¥–æ–±–∞–Ω–Ω—è, –∑–±–µ—Ä–µ–∂–µ–Ω—ñ –ø–æ—Å—Ç–∏.</li>
        <li>–î–∞–Ω—ñ –ø—Ä–æ –≤–∑–∞—î–º–æ–¥—ñ—é (–ø—ñ–¥–ø–∏—Å–∫–∏, –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –≤ —á–∞—Ç–∞—Ö).</li>
        <li>–¢–µ—Ö–Ω—ñ—á–Ω—ñ –¥–∞–Ω—ñ: IP-–∞–¥—Ä–µ—Å–∞, —Ç–∏–ø –ø—Ä–∏—Å—Ç—Ä–æ—é, —á–∞—Å –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—ñ.</li>
      </ul>

      <h4>2. –Ø–∫ –º–∏ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ –≤–∞—à—ñ –¥–∞–Ω—ñ</h4>
      <p>–í–∞—à—ñ –¥–∞–Ω—ñ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—é—Ç—å—Å—è –≤–∏–∫–ª—é—á–Ω–æ –¥–ª—è:</p>
      <ul>
        <li>–ù–∞–¥–∞–Ω–Ω—è —Ñ—É–Ω–∫—Ü—ñ–æ–Ω–∞–ª—É —Å–æ—Ü—ñ–∞–ª—å–Ω–æ—ó –º–µ—Ä–µ–∂—ñ (–ø—É–±–ª—ñ–∫–∞—Ü—ñ—è –ø–æ—Å—Ç—ñ–≤, —á–∞—Ç–∏, –ø—ñ–¥–ø–∏—Å–∫–∏).</li>
        <li>–ü–µ—Ä—Å–æ–Ω–∞–ª—ñ–∑–∞—Ü—ñ—ó –∫–æ–Ω—Ç–µ–Ω—Ç—É (—Å—Ç—Ä—ñ—á–∫–∞ –Ω–æ–≤–∏–Ω, —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü—ñ—ó).</li>
        <li>–ó–∞–±–µ–∑–ø–µ—á–µ–Ω–Ω—è –±–µ–∑–ø–µ–∫–∏ —Ç–∞ –∑–∞–ø–æ–±—ñ–≥–∞–Ω–Ω—è —à–∞—Ö—Ä–∞–π—Å—Ç–≤—É.</li>
        <li>–ö–æ–º—É–Ω—ñ–∫–∞—Ü—ñ—ó –∑ –≤–∞–º–∏ (—Å–ø–æ–≤—ñ—â–µ–Ω–Ω—è, –≤—ñ–¥–Ω–æ–≤–ª–µ–Ω–Ω—è –ø–∞—Ä–æ–ª—è).</li>
      </ul>

      <h4>3. –ü–µ—Ä–µ–¥–∞—á–∞ –¥–∞–Ω–∏—Ö —Ç—Ä–µ—Ç—ñ–º –æ—Å–æ–±–∞–º</h4>
      <p>–ú–∏ –Ω–µ –ø—Ä–æ–¥–∞—î–º–æ –≤–∞—à—ñ –¥–∞–Ω—ñ. –Ü–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—è –º–æ–∂–µ –±—É—Ç–∏ –ø–µ—Ä–µ–¥–∞–Ω–∞ –ª–∏—à–µ —É –≤–∏–ø–∞–¥–∫–∞—Ö:</p>
      <ul>
        <li>–ó–∞ –≤–∞—à–æ–≥–æ —è–≤–Ω–æ–≥–æ –¥–æ–∑–≤–æ–ª—É.</li>
        <li>–î–ª—è –≤–∏–∫–æ–Ω–∞–Ω–Ω—è –≤–∏–º–æ–≥ –∑–∞–∫–æ–Ω–æ–¥–∞–≤—Å—Ç–≤–∞.</li>
        <li>–¢–µ—Ö–Ω—ñ—á–Ω–∏–º –ø–∞—Ä—Ç–Ω–µ—Ä–∞–º (Firebase, Google Cloud) –¥–ª—è –∑–∞–±–µ–∑–ø–µ—á–µ–Ω–Ω—è —Ä–æ–±–æ—Ç–∏ —Å–µ—Ä–≤—ñ—Å—É.</li>
      </ul>

      <h4>4. –í–∞—à—ñ –ø—Ä–∞–≤–∞</h4>
      <p>–í–∏ –º–æ–∂–µ—Ç–µ –≤ –±—É–¥—å-—è–∫–∏–π —á–∞—Å:</p>
      <ul>
        <li>–ü–µ—Ä–µ–≥–ª—è–Ω—É—Ç–∏ —Ç–∞ —Ä–µ–¥–∞–≥—É–≤–∞—Ç–∏ —Å–≤–æ—ó –¥–∞–Ω—ñ –≤ –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è—Ö –ø—Ä–æ—Ñ—ñ–ª—é.</li>
        <li>–í–∏–¥–∞–ª–∏—Ç–∏ —Å–≤—ñ–π –∞–∫–∞—É–Ω—Ç (–∑–≤–µ—Ä–Ω—ñ—Ç—å—Å—è –¥–æ –ø—ñ–¥—Ç—Ä–∏–º–∫–∏).</li>
        <li>–ó–∞–±–ª–æ–∫—É–≤–∞—Ç–∏ —ñ–Ω—à–∏—Ö –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ–≤.</li>
      </ul>

      <h4>5. –ë–µ–∑–ø–µ–∫–∞</h4>
      <p>–ú–∏ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ —Å—É—á–∞—Å–Ω—ñ –º–µ—Ç–æ–¥–∏ —à–∏—Ñ—Ä—É–≤–∞–Ω–Ω—è (HTTPS, —Ö–µ—à—É–≤–∞–Ω–Ω—è –ø–∞—Ä–æ–ª—ñ–≤) —Ç–∞ —Ä–µ–≥—É–ª—è—Ä–Ω–æ –æ–Ω–æ–≤–ª—é—î–º–æ —Å–∏—Å—Ç–µ–º–∏ –±–µ–∑–ø–µ–∫–∏. –û–¥–Ω–∞–∫ –∂–æ–¥–µ–Ω –º–µ—Ç–æ–¥ –ø–µ—Ä–µ–¥–∞—á—ñ –¥–∞–Ω–∏—Ö —á–µ—Ä–µ–∑ –Ü–Ω—Ç–µ—Ä–Ω–µ—Ç –Ω–µ —î 100% –±–µ–∑–ø–µ—á–Ω–∏–º.</p>

      <h4>6. –ó–º—ñ–Ω–∏ –≤ –ø–æ–ª—ñ—Ç–∏—Ü—ñ</h4>
      <p>–ü—Ä–æ –±—É–¥—å-—è–∫—ñ –∑–º—ñ–Ω–∏ –º–∏ –ø–æ–≤—ñ–¥–æ–º–∏–º–æ –Ω–∞ —Ü—ñ–π —Å—Ç–æ—Ä—ñ–Ω—Ü—ñ. –†–µ–∫–æ–º–µ–Ω–¥—É—î–º–æ –ø–µ—Ä—ñ–æ–¥–∏—á–Ω–æ –ø–µ—Ä–µ–≥–ª—è–¥–∞—Ç–∏ –ø–æ–ª—ñ—Ç–∏–∫—É.</p>

      <p><strong>–ö–æ–Ω—Ç–∞–∫—Ç–∏:</strong> –Ø–∫—â–æ —É –≤–∞—Å –≤–∏–Ω–∏–∫–ª–∏ –ø–∏—Ç–∞–Ω–Ω—è, –Ω–∞–ø–∏—à—ñ—Ç—å –Ω–∞–º –Ω–∞ privacy@fantasyas.com.</p>
    </div>
  </div>
</div>

<div id="toast"></div>
<div id="tvCursor">
  <svg viewBox="0 0 32 32">
    <polygon points="2,2 30,16 2,30 8,16 2,2" fill="currentColor" stroke="white" stroke-width="2"/>
  </svg>
</div>

<script type="module">
  // ================= Firebase —ñ–º–ø–æ—Ä—Ç–∏ =================
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js";
  import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut, GoogleAuthProvider, OAuthProvider, signInWithPopup, sendPasswordResetEmail } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-auth.js";
  import { getFirestore, doc, setDoc, getDoc, updateDoc, collection, addDoc, query, where, onSnapshot, orderBy, serverTimestamp, arrayUnion, arrayRemove, deleteDoc, getDocs, increment, limit, startAfter } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore.js";
  import { getStorage, ref, uploadBytes, getDownloadURL, deleteObject } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-storage.js";

  // ================= –ö–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—è =================
  const firebaseConfig = {
    apiKey: "AIzaSyDRzC-QDE0-UXd-XL0i3iqayFiKcc6wmvc",
    authDomain: "fantasyasapp.firebaseapp.com",
    projectId: "fantasyasapp",
    storageBucket: "fantasyasapp.appspot.com",
    messagingSenderId: "721763921060",
    appId: "1:721763921060:web:3d61044ea2424e8176ca31"
  };
  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);
  const storage = getStorage(app);

  // ================= –ì–ª–æ–±–∞–ª—å–Ω—ñ –∑–º—ñ–Ω–Ω—ñ =================
  let currentUser = null;
  let currentUserFollowing = [];
  let currentChatPartner = null;
  let currentChatPartnerName = '';
  let currentChatId = null;
  let currentProfileUid = null;
  let currentEditingPost = null;
  
  let unsubscribeFeed = null;
  let unsubscribeChat = null;
  let unsubscribeChatList = null;
  let unsubscribeTyping = null;
  let unsubscribeOnlineStatus = null;
  let unsubscribeFollowing = null;
  let lastOnlineInterval = null;

  let unreadCount = 0;
  let currentFeedType = 'new';
  let lastVisible = null;
  let loading = false;
  let hasMore = true;

  const viewedPosts = new Set();

  // TV –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è ‚Äì –∑–∞ –∑–∞–º–æ–≤—á—É–≤–∞–Ω–Ω—è–º —É–≤—ñ–º–∫–Ω–µ–Ω–æ
  const tvSettings = {
    tvNavEnabled: localStorage.getItem('tvNav') !== 'false',   // true –∑–∞ –∑–∞–º–æ–≤—á—É–≤–∞–Ω–Ω—è–º
    remoteNavEnabled: localStorage.getItem('remoteNav') !== 'false',
    focusOptimized: localStorage.getItem('focusOptimized') !== 'false',
    tvCursorEnabled: localStorage.getItem('tvCursor') === 'true'
  };

  // ================= –ù–ê–í–Ü–ì–ê–¶–Ü–Ø –ü–£–õ–¨–¢–û–ú (D-Pad) =================
  // –ö–µ—à —Ñ–æ–∫—É—Å–æ–≤–∞–Ω–∏—Ö –µ–ª–µ–º–µ–Ω—Ç—ñ–≤
  let cachedFocusableElements = [];
  let lastDOMUpdate = 0;
  let lastFocusedElement = null; // –¥–ª—è –≤—ñ–¥–Ω–æ–≤–ª–µ–Ω–Ω—è –ø—ñ—Å–ª—è –∑–∞–∫—Ä–∏—Ç—Ç—è –º–æ–¥–∞–ª–æ–∫

  // –û—Ç—Ä–∏–º—É—î –≤—Å—ñ –≤–∏–¥–∏–º—ñ —Ñ–æ–∫—É—Å–æ–≤–∞–Ω—ñ –µ–ª–µ–º–µ–Ω—Ç–∏ –∑ —É—Ä–∞—Ö—É–≤–∞–Ω–Ω—è–º –∞–∫—Ç–∏–≤–Ω–∏—Ö –º–æ–¥–∞–ª–æ–∫
  function getFocusableElements() {
    const activeModal = document.querySelector('.modal.active');
    let container = activeModal || document;

    const baseSelector = `
      button, input, textarea, select, a[href], 
      [tabindex]:not([tabindex="-1"]), 
      .nav-item, .post, .chat-item, .profile-tab, 
      .hashtag-item, .modal-close, .emoji-button, 
      .btn, .file-input-button, .post-actions button,
      .comment-author, .post-author, .avatar, .hashtag,
      .follow-btn-post, .profile-menu-btn, .profile-menu-item
    `;

    const elements = Array.from(container.querySelectorAll(baseSelector));
    
    return elements.filter(el => {
      const style = window.getComputedStyle(el);
      return style.display !== 'none' && 
             style.visibility !== 'hidden' && 
             el.offsetParent !== null && 
             !el.disabled &&
             !el.hasAttribute('aria-hidden');
    });
  }

  function updateFocusableCache() {
    cachedFocusableElements = getFocusableElements();
    lastDOMUpdate = Date.now();
  }

  function getCenter(el) {
    const rect = el.getBoundingClientRect();
    return {
      x: rect.left + rect.width / 2,
      y: rect.top + rect.height / 2
    };
  }

  function findClosestElement(currentEl, direction) {
    if (!currentEl) return null;
    
    const currentCenter = getCenter(currentEl);
    const candidates = cachedFocusableElements.filter(el => el !== currentEl);
    
    if (candidates.length === 0) return null;

    const dirMap = {
      'ArrowUp': { dx: 0, dy: -1 },
      'ArrowDown': { dx: 0, dy: 1 },
      'ArrowLeft': { dx: -1, dy: 0 },
      'ArrowRight': { dx: 1, dy: 0 }
    };
    const dir = dirMap[direction];
    if (!dir) return null;

    let best = null;
    let bestScore = Infinity;

    candidates.forEach(candidate => {
      const candidateCenter = getCenter(candidate);
      const dx = candidateCenter.x - currentCenter.x;
      const dy = candidateCenter.y - currentCenter.y;

      const dot = dx * dir.dx + dy * dir.dy;
      if (dot <= 0) return;

      const length = Math.sqrt(dx * dx + dy * dy);
      const cosAngle = dot / length;
      if (cosAngle < 0.5) return;

      const score = length / cosAngle;
      if (score < bestScore) {
        bestScore = score;
        best = candidate;
      }
    });

    return best;
  }

  function setFocusOnElement(el) {
    if (!el) return;
    
    // –ù–µ –∑–Ω—ñ–º–∞—î–º–æ —Ñ–æ–∫—É—Å, —è–∫—â–æ —Ü–µ –ø–æ–ª–µ –≤–≤–µ–¥–µ–Ω–Ω—è —ñ –≤–æ–Ω–æ –≤–∂–µ –∞–∫—Ç–∏–≤–Ω–µ
    if (el.tagName === 'INPUT' || el.tagName === 'TEXTAREA' || el.isContentEditable) {
      el.focus();
      // –î–æ–¥–∞—î–º–æ –∫–ª–∞—Å focused –¥–ª—è –≤—ñ–∑—É–∞–ª—å–Ω–æ–≥–æ –≤–∏–¥—ñ–ª–µ–Ω–Ω—è, –∞–ª–µ –Ω–µ –∑–Ω—ñ–º–∞—î–º–æ –∑ —ñ–Ω—à–∏—Ö?
      // –ö—Ä–∞—â–µ –¥–æ–¥–∞—Ç–∏ –∫–ª–∞—Å —Ç—ñ–ª—å–∫–∏ —Ü—å–æ–º—É –µ–ª–µ–º–µ–Ω—Ç—É, –∞ –∑ —ñ–Ω—à–∏—Ö –∑–Ω—è—Ç–∏
      document.querySelectorAll('.focused').forEach(e => {
        if (e !== el) e.classList.remove('focused');
      });
      el.classList.add('focused');
    } else {
      document.querySelectorAll('.focused').forEach(e => e.classList.remove('focused'));
      el.classList.add('focused');
      el.focus({ preventScroll: true }); // —Ñ–æ–∫—É—Å –±–µ–∑ –ø—Ä–æ–∫—Ä—É—Ç–∫–∏, —â–æ–± –Ω–µ –∑–±–∏–≤–∞—Ç–∏
    }
    
    el.scrollIntoView({ block: 'nearest', behavior: 'smooth' });
    
    lastFocusedElement = el;
    
    if (tvSettings.tvCursorEnabled) {
      updateTVCursor();
    }
  }

  function closeAllPopups() {
    document.querySelectorAll('.emoji-picker').forEach(p => p.style.display = 'none');
    document.querySelectorAll('.profile-menu-dropdown.show').forEach(d => d.classList.remove('show'));
  }

  // ========== –í–ò–ü–†–ê–í–õ–ï–ù–ê –§–£–ù–ö–¶–Ü–Ø –û–ë–†–û–ë–ö–ò –ö–õ–ê–í–Ü–® ==========
  function handleKeyDown(e) {
    // –Ø–∫—â–æ –Ω–∞–≤—ñ–≥–∞—Ü—ñ—è –≤–∏–º–∫–Ω–µ–Ω–∞ ‚Äì –Ω—ñ—á–æ–≥–æ –Ω–µ —Ä–æ–±–∏–º–æ
    if (!tvSettings.tvNavEnabled && !tvSettings.remoteNavEnabled) return;

    const arrowKeys = ['ArrowUp', 'ArrowDown', 'ArrowLeft', 'ArrowRight'];
    const isArrow = arrowKeys.includes(e.key);
    const isEnter = e.key === 'Enter';
    const isBack = e.key === 'Escape' || e.key === 'Back' || e.code === 'Escape';

    if (!isArrow && !isEnter && !isBack) return;

    // –û–Ω–æ–≤–ª—é—î–º–æ –∫–µ—à, —è–∫—â–æ –º–∏–Ω—É–ª–æ –±—ñ–ª—å—à–µ 100 –º—Å
    if (Date.now() - lastDOMUpdate > 100) {
      updateFocusableCache();
    }

    // –í–∏–∑–Ω–∞—á–∞—î–º–æ –ø–æ—Ç–æ—á–Ω–∏–π –∞–∫—Ç–∏–≤–Ω–∏–π –µ–ª–µ–º–µ–Ω—Ç
    const activeEl = document.activeElement;
    const isInput = activeEl && (activeEl.tagName === 'INPUT' || activeEl.tagName === 'TEXTAREA' || activeEl.isContentEditable);

    // –Ø–∫—â–æ –∞–∫—Ç–∏–≤–Ω–µ –ø–æ–ª–µ –≤–≤–µ–¥–µ–Ω–Ω—è ‚Äì –Ω–µ –∑–∞–≤–∞–∂–∞—î–º–æ (–∫—Ä—ñ–º Escape)
    if (isInput) {
      if (isArrow || isEnter) {
        // –î–æ–∑–≤–æ–ª—è—î–º–æ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—É –ø–æ–≤–µ–¥—ñ–Ω–∫—É (–ø–µ—Ä–µ–º—ñ—â–µ–Ω–Ω—è –∫—É—Ä—Å–æ—Ä–∞, –Ω–æ–≤–∏–π —Ä—è–¥–æ–∫)
        return;
      }
      // Escape –æ–±—Ä–æ–±–ª—è—î–º–æ –Ω–∏–∂—á–µ
    }

    // ===== BACK / ESCAPE =====
    if (isBack) {
      e.preventDefault();
      
      // 1. –Ø–∫—â–æ –≤—ñ–¥–∫—Ä–∏—Ç–æ –µ–º–æ–¥–∂—ñ-–ø—ñ–∫–µ—Ä ‚Äì –∑–∞–∫—Ä–∏–≤–∞—î–º–æ
      const openEmojiPicker = document.querySelector('.emoji-picker[style*="display: grid"]');
      if (openEmojiPicker) {
        openEmojiPicker.style.display = 'none';
        // –ü–æ–≤–µ—Ä—Ç–∞—î–º–æ —Ñ–æ–∫—É—Å –Ω–∞ –∫–Ω–æ–ø–∫—É, —è–∫–∞ –π–æ–≥–æ –≤—ñ–¥–∫—Ä–∏–ª–∞
        if (lastFocusedElement && lastFocusedElement.classList.contains('emoji-button')) {
          setFocusOnElement(lastFocusedElement);
        } else {
          updateFocusableCache();
          const first = cachedFocusableElements[0];
          if (first) setFocusOnElement(first);
        }
        return;
      }

      // 2. –Ø–∫—â–æ –≤—ñ–¥–∫—Ä–∏—Ç–æ –≤–∏–ø–∞–¥–∞—é—á–µ –º–µ–Ω—é ‚Äì –∑–∞–∫—Ä–∏–≤–∞—î–º–æ
      const openDropdown = document.querySelector('.profile-menu-dropdown.show');
      if (openDropdown) {
        openDropdown.classList.remove('show');
        const menuBtn = document.querySelector('.profile-menu-btn');
        if (menuBtn) setFocusOnElement(menuBtn);
        return;
      }

      // 3. –ó–∞–∫—Ä–∏–≤–∞—î–º–æ –∞–∫—Ç–∏–≤–Ω—ñ –º–æ–¥–∞–ª–∫–∏
      const activeModals = document.querySelectorAll('.modal.active');
      if (activeModals.length > 0) {
        activeModals.forEach(modal => modal.classList.remove('active'));
        setTimeout(() => {
          updateFocusableCache();
          if (lastFocusedElement && !lastFocusedElement.closest('.modal')) {
            setFocusOnElement(lastFocusedElement);
          } else {
            const first = cachedFocusableElements[0];
            if (first) setFocusOnElement(first);
          }
        }, 50);
        return;
      }

      // 4. –Ø–∫—â–æ –≤—ñ–¥–∫—Ä–∏—Ç–æ —á–∞—Ç ‚Äì –∑–∞–∫—Ä–∏–≤–∞—î–º–æ
      const chatWindow = document.getElementById('chatWindow');
      if (chatWindow && chatWindow.style.display === 'flex') {
        chatWindow.style.display = 'none';
        setTimeout(() => {
          updateFocusableCache();
          const firstChat = document.querySelector('.chat-item');
          if (firstChat) setFocusOnElement(firstChat);
        }, 50);
        return;
      }

      // 5. –Ü–Ω–∞–∫—à–µ ‚Äì –ø–µ—Ä–µ—Ö–æ–¥–∏–º–æ –Ω–∞ –≥–æ–ª–æ–≤–Ω—É
      const activeSection = document.querySelector('.section.active');
      if (activeSection && activeSection.id !== 'home') {
        document.querySelector('[data-section="home"]').click();
      }
      return;
    }

    // ===== ENTER =====
    if (isEnter) {
      // –Ø–∫—â–æ –∞–∫—Ç–∏–≤–Ω–µ –ø–æ–ª–µ –≤–≤–µ–¥–µ–Ω–Ω—è ‚Äì –Ω—ñ—á–æ–≥–æ –Ω–µ —Ä–æ–±–∏–º–æ (–≤–∂–µ –ø–µ—Ä–µ–≤—ñ—Ä–∏–ª–∏)
      if (isInput) return;

      const focused = document.querySelector('.focused') || activeEl;
      if (focused) {
        e.preventDefault();
        focused.click();
      } else {
        e.preventDefault();
        const first = cachedFocusableElements[0];
        if (first) setFocusOnElement(first);
      }
      return;
    }

    // ===== –°–¢–†–Ü–õ–ö–ò =====
    if (isArrow) {
      // –Ø–∫—â–æ –∞–∫—Ç–∏–≤–Ω–µ –ø–æ–ª–µ –≤–≤–µ–¥–µ–Ω–Ω—è ‚Äì –Ω–µ –∑–∞–≤–∞–∂–∞—î–º–æ
      if (isInput) return;

      e.preventDefault();
      
      let current = document.querySelector('.focused') || activeEl;
      
      if (!current) {
        const first = cachedFocusableElements[0];
        if (first) setFocusOnElement(first);
        return;
      }

      // –Ø–∫—â–æ –ø–æ—Ç–æ—á–Ω–∏–π –µ–ª–µ–º–µ–Ω—Ç –≤—Å–µ—Ä–µ–¥–∏–Ω—ñ –µ–º–æ–¥–∂—ñ-–ø—ñ–∫–µ—Ä–∞
      const emojiPicker = current.closest('.emoji-picker');
      if (emojiPicker && emojiPicker.style.display === 'grid') {
        const emojiButtons = Array.from(emojiPicker.querySelectorAll('button'));
        const currentIndex = emojiButtons.indexOf(current);
        if (currentIndex !== -1) {
          let nextIndex;
          const cols = 8;
          if (e.key === 'ArrowRight') nextIndex = currentIndex + 1;
          else if (e.key === 'ArrowLeft') nextIndex = currentIndex - 1;
          else if (e.key === 'ArrowDown') nextIndex = currentIndex + cols;
          else if (e.key === 'ArrowUp') nextIndex = currentIndex - cols;
          
          if (nextIndex >= 0 && nextIndex < emojiButtons.length) {
            setFocusOnElement(emojiButtons[nextIndex]);
          }
          return;
        }
      }

      // –ó–≤–∏—á–∞–π–Ω–∞ –Ω–∞–≤—ñ–≥–∞—Ü—ñ—è
      const next = findClosestElement(current, e.key);
      if (next) setFocusOnElement(next);
    }
  }

  document.addEventListener('keydown', handleKeyDown);

  function updateTVCursor() {
    const cursor = document.getElementById('tvCursor');
    if (!cursor) return;
    if (!tvSettings.tvCursorEnabled) {
      cursor.style.display = 'none';
      return;
    }
    const focusedEl = document.querySelector('.focused');
    if (!focusedEl) {
      cursor.style.display = 'none';
      return;
    }
    const rect = focusedEl.getBoundingClientRect();
    cursor.style.display = 'block';
    cursor.style.left = (rect.left - 20) + 'px';
    cursor.style.top = (rect.top + rect.height/2 - 16) + 'px';
  }

  // –°–ø–æ—Å—Ç–µ—Ä—ñ–≥–∞—á –∑–∞ –∑–º—ñ–Ω–∞–º–∏ DOM
  const observer = new MutationObserver(() => {
    updateFocusableCache();
  });
  observer.observe(document.body, { childList: true, subtree: true, attributes: true });

  // –§–æ–∫—É—Å –Ω–∞ –ø–µ—Ä—à–∏–π –µ–ª–µ–º–µ–Ω—Ç –ø—ñ—Å–ª—è –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è
  window.addEventListener('load', () => {
    setTimeout(() => {
      updateFocusableCache();
      const first = cachedFocusableElements[0];
      if (first) setFocusOnElement(first);
    }, 500);
  });

  // ================= –î–æ–ø–æ–º—ñ–∂–Ω—ñ —Ñ—É–Ω–∫—Ü—ñ—ó =================
  const showToast = (msg) => {
    const toast = document.getElementById('toast');
    if (!toast) return;
    toast.textContent = msg;
    toast.classList.add('show');
    setTimeout(() => toast.classList.remove('show'), 3000);
  };

  const vibrate = (ms) => { if (navigator.vibrate) navigator.vibrate(ms); };

  const updateUnreadBadge = () => {
    const badge = document.getElementById('unreadBadge');
    if (!badge) return;
    if (unreadCount > 0) {
      badge.textContent = unreadCount > 99 ? '99+' : unreadCount;
      badge.style.display = 'inline-block';
    } else {
      badge.style.display = 'none';
    }
  };

  const cleanupListeners = () => {
    if (unsubscribeFeed) { unsubscribeFeed(); unsubscribeFeed = null; }
    if (unsubscribeChat) { unsubscribeChat(); unsubscribeChat = null; }
    if (unsubscribeChatList) { unsubscribeChatList(); unsubscribeChatList = null; }
    if (unsubscribeTyping) { unsubscribeTyping(); unsubscribeTyping = null; }
    if (unsubscribeOnlineStatus) { unsubscribeOnlineStatus(); unsubscribeOnlineStatus = null; }
    if (unsubscribeFollowing) { unsubscribeFollowing(); unsubscribeFollowing = null; }
    if (lastOnlineInterval) { clearInterval(lastOnlineInterval); lastOnlineInterval = null; }
  };

  // ================= –§—É–Ω–∫—Ü—ñ—ó –¥–ª—è —Å–∫–∞—Ä–≥, –º—é—Ç—É, –±–ª–æ–∫—É–≤–∞–Ω–Ω—è =================
  async function reportUser(targetUid, reason = '') {
    if (!currentUser) return;
    try {
      await addDoc(collection(db, "reports"), {
        reportedUserId: targetUid,
        reporterId: currentUser.uid,
        reason: reason || '–ë–µ–∑ –ø—Ä–∏—á–∏–Ω–∏',
        timestamp: serverTimestamp()
      });
      showToast('–°–∫–∞—Ä–≥—É –Ω–∞–¥—ñ—Å–ª–∞–Ω–æ');
    } catch (e) {
      showToast('–ü–æ–º–∏–ª–∫–∞: ' + e.message);
    }
  }

  async function muteUser(targetUid) {
    if (!currentUser) return;
    const userRef = doc(db, "users", currentUser.uid);
    try {
      await updateDoc(userRef, {
        mutedUsers: arrayUnion(targetUid)
      });
      showToast('–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ –∑–∞–º—É—á–µ–Ω–æ');
    } catch (e) {
      showToast('–ü–æ–º–∏–ª–∫–∞: ' + e.message);
    }
  }

  async function unmuteUser(targetUid) {
    if (!currentUser) return;
    const userRef = doc(db, "users", currentUser.uid);
    try {
      await updateDoc(userRef, {
        mutedUsers: arrayRemove(targetUid)
      });
      showToast('–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ —Ä–æ–∑–º—É—á–µ–Ω–æ');
    } catch (e) {
      showToast('–ü–æ–º–∏–ª–∫–∞: ' + e.message);
    }
  }

  async function blockUser(targetUid) {
    if (!currentUser) return;
    const userRef = doc(db, "users", currentUser.uid);
    try {
      await updateDoc(userRef, {
        blockedUsers: arrayUnion(targetUid)
      });
      showToast('–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ –∑–∞–±–ª–æ–∫–æ–≤–∞–Ω–æ');
    } catch (e) {
      showToast('–ü–æ–º–∏–ª–∫–∞: ' + e.message);
    }
  }

  async function unblockUser(targetUid) {
    if (!currentUser) return;
    const userRef = doc(db, "users", currentUser.uid);
    try {
      await updateDoc(userRef, {
        blockedUsers: arrayRemove(targetUid)
      });
      showToast('–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ —Ä–æ–∑–±–ª–æ–∫–æ–≤–∞–Ω–æ');
    } catch (e) {
      showToast('–ü–æ–º–∏–ª–∫–∞: ' + e.message);
    }
  }

  // ================= –ù–∞–≤—ñ–≥–∞—Ü—ñ—è –ø–æ —Ä–æ–∑–¥—ñ–ª–∞—Ö =================
  const sections = ['home','search','hashtags','profile','chats','settings'];
  const navItems = document.querySelectorAll('.nav-item');
  navItems.forEach((item) => {
    item.addEventListener('click', () => {
      const section = item.dataset.section;
      navItems.forEach(n => n.classList.remove('active'));
      item.classList.add('active');
      sections.forEach(s => document.getElementById(s).classList.remove('active'));
      const sectionEl = document.getElementById(section);
      if (sectionEl) sectionEl.classList.add('active');
      document.getElementById('pageTitle').textContent = item.textContent.trim();
      
      cleanupListeners();
      
      if (section === 'home' && currentUser) resetPagination();
      if (section === 'search' && currentUser) loadSearchUsers();
      if (section === 'hashtags' && currentUser) loadHashtags();
      if (section === 'chats' && currentUser) {
        document.getElementById('chatWindow').style.display = 'none';
        loadChatList();
        document.getElementById('chatSearchResults').style.display = 'none';
        document.getElementById('chatSearchInput').value = '';
      }
      if (section === 'profile' && currentUser) {
        viewProfile(currentUser.uid);
      }
      
      closeSidebar();
      setTimeout(() => { updateFocusableCache(); setFocusOnElement(cachedFocusableElements[0]); }, 200);
    });
  });

  const sidebar = document.getElementById('sidebar');
  const menuToggle = document.getElementById('menuToggle');
  const backdrop = document.getElementById('sidebarBackdrop');

  function openSidebar() {
    sidebar.classList.add('open');
    menuToggle.classList.add('active');
    backdrop.classList.add('active');
  }

  function closeSidebar() {
    sidebar.classList.remove('open');
    menuToggle.classList.remove('active');
    backdrop.classList.remove('active');
  }

  menuToggle.addEventListener('click', (e) => {
    e.stopPropagation();
    if (sidebar.classList.contains('open')) {
      closeSidebar();
    } else {
      openSidebar();
    }
  });

  backdrop.addEventListener('click', closeSidebar);

  // ================= –ï–º–æ–¥–∂—ñ-–ø—ñ–∫–µ—Ä =================
  const emojiList = ['üòÄ','üòÉ','üòÑ','üòÅ','üòÜ','üòÖ','üòÇ','ü§£','üòä','üòá','üôÇ','üôÉ','üòâ','üòå','üòç','ü•∞','üòò','üòó','üòô','üòö','üòã','üòõ','üòù','üòú','ü§™','ü§®','üßê','ü§ì','üòé','ü•∏','ü§©','ü•≥','üòè','üòí','üòû','üòî','üòü','üòï','üôÅ','‚òπÔ∏è','üò£','üòñ','üò´','üò©','ü•∫','üò¢','üò≠','üò§','üò†','üò°','ü§¨','ü§Ø','üò≥','ü•µ','ü•∂','üò±','üò®','üò∞','üò•','üòì','ü§ó','ü§î','ü§≠','ü§´','ü§•','üò∂','üòê','üòë','üò¨','üôÑ','üòØ','üò¶','üòß','üòÆ','üò≤','ü•±','üò¥','ü§§','üò™','üòµ','ü§ê','ü•¥','ü§¢','ü§Æ','ü§ß','üò∑','ü§í','ü§ï','ü§ë','ü§†','üòà','üëø','üëπ','üë∫','ü§°','üí©','üëª','üíÄ','‚ò†Ô∏è','üëΩ','üëæ','ü§ñ','üéÉ','üò∫','üò∏','üòπ','üòª','üòº','üòΩ','üôÄ','üòø','üòæ'];

  function closeAllEmojiPickers() {
    document.querySelectorAll('.emoji-picker').forEach(p => p.style.display = 'none');
  }

  function setupEmojiPicker(buttonId, pickerId, inputId) {
    const btn = document.getElementById(buttonId);
    const picker = document.getElementById(pickerId);
    const input = document.getElementById(inputId);
    if (!btn || !picker || !input) return;
    
    btn.addEventListener('click', (e) => {
      e.stopPropagation();
      closeAllEmojiPickers();
      
      const rect = btn.getBoundingClientRect();
      const spaceAbove = rect.top;
      const spaceBelow = window.innerHeight - rect.bottom;
      picker.style.bottom = spaceAbove > 280 ? '100%' : 'auto';
      picker.style.top = spaceBelow > 280 ? 'auto' : '100%';
      picker.style.left = 'auto';
      picker.style.right = '0';
      
      picker.style.display = picker.style.display === 'none' ? 'grid' : 'none';
      if (picker.style.display === 'grid') {
        setTimeout(() => { 
          updateFocusableCache(); 
          const firstEmoji = picker.querySelector('button');
          if (firstEmoji) setFocusOnElement(firstEmoji);
        }, 50);
      }
    });
    
    picker.innerHTML = '';
    emojiList.forEach(emoji => {
      const button = document.createElement('button');
      button.textContent = emoji;
      button.type = 'button';
      button.tabIndex = 0;
      button.addEventListener('click', (e) => {
        e.stopPropagation();
        const start = input.selectionStart;
        const end = input.selectionEnd;
        const text = input.value;
        input.value = text.substring(0, start) + emoji + text.substring(end);
        input.focus();
        input.selectionStart = input.selectionEnd = start + emoji.length;
        picker.style.display = 'none';
        updateFocusableCache();
        setFocusOnElement(input);
      });
      picker.appendChild(button);
    });
    
    document.addEventListener('click', (e) => {
      if (!picker.contains(e.target) && e.target !== btn) {
        picker.style.display = 'none';
      }
    });
  }

  // ================= –ö–∞—Å—Ç–æ–º–Ω–∏–π –≤–∏–±—ñ—Ä —Ñ–∞–π–ª—É =================
  function setupFileInput(inputId, labelId, previewId) {
    const input = document.getElementById(inputId);
    const label = document.getElementById(labelId);
    const preview = document.getElementById(previewId);
    if (!input || !label) return;

    input.addEventListener('change', function() {
      if (this.files && this.files[0]) {
        const file = this.files[0];
        label.textContent = file.name.length > 30 ? file.name.substring(0,30)+'‚Ä¶' : file.name;
        
        if (preview) {
          if (file.type.startsWith('image/')) {
            const reader = new FileReader();
            reader.onload = (e) => {
              preview.src = e.target.result;
              preview.classList.add('show');
            };
            reader.readAsDataURL(file);
          } else if (file.type.startsWith('video/')) {
            preview.src = '';
            preview.classList.remove('show');
          }
        }
      } else {
        label.textContent = inputId.includes('Avatar') ? '–û–±—Ä–∞—Ç–∏ –∞–≤–∞—Ç–∞—Ä' : '–û–±—Ä–∞—Ç–∏ —Ñ–æ—Ç–æ/–≤—ñ–¥–µ–æ';
        if (preview) preview.classList.remove('show');
      }
    });
  }

  // ================= –§—É–Ω–∫—Ü—ñ—ó –¥–ª—è —Ö–µ—à—Ç–µ–≥—ñ–≤ =================
  function extractHashtags(text) {
    const regex = /#(\w+)/g;
    const matches = text.match(regex);
    return matches ? matches.map(tag => tag.toLowerCase()) : [];
  }

  async function loadHashtags() {
    const list = document.getElementById('hashtagList');
    if (!list) return;
    list.innerHTML = '<div class="skeleton" style="height:60px;"></div>';

    try {
      const postsSnap = await getDocs(collection(db, "posts"));
      const tagCount = new Map();
      postsSnap.forEach(doc => {
        const tags = doc.data().hashtags || [];
        tags.forEach(tag => {
          tagCount.set(tag, (tagCount.get(tag) || 0) + 1);
        });
      });

      const sortedTags = Array.from(tagCount.entries()).sort((a, b) => b[1] - a[1]).slice(0, 20);
      
      list.innerHTML = '';
      if (sortedTags.length === 0) {
        list.innerHTML = '<p style="text-align:center; padding:20px;">–ü–æ–∫–∏ –Ω–µ–º–∞—î —Ö–µ—à—Ç–µ–≥—ñ–≤</p>';
        return;
      }

      sortedTags.forEach(([tag, count]) => {
        const div = document.createElement('div');
        div.className = 'hashtag-item';
        div.tabIndex = 0;
        div.innerHTML = `
          <span class="hashtag-name">${tag}</span>
          <span class="hashtag-count">${count} –ø–æ—Å—Ç—ñ–≤</span>
        `;
        div.onclick = () => searchHashtag(tag);
        list.appendChild(div);
      });
    } catch (e) {
      console.error('Error loading hashtags:', e);
      list.innerHTML = '<p style="text-align:center; padding:20px;">–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è</p>';
    }
    setTimeout(() => updateFocusableCache(), 100);
  }

  function searchHashtag(tag) {
    const searchInput = document.getElementById('searchInput');
    if (searchInput) {
      searchInput.value = '#' + tag;
      document.querySelector('[data-section="search"]').click();
      loadSearchUsers();
    }
  }

  // ================= –ê–í–¢–û–†–ò–ó–ê–¶–Ü–Ø =================
  document.getElementById('toRegister').onclick = () => {
    document.getElementById('loginForm').style.display = 'none';
    document.getElementById('registerForm').style.display = 'block';
    setTimeout(() => { updateFocusableCache(); setFocusOnElement(document.getElementById('registerNickname')); }, 50);
  };
  document.getElementById('toLogin').onclick = () => {
    document.getElementById('registerForm').style.display = 'none';
    document.getElementById('loginForm').style.display = 'block';
    setTimeout(() => { updateFocusableCache(); setFocusOnElement(document.getElementById('loginNickname')); }, 50);
  };

  document.getElementById('registerBtn').onclick = async () => {
    const nickname = document.getElementById('registerNickname').value.trim();
    const password = document.getElementById('registerPassword').value.trim();
    if (!nickname) return alert('–í–≤–µ–¥—ñ—Ç—å –ø—Å–µ–≤–¥–æ–Ω—ñ–º');
    if (password.length < 6) return alert('–ú—ñ–Ω—ñ–º—É–º 6 —Å–∏–º–≤–æ–ª—ñ–≤');
    
    const userId = `@${nickname.toLowerCase()}`;
    const q = query(collection(db, "users"), where("userId", "==", userId));
    const snap = await getDocs(q);
    if (!snap.empty) return alert('–¶–µ–π ID –≤–∂–µ –∑–∞–π–Ω—è—Ç–∏–π');
    
    try {
      const safeNick = nickname.toLowerCase().replace(/[^a-z0-9]/g, '');
      const randomSuffix = Math.floor(Math.random() * 10000);
      const email = `${safeNick}_${randomSuffix}@fantasyas.local`;
      
      const cred = await createUserWithEmailAndPassword(auth, email, password);
      
      await setDoc(doc(db, "users", cred.user.uid), {
        nickname,
        userId,
        nickname_lower: nickname.toLowerCase(),
        bio: '',
        avatar: '',
        posts: [],
        likedPosts: [],
        savedPosts: [],
        followers: [],
        following: [],
        mutedUsers: [],
        blockedUsers: [],
        createdAt: serverTimestamp(),
        lastOnline: serverTimestamp(),
        email: email
      });
      
      showToast('–†–µ—î—Å—Ç—Ä–∞—Ü—ñ—è —É—Å–ø—ñ—à–Ω–∞');
      document.getElementById('toLogin').click();
    } catch (e) { showToast(e.message); }
  };

  document.getElementById('loginBtn').onclick = async () => {
    const nickname = document.getElementById('loginNickname').value.trim();
    const password = document.getElementById('loginPassword').value.trim();
    if (!nickname || !password) return alert('–ó–∞–ø–æ–≤–Ω—ñ—Ç—å –ø–æ–ª—è');
    try {
      const userId = `@${nickname.toLowerCase()}`;
      const q = query(collection(db, "users"), where("userId", "==", userId));
      const snap = await getDocs(q);
      if (snap.empty) return alert('–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ');
      
      const userDoc = snap.docs[0];
      const userData = userDoc.data();
      const email = userData.email;
      
      if (!email) {
        return alert('–î–ª—è —Ü—å–æ–≥–æ –∞–∫–∞—É–Ω—Ç—É –Ω–µ –≤—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ email. –£–≤—ñ–π–¥—ñ—Ç—å —á–µ—Ä–µ–∑ Google –∞–±–æ Apple, –∞–±–æ —Å—Ç–≤–æ—Ä—ñ—Ç—å –Ω–æ–≤–∏–π –∞–∫–∞—É–Ω—Ç.');
      }
      
      await signInWithEmailAndPassword(auth, email, password);
      showToast('–õ–∞—Å–∫–∞–≤–æ –ø—Ä–æ—Å–∏–º–æ!');
    } catch (err) {
      alert('–ù–µ–≤—ñ—Ä–Ω–∏–π –ø—Å–µ–≤–¥–æ–Ω—ñ–º –∞–±–æ –ø–∞—Ä–æ–ª—å');
    }
  };

  // Google Login
  document.getElementById('googleLoginBtn').onclick = async () => {
    const provider = new GoogleAuthProvider();
    provider.setCustomParameters({
      prompt: 'select_account'
    });
    try {
      const result = await signInWithPopup(auth, provider);
      const user = result.user;
      const userDoc = await getDoc(doc(db, "users", user.uid));
      if (!userDoc.exists()) {
        const nickname = user.displayName || user.email?.split('@')[0] || 'user';
        let userId = `@${nickname.toLowerCase()}`;
        const q = query(collection(db, "users"), where("userId", "==", userId));
        const snap = await getDocs(q);
        if (!snap.empty) userId = `@${nickname.toLowerCase()}${Math.floor(Math.random()*1000)}`;
        await setDoc(doc(db, "users", user.uid), {
          nickname,
          userId,
          nickname_lower: nickname.toLowerCase(),
          bio: '',
          avatar: user.photoURL || '',
          posts: [],
          likedPosts: [],
          savedPosts: [],
          followers: [],
          following: [],
          mutedUsers: [],
          blockedUsers: [],
          createdAt: serverTimestamp(),
          lastOnline: serverTimestamp(),
          email: user.email
        });
      }
      showToast('–í—Ö—ñ–¥ —á–µ—Ä–µ–∑ Google —É—Å–ø—ñ—à–Ω–∏–π');
    } catch (error) {
      console.error('Google login error:', error);
      if (error.code === 'auth/popup-blocked') {
        showToast('–ë—É–¥—å –ª–∞—Å–∫–∞, –¥–æ–∑–≤–æ–ª—å—Ç–µ —Å–ø–ª–∏–≤–∞—é—á—ñ –≤—ñ–∫–Ω–∞ –¥–ª—è —Ü—å–æ–≥–æ —Å–∞–π—Ç—É, —â–æ–± —É–≤—ñ–π—Ç–∏ —á–µ—Ä–µ–∑ Google.');
      } else if (error.code === 'auth/operation-not-allowed') {
        showToast('–í—Ö—ñ–¥ —á–µ—Ä–µ–∑ Google –Ω–µ –Ω–∞–ª–∞—à—Ç–æ–≤–∞–Ω–æ –≤ Firebase. –ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ –∫–æ–Ω—Å–æ–ª—å Firebase.');
      } else {
        showToast('–ü–æ–º–∏–ª–∫–∞ –≤—Ö–æ–¥—É: ' + error.message);
      }
    }
  };

  document.getElementById('appleLoginBtn').onclick = async () => {
    const provider = new OAuthProvider('apple.com');
    provider.addScope('email');
    provider.addScope('name');
    try {
      const result = await signInWithPopup(auth, provider);
      const user = result.user;
      const userDoc = await getDoc(doc(db, "users", user.uid));
      if (!userDoc.exists()) {
        const nickname = user.displayName || user.email?.split('@')[0] || 'user';
        let userId = `@${nickname.toLowerCase()}`;
        const q = query(collection(db, "users"), where("userId", "==", userId));
        const snap = await getDocs(q);
        if (!snap.empty) userId = `@${nickname.toLowerCase()}${Math.floor(Math.random()*1000)}`;
        await setDoc(doc(db, "users", user.uid), {
          nickname,
          userId,
          nickname_lower: nickname.toLowerCase(),
          bio: '',
          avatar: user.photoURL || '',
          posts: [],
          likedPosts: [],
          savedPosts: [],
          followers: [],
          following: [],
          mutedUsers: [],
          blockedUsers: [],
          createdAt: serverTimestamp(),
          lastOnline: serverTimestamp(),
          email: user.email
        });
      }
      showToast('–í—Ö—ñ–¥ —á–µ—Ä–µ–∑ Apple —É—Å–ø—ñ—à–Ω–∏–π');
    } catch (error) {
      showToast('–ü–æ–º–∏–ª–∫–∞: ' + error.message);
    }
  };

  document.getElementById('forgotPassword').onclick = async (e) => {
    e.preventDefault();
    const nickname = prompt('–í–≤–µ–¥—ñ—Ç—å –≤–∞—à –ø—Å–µ–≤–¥–æ–Ω—ñ–º (–±–µ–∑ @)');
    if (!nickname) return;
    
    const userId = `@${nickname.toLowerCase()}`;
    const q = query(collection(db, "users"), where("userId", "==", userId));
    const snap = await getDocs(q);
    if (snap.empty) return alert('–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ');
    
    const userData = snap.docs[0].data();
    const email = userData.email;
    if (!email) return alert('–î–ª—è —Ü—å–æ–≥–æ –∞–∫–∞—É–Ω—Ç—É –Ω–µ –≤–∫–∞–∑–∞–Ω–æ email. –£–≤—ñ–π–¥—ñ—Ç—å —á–µ—Ä–µ–∑ Google/Apple –∞–±–æ —Å—Ç–≤–æ—Ä—ñ—Ç—å –Ω–æ–≤–∏–π –∞–∫–∞—É–Ω—Ç.');
    
    try {
      await sendPasswordResetEmail(auth, email);
      showToast('–õ–∏—Å—Ç –¥–ª—è —Å–∫–∏–¥–∞–Ω–Ω—è –ø–∞—Ä–æ–ª—è –≤—ñ–¥–ø—Ä–∞–≤–ª–µ–Ω–æ');
    } catch (err) {
      showToast('–ü–æ–º–∏–ª–∫–∞: ' + err.message);
    }
  };

  onAuthStateChanged(auth, (user) => {
    cleanupListeners();
    
    if (user) {
      currentUser = user;
      currentProfileUid = user.uid;
      const authBox = document.getElementById('authBox');
      if (authBox) authBox.style.display = 'none';
      const newPostBox = document.getElementById('newPostBox');
      if (newPostBox) newPostBox.style.display = 'block';
      
      lastOnlineInterval = setInterval(() => {
        updateDoc(doc(db, "users", currentUser.uid), { lastOnline: serverTimestamp() }).catch(console.error);
      }, 30000);
      
      // –ü—ñ–¥–ø–∏—Å–∫–∞ –Ω–∞ –∑–º—ñ–Ω–∏ following
      const userRef = doc(db, "users", currentUser.uid);
      unsubscribeFollowing = onSnapshot(userRef, (docSnap) => {
        if (docSnap.exists()) {
          currentUserFollowing = docSnap.data().following || [];
          document.querySelectorAll('.follow-btn-post').forEach(btn => {
            const targetUid = btn.dataset.uid;
            if (targetUid) {
              const isFollowing = currentUserFollowing.includes(targetUid);
              btn.textContent = isFollowing ? '–í—ñ–¥–ø–∏—Å–∞—Ç–∏—Å—è' : '–ü—ñ–¥–ø–∏—Å–∞—Ç–∏—Å—è';
              btn.classList.toggle('following', isFollowing);
            }
          });
        }
      }, (error) => {
        console.error('Error in following snapshot:', error);
      });
      
      resetPagination();
      loadMyProfile();
      
      const q = query(collection(db, "chats"), where("participants", "array-contains", currentUser.uid));
      unsubscribeChatList = onSnapshot(q, (snapshot) => {
        let totalUnread = 0;
        snapshot.forEach(doc => {
          const data = doc.data();
          if (data.unread && data.unread[currentUser.uid]) {
            totalUnread += data.unread[currentUser.uid];
          }
        });
        unreadCount = totalUnread;
        updateUnreadBadge();
        if (document.getElementById('chats')?.classList.contains('active')) {
          loadChatList();
        }
      }, (error) => {
        console.error('Chat list snapshot error:', error);
        alert('–ü–æ–º–∏–ª–∫–∞ –≤ —Ä–µ–∞–ª—å–Ω–æ–º—É —á–∞—Å—ñ (—Å–ø–∏—Å–æ–∫ —á–∞—Ç—ñ–≤):\n' + error.message + '\n–ö–æ–¥: ' + error.code);
        showToast('–ü–æ–º–∏–ª–∫–∞ –æ–Ω–æ–≤–ª–µ–Ω–Ω—è —Å–ø–∏—Å–∫—É —á–∞—Ç—ñ–≤. –ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ —ñ–Ω–¥–µ–∫—Å–∏ Firestore.');
      });

      setupEmojiPicker('postEmojiBtn', 'postEmojiPicker', 'postText');
      setupEmojiPicker('chatEmojiBtn', 'chatEmojiPicker', 'chatText');

      setupFileInput('postMedia', 'postMediaLabel', 'postMediaPreview');
      setupFileInput('editAvatar', 'editAvatarLabel', 'editAvatarPreview');
      setupFileInput('editPostMedia', 'editPostMediaLabel', 'editPostMediaPreview');

      setTimeout(() => {
        const content = document.querySelector('.content');
        if (content) {
          content.setAttribute('tabindex', '-1');
          content.focus({ preventScroll: true });
        }
        updateFocusableCache();
        setFocusOnElement(cachedFocusableElements[0]);
      }, 500);
    } else {
      currentUser = null;
      currentUserFollowing = [];
      const authBox = document.getElementById('authBox');
      if (authBox) authBox.style.display = 'block';
      const newPostBox = document.getElementById('newPostBox');
      if (newPostBox) newPostBox.style.display = 'none';
      unreadCount = 0;
      updateUnreadBadge();
      setTimeout(() => { updateFocusableCache(); setFocusOnElement(cachedFocusableElements[0]); }, 500);
    }
  });

  // ================= –°—Ç—Ä—ñ—á–∫–∞ –∑ –∫–Ω–æ–ø–∫–æ—é –ø—ñ–¥–ø–∏—Å–∫–∏ =================
  document.getElementById('feedNewBtn').onclick = () => {
    if (currentFeedType === 'new') return;
    currentFeedType = 'new';
    resetPagination();
  };
  document.getElementById('feedPopularBtn').onclick = () => {
    if (currentFeedType === 'popular') return;
    currentFeedType = 'popular';
    resetPagination();
  };

  function resetPagination() {
    lastVisible = null;
    hasMore = true;
    const feed = document.getElementById('feed');
    if (feed) feed.innerHTML = '';
    loadMorePosts();
  }

  document.getElementById('addPost').onclick = async () => {
    if (!currentUser) return alert('–£–≤—ñ–π–¥—ñ—Ç—å');
    const text = document.getElementById('postText').value.trim();
    const file = document.getElementById('postMedia').files[0];
    if (!text && !file) return alert('–î–æ–¥–∞–π—Ç–µ —Ç–µ–∫—Å—Ç –∞–±–æ –º–µ–¥—ñ–∞');
    try {
      let mediaUrl = '', mediaType = '';
      if (file) {
        const storageRef = ref(storage, `posts/${currentUser.uid}/${Date.now()}_${file.name}`);
        await uploadBytes(storageRef, file);
        mediaUrl = await getDownloadURL(storageRef);
        mediaType = file.type.split('/')[0];
      }
      const userSnap = await getDoc(doc(db, "users", currentUser.uid));
      const userData = userSnap.data();
      
      const hashtags = extractHashtags(text);
      
      const postDoc = await addDoc(collection(db, "posts"), {
        author: currentUser.uid,
        authorType: 'user',
        authorName: userData.nickname,
        authorUserId: userData.userId,
        authorAvatar: userData.avatar || '',
        text,
        mediaUrl,
        mediaType,
        createdAt: serverTimestamp(),
        likes: [],
        likesCount: 0,
        commentsCount: 0,
        saves: [],
        views: 0,
        hashtags: hashtags
      });
      await updateDoc(doc(db, "users", currentUser.uid), { posts: arrayUnion(postDoc.id) });
      document.getElementById('postText').value = '';
      document.getElementById('postMedia').value = '';
      document.getElementById('postMediaLabel').textContent = '–û–±—Ä–∞—Ç–∏ —Ñ–æ—Ç–æ/–≤—ñ–¥–µ–æ';
      document.getElementById('postMediaPreview').classList.remove('show');
      showToast('–ü–æ—Å—Ç –æ–ø—É–±–ª—ñ–∫–æ–≤–∞–Ω–æ!');
    } catch (e) { showToast(e.message); }
  };

  async function loadMorePosts() {
    if (!currentUser || loading || !hasMore) return;
    loading = true;
    const skeleton = document.getElementById('skeletonContainer');
    if (skeleton) skeleton.style.display = 'block';
    
    try {
      let q;
      if (currentFeedType === 'new') {
        q = query(collection(db, "posts"), orderBy("createdAt", "desc"), limit(10));
      } else {
        q = query(collection(db, "posts"), orderBy("likesCount", "desc"), orderBy("createdAt", "desc"), limit(10));
      }
      if (lastVisible) q = query(q, startAfter(lastVisible));
      
      const snapshot = await getDocs(q);
      if (snapshot.empty) { hasMore = false; return; }
      
      lastVisible = snapshot.docs[snapshot.docs.length - 1];
      renderPosts(snapshot.docs);
    } catch (e) {
      console.error("–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –ø–æ—Å—Ç—ñ–≤:", e);
      alert('–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –ø–æ—Å—Ç—ñ–≤:\n' + e.message + '\n–ö–æ–¥: ' + e.code);
      showToast("–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è. –ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ —ñ–Ω–¥–µ–∫—Å–∏ Firestore.");
    } finally {
      if (skeleton) skeleton.style.display = 'none';
      loading = false;
      setTimeout(() => { updateFocusableCache(); }, 100);
    }
  }

  async function loadComments(postId, container) {
    const q = query(collection(db, `posts/${postId}/comments`), orderBy("createdAt", "asc"));
    const snapshot = await getDocs(q);
    container.innerHTML = '';
    snapshot.forEach(doc => {
      const comment = doc.data();
      const commentEl = document.createElement('div');
      commentEl.className = 'comment';
      commentEl.innerHTML = `
        <div class="comment-avatar" style="background-image:url(${comment.authorAvatar || ''})" data-uid="${comment.author}"></div>
        <div class="comment-content">
          <div>
            <span class="comment-author" data-uid="${comment.author}">${comment.authorName}</span>
            <span class="comment-time">${new Date(comment.createdAt?.seconds * 1000).toLocaleString()}</span>
          </div>
          <div class="comment-text">${comment.text}</div>
        </div>
      `;
      container.appendChild(commentEl);
    });
  }

  async function addComment(postId, text) {
    if (!currentUser || !text.trim()) return;
    const userSnap = await getDoc(doc(db, "users", currentUser.uid));
    const user = userSnap.data();
    const commentRef = collection(db, `posts/${postId}/comments`);
    await addDoc(commentRef, {
      author: currentUser.uid,
      authorName: user.nickname,
      authorAvatar: user.avatar || '',
      text: text.trim(),
      createdAt: serverTimestamp()
    });
    await updateDoc(doc(db, "posts", postId), { commentsCount: increment(1) });
  }

  async function incrementPostView(postId) {
    if (!currentUser) return;
    if (viewedPosts.has(postId)) return;
    viewedPosts.add(postId);
    try {
      await updateDoc(doc(db, "posts", postId), { views: increment(1) });
    } catch (e) {
      console.warn("–ù–µ –≤–¥–∞–ª–æ—Å—è –æ–Ω–æ–≤–∏—Ç–∏ –ø–µ—Ä–µ–≥–ª—è–¥–∏:", e);
    }
  }

  function renderPosts(docs, container = null) {
    const feed = container || document.getElementById('feed');
    if (!feed) return;
    docs.forEach(docSnap => {
      const post = { id: docSnap.id, ...docSnap.data() };
      const liked = post.likes?.includes(currentUser?.uid) || false;
      const saved = post.saves?.includes(currentUser?.uid) || false;
      const postTime = post.createdAt ? new Date(post.createdAt.seconds * 1000).toLocaleString() : '';
      const isAuthor = currentUser && post.author === currentUser.uid;
      const isFollowing = currentUserFollowing.includes(post.author);
      
      const postEl = document.createElement('div');
      postEl.className = 'post';
      postEl.dataset.postId = post.id;
      postEl.tabIndex = 0;
      
      let actionsHtml = '';
      if (isAuthor) {
        actionsHtml = `
          <div class="post-actions">
            <button class="edit-post-btn" title="–†–µ–¥–∞–≥—É–≤–∞—Ç–∏ –ø–æ—Å—Ç" tabindex="0">‚ãØ</button>
          </div>
        `;
      }
      
      let contentHtml = post.text || '';
      const hashtagRegex = /#(\w+)/g;
      contentHtml = contentHtml.replace(hashtagRegex, '<span class="hashtag" data-tag="$1">#$1</span>');
      
      const followButtonHtml = !isAuthor && currentUser ? 
        `<button class="follow-btn-post ${isFollowing ? 'following' : ''}" data-uid="${post.author}" tabindex="0">${isFollowing ? '–í—ñ–¥–ø–∏—Å–∞—Ç–∏—Å—è' : '–ü—ñ–¥–ø–∏—Å–∞—Ç–∏—Å—è'}</button>` : '';
      
      postEl.innerHTML = `
        ${actionsHtml}
        <div class="post-header">
          <div class="avatar" style="background-image:url(${post.authorAvatar || ''})" data-uid="${post.author}" tabindex="0"></div>
          <div class="post-author-info">
            <div>
              <span class="post-author" data-uid="${post.author}" tabindex="0">${post.authorName || '–ù–µ–≤—ñ–¥–æ–º–æ'}</span>
              <span class="post-meta">${post.authorUserId || ''}</span>
              ${followButtonHtml}
            </div>
            <div class="post-time">${postTime}</div>
          </div>
        </div>
        <div class="post-content">${contentHtml}</div>
        ${post.mediaUrl ? (post.mediaType==='image' ? `<img src="${post.mediaUrl}" class="post-media" loading="lazy" tabindex="0">` : `<video src="${post.mediaUrl}" controls class="post-media" tabindex="0"></video>`) : ''}
        <div class="post-footer">
          <button class="like-btn ${liked ? 'liked' : ''}" data-post-id="${post.id}" tabindex="0">
            <svg viewBox="0 0 24 24" width="20" height="20"><path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/></svg>
            <span>${post.likesCount || 0}</span>
          </button>
          <button class="comment-toggle-btn" data-post-id="${post.id}" tabindex="0">
            <svg viewBox="0 0 24 24" width="20" height="20"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>
            <span>${post.commentsCount || 0}</span>
          </button>
          <button class="save-btn ${saved ? 'saved' : ''}" data-post-id="${post.id}" tabindex="0">
            <svg viewBox="0 0 24 24" width="20" height="20"><path d="M19 21l-7-5-7 5V5a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2z"/></svg>
          </button>
          <span class="view-count" title="–ü–µ—Ä–µ–≥–ª—è–¥–∏">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="2"/><path d="M22 12c-2.667 4.667-6 7-10 7s-7.333-2.333-10-7c2.667-4.667 6-7 10-7s7.333 2.333 10 7z"/></svg>
            ${post.views || 0}
          </span>
        </div>
        <div class="comments-section" id="comments-${post.id}" style="display: none;">
          <div class="comments-list" id="comments-list-${post.id}"></div>
          <div class="comment-form">
            <input type="text" id="comment-input-${post.id}" class="comment-input" placeholder="–ù–∞–ø–∏—à—ñ—Ç—å –∫–æ–º–µ–Ω—Ç–∞—Ä..." tabindex="0">
            <div class="emoji-picker-container" style="position: relative;">
              <button class="emoji-button" id="comment-emoji-${post.id}" tabindex="0">üòä</button>
              <div class="emoji-picker" id="comment-picker-${post.id}" style="display: none; bottom: 100%; right: 0; position: absolute;"></div>
            </div>
            <button class="btn btn-primary btn-icon" id="submit-comment-${post.id}" tabindex="0">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></svg>
            </button>
          </div>
        </div>
      `;
      feed.appendChild(postEl);

      incrementPostView(post.id);

      const followBtn = postEl.querySelector('.follow-btn-post');
      if (followBtn) {
        followBtn.addEventListener('click', (e) => {
          e.stopPropagation();
          const targetUid = followBtn.dataset.uid;
          toggleFollow(targetUid, followBtn);
        });
      }

      if (isAuthor) {
        postEl.querySelector('.edit-post-btn').onclick = () => openEditPostModal(post);
      }

      postEl.querySelectorAll('.hashtag').forEach(span => {
        span.onclick = (e) => {
          e.stopPropagation();
          const tag = span.dataset.tag;
          searchHashtag(tag);
        };
      });

      const commentInput = document.getElementById(`comment-input-${post.id}`);
      if (commentInput) {
        setupEmojiPicker(`comment-emoji-${post.id}`, `comment-picker-${post.id}`, `comment-input-${post.id}`);
      }

      const toggleBtn = postEl.querySelector('.comment-toggle-btn');
      const commentsSection = postEl.querySelector('.comments-section');
      toggleBtn.onclick = async () => {
        if (commentsSection.style.display === 'none') {
          commentsSection.style.display = 'block';
          const commentsList = document.getElementById(`comments-list-${post.id}`);
          if (commentsList) await loadComments(post.id, commentsList);
          setTimeout(() => { updateFocusableCache(); }, 100);
        } else {
          commentsSection.style.display = 'none';
        }
      };

      const submitBtn = document.getElementById(`submit-comment-${post.id}`);
      if (submitBtn) {
        submitBtn.onclick = async () => {
          const text = commentInput.value.trim();
          if (!text) return;
          try {
            await addComment(post.id, text);
            commentInput.value = '';
            const commentsList = document.getElementById(`comments-list-${post.id}`);
            if (commentsList) await loadComments(post.id, commentsList);
            const countSpan = toggleBtn.querySelector('span');
            if (countSpan) countSpan.textContent = parseInt(countSpan.textContent) + 1;
            showToast('–ö–æ–º–µ–Ω—Ç–∞—Ä –¥–æ–¥–∞–Ω–æ');
          } catch (error) {
            console.error('Error adding comment:', error);
            showToast('–ü–æ–º–∏–ª–∫–∞: ' + error.message);
          }
        };
      }
    });
    setTimeout(updateFocusableCache, 100);
  }

  async function toggleFollow(targetUid, buttonElement) {
    if (!currentUser) return;
    
    const wasFollowing = currentUserFollowing.includes(targetUid);
    const newFollowingState = !wasFollowing;
    
    if (newFollowingState) {
      currentUserFollowing.push(targetUid);
    } else {
      currentUserFollowing = currentUserFollowing.filter(id => id !== targetUid);
    }
    
    if (buttonElement) {
      buttonElement.textContent = newFollowingState ? '–í—ñ–¥–ø–∏—Å–∞—Ç–∏—Å—è' : '–ü—ñ–¥–ø–∏—Å–∞—Ç–∏—Å—è';
      buttonElement.classList.toggle('following', newFollowingState);
    }
    
    try {
      const myRef = doc(db, "users", currentUser.uid);
      const targetRef = doc(db, "users", targetUid);
      
      if (wasFollowing) {
        await updateDoc(myRef, { following: arrayRemove(targetUid) });
        await updateDoc(targetRef, { followers: arrayRemove(currentUser.uid) });
      } else {
        await updateDoc(myRef, { following: arrayUnion(targetUid) });
        await updateDoc(targetRef, { followers: arrayUnion(currentUser.uid) });
        vibrate(30);
      }
    } catch (error) {
      console.error('Follow error:', error);
      if (newFollowingState) {
        currentUserFollowing = currentUserFollowing.filter(id => id !== targetUid);
      } else {
        currentUserFollowing.push(targetUid);
      }
      if (buttonElement) {
        buttonElement.textContent = wasFollowing ? '–í—ñ–¥–ø–∏—Å–∞—Ç–∏—Å—è' : '–ü—ñ–¥–ø–∏—Å–∞—Ç–∏—Å—è';
        buttonElement.classList.toggle('following', wasFollowing);
      }
      if (error.code === 'permission-denied') {
        showToast('–ü–æ–º–∏–ª–∫–∞: –Ω–µ–¥–æ—Å—Ç–∞—Ç–Ω—å–æ –ø—Ä–∞–≤. –ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ –ø—Ä–∞–≤–∏–ª–∞ –±–µ–∑–ø–µ–∫–∏ Firestore.');
      } else {
        showToast('–ü–æ–º–∏–ª–∫–∞: ' + (error.message || '–ù–µ–≤—ñ–¥–æ–º–∞ –ø–æ–º–∏–ª–∫–∞'));
      }
    }
  }

  function openEditPostModal(post) {
    currentEditingPost = post;
    document.getElementById('editPostText').value = post.text || '';
    document.getElementById('editPostMedia').value = '';
    document.getElementById('editPostMediaLabel').textContent = '–ó–º—ñ–Ω–∏—Ç–∏ –º–µ–¥—ñ–∞';
    const preview = document.getElementById('editPostMediaPreview');
    preview.classList.remove('show');
    if (post.mediaUrl) {
      if (post.mediaType === 'image') {
        preview.src = post.mediaUrl;
        preview.classList.add('show');
      }
    }
    document.getElementById('editPostModal').classList.add('active');
    setTimeout(() => { updateFocusableCache(); setFocusOnElement(document.getElementById('editPostText')); }, 50);
  }

  document.getElementById('closeEditPostModal').onclick = () => {
    document.getElementById('editPostModal').classList.remove('active');
    currentEditingPost = null;
    setTimeout(() => { updateFocusableCache(); setFocusOnElement(cachedFocusableElements[0]); }, 50);
  };

  document.getElementById('savePostEdit').onclick = async () => {
    if (!currentEditingPost || !currentUser) return;
    const newText = document.getElementById('editPostText').value.trim();
    const file = document.getElementById('editPostMedia').files[0];
    try {
      const postRef = doc(db, "posts", currentEditingPost.id);
      let updateData = { text: newText };
      updateData.hashtags = extractHashtags(newText);
      if (file) {
        if (currentEditingPost.mediaUrl) {
          try {
            const oldMediaRef = ref(storage, currentEditingPost.mediaUrl);
            await deleteObject(oldMediaRef);
          } catch (e) {}
        }
        const storageRef = ref(storage, `posts/${currentUser.uid}/${Date.now()}_${file.name}`);
        await uploadBytes(storageRef, file);
        const mediaUrl = await getDownloadURL(storageRef);
        const mediaType = file.type.split('/')[0];
        updateData.mediaUrl = mediaUrl;
        updateData.mediaType = mediaType;
      }
      await updateDoc(postRef, updateData);
      showToast('–ü–æ—Å—Ç –æ–Ω–æ–≤–ª–µ–Ω–æ');
      document.getElementById('editPostModal').classList.remove('active');
    } catch (e) {
      showToast('–ü–æ–º–∏–ª–∫–∞: ' + e.message);
    }
  };

  document.getElementById('deletePostBtn').onclick = async () => {
    if (!currentEditingPost || !currentUser) return;
    if (!confirm('–í–∏–¥–∞–ª–∏—Ç–∏ –ø–æ—Å—Ç?')) return;
    try {
      if (currentEditingPost.mediaUrl) {
        try {
          const mediaRef = ref(storage, currentEditingPost.mediaUrl);
          await deleteObject(mediaRef);
        } catch (e) {}
      }
      await deleteDoc(doc(db, "posts", currentEditingPost.id));
      await updateDoc(doc(db, "users", currentUser.uid), { posts: arrayRemove(currentEditingPost.id) });
      showToast('–ü–æ—Å—Ç –≤–∏–¥–∞–ª–µ–Ω–æ');
      document.getElementById('editPostModal').classList.remove('active');
    } catch (e) {
      showToast('–ü–æ–º–∏–ª–∫–∞: ' + e.message);
    }
  };

  async function loadSearchUsers() {
    if (!currentUser) return;
    const val = document.getElementById('searchInput').value.trim().toLowerCase();
    const userList = document.getElementById('userList');
    if (!val) { userList.innerHTML = ''; return; }

    if (val.startsWith('#')) {
      const tag = val.substring(1);
      const q = query(collection(db, "posts"), where("hashtags", "array-contains", tag));
      const snapshot = await getDocs(q);
      userList.innerHTML = '<h3 style="margin-bottom:12px;">–ü–æ—Å—Ç–∏ –∑ —Ç–µ–≥–æ–º</h3>';
      if (snapshot.empty) {
        userList.innerHTML += '<p>–ù–µ–º–∞—î –ø–æ—Å—Ç—ñ–≤ –∑ —Ü–∏–º —Ç–µ–≥–æ–º</p>';
      } else {
        const feedDiv = document.createElement('div');
        feedDiv.className = 'feed';
        userList.appendChild(feedDiv);
        renderPosts(snapshot.docs, feedDiv);
      }
      return;
    }
    
    const mySnap = await getDoc(doc(db, "users", currentUser.uid));
    const myFollowing = mySnap.data().following || [];
    
    const q1 = query(collection(db, "users"), where("userId", ">=", val.startsWith('@') ? val : `@${val}`), where("userId", "<=", (val.startsWith('@') ? val : `@${val}`) + '\uf8ff'));
    const q2 = query(collection(db, "users"), where("nickname_lower", ">=", val), where("nickname_lower", "<=", val + '\uf8ff'));
    
    const [snap1, snap2] = await Promise.all([getDocs(q1), getDocs(q2)]);
    const usersMap = new Map();
    snap1.forEach(d => usersMap.set(d.id, d.data()));
    snap2.forEach(d => usersMap.set(d.id, d.data()));
    
    userList.innerHTML = '';
    usersMap.forEach((data, uid) => {
      if (uid === currentUser.uid) return;
      const isFollowing = myFollowing.includes(uid);
      const div = document.createElement('div');
      div.className = 'chat-item';
      div.tabIndex = 0;
      div.innerHTML = `
        <div class="avatar small" style="background-image:url(${data.avatar || ''})" tabindex="0"></div>
        <div class="chat-info">
          <div class="chat-name">${data.nickname}</div>
          <div class="chat-last">${data.userId}</div>
        </div>
        <button class="btn follow-btn" tabindex="0">${isFollowing ? '–í—ñ–¥–ø–∏—Å–∞—Ç–∏—Å—è' : '–ü—ñ–¥–ø–∏—Å–∞—Ç–∏—Å—è'}</button>
      `;
      const followBtn = div.querySelector('.follow-btn');
      followBtn.onclick = async (e) => {
        e.stopPropagation();
        await toggleFollow(uid, followBtn);
      };
      div.onclick = () => viewProfile(uid);
      userList.appendChild(div);
    });
    setTimeout(() => { updateFocusableCache(); }, 100);
  }
  document.getElementById('searchInput').addEventListener('input', loadSearchUsers);

  async function loadMyProfile() {
    if (!currentUser) return;
    const snap = await getDoc(doc(db, "users", currentUser.uid));
    if (snap.exists()) renderProfile(snap.data(), currentUser.uid, true);
  }

  function viewProfile(uid) {
    currentProfileUid = uid;
    document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
    const profileNav = document.querySelector('[data-section="profile"]');
    if (profileNav) profileNav.classList.add('active');
    sections.forEach(s => document.getElementById(s).classList.remove('active'));
    const profileSection = document.getElementById('profile');
    if (profileSection) profileSection.classList.add('active');
    document.getElementById('pageTitle').textContent = '–ü—Ä–æ—Ñ—ñ–ª—å';
    
    if (uid === currentUser?.uid) {
      loadMyProfile();
    } else {
      loadUserProfile(uid);
    }
    
    closeSidebar();
    setTimeout(() => { updateFocusableCache(); setFocusOnElement(cachedFocusableElements[0]); }, 200);
  }

  async function loadUserProfile(uid) {
    if (!currentUser) return;
    const snap = await getDoc(doc(db, "users", uid));
    if (snap.exists()) renderProfile(snap.data(), uid, uid === currentUser.uid);
  }

  function renderProfile(data, uid, isOwn) {
    const header = document.getElementById('profileHeader');
    if (!header) return;

    if (!isOwn && currentUser && data.blockedUsers?.includes(currentUser.uid)) {
      header.innerHTML = `
        <div class="avatar large" style="background-image:url(${data.avatar || ''})" data-uid="${uid}" tabindex="0"></div>
        <div>
          <h2>${data.nickname}</h2>
          <p class="text-danger">–¶–µ–π –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á –≤–∞—Å –∑–∞–±–ª–æ–∫—É–≤–∞–≤</p>
        </div>
      `;
      return;
    }

    const isFollowing = !isOwn && currentUser ? (data.followers?.includes(currentUser.uid) || false) : false;

    header.innerHTML = `
      <div class="avatar large" style="background-image:url(${data.avatar || ''})" data-uid="${uid}" tabindex="0"></div>
      <div style="flex:1">
        <h2>${data.nickname}</h2>
        <div class="user-id">${data.userId}</div>
        <p>${data.bio || ''}</p>
        <div class="profile-stats">
          <span id="followersCount" data-uid="${uid}">${data.followers?.length || 0} –ø—ñ–¥–ø–∏—Å–Ω–∏–∫—ñ–≤</span>
          <span id="followingCount" data-uid="${uid}">${data.following?.length || 0} –ø—ñ–¥–ø–∏—Å–æ–∫</span>
          <span>${data.posts?.length || 0} –ø–æ—Å—Ç—ñ–≤</span>
        </div>
        ${!isOwn && currentUser ? `
          <div style="display:flex; gap:10px; margin-top:10px; align-items:center;">
            <button class="btn" id="profileFollowBtn" tabindex="0">${isFollowing ? '–í—ñ–¥–ø–∏—Å–∞—Ç–∏—Å—è' : '–ü—ñ–¥–ø–∏—Å–∞—Ç–∏—Å—è'}</button>
            <button class="btn" id="profileMessageBtn" tabindex="0">–ù–∞–ø–∏—Å–∞—Ç–∏</button>
          </div>
        ` : ''}
        ${isOwn ? '<button class="btn" id="editProfileBtn" tabindex="0">–†–µ–¥–∞–≥—É–≤–∞—Ç–∏</button>' : ''}
      </div>
      ${!isOwn && currentUser ? `
        <div class="profile-menu">
          <button class="profile-menu-btn" id="profileMenuBtn" tabindex="0">‚ãØ</button>
          <div class="profile-menu-dropdown" id="profileMenuDropdown">
            <div class="profile-menu-item" id="reportUserBtn">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2l2.5 6.5L21 9l-5 4 2 7-6-4-6 4 2-7-5-4 6.5-.5L12 2z"/></svg>
              –ü–æ—Å–∫–∞—Ä–∂–∏—Ç–∏—Å—è
            </div>
            <div class="profile-menu-item" id="muteUserBtn">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 10h3l4-4v12l-4-4H3v-4z"/><line x1="18" y1="7" x2="22" y2="11"/><line x1="18" y1="11" x2="22" y2="7"/></svg>
              –ó–∞–º—É—Ç–∏—Ç–∏ –≤ —á–∞—Ç–∞—Ö
            </div>
            <div class="profile-menu-item" id="blockUserBtn">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="4.93" y1="4.93" x2="19.07" y2="19.07"/></svg>
              –ó–∞–±–ª–æ–∫—É–≤–∞—Ç–∏
            </div>
          </div>
        </div>
      ` : ''}
    `;

    const followersCount = document.getElementById('followersCount');
    if (followersCount) {
      followersCount.style.cursor = 'pointer';
      followersCount.onclick = () => openFollowersList(uid);
    }
    const followingCount = document.getElementById('followingCount');
    if (followingCount) {
      followingCount.style.cursor = 'pointer';
      followingCount.onclick = () => openFollowingList(uid);
    }

    if (!isOwn && currentUser) {
      const profileFollowBtn = document.getElementById('profileFollowBtn');
      if (profileFollowBtn) {
        profileFollowBtn.onclick = async () => {
          await toggleFollow(uid, profileFollowBtn);
        };
      }
      const profileMessageBtn = document.getElementById('profileMessageBtn');
      if (profileMessageBtn) {
        profileMessageBtn.onclick = () => {
          openChat(data.nickname, uid, data.userId);
        };
      }

      const menuBtn = document.getElementById('profileMenuBtn');
      const dropdown = document.getElementById('profileMenuDropdown');
      if (menuBtn && dropdown) {
        menuBtn.onclick = (e) => {
          e.stopPropagation();
          dropdown.classList.toggle('show');
          if (dropdown.classList.contains('show')) {
            setTimeout(() => { 
              updateFocusableCache(); 
              const firstItem = dropdown.querySelector('.profile-menu-item');
              if (firstItem) setFocusOnElement(firstItem);
            }, 50);
          } else {
            setTimeout(() => { updateFocusableCache(); setFocusOnElement(menuBtn); }, 50);
          }
        };
        document.addEventListener('click', (e) => {
          if (!menuBtn.contains(e.target)) {
            dropdown.classList.remove('show');
          }
        });

        document.getElementById('reportUserBtn').onclick = async () => {
          dropdown.classList.remove('show');
          const reason = prompt('–û–ø–∏—à—ñ—Ç—å –ø—Ä–∏—á–∏–Ω—É —Å–∫–∞—Ä–≥–∏ (–Ω–µ–æ–±–æ–≤\'—è–∑–∫–æ–≤–æ)');
          await reportUser(uid, reason);
        };
        document.getElementById('muteUserBtn').onclick = async () => {
          dropdown.classList.remove('show');
          const userRef = doc(db, "users", currentUser.uid);
          const snap = await getDoc(userRef);
          const muted = snap.data().mutedUsers || [];
          if (muted.includes(uid)) {
            await unmuteUser(uid);
          } else {
            await muteUser(uid);
          }
        };
        document.getElementById('blockUserBtn').onclick = async () => {
          dropdown.classList.remove('show');
          const userRef = doc(db, "users", currentUser.uid);
          const snap = await getDoc(userRef);
          const blocked = snap.data().blockedUsers || [];
          if (blocked.includes(uid)) {
            await unblockUser(uid);
          } else {
            await blockUser(uid);
          }
          loadUserProfile(uid);
        };
      }
    }
    if (isOwn) {
      const editProfileBtn = document.getElementById('editProfileBtn');
      if (editProfileBtn) {
        editProfileBtn.onclick = () => {
          document.getElementById('editNickname').value = data.nickname;
          document.getElementById('editBio').value = data.bio || '';
          document.getElementById('editAvatar').value = '';
          document.getElementById('editAvatarLabel').textContent = '–û–±—Ä–∞—Ç–∏ –∞–≤–∞—Ç–∞—Ä';
          document.getElementById('editAvatarPreview').classList.remove('show');
          document.getElementById('editProfileModal').classList.add('active');
          setTimeout(() => { updateFocusableCache(); setFocusOnElement(document.getElementById('editNickname')); }, 50);
        };
      }
    }
    
    const tabs = document.getElementById('profileTabs');
    if (tabs) {
      tabs.innerHTML = `
        <div class="profile-tab active" data-tab="posts" tabindex="0">–ü–æ—Å—Ç–∏</div>
        <div class="profile-tab" data-tab="likes" tabindex="0">–õ–∞–π–∫–∏</div>
        <div class="profile-tab" data-tab="media" tabindex="0">–ú–µ–¥—ñ–∞</div>
        <div class="profile-tab" data-tab="saved" tabindex="0">–ó–±–µ—Ä–µ–∂–µ–Ω–µ</div>
      `;
      document.querySelectorAll('.profile-tab').forEach(tab => {
        tab.onclick = () => {
          document.querySelectorAll('.profile-tab').forEach(t => t.classList.remove('active'));
          tab.classList.add('active');
          loadProfileFeed(uid, tab.dataset.tab);
        };
      });
    }
    loadProfileFeed(uid, 'posts');
    setTimeout(() => { updateFocusableCache(); }, 100);
  }

  async function openFollowersList(uid) {
    const modal = document.getElementById('followersModal');
    const list = document.getElementById('followersList');
    if (!modal || !list) return;
    list.innerHTML = '<div class="skeleton" style="height:60px;"></div>';
    modal.classList.add('active');
    
    const userSnap = await getDoc(doc(db, "users", uid));
    const followersIds = userSnap.data().followers || [];
    const followers = [];
    for (const id of followersIds) {
      const snap = await getDoc(doc(db, "users", id));
      if (snap.exists()) followers.push({ id, ...snap.data() });
    }
    
    list.innerHTML = '';
    if (followers.length === 0) {
      list.innerHTML = '<p style="text-align:center; padding:20px;">–ù–µ–º–∞—î –ø—ñ–¥–ø–∏—Å–Ω–∏–∫—ñ–≤</p>';
    } else {
      followers.forEach(user => {
        const div = document.createElement('div');
        div.className = 'chat-item';
        div.tabIndex = 0;
        div.innerHTML = `
          <div class="avatar small" style="background-image:url(${user.avatar || ''})" data-uid="${user.id}" tabindex="0"></div>
          <div class="chat-info">
            <div class="chat-name">${user.nickname}</div>
            <div class="chat-last">${user.userId}</div>
          </div>
        `;
        div.onclick = () => {
          viewProfile(user.id);
          modal.classList.remove('active');
        };
        list.appendChild(div);
      });
    }
    setTimeout(() => { updateFocusableCache(); setFocusOnElement(list.firstChild); }, 100);
  }

  async function openFollowingList(uid) {
    const modal = document.getElementById('followingModal');
    const list = document.getElementById('followingList');
    if (!modal || !list) return;
    list.innerHTML = '<div class="skeleton" style="height:60px;"></div>';
    modal.classList.add('active');
    
    const userSnap = await getDoc(doc(db, "users", uid));
    const followingIds = userSnap.data().following || [];
    const following = [];
    for (const id of followingIds) {
      const snap = await getDoc(doc(db, "users", id));
      if (snap.exists()) following.push({ id, ...snap.data() });
    }
    
    list.innerHTML = '';
    if (following.length === 0) {
      list.innerHTML = '<p style="text-align:center; padding:20px;">–ù—ñ –Ω–∞ –∫–æ–≥–æ –Ω–µ –ø—ñ–¥–ø–∏—Å–∞–Ω–∏–π</p>';
    } else {
      following.forEach(user => {
        const div = document.createElement('div');
        div.className = 'chat-item';
        div.tabIndex = 0;
        div.innerHTML = `
          <div class="avatar small" style="background-image:url(${user.avatar || ''})" data-uid="${user.id}" tabindex="0"></div>
          <div class="chat-info">
            <div class="chat-name">${user.nickname}</div>
            <div class="chat-last">${user.userId}</div>
          </div>
        `;
        div.onclick = () => {
          viewProfile(user.id);
          modal.classList.remove('active');
        };
        list.appendChild(div);
      });
    }
    setTimeout(() => { updateFocusableCache(); setFocusOnElement(list.firstChild); }, 100);
  }

  document.getElementById('closeFollowersModal').onclick = () => {
    document.getElementById('followersModal').classList.remove('active');
    setTimeout(() => { updateFocusableCache(); setFocusOnElement(cachedFocusableElements[0]); }, 50);
  };
  document.getElementById('closeFollowingModal').onclick = () => {
    document.getElementById('followingModal').classList.remove('active');
    setTimeout(() => { updateFocusableCache(); setFocusOnElement(cachedFocusableElements[0]); }, 50);
  };

  async function loadProfileFeed(uid, tab) {
    if (!currentUser) return;
    const feed = document.getElementById('profileFeed');
    if (!feed) return;
    feed.innerHTML = '';
    let posts = [];
    const userSnap = await getDoc(doc(db, "users", uid));
    const userData = userSnap.data();
    
    if (tab === 'posts') {
      const postIds = userData.posts || [];
      for (const id of postIds.slice(0, 20)) {
        const postSnap = await getDoc(doc(db, "posts", id));
        if (postSnap.exists()) posts.push({ id, ...postSnap.data() });
      }
    } else if (tab === 'likes') {
      const likedIds = userData.likedPosts || [];
      for (const id of likedIds.slice(0, 20)) {
        const postSnap = await getDoc(doc(db, "posts", id));
        if (postSnap.exists()) posts.push({ id, ...postSnap.data() });
      }
    } else if (tab === 'media') {
      const q = query(collection(db, "posts"), where("author", "==", uid), where("mediaUrl", "!=", ""));
      const snap = await getDocs(q);
      snap.forEach(d => posts.push({ id: d.id, ...d.data() }));
    } else if (tab === 'saved') {
      const savedIds = userData.savedPosts || [];
      for (const id of savedIds.slice(0, 20)) {
        const postSnap = await getDoc(doc(db, "posts", id));
        if (postSnap.exists()) posts.push({ id, ...postSnap.data() });
      }
    }
    
    posts.sort((a, b) => (b.createdAt?.seconds || 0) - (a.createdAt?.seconds || 0));
    
    posts.forEach(post => {
      const div = document.createElement('div');
      div.className = 'post';
      div.tabIndex = 0;
      div.innerHTML = `<div class="post-content">${post.text || ''}</div>`;
      feed.appendChild(div);
    });
    setTimeout(() => { updateFocusableCache(); }, 100);
  }

  document.getElementById('closeModal').onclick = () => {
    document.getElementById('editProfileModal').classList.remove('active');
    setTimeout(() => { updateFocusableCache(); setFocusOnElement(cachedFocusableElements[0]); }, 50);
  };
  
  document.getElementById('saveProfileEdit').onclick = async () => {
    if (!currentUser) return;
    const nickname = document.getElementById('editNickname').value.trim();
    const bio = document.getElementById('editBio').value.trim();
    const avatarFile = document.getElementById('editAvatar').files[0];
    if (!nickname) return alert('–ü—Å–µ–≤–¥–æ–Ω—ñ–º –æ–±–æ–≤‚Äô—è–∑–∫–æ–≤–∏–π');
    
    const newUserId = `@${nickname.toLowerCase()}`;
    const q = query(collection(db, "users"), where("userId", "==", newUserId));
    const snap = await getDocs(q);
    if (!snap.empty && snap.docs[0].id !== currentUser.uid) return alert('–¶–µ–π ID –≤–∂–µ –∑–∞–π–Ω—è—Ç–∏–π');
    
    try {
      let avatarUrl;
      if (avatarFile) {
        const storageRef = ref(storage, `avatars/${currentUser.uid}/${Date.now()}_${avatarFile.name}`);
        await uploadBytes(storageRef, avatarFile);
        avatarUrl = await getDownloadURL(storageRef);
      }
      
      const updateData = { 
        nickname, 
        userId: newUserId, 
        nickname_lower: nickname.toLowerCase(), 
        bio 
      };
      if (avatarUrl) updateData.avatar = avatarUrl;
      
      await updateDoc(doc(db, "users", currentUser.uid), updateData);
      loadMyProfile();
      document.getElementById('editProfileModal').classList.remove('active');
      showToast('–ü—Ä–æ—Ñ—ñ–ª—å –æ–Ω–æ–≤–ª–µ–Ω–æ');
    } catch (e) {
      showToast('–ü–æ–º–∏–ª–∫–∞: ' + e.message);
    }
  };

  const getChatId = (uid1, uid2) => [uid1, uid2].sort().join('_');

  async function loadChatList() {
    if (!currentUser) return;
    const list = document.getElementById('chatList');
    if (!list) return;
    list.innerHTML = '';

    try {
      const q = query(collection(db, "chats"), where("participants", "array-contains", currentUser.uid));
      const snapshot = await getDocs(q);

      if (snapshot.empty) {
        list.innerHTML = '<p style="text-align:center; padding:20px;">–ù–µ–º–∞—î —á–∞—Ç—ñ–≤</p>';
        return;
      }

      const chatItems = [];
      for (const docSnap of snapshot.docs) {
        const chat = docSnap.data();
        const otherUid = chat.participants.find(uid => uid !== currentUser.uid);
        if (!otherUid) continue;

        const userSnap = await getDoc(doc(db, "users", otherUid));
        const user = userSnap.data();
        if (!user) continue;

        const unread = chat.unread?.[currentUser.uid] || 0;
        const lastMsg = chat.lastMessage || '';
        const updatedAt = chat.updatedAt?.seconds || 0;
        const time = updatedAt ? new Date(updatedAt * 1000).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }) : '';
        const lastOnline = user.lastOnline?.seconds || 0;
        const isOnline = (Date.now() / 1000 - lastOnline) < 60;

        chatItems.push({
          chatId: docSnap.id,
          otherUid,
          user,
          unread,
          lastMsg,
          time,
          isOnline,
          updatedAt
        });
      }

      chatItems.sort((a, b) => b.updatedAt - a.updatedAt);

      if (chatItems.length === 0) {
        list.innerHTML = '<p style="text-align:center; padding:20px;">–ù–µ–º–∞—î —á–∞—Ç—ñ–≤</p>';
        return;
      }

      chatItems.forEach(item => {
        const div = document.createElement('div');
        div.className = `chat-item ${item.unread > 0 ? 'unread' : ''}`;
        div.dataset.chatId = item.chatId;
        div.dataset.otherUid = item.otherUid;
        div.tabIndex = 0;
        div.innerHTML = `
          <div class="avatar small" style="background-image:url(${item.user.avatar || ''})" tabindex="0"></div>
          <div class="chat-info">
            <div class="chat-name">${item.user.nickname} ${item.isOnline ? '<span class="online-indicator" style="display:inline-block;"></span>' : ''}</div>
            <div class="chat-last">${item.lastMsg}</div>
          </div>
          <div class="chat-time">${item.time}</div>
          ${item.unread > 0 ? `<div class="chat-badge">${item.unread}</div>` : ''}
        `;
        div.onclick = () => openChatFromList(item.chatId, item.otherUid, item.user.nickname, item.user.userId, item.user.avatar);
        list.appendChild(div);
      });
    } catch (error) {
      console.error('Error loading chat list:', error);
      alert('–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —Å–ø–∏—Å–∫—É —á–∞—Ç—ñ–≤:\n' + (error.message || '–ù–µ–≤—ñ–¥–æ–º–∞ –ø–æ–º–∏–ª–∫–∞') + '\n–ö–æ–¥: ' + (error.code || 'N/A'));
      showToast('–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —Å–ø–∏—Å–∫—É —á–∞—Ç—ñ–≤.');
    }
    setTimeout(() => { updateFocusableCache(); }, 100);
  }

  async function openChatFromList(chatId, otherUid, otherName, otherUserId, otherAvatar) {
    if (!currentUser) return;
    currentChatPartner = otherUid;
    currentChatPartnerName = otherName;
    currentChatId = chatId;
    
    const chatWindow = document.getElementById('chatWindow');
    if (chatWindow) chatWindow.style.display = 'flex';
    const chatName = document.getElementById('chatName');
    if (chatName) chatName.textContent = otherName;
    const chatUserId = document.getElementById('chatUserId');
    if (chatUserId) chatUserId.textContent = otherUserId || '';
    const chatAvatar = document.getElementById('chatAvatar');
    if (chatAvatar) chatAvatar.style.backgroundImage = `url(${otherAvatar || ''})`;
    
    const chatRef = doc(db, "chats", chatId);
    await updateDoc(chatRef, { [`unread.${currentUser.uid}`]: 0 }).catch(console.error);
    
    setTimeout(() => {
      subscribeToChat(chatId).catch(err => {
        console.error('Error subscribing to chat:', err);
        showToast('–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω—å');
      });
    }, 100);
    
    if (unsubscribeOnlineStatus) unsubscribeOnlineStatus();
    unsubscribeOnlineStatus = onSnapshot(doc(db, "users", otherUid), (snap) => {
      const lastOnline = snap.data()?.lastOnline?.seconds || 0;
      const isOnline = (Date.now()/1000 - lastOnline) < 60;
      const indicator = document.getElementById('onlineIndicator');
      if (indicator) indicator.style.display = isOnline ? 'inline-block' : 'none';
    }, (error) => {
      console.error('Online status error:', error);
    });
    
    setTimeout(() => { updateFocusableCache(); setFocusOnElement(document.getElementById('chatText')); }, 200);
  }

  function openChat(otherName, otherUid, otherUserId) {
    if (!currentUser) return;
    currentChatPartner = otherUid;
    currentChatPartnerName = otherName;
    
    document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
    const chatsNav = document.querySelector('[data-section="chats"]');
    if (chatsNav) chatsNav.classList.add('active');
    sections.forEach(s => document.getElementById(s).classList.remove('active'));
    const chatsSection = document.getElementById('chats');
    if (chatsSection) chatsSection.classList.add('active');
    document.getElementById('pageTitle').textContent = '–ß–∞—Ç–∏';
    
    const chatWindow = document.getElementById('chatWindow');
    if (chatWindow) chatWindow.style.display = 'flex';
    const chatName = document.getElementById('chatName');
    if (chatName) chatName.textContent = otherName;
    const chatUserId = document.getElementById('chatUserId');
    if (chatUserId) chatUserId.textContent = otherUserId || '';
    
    getDoc(doc(db, "users", otherUid)).then(snap => {
      if (snap.exists()) {
        const chatAvatar = document.getElementById('chatAvatar');
        if (chatAvatar) chatAvatar.style.backgroundImage = `url(${snap.data().avatar || ''})`;
        const lastOnline = snap.data().lastOnline?.seconds || 0;
        const isOnline = (Date.now()/1000 - lastOnline) < 60;
        const indicator = document.getElementById('onlineIndicator');
        if (indicator) indicator.style.display = isOnline ? 'inline-block' : 'none';
      }
    }).catch(console.error);
    
    if (unsubscribeOnlineStatus) unsubscribeOnlineStatus();
    unsubscribeOnlineStatus = onSnapshot(doc(db, "users", otherUid), (snap) => {
      const lastOnline = snap.data()?.lastOnline?.seconds || 0;
      const isOnline = (Date.now()/1000 - lastOnline) < 60;
      const indicator = document.getElementById('onlineIndicator');
      if (indicator) indicator.style.display = isOnline ? 'inline-block' : 'none';
    }, (error) => {
      console.error('Online status error:', error);
    });
    
    const chatId = getChatId(currentUser.uid, otherUid);
    currentChatId = chatId;
    const chatRef = doc(db, "chats", chatId);
    getDoc(chatRef).then(async (docSnap) => {
      try {
        if (!docSnap.exists()) {
          await setDoc(chatRef, {
            participants: [currentUser.uid, otherUid],
            createdAt: serverTimestamp(),
            updatedAt: serverTimestamp(),
            lastMessage: '',
            unread: { [currentUser.uid]: 0, [otherUid]: 0 }
          });
        } else {
          await updateDoc(chatRef, { [`unread.${currentUser.uid}`]: 0 });
        }
        setTimeout(() => {
          subscribeToChat(chatId).catch(err => {
            console.error('Error subscribing to chat:', err);
            showToast('–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω—å');
          });
        }, 100);
        loadChatList();
      } catch (error) {
        console.error('Error opening chat:', error);
        alert('–ü–æ–º–∏–ª–∫–∞ –≤—ñ–¥–∫—Ä–∏—Ç—Ç—è —á–∞—Ç—É:\n' + error.message);
        showToast('–ü–æ–º–∏–ª–∫–∞ –≤—ñ–¥–∫—Ä–∏—Ç—Ç—è —á–∞—Ç—É');
      }
    }).catch(error => {
      console.error('Error getting chat doc:', error);
      alert('–ü–æ–º–∏–ª–∫–∞ –¥–æ—Å—Ç—É–ø—É –¥–æ —á–∞—Ç—É:\n' + error.message);
      showToast('–ü–æ–º–∏–ª–∫–∞ –¥–æ—Å—Ç—É–ø—É –¥–æ —á–∞—Ç—É');
    });
    
    setTimeout(() => { updateFocusableCache(); setFocusOnElement(document.getElementById('chatText')); }, 200);
  }

  function formatMessageTime(timestamp) {
    if (!timestamp) return '';
    const date = timestamp.toDate ? timestamp.toDate() : new Date(timestamp.seconds * 1000);
    return date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
  }

  function formatMessageDate(timestamp) {
    if (!timestamp) return '';
    const date = timestamp.toDate ? timestamp.toDate() : new Date(timestamp.seconds * 1000);
    const today = new Date();
    const yesterday = new Date(today);
    yesterday.setDate(yesterday.getDate() - 1);
    
    if (date.toDateString() === today.toDateString()) return '–°—å–æ–≥–æ–¥–Ω—ñ';
    if (date.toDateString() === yesterday.toDateString()) return '–í—á–æ—Ä–∞';
    return date.toLocaleDateString();
  }

  async function subscribeToChat(chatId) {
    if (!currentUser) throw new Error('No current user');
    if (unsubscribeChat) unsubscribeChat();
    if (unsubscribeTyping) unsubscribeTyping();

    const messagesContainer = document.getElementById('chatMessages');
    if (!messagesContainer) {
      throw new Error('chatMessages container not found');
    }

    const otherUserSnap = await getDoc(doc(db, "users", currentChatPartner));
    const otherUser = otherUserSnap.data();

    const q = query(collection(db, `chats/${chatId}/messages`), orderBy("createdAt"));
    let lastDate = '';
    unsubscribeChat = onSnapshot(q, (snap) => {
      messagesContainer.innerHTML = '';
      snap.forEach(doc => {
        const msg = doc.data();
        const msgDate = formatMessageDate(msg.createdAt);
        if (msgDate !== lastDate) {
          lastDate = msgDate;
          const divider = document.createElement('div');
          divider.className = 'date-divider';
          divider.textContent = msgDate;
          messagesContainer.appendChild(divider);
        }

        const wrapper = document.createElement('div');
        wrapper.className = `message-wrapper ${msg.from === currentUser.uid ? 'sent' : 'received'}`;

        const bubble = document.createElement('div');
        bubble.className = `message-bubble ${msg.from === currentUser.uid ? 'sent' : 'received'}`;

        if (msg.from !== currentUser.uid) {
          const senderDiv = document.createElement('div');
          senderDiv.className = 'message-sender';
          senderDiv.innerHTML = `
            <div class="message-sender-avatar" style="background-image:url(${otherUser?.avatar || ''})"></div>
            <span>${currentChatPartnerName}</span>
          `;
          bubble.appendChild(senderDiv);
        }

        const textDiv = document.createElement('div');
        textDiv.textContent = msg.text;
        bubble.appendChild(textDiv);

        const timeDiv = document.createElement('div');
        timeDiv.className = 'message-time';
        timeDiv.textContent = formatMessageTime(msg.createdAt);
        bubble.appendChild(timeDiv);

        wrapper.appendChild(bubble);
        messagesContainer.appendChild(wrapper);
      });
      messagesContainer.scrollTop = messagesContainer.scrollHeight;
    }, (error) => {
      console.error('Error in messages snapshot:', error);
      alert('–ü–æ–º–∏–ª–∫–∞ –æ—Ç—Ä–∏–º–∞–Ω–Ω—è –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω—å:\n' + error.message);
      showToast('–ü–æ–º–∏–ª–∫–∞ –æ—Ç—Ä–∏–º–∞–Ω–Ω—è –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω—å');
    });
    
    if (currentChatPartner) {
      const typingRef = doc(db, `chats/${chatId}/typing/${currentChatPartner}`);
      unsubscribeTyping = onSnapshot(typingRef, (docSnap) => {
        const indicator = document.getElementById('typingIndicator');
        if (indicator) {
          if (docSnap.exists() && docSnap.data().isTyping) {
            indicator.style.display = 'flex';
          } else {
            indicator.style.display = 'none';
          }
        }
      }, (error) => {
        console.error('Typing indicator error:', error);
      });
    }
  }

  document.getElementById('chatText').addEventListener('input', () => {
    if (!currentUser || !currentChatPartner || !currentChatId) return;
    const typingRef = doc(db, `chats/${currentChatId}/typing/${currentUser.uid}`);
    setDoc(typingRef, { isTyping: true }, { merge: true }).catch(console.error);
    clearTimeout(window.typingTimeout);
    window.typingTimeout = setTimeout(() => setDoc(typingRef, { isTyping: false }, { merge: true }).catch(console.error), 2000);
  });

  document.getElementById('sendMessage').onclick = async () => {
    const text = document.getElementById('chatText').value.trim();
    if (!text || !currentUser || !currentChatPartner || !currentChatId) return;
    const chatRef = doc(db, "chats", currentChatId);
    const messageRef = collection(db, `chats/${currentChatId}/messages`);
    try {
      await addDoc(messageRef, { from: currentUser.uid, text, createdAt: serverTimestamp() });
      await updateDoc(chatRef, {
        lastMessage: text,
        updatedAt: serverTimestamp(),
        [`unread.${currentChatPartner}`]: increment(1)
      });
      document.getElementById('chatText').value = '';
      
      const typingRef = doc(db, `chats/${currentChatId}/typing/${currentUser.uid}`);
      await setDoc(typingRef, { isTyping: false }, { merge: true });
    } catch (error) {
      console.error('Send message error:', error);
      alert('–ü–æ–º–∏–ª–∫–∞ –≤—ñ–¥–ø—Ä–∞–≤–ª–µ–Ω–Ω—è –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è:\n' + error.message);
    }
  };

  document.getElementById('chatText').addEventListener('keypress', (e) => {
    if (e.key === 'Enter' && !e.shiftKey) {
      e.preventDefault();
      document.getElementById('sendMessage').click();
    }
  });

  let searchTimeout;
  document.getElementById('chatSearchInput').addEventListener('input', (e) => {
    clearTimeout(searchTimeout);
    const val = e.target.value.trim();
    if (!val) {
      document.getElementById('chatSearchResults').style.display = 'none';
      return;
    }
    searchTimeout = setTimeout(() => searchUsersForChat(val), 300);
  });

  async function searchUsersForChat(queryText) {
    if (!currentUser) return;
    const val = queryText.toLowerCase();
    const resultsContainer = document.getElementById('chatSearchResults');
    if (!resultsContainer) return;
    resultsContainer.innerHTML = '';
    
    const q1 = query(collection(db, "users"), where("userId", ">=", val.startsWith('@') ? val : `@${val}`), where("userId", "<=", (val.startsWith('@') ? val : `@${val}`) + '\uf8ff'));
    const q2 = query(collection(db, "users"), where("nickname_lower", ">=", val), where("nickname_lower", "<=", val + '\uf8ff'));
    
    const [snap1, snap2] = await Promise.all([getDocs(q1), getDocs(q2)]);
    const usersMap = new Map();
    snap1.forEach(d => usersMap.set(d.id, d.data()));
    snap2.forEach(d => usersMap.set(d.id, d.data()));
    
    if (usersMap.size === 0) {
      resultsContainer.style.display = 'none';
      return;
    }
    
    resultsContainer.style.display = 'block';
    usersMap.forEach((data, uid) => {
      if (uid === currentUser.uid) return;
      const div = document.createElement('div');
      div.className = 'chat-item';
      div.tabIndex = 0;
      div.innerHTML = `
        <div class="avatar small" style="background-image:url(${data.avatar || ''})" tabindex="0"></div>
        <div class="chat-info">
          <div class="chat-name">${data.nickname}</div>
          <div class="chat-last">${data.userId}</div>
        </div>
        <button class="btn" tabindex="0">–ù–∞–ø–∏—Å–∞—Ç–∏</button>
      `;
      div.onclick = () => {
        openChat(data.nickname, uid, data.userId);
        resultsContainer.style.display = 'none';
        document.getElementById('chatSearchInput').value = '';
      };
      const btn = div.querySelector('button');
      if (btn) {
        btn.onclick = (e) => {
          e.stopPropagation();
          openChat(data.nickname, uid, data.userId);
          resultsContainer.style.display = 'none';
          document.getElementById('chatSearchInput').value = '';
        };
      }
      resultsContainer.appendChild(div);
    });
    setTimeout(() => { updateFocusableCache(); }, 100);
  }

  document.getElementById('toggleTheme').onclick = () => {
    document.body.classList.toggle('dark');
    localStorage.setItem('theme', document.body.classList.contains('dark') ? 'dark' : 'light');
  };
  if (localStorage.getItem('theme') === 'dark') document.body.classList.add('dark');

  document.getElementById('privacyPolicyBtn').onclick = () => {
    document.getElementById('privacyPolicyModal').classList.add('active');
    setTimeout(() => { updateFocusableCache(); setFocusOnElement(document.getElementById('closePrivacyModal')); }, 50);
  };
  document.getElementById('closePrivacyModal').onclick = () => {
    document.getElementById('privacyPolicyModal').classList.remove('active');
    setTimeout(() => { updateFocusableCache(); setFocusOnElement(cachedFocusableElements[0]); }, 50);
  };

  function updateTvButtons() {
    const tvNavToggle = document.getElementById('tvNavToggle');
    if (tvNavToggle) tvNavToggle.textContent = `TV-–Ω–∞–≤—ñ–≥–∞—Ü—ñ—è: ${tvSettings.tvNavEnabled ? '—É–≤—ñ–º–∫–Ω–µ–Ω–æ' : '–≤–∏–º–∫–Ω–µ–Ω–æ'}`;
    const remoteNavToggle = document.getElementById('remoteNavToggle');
    if (remoteNavToggle) remoteNavToggle.textContent = `–ù–∞–≤—ñ–≥–∞—Ü—ñ—è –∑ –ø—É–ª—å—Ç–∞: ${tvSettings.remoteNavEnabled ? '—É–≤—ñ–º–∫–Ω–µ–Ω–æ' : '–≤–∏–º–∫–Ω–µ–Ω–æ'}`;
    const focusOptimizeToggle = document.getElementById('focusOptimizeToggle');
    if (focusOptimizeToggle) focusOptimizeToggle.textContent = `–û–ø—Ç–∏–º—ñ–∑–∞—Ü—ñ—è —Ñ–æ–∫—É—Å—É: ${tvSettings.focusOptimized ? '—É–≤—ñ–º–∫–Ω–µ–Ω–æ' : '–≤–∏–º–∫–Ω–µ–Ω–æ'}`;
    const tvCursorToggle = document.getElementById('tvCursorToggle');
    if (tvCursorToggle) tvCursorToggle.textContent = `TV-—Å—Ç—Ä—ñ–ª–æ—á–∫–∞: ${tvSettings.tvCursorEnabled ? '—É–≤—ñ–º–∫–Ω–µ–Ω–æ' : '–≤–∏–º–∫–Ω–µ–Ω–æ'}`;
  }
  document.getElementById('tvNavToggle').onclick = () => {
    tvSettings.tvNavEnabled = !tvSettings.tvNavEnabled;
    localStorage.setItem('tvNav', tvSettings.tvNavEnabled);
    updateTvButtons();
    if (!tvSettings.tvNavEnabled) {
      document.querySelectorAll('.focused').forEach(el => el.classList.remove('focused'));
      document.getElementById('tvCursor').style.display = 'none';
    } else {
      updateTVCursor();
    }
  };
  document.getElementById('remoteNavToggle').onclick = () => {
    tvSettings.remoteNavEnabled = !tvSettings.remoteNavEnabled;
    localStorage.setItem('remoteNav', tvSettings.remoteNavEnabled);
    updateTvButtons();
  };
  document.getElementById('focusOptimizeToggle').onclick = () => {
    tvSettings.focusOptimized = !tvSettings.focusOptimized;
    localStorage.setItem('focusOptimized', tvSettings.focusOptimized);
    updateTvButtons();
  };
  document.getElementById('tvCursorToggle').onclick = () => {
    tvSettings.tvCursorEnabled = !tvSettings.tvCursorEnabled;
    localStorage.setItem('tvCursor', tvSettings.tvCursorEnabled);
    updateTvButtons();
    updateTVCursor();
  };
  updateTvButtons();

  document.getElementById('logoutBtn').onclick = () => {
    cleanupListeners();
    signOut(auth);
  };

  const sentinel = document.getElementById('feedSentinel');
  if (sentinel) {
    const observer = new IntersectionObserver((entries) => {
      if (entries[0].isIntersecting) loadMorePosts();
    }, { threshold: 0.5 });
    observer.observe(sentinel);
  }

  document.addEventListener('click', async (e) => {
    if (!currentUser) return;
    const target = e.target.closest('button');
    if (!target) return;
    
    if (target.classList.contains('like-btn')) {
      const postId = target.dataset.postId;
      const liked = target.classList.contains('liked');
      const countSpan = target.querySelector('span');
      const oldCount = parseInt(countSpan.textContent);
      target.classList.toggle('liked');
      countSpan.textContent = liked ? oldCount - 1 : oldCount + 1;
      try {
        const postRef = doc(db, "posts", postId);
        if (liked) {
          await updateDoc(postRef, { likes: arrayRemove(currentUser.uid), likesCount: increment(-1) });
          await updateDoc(doc(db, "users", currentUser.uid), { likedPosts: arrayRemove(postId) });
        } else {
          await updateDoc(postRef, { likes: arrayUnion(currentUser.uid), likesCount: increment(1) });
          await updateDoc(doc(db, "users", currentUser.uid), { likedPosts: arrayUnion(postId) });
          vibrate(30);
        }
      } catch {
        target.classList.toggle('liked');
        countSpan.textContent = oldCount;
      }
    }
    
    if (target.classList.contains('save-btn')) {
      const postId = target.dataset.postId;
      const saved = target.classList.contains('saved');
      target.classList.toggle('saved');
      try {
        const userRef = doc(db, "users", currentUser.uid);
        const postRef = doc(db, "posts", postId);
        if (saved) {
          await updateDoc(userRef, { savedPosts: arrayRemove(postId) });
          await updateDoc(postRef, { saves: arrayRemove(currentUser.uid) });
        } else {
          await updateDoc(userRef, { savedPosts: arrayUnion(postId) });
          await updateDoc(postRef, { saves: arrayUnion(currentUser.uid) });
        }
      } catch { target.classList.toggle('saved'); }
    }
  });

  document.addEventListener('click', (e) => {
    const uidElement = e.target.closest('[data-uid]');
    if (uidElement) {
      const uid = uidElement.dataset.uid;
      viewProfile(uid);
    }
  });
</script>
</body>
</html>

<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>FANTASYAS ‚Äî —á–æ—Ä–Ω–æ-–±—ñ–ª–∏–π</title>
  <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@500;600;700;800&display=swap" rel="stylesheet"/>
  <style>
    /* –ß–æ—Ä–Ω–æ-–±—ñ–ª–∞ —Å—É—á–∞—Å–Ω–∞ —Ç–µ–º–∞ */
    :root {
      --bg: #000000;
      --text: #ffffff;
      --text-secondary: #aaaaaa;
      --card-bg: #1a1a1a;
      --card-border: #333333;
      --input-bg: #222222;
      --input-border: #444444;
      --btn-bg: #333333;
      --btn-hover: #444444;
      --accent: #888888;       /* –∞–∫—Ü–µ–Ω—Ç —Ç–µ–ø–µ—Ä —Å—ñ—Ä–∏–π */
    }

    body.light {
      --bg: #ffffff;
      --text: #111111;
      --text-secondary: #555555;
      --card-bg: #f5f5f5;
      --card-border: #dddddd;
      --input-bg: #ffffff;
      --input-border: #cccccc;
      --btn-bg: #e0e0e0;
      --btn-hover: #d0d0d0;
      --accent: #666666;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Manrope', sans-serif;
    }

    body {
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
      transition: background 0.3s, color 0.3s;
    }

    /* Top bar */
    .top-bar {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      height: 70px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 20px;
      background: rgba(0,0,0,0.8);
      backdrop-filter: blur(10px);
      z-index: 1000;
      border-bottom: 1px solid var(--card-border);
    }
    body.light .top-bar {
      background: rgba(255,255,255,0.9);
    }

    .site-name {
      font-size: 1.8rem;
      font-weight: 800;
      background: linear-gradient(90deg, #ffffff, #aaaaaa);
      -webkit-background-clip: text;
      background-clip: text;
      color: transparent;
      -webkit-text-fill-color: transparent;
    }
    body.light .site-name {
      background: linear-gradient(90deg, #111111, #555555);
      -webkit-background-clip: text;
      background-clip: text;
      color: transparent;
    }

    .burger {
      width: 32px;
      height: 24px;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
      cursor: pointer;
    }
    .burger span {
      height: 3px;
      width: 100%;
      background: var(--text);
      border-radius: 2px;
      transition: 0.35s;
    }
    .burger.active span:nth-child(1) { transform: rotate(45deg) translate(7px,7px); }
    .burger.active span:nth-child(2) { opacity: 0; }
    .burger.active span:nth-child(3) { transform: rotate(-45deg) translate(6px,-6px); }

    /* Sidebar */
    .sidebar {
      position: fixed;
      top: 0;
      left: -300px;
      width: 280px;
      height: 100%;
      background: rgba(0,0,0,0.6);
      backdrop-filter: blur(16px);
      padding: 90px 28px;
      border-right: 1px solid var(--card-border);
      transition: left 0.4s ease;
      z-index: 900;
    }
    body.light .sidebar {
      background: rgba(255,255,255,0.6);
    }
    .sidebar.active { left: 0; }
    .sidebar a {
      display: block;
      color: var(--text-secondary);
      text-decoration: none;
      font-size: 1.2rem;
      font-weight: 600;
      margin: 1.5rem 0;
      transition: 0.2s;
    }
    .sidebar a:hover {
      color: var(--text);
      transform: translateX(8px);
    }

    .main-content {
      margin-top: 90px;
      padding: 20px;
      max-width: 720px;
      margin-left: auto;
      margin-right: auto;
    }

    .section { display: none; opacity: 0; transform: translateY(12px); transition: 0.35s; }
    .section.active { display: block; opacity: 1; transform: translateY(0); }

    .card {
      background: var(--card-bg);
      border: 1px solid var(--card-border);
      border-radius: 20px;
      padding: 24px;
      margin-bottom: 20px;
      transition: 0.2s;
      box-shadow: 0 8px 24px rgba(0,0,0,0.3);
    }
    body.light .card { box-shadow: 0 4px 12px rgba(0,0,0,0.05); }

    input, textarea {
      width: 100%;
      padding: 14px 16px;
      border-radius: 14px;
      border: 1px solid var(--input-border);
      background: var(--input-bg);
      color: var(--text);
      font-size: 1rem;
      outline: none;
      transition: border 0.2s;
    }
    input:focus, textarea:focus { border-color: var(--accent); }
    ::placeholder { color: var(--text-secondary); opacity: 0.6; }

    button {
      padding: 12px 24px;
      border: none;
      border-radius: 14px;
      background: var(--btn-bg);
      color: var(--text);
      font-weight: 700;
      cursor: pointer;
      transition: 0.2s;
      border: 1px solid var(--card-border);
    }
    button:hover {
      background: var(--btn-hover);
      transform: scale(1.02);
    }
    button:active { transform: scale(0.98); }

    .feed { display: flex; flex-direction: column; gap: 20px; }

    .post {
      background: var(--card-bg);
      border: 1px solid var(--card-border);
      border-radius: 20px;
      padding: 20px;
      opacity: 0;
      transform: translateY(24px);
      transition: opacity 0.5s, transform 0.5s;
    }
    .post.show { opacity: 1; transform: translateY(0); }

    .post-header {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 16px;
      position: relative;
    }
    .avatar {
      width: 48px;
      height: 48px;
      border-radius: 50%;
      background: #444;
      background-size: cover;
      background-position: center;
      border: 1px solid var(--card-border);
    }
    .username { font-weight: 700; font-size: 1.1rem; }

    .menu-btn {
      background: none;
      border: none;
      font-size: 1.8rem;
      line-height: 1;
      padding: 0 8px;
      margin-left: auto;
      color: var(--text-secondary);
      cursor: pointer;
    }
    .menu-btn:hover { color: var(--text); transform: scale(1.2); background: none; border: none; }

    .post-content {
      line-height: 1.6;
      word-break: break-word;
      margin-bottom: 12px;
    }
    .post-media {
      width: 100%;
      border-radius: 16px;
      margin: 12px 0;
    }

    .post-footer {
      display: flex;
      gap: 24px;
      margin: 16px 0 8px;
    }
    .post-footer button {
      background: none;
      border: none;
      color: var(--text-secondary);
      font-size: 1rem;
      padding: 0;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .post-footer button:hover { color: var(--text); transform: scale(1.1); background: none; }

    .comments-section {
      margin-top: 20px;
      border-top: 1px solid var(--card-border);
      padding-top: 16px;
    }
    .comment {
      display: flex;
      gap: 10px;
      margin-bottom: 14px;
      font-size: 0.95rem;
    }
    .comment .avatar { width: 32px; height: 32px; }
    .comment-content {
      background: var(--input-bg);
      padding: 10px 14px;
      border-radius: 18px;
      flex: 1;
    }
    .comment-author { font-weight: 700; margin-right: 8px; }
    .comment-text { word-break: break-word; }
    .comment-input-area {
      display: flex;
      gap: 8px;
      align-items: flex-end;
    }
    .comment-input-area textarea {
      flex: 1;
      min-height: 40px;
      padding: 10px;
      border-radius: 20px;
      resize: vertical;
    }

    .emoji-picker {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      background: var(--card-bg);
      border: 1px solid var(--card-border);
      border-radius: 30px;
      padding: 10px;
      margin: 8px 0;
      max-width: 300px;
    }
    .emoji-picker span {
      font-size: 1.8rem;
      cursor: pointer;
      transition: 0.2s;
    }
    .emoji-picker span:hover { transform: scale(1.3); }

    /* Modal */
    .modal {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.8);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 2000;
    }
    .modal.active { display: flex; }
    .modal-content {
      background: var(--card-bg);
      border: 1px solid var(--card-border);
      color: var(--text);
      width: 92%;
      max-width: 520px;
      border-radius: 28px;
      padding: 30px;
      position: relative;
    }
    .close-modal {
      position: absolute;
      top: 16px;
      right: 20px;
      font-size: 2.5rem;
      cursor: pointer;
      color: var(--text-secondary);
    }

    .profile-header {
      display: flex;
      flex-wrap: wrap;
      gap: 24px;
      align-items: flex-start;
    }
    .profile-avatar {
      width: 110px;
      height: 110px;
      border-radius: 50%;
      background: #333;
      background-size: cover;
      border: 2px solid var(--card-border);
      cursor: pointer;
    }

    .search-input { margin-bottom: 20px; }
    .user-list, .chat-list {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    .user-item, .chat-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 10px;
      border-radius: 16px;
      background: var(--card-bg);
      border: 1px solid var(--card-border);
      cursor: pointer;
    }
    .user-item:hover, .chat-item:hover { background: var(--input-bg); }
    .follow-btn {
      margin-left: auto;
      padding: 6px 14px;
      font-size: 0.9rem;
      background: var(--accent);
      color: white;
      border-radius: 30px;
      border: none;
    }

    .chat-window {
      display: none;
      flex-direction: column;
      height: 500px;
      border: 1px solid var(--card-border);
      border-radius: 24px;
      overflow: hidden;
      margin-top: 20px;
    }
    .chat-header { padding: 16px; border-bottom: 1px solid var(--card-border); }
    .chat-messages {
      flex: 1;
      padding: 16px;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    .message {
      padding: 10px 16px;
      border-radius: 20px;
      max-width: 80%;
    }
    .message.sent { background: var(--accent); color: white; align-self: flex-end; }
    .message.received { background: var(--input-bg); align-self: flex-start; }
    .chat-input { display: flex; padding: 16px; border-top: 1px solid var(--card-border); }
    .chat-input input { flex: 1; margin-right: 12px; }

    @media (max-width: 900px) {
      .sidebar { width: 100%; left: -100%; }
    }
  </style>
</head>
<body>

<div class="top-bar">
  <div class="burger" id="burger"><span></span><span></span><span></span></div>
  <div class="site-name">FANTASYAS</div>
</div>

<nav class="sidebar" id="sidebar">
  <a data-section="home">–ì–æ–ª–æ–≤–Ω–∞</a>
  <a data-section="search">–ü–æ—à—É–∫</a>
  <a data-section="profile">–ü—Ä–æ—Ñ—ñ–ª—å</a>
  <a data-section="chats">–ß–∞—Ç–∏</a>
  <a data-section="settings">–ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è</a>
</nav>

<main class="main-content">

  <!-- –ì–û–õ–û–í–ù–ê -->
  <div id="home" class="section active">
    <div class="card" id="authBox">
      <div id="loginForm">
        <input type="text" id="loginNickname" placeholder="–ü—Å–µ–≤–¥–æ–Ω—ñ–º" autocomplete="off"/>
        <input type="password" id="loginPassword" placeholder="–ü–∞—Ä–æ–ª—å"/>
        <button id="loginBtn">–£–≤—ñ–π—Ç–∏</button>
        <button id="googleLoginBtn" style="background:#444; color:white; margin-top:12px;">–£–≤—ñ–π—Ç–∏ —á–µ—Ä–µ–∑ Google</button>
        <button id="appleLoginBtn" style="background:#222; color:white; margin-top:12px;">–£–≤—ñ–π—Ç–∏ —á–µ—Ä–µ–∑ Apple</button>
        <p style="margin-top:16px;">–ù–µ–º–∞—î –∞–∫–∞—É–Ω—Ç–∞? <span id="toRegister" style="color:var(--accent);cursor:pointer;">–ó–∞—Ä–µ—î—Å—Ç—Ä—É–≤–∞—Ç–∏—Å—è</span></p>
      </div>
      <div id="registerForm" style="display:none;">
        <input type="text" id="registerNickname" placeholder="–ü—Å–µ–≤–¥–æ–Ω—ñ–º"/>
        <input type="password" id="registerPassword" placeholder="–ü–∞—Ä–æ–ª—å"/>
        <button id="registerBtn">–ó–∞—Ä–µ—î—Å—Ç—Ä—É–≤–∞—Ç–∏—Å—è</button>
        <p>–í–∂–µ —î –∞–∫–∞—É–Ω—Ç? <span id="toLogin" style="color:var(--accent);cursor:pointer;">–£–≤—ñ–π—Ç–∏</span></p>
      </div>
    </div>

    <div class="card" id="newPostBox" style="display:none;">
      <textarea id="postText" placeholder="–©–æ —É —Ç–µ–±–µ –Ω–∞ –¥—É–º—Ü—ñ?..."></textarea>
      <!-- –ï–º–æ–¥–∑—ñ –¥–ª—è –ø–æ—Å—Ç–∞ -->
      <div style="display:flex; gap:8px; align-items:center; margin:8px 0;">
        <button id="emojiPostBtn" style="padding:8px 12px;">üòÄ –î–æ–¥–∞—Ç–∏ –µ–º–æ–¥–∑—ñ</button>
        <div id="emojiPostPicker" class="emoji-picker" style="display:none;">
          <span>üòä</span><span>üòÇ</span><span>‚ù§Ô∏è</span><span>üî•</span><span>üëç</span><span>üéâ</span><span>üò¢</span><span>üòé</span><span>ü§î</span><span>üëè</span>
        </div>
      </div>
      <input type="file" id="postMedia" accept="image/*,video/*" style="margin:12px 0;"/>
      <button id="addPost">–û–ø—É–±–ª—ñ–∫—É–≤–∞—Ç–∏</button>
    </div>

    <div class="feed" id="feed"></div>
  </div>

  <!-- –ü–û–®–£–ö -->
  <div id="search" class="section">
    <input type="text" id="searchInput" class="search-input" placeholder="–ü–æ—à—É–∫ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ–≤..."/>
    <div class="user-list" id="userList"></div>
  </div>

  <!-- –ü–†–û–§–Ü–õ–¨ -->
  <div id="profile" class="section">
    <div class="card profile-header">
      <div class="profile-avatar" id="profileAvatar"></div>
      <input type="file" id="avatarInput" accept="image/*" style="display:none;"/>
      <div style="flex:1;">
        <h2 id="profileUsernameDisplay"></h2>
        <p id="profileBio" style="margin:8px 0;color:var(--text-secondary);">–ù–µ–º–∞—î –æ–ø–∏—Å—É</p>
        <p id="profileStatus" style="color:var(--accent);">–û–Ω–ª–∞–π–Ω</p>
        <div style="display:flex;gap:20px;font-weight:600;">
          <span id="postsCount">–ü–æ—Å—Ç–∏: 0</span>
          <span id="followersCount">–ü—ñ–¥–ø–∏—Å–Ω–∏–∫–∏: 0</span>
          <span id="followingCount">–ü—ñ–¥–ø–∏—Å–∫–∏: 0</span>
        </div>
      </div>
      <button id="editProfileBtn">–†–µ–¥–∞–≥—É–≤–∞—Ç–∏</button>
    </div>
  </div>

  <!-- –ß–ê–¢–ò -->
  <div id="chats" class="section">
    <div class="chat-list" id="chatList"></div>
    <div class="chat-window" id="chatWindow">
      <div class="chat-header" id="chatHeader"></div>
      <div class="chat-messages" id="chatMessages"></div>
      <div class="chat-input">
        <input type="text" id="chatText" placeholder="–ü–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è..."/>
        <button id="sendMessage">‚û§</button>
      </div>
    </div>
  </div>

  <!-- –ù–ê–õ–ê–®–¢–£–í–ê–ù–ù–Ø -->
  <div id="settings" class="section card">
    <h2>–ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è</h2>
    <button id="toggleTheme" style="margin:16px 0;">–ü–µ—Ä–µ–º–∫–Ω—É—Ç–∏ —Ç–µ–º—É</button>
    <button id="logoutBtn">–í–∏–π—Ç–∏</button>
  </div>

</main>

<!-- –ú–û–î–ê–õ–ö–ê –†–ï–î–ê–ì–£–í–ê–ù–ù–Ø –ü–†–û–§–Ü–õ–Æ -->
<div class="modal" id="editProfileModal">
  <div class="modal-content">
    <span class="close-modal" id="closeModal">√ó</span>
    <h2>–†–µ–¥–∞–≥—É–≤–∞—Ç–∏ –ø—Ä–æ—Ñ—ñ–ª—å</h2>
    <input type="text" id="editNickname" placeholder="–ü—Å–µ–≤–¥–æ–Ω—ñ–º"/>
    <textarea id="editBio" placeholder="–û–ø–∏—Å..." rows="4"></textarea>
    <button id="saveProfileEdit" style="margin-top:16px;">–ó–±–µ—Ä–µ–≥—Ç–∏</button>
  </div>
</div>

<!-- –ú–û–î–ê–õ–ö–ê –†–ï–î–ê–ì–£–í–ê–ù–ù–Ø –ü–û–°–¢–ê -->
<div class="modal" id="editPostModal">
  <div class="modal-content">
    <span class="close-modal" id="closeEditPostModal">√ó</span>
    <h2>–†–µ–¥–∞–≥—É–≤–∞—Ç–∏ –ø–æ—Å—Ç</h2>
    <textarea id="editPostText" placeholder="–¢–µ–∫—Å—Ç..." rows="4"></textarea>
    <button id="savePostEdit">–ó–±–µ—Ä–µ–≥—Ç–∏ –∑–º—ñ–Ω–∏</button>
  </div>
</div>

<script type="module">
  // –Ü–º–ø–æ—Ä—Ç–∏ Firebase
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js";
  import {
    getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword,
    onAuthStateChanged, signOut, GoogleAuthProvider, OAuthProvider, signInWithPopup
  } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-auth.js";
  import {
    getFirestore, doc, setDoc, getDoc, updateDoc, collection, addDoc,
    query, where, onSnapshot, orderBy, serverTimestamp, arrayUnion, arrayRemove,
    deleteDoc, getDocs, writeBatch
  } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore.js";
  import {
    getStorage, ref, uploadBytes, getDownloadURL
  } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-storage.js";

  const firebaseConfig = {
    apiKey: "AIzaSyDRzC-QDE0-UXd-XL0i3iqayFiKcc6wmvc",
    authDomain: "fantasyasapp.firebaseapp.com",
    projectId: "fantasyasapp",
    storageBucket: "fantasyasapp.firebasestorage.app",
    messagingSenderId: "721763921060",
    appId: "1:721763921060:web:3d61044ea2424e8176ca31"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);
  const storage = getStorage(app);

  let currentUser = null;
  let currentChatPartner = null;
  let unsubscribeFeed = null;
  let unsubscribeChat = null;
  let currentEditPostId = null;

  // --- helpers ---
  function getChatId(uid1, uid2) { return [uid1, uid2].sort().join('_'); }

  // --- burger menu ---
  document.getElementById('burger').onclick = () => {
    document.getElementById('burger').classList.toggle('active');
    document.getElementById('sidebar').classList.toggle('active');
  };
  document.querySelectorAll('[data-section]').forEach(link => {
    link.onclick = () => {
      document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
      document.getElementById(link.dataset.section).classList.add('active');
      document.getElementById('sidebar').classList.remove('active');
      document.getElementById('burger').classList.remove('active');
      if (link.dataset.section === 'search') loadSearchUsers();
      if (link.dataset.section === 'chats') loadChatList();
      if (link.dataset.section === 'profile') loadProfile();
    };
  });

  // --- –ø–µ—Ä–µ–º–∏–∫–∞–Ω–Ω—è –ª–æ–≥—ñ–Ω/—Ä–µ—î—Å—Ç—Ä–∞—Ü—ñ—è ---
  document.getElementById('toRegister').onclick = () => {
    document.getElementById('loginForm').style.display = 'none';
    document.getElementById('registerForm').style.display = 'block';
  };
  document.getElementById('toLogin').onclick = () => {
    document.getElementById('registerForm').style.display = 'none';
    document.getElementById('loginForm').style.display = 'block';
  };

  // --- —Ä–µ—î—Å—Ç—Ä–∞—Ü—ñ—è (–∑ nickname_lower) ---
  document.getElementById('registerBtn').onclick = async () => {
    const nickname = document.getElementById('registerNickname').value.trim();
    const password = document.getElementById('registerPassword').value.trim();
    if (!nickname) return alert('–í–≤–µ–¥—ñ—Ç—å –ø—Å–µ–≤–¥–æ–Ω—ñ–º');
    if (password.length < 6) return alert('–ü–∞—Ä–æ–ª—å –º—ñ–Ω—ñ–º—É–º 6 —Å–∏–º–≤–æ–ª—ñ–≤');
    try {
      const safeNick = nickname.toLowerCase().replace(/[^a-z0-9]/g, '');
      const email = `${safeNick}@fantasyas.local`;
      const cred = await createUserWithEmailAndPassword(auth, email, password);
      const uid = cred.user.uid;
      await setDoc(doc(db, "users", uid), {
        nickname,
        nickname_lower: nickname.toLowerCase(),
        bio: "",
        avatar: "",
        posts: [],
        followers: [],
        following: [],
        createdAt: serverTimestamp()
      });
      alert('–†–µ—î—Å—Ç—Ä–∞—Ü—ñ—è —É—Å–ø—ñ—à–Ω–∞! –£–≤—ñ–π–¥—ñ—Ç—å.');
      document.getElementById('toLogin').click();
      document.getElementById('loginNickname').value = nickname;
    } catch (e) {
      alert(e.message);
    }
  };

  // --- –≤—Ö—ñ–¥ ---
  document.getElementById('loginBtn').onclick = async () => {
    const nickname = document.getElementById('loginNickname').value.trim();
    const password = document.getElementById('loginPassword').value.trim();
    if (!nickname || !password) return alert('–ó–∞–ø–æ–≤–Ω—ñ—Ç—å –ø–æ–ª—è');
    try {
      const safeNick = nickname.toLowerCase().replace(/[^a-z0-9]/g, '');
      const email = `${safeNick}@fantasyas.local`;
      await signInWithEmailAndPassword(auth, email, password);
    } catch { alert('–ù–µ–≤—ñ—Ä–Ω–∏–π –ø—Å–µ–≤–¥–æ–Ω—ñ–º –∞–±–æ –ø–∞—Ä–æ–ª—å'); }
  };

  // --- Google ---
  document.getElementById('googleLoginBtn').onclick = async () => {
    try {
      const provider = new GoogleAuthProvider();
      const result = await signInWithPopup(auth, provider);
      const user = result.user;
      const userDoc = await getDoc(doc(db, "users", user.uid));
      if (!userDoc.exists()) {
        await setDoc(doc(db, "users", user.uid), {
          nickname: user.displayName || user.email.split('@')[0],
          nickname_lower: (user.displayName || user.email.split('@')[0]).toLowerCase(),
          bio: "",
          avatar: user.photoURL || "",
          posts: [],
          followers: [],
          following: [],
          createdAt: serverTimestamp()
        });
      }
    } catch (e) { alert('–ü–æ–º–∏–ª–∫–∞ Google: ' + e.message); }
  };

  // --- Apple ---
  document.getElementById('appleLoginBtn').onclick = async () => {
    try {
      const provider = new OAuthProvider('apple.com');
      provider.addScope('email name');
      const result = await signInWithPopup(auth, provider);
      const user = result.user;
      const userDoc = await getDoc(doc(db, "users", user.uid));
      if (!userDoc.exists()) {
        await setDoc(doc(db, "users", user.uid), {
          nickname: user.displayName || user.email.split('@')[0],
          nickname_lower: (user.displayName || user.email.split('@')[0]).toLowerCase(),
          bio: "",
          avatar: user.photoURL || "",
          posts: [],
          followers: [],
          following: [],
          createdAt: serverTimestamp()
        });
      }
    } catch (e) { alert('–ü–æ–º–∏–ª–∫–∞ Apple: ' + e.message); }
  };

  // --- —Å–ª—É—Ö–∞—á –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü—ñ—ó ---
  onAuthStateChanged(auth, async (user) => {
    if (user) {
      currentUser = user;
      document.getElementById('authBox').style.display = 'none';
      document.getElementById('newPostBox').style.display = 'block';
      subscribeToFeed();
      loadProfile();
    } else {
      currentUser = null;
      document.getElementById('authBox').style.display = 'block';
      document.getElementById('newPostBox').style.display = 'none';
      if (unsubscribeFeed) unsubscribeFeed();
    }
  });

  // --- –ï–º–æ–¥–∑—ñ –¥–ª—è –ø–æ—Å—Ç–∞ ---
  const emojiPostBtn = document.getElementById('emojiPostBtn');
  const emojiPostPicker = document.getElementById('emojiPostPicker');
  emojiPostBtn.onclick = () => {
    emojiPostPicker.style.display = emojiPostPicker.style.display === 'none' ? 'flex' : 'none';
  };
  emojiPostPicker.querySelectorAll('span').forEach(span => {
    span.onclick = () => {
      const textarea = document.getElementById('postText');
      textarea.value += span.textContent;
      emojiPostPicker.style.display = 'none';
    };
  });

  // --- –ø—É–±–ª—ñ–∫–∞—Ü—ñ—è –ø–æ—Å—Ç–∞ ---
  document.getElementById('addPost').onclick = async () => {
    if (!currentUser) return alert('–£–≤—ñ–π–¥—ñ—Ç—å');
    const text = document.getElementById('postText').value.trim();
    const file = document.getElementById('postMedia').files[0];
    if (!text && !file) return alert('–î–æ–¥–∞–π—Ç–µ —Ç–µ–∫—Å—Ç –∞–±–æ –º–µ–¥—ñ–∞');
    try {
      let mediaUrl = '', mediaType = '';
      if (file) {
        const storageRef = ref(storage, `posts/${currentUser.uid}/${Date.now()}_${file.name}`);
        await uploadBytes(storageRef, file);
        mediaUrl = await getDownloadURL(storageRef);
        mediaType = file.type.split('/')[0];
      }
      await addDoc(collection(db, "posts"), {
        author: currentUser.uid,
        text,
        mediaUrl,
        mediaType,
        createdAt: serverTimestamp(),
        likes: [],
        commentsCount: 0
      });
      document.getElementById('postText').value = '';
      document.getElementById('postMedia').value = '';
      alert('–ü–æ—Å—Ç –æ–ø—É–±–ª—ñ–∫–æ–≤–∞–Ω–æ');
    } catch (e) { alert('–ü–æ–º–∏–ª–∫–∞: ' + e.message); }
  };

  // --- —Å—Ç—Ä—ñ—á–∫–∞ –ø–æ—Å—Ç—ñ–≤ –∑ –∫–æ–º–µ–Ω—Ç–∞—Ä—è–º–∏ ---
  function subscribeToFeed() {
    if (unsubscribeFeed) unsubscribeFeed();
    const q = query(collection(db, "posts"), orderBy("createdAt", "desc"));
    unsubscribeFeed = onSnapshot(q, async (snapshot) => {
      const feed = document.getElementById('feed');
      feed.innerHTML = '';
      let delay = 0;
      for (const docSnap of snapshot.docs) {
        const post = docSnap.data();
        const postId = docSnap.id;
        const authorSnap = await getDoc(doc(db, "users", post.author));
        const author = authorSnap.exists() ? authorSnap.data() : { nickname: '–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á', avatar: '' };
        const isOwn = post.author === currentUser?.uid;
        const liked = post.likes?.includes(currentUser?.uid) || false;

        // –ó–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ –∫–æ–º–µ–Ω—Ç–∞—Ä—ñ (–æ—Å—Ç–∞–Ω–Ω—ñ 5)
        const commentsQuery = query(collection(db, "posts", postId, "comments"), orderBy("createdAt", "desc"));
        const commentsSnap = await getDocs(commentsQuery);
        const comments = [];
        commentsSnap.forEach(c => comments.push({ id: c.id, ...c.data() }));

        const postEl = document.createElement('div');
        postEl.className = 'post';
        postEl.innerHTML = `
          <div class="post-header">
            <div class="avatar" style="background-image:url(${author.avatar || ''})"></div>
            <div class="username">@${author.nickname}</div>
            ${isOwn ? `<button class="menu-btn" data-post-id="${postId}">‚ãØ</button>` : ''}
          </div>
          <div class="post-content">${post.text ? post.text.replace(/\n/g, '<br>') : ''}</div>
          ${post.mediaUrl ? (post.mediaType === 'image' ? `<img src="${post.mediaUrl}" class="post-media">` : `<video src="${post.mediaUrl}" controls class="post-media"></video>`) : ''}
          <div class="post-footer">
            <button class="like-btn ${liked ? 'liked' : ''}" data-post-id="${postId}">‚ù§Ô∏è ${post.likes?.length || 0}</button>
            <button class="comments-toggle" data-post-id="${postId}">üí¨ ${post.commentsCount || 0}</button>
            <button>üîó</button>
          </div>
          <div class="comments-section" id="comments-${postId}" style="display:none;">
            <div class="comments-list" id="comments-list-${postId}"></div>
            <div class="comment-input-area">
              <textarea id="comment-text-${postId}" placeholder="–ù–∞–ø–∏—à—ñ—Ç—å –∫–æ–º–µ–Ω—Ç–∞—Ä..."></textarea>
              <button class="send-comment" data-post-id="${postId}">‚û§</button>
            </div>
            <div style="display:flex; gap:8px; margin-top:8px;">
              <button class="emoji-comment-btn" data-post-id="${postId}">üòÄ</button>
              <div class="emoji-picker" id="emoji-comment-${postId}" style="display:none;">
                <span>üòä</span><span>üòÇ</span><span>‚ù§Ô∏è</span><span>üî•</span><span>üëç</span><span>üéâ</span>
              </div>
            </div>
          </div>
        `;

        // –î–æ–¥–∞—Ç–∏ –∫–æ–º–µ–Ω—Ç–∞—Ä—ñ –≤ —Å–ø–∏—Å–æ–∫
        const commentsList = comments.reverse().map(c => `
          <div class="comment">
            <div class="avatar" style="background-image:url(${c.authorAvatar || ''})"></div>
            <div class="comment-content">
              <span class="comment-author">@${c.authorNickname || '–Ω–µ–≤—ñ–¥–æ–º–∏–π'}</span>
              <span class="comment-text">${c.text}</span>
            </div>
          </div>
        `).join('');
        setTimeout(() => {
          const listDiv = postEl.querySelector(`#comments-list-${postId}`);
          if (listDiv) listDiv.innerHTML = commentsList;
        }, 100);

        feed.appendChild(postEl);
        setTimeout(() => postEl.classList.add('show'), delay);
        delay += 80;
      }
    });
  }

  // --- –¥–µ–ª–µ–≥—É–≤–∞–Ω–Ω—è –ø–æ–¥—ñ–π –¥–ª—è –ª–∞–π–∫—ñ–≤, –∫–æ–º–µ–Ω—Ç–∞—Ä—ñ–≤, –º–µ–Ω—é ---
  document.getElementById('feed').addEventListener('click', async (e) => {
    if (e.target.closest('.like-btn')) {
      const btn = e.target.closest('.like-btn');
      const postId = btn.dataset.postId;
      const postRef = doc(db, "posts", postId);
      const snap = await getDoc(postRef);
      const likes = snap.data().likes || [];
      if (likes.includes(currentUser.uid)) {
        await updateDoc(postRef, { likes: arrayRemove(currentUser.uid) });
      } else {
        await updateDoc(postRef, { likes: arrayUnion(currentUser.uid) });
      }
    }

    if (e.target.closest('.menu-btn')) {
      const postId = e.target.closest('.menu-btn').dataset.postId;
      const action = prompt('–í–∏–±–µ—Ä—ñ—Ç—å: 1 - —Ä–µ–¥–∞–≥—É–≤–∞—Ç–∏, 2 - –≤–∏–¥–∞–ª–∏—Ç–∏');
      if (action === '1') {
        const postRef = doc(db, "posts", postId);
        const postSnap = await getDoc(postRef);
        document.getElementById('editPostText').value = postSnap.data().text || '';
        currentEditPostId = postId;
        document.getElementById('editPostModal').classList.add('active');
      } else if (action === '2') {
        if (confirm('–í–∏–¥–∞–ª–∏—Ç–∏ –ø–æ—Å—Ç?')) {
          await deleteDoc(doc(db, "posts", postId));
          // —Ç–∞–∫–æ–∂ –≤–∏–¥–∞–ª–∏—Ç–∏ –∫–æ–º–µ–Ω—Ç–∞—Ä—ñ (–º–æ–∂–Ω–∞ –≤ —Ñ–æ–Ω—ñ)
        }
      }
    }

    if (e.target.closest('.comments-toggle')) {
      const postId = e.target.closest('.comments-toggle').dataset.postId;
      const section = document.getElementById(`comments-${postId}`);
      section.style.display = section.style.display === 'none' ? 'block' : 'none';
    }

    if (e.target.closest('.send-comment')) {
      const btn = e.target.closest('.send-comment');
      const postId = btn.dataset.postId;
      const textarea = document.getElementById(`comment-text-${postId}`);
      const text = textarea.value.trim();
      if (!text) return;
      const userDoc = await getDoc(doc(db, "users", currentUser.uid));
      const userData = userDoc.data();
      await addDoc(collection(db, "posts", postId, "comments"), {
        author: currentUser.uid,
        authorNickname: userData.nickname,
        authorAvatar: userData.avatar || '',
        text,
        createdAt: serverTimestamp()
      });
      // –∑–±—ñ–ª—å—à–∏—Ç–∏ –ª—ñ—á–∏–ª—å–Ω–∏–∫ –∫–æ–º–µ–Ω—Ç–∞—Ä—ñ–≤
      const postRef = doc(db, "posts", postId);
      await updateDoc(postRef, { commentsCount: arrayUnion('dummy') }); // –¥–ª—è —Ç—Ä–∏–≥–µ—Ä–∞
      textarea.value = '';
    }

    if (e.target.closest('.emoji-comment-btn')) {
      const btn = e.target.closest('.emoji-comment-btn');
      const postId = btn.dataset.postId;
      const picker = document.getElementById(`emoji-comment-${postId}`);
      picker.style.display = picker.style.display === 'none' ? 'flex' : 'none';
    }
  });

  // --- –µ–º–æ–¥–∑—ñ –¥–ª—è –∫–æ–º–µ–Ω—Ç–∞—Ä—ñ–≤ (–¥–∏–Ω–∞–º—ñ—á–Ω–æ) ---
  document.getElementById('feed').addEventListener('click', (e) => {
    if (e.target.closest('.emoji-picker span')) {
      const span = e.target.closest('.emoji-picker span');
      const picker = span.closest('.emoji-picker');
      const postId = picker.id.replace('emoji-comment-', '');
      const textarea = document.getElementById(`comment-text-${postId}`);
      textarea.value += span.textContent;
      picker.style.display = 'none';
    }
  });

  // --- —Ä–µ–¥–∞–≥—É–≤–∞–Ω–Ω—è –ø–æ—Å—Ç–∞ (–∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è) ---
  document.getElementById('savePostEdit').onclick = async () => {
    if (!currentEditPostId) return;
    const newText = document.getElementById('editPostText').value.trim();
    await updateDoc(doc(db, "posts", currentEditPostId), { text: newText });
    document.getElementById('editPostModal').classList.remove('active');
    currentEditPostId = null;
  };
  document.getElementById('closeEditPostModal').onclick = () => {
    document.getElementById('editPostModal').classList.remove('active');
    currentEditPostId = null;
  };

  // --- –ø–æ—à—É–∫ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ–≤ (–Ω—ñ–∫–Ω–µ–π–º lower) ---
  async function loadSearchUsers() {
    const input = document.getElementById('searchInput');
    const userList = document.getElementById('userList');
    const val = input.value.trim().toLowerCase();
    if (!val) { userList.innerHTML = ''; return; }

    const myRef = doc(db, "users", currentUser.uid);
    const mySnap = await getDoc(myRef);
    const myFollowing = mySnap.data().following || [];

    const q = query(collection(db, "users"), where("nickname_lower", ">=", val), where("nickname_lower", "<=", val + '\uf8ff'));
    const snap = await getDocs(q);
    userList.innerHTML = '';
    snap.forEach(docSnap => {
      if (docSnap.id === currentUser.uid) return;
      const data = docSnap.data();
      const isFollowing = myFollowing.includes(docSnap.id);
      const item = document.createElement('div');
      item.className = 'user-item';
      item.innerHTML = `
        <div class="avatar" style="background-image:url(${data.avatar || ''})"></div>
        <div class="name">@${data.nickname}</div>
        <button class="follow-btn">${isFollowing ? '–í—ñ–¥–ø–∏—Å–∞—Ç–∏—Å—è' : '–ü—ñ–¥–ø–∏—Å–∞—Ç–∏—Å—è'}</button>
      `;
      item.querySelector('.follow-btn').onclick = async (e) => {
        e.stopPropagation();
        await toggleFollow(docSnap.id);
        loadSearchUsers();
      };
      item.onclick = () => openChat(data.nickname, docSnap.id);
      userList.appendChild(item);
    });
  }

  document.getElementById('searchInput').addEventListener('input', () => {
    setTimeout(loadSearchUsers, 300);
  });

  async function toggleFollow(targetUid) {
    const myRef = doc(db, "users", currentUser.uid);
    const targetRef = doc(db, "users", targetUid);
    const mySnap = await getDoc(myRef);
    const following = mySnap.data().following || [];
    if (following.includes(targetUid)) {
      await updateDoc(myRef, { following: arrayRemove(targetUid) });
      await updateDoc(targetRef, { followers: arrayRemove(currentUser.uid) });
    } else {
      await updateDoc(myRef, { following: arrayUnion(targetUid) });
      await updateDoc(targetRef, { followers: arrayUnion(currentUser.uid) });
    }
  }

  // --- –ø—Ä–æ—Ñ—ñ–ª—å + –∞–≤–∞—Ç–∞—Ä ---
  document.getElementById('profileAvatar').onclick = () => {
    if (!currentUser) return alert('–£–≤—ñ–π–¥—ñ—Ç—å');
    document.getElementById('avatarInput').click();
  };
  document.getElementById('avatarInput').onchange = async (e) => {
    const file = e.target.files[0];
    if (!file) return;
    try {
      const storageRef = ref(storage, `avatars/${currentUser.uid}`);
      await uploadBytes(storageRef, file);
      const url = await getDownloadURL(storageRef);
      await updateDoc(doc(db, "users", currentUser.uid), { avatar: url });
      document.getElementById('profileAvatar').style.backgroundImage = `url(${url})`;
    } catch { alert('–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è'); }
  };

  async function loadProfile() {
    if (!currentUser) return;
    const snap = await getDoc(doc(db, "users", currentUser.uid));
    if (snap.exists()) {
      const data = snap.data();
      document.getElementById('profileUsernameDisplay').textContent = data.nickname;
      document.getElementById('profileBio').textContent = data.bio || '–ù–µ–º–∞—î –æ–ø–∏—Å—É';
      document.getElementById('profileAvatar').style.backgroundImage = `url(${data.avatar || ''})`;
      document.getElementById('postsCount').textContent = `–ü–æ—Å—Ç–∏: ${data.posts?.length || 0}`;
      document.getElementById('followersCount').textContent = `–ü—ñ–¥–ø–∏—Å–Ω–∏–∫–∏: ${data.followers?.length || 0}`;
      document.getElementById('followingCount').textContent = `–ü—ñ–¥–ø–∏—Å–∫–∏: ${data.following?.length || 0}`;
    }
  }

  // --- —Ä–µ–¥–∞–≥—É–≤–∞–Ω–Ω—è –ø—Ä–æ—Ñ—ñ–ª—é (–∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è –Ω—ñ–∫—É) ---
  document.getElementById('editProfileBtn').onclick = () => {
    document.getElementById('editNickname').value = document.getElementById('profileUsernameDisplay').textContent;
    document.getElementById('editBio').value = document.getElementById('profileBio').textContent !== '–ù–µ–º–∞—î –æ–ø–∏—Å—É' ? document.getElementById('profileBio').textContent : '';
    document.getElementById('editProfileModal').classList.add('active');
  };
  document.getElementById('closeModal').onclick = () => document.getElementById('editProfileModal').classList.remove('active');

  document.getElementById('saveProfileEdit').onclick = async () => {
    const nickname = document.getElementById('editNickname').value.trim();
    const bio = document.getElementById('editBio').value.trim();
    if (!nickname) return alert('–ü—Å–µ–≤–¥–æ–Ω—ñ–º –Ω–µ –º–æ–∂–µ –±—É—Ç–∏ –ø–æ—Ä–æ–∂–Ω—ñ–º');
    await updateDoc(doc(db, "users", currentUser.uid), { 
      nickname, 
      nickname_lower: nickname.toLowerCase(),
      bio 
    });
    loadProfile();
    document.getElementById('editProfileModal').classList.remove('active');
  };

  // --- —á–∞—Ç–∏ (—Å–ø—Ä–æ—â–µ–Ω–æ) ---
  async function loadChatList() {
    const chatList = document.getElementById('chatList');
    chatList.innerHTML = '';
    const q = query(collection(db, "users"));
    onSnapshot(q, snapshot => {
      chatList.innerHTML = '';
      snapshot.forEach(docSnap => {
        if (docSnap.id === currentUser.uid) return;
        const data = docSnap.data();
        const item = document.createElement('div');
        item.className = 'chat-item';
        item.innerHTML = `<div class="avatar" style="background-image:url(${data.avatar || ''})"></div><div>@${data.nickname}</div>`;
        item.onclick = () => openChat(data.nickname, docSnap.id);
        chatList.appendChild(item);
      });
    });
  }

  function openChat(name, uid) {
    currentChatPartner = uid;
    document.getElementById('chatWindow').style.display = 'flex';
    document.getElementById('chatHeader').innerHTML = `<div>@${name}</div>`;
    subscribeToChat(uid);
  }

  function subscribeToChat(otherUid) {
    if (unsubscribeChat) unsubscribeChat();
    const chatId = getChatId(currentUser.uid, otherUid);
    const q = query(collection(db, `messages/${chatId}/chat`), orderBy("createdAt"));
    unsubscribeChat = onSnapshot(q, snap => {
      const messages = document.getElementById('chatMessages');
      messages.innerHTML = '';
      snap.forEach(m => {
        const msg = m.data();
        const div = document.createElement('div');
        div.className = `message ${msg.from === currentUser.uid ? 'sent' : 'received'}`;
        div.textContent = msg.text;
        messages.appendChild(div);
      });
      messages.scrollTop = messages.scrollHeight;
    });
  }

  document.getElementById('sendMessage').onclick = async () => {
    const text = document.getElementById('chatText').value.trim();
    if (!text || !currentChatPartner) return;
    const chatId = getChatId(currentUser.uid, currentChatPartner);
    await addDoc(collection(db, `messages/${chatId}/chat`), {
      from: currentUser.uid,
      text,
      createdAt: serverTimestamp()
    });
    document.getElementById('chatText').value = '';
  };

  // --- —Ç–µ–º–∞ ---
  document.getElementById('toggleTheme').onclick = () => {
    document.body.classList.toggle('light');
    localStorage.setItem('theme', document.body.classList.contains('light') ? 'light' : 'dark');
  };
  if (localStorage.getItem('theme') === 'light') document.body.classList.add('light');

  // --- –≤–∏—Ö—ñ–¥ ---
  document.getElementById('logoutBtn').onclick = () => signOut(auth);

  // --- –ø—Ä–∏—Ö–æ–≤–∞—Ç–∏ —á–∞—Ç –≤—ñ–∫–Ω–æ —Å–ø–æ—á–∞—Ç–∫—É ---
  document.getElementById('chatWindow').style.display = 'none';
</script>
</body>
</html>

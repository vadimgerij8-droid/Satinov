<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>FANTASYAS ¬∑ —á–æ—Ä–Ω–æ-–±—ñ–ª–∏–π</title>
  <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;500;600;700;800&display=swap" rel="stylesheet"/>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Manrope', sans-serif;
    }

    :root {
      --bg: #000000;
      --surface: #111111;
      --card: #1a1a1a;
      --border: #2a2a2a;
      --text: #ffffff;
      --text-sec: #aaaaaa;
      --accent: #888888;
      --hover: #2c2c2c;
      --shadow: 0 12px 30px rgba(0, 0, 0, 0.8);
    }

    body.light {
      --bg: #f8f8f8;
      --surface: #ffffff;
      --card: #eeeeee;
      --border: #d0d0d0;
      --text: #111111;
      --text-sec: #555555;
      --accent: #666666;
      --hover: #e0e0e0;
      --shadow: 0 8px 24px rgba(0, 0, 0, 0.05);
    }

    body {
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
      transition: background 0.25s, color 0.25s;
    }

    /* –¢–æ–ø–±–∞—Ä */
    .top-bar {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      height: 70px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 24px;
      background: rgba(0,0,0,0.7);
      backdrop-filter: blur(18px);
      -webkit-backdrop-filter: blur(18px);
      border-bottom: 1px solid var(--border);
      z-index: 1000;
    }
    body.light .top-bar { background: rgba(255,255,255,0.8); }

    .site-name {
      font-size: 2rem;
      font-weight: 800;
      background: linear-gradient(145deg, #fff, #aaa);
      -webkit-background-clip: text;
      background-clip: text;
      color: transparent;
      letter-spacing: -0.5px;
    }
    body.light .site-name { background: linear-gradient(145deg, #111, #555); -webkit-background-clip: text; }

    /* –ë—É—Ä–≥–µ—Ä */
    .burger {
      width: 32px;
      height: 22px;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
      cursor: pointer;
    }
    .burger span {
      height: 3px;
      width: 100%;
      background: var(--text);
      border-radius: 6px;
      transition: 0.3s cubic-bezier(0.68, -0.6, 0.32, 1.6);
    }
    .burger.active span:nth-child(1) { transform: rotate(45deg) translate(7px, 6px); }
    .burger.active span:nth-child(2) { opacity: 0; transform: scale(0); }
    .burger.active span:nth-child(3) { transform: rotate(-45deg) translate(7px, -6px); }

    /* –°–∞–π–¥–±–∞—Ä */
    .sidebar {
      position: fixed;
      top: 0;
      left: -300px;
      width: 280px;
      height: 100%;
      background: rgba(10,10,10,0.7);
      backdrop-filter: blur(24px);
      -webkit-backdrop-filter: blur(24px);
      padding: 100px 28px;
      border-right: 1px solid var(--border);
      transition: left 0.4s cubic-bezier(0.16, 1, 0.3, 1);
      z-index: 999;
    }
    body.light .sidebar { background: rgba(255,255,255,0.7); }
    .sidebar.active { left: 0; }

    .sidebar a {
      display: block;
      color: var(--text-sec);
      text-decoration: none;
      font-size: 1.3rem;
      font-weight: 600;
      margin: 2rem 0;
      transition: 0.2s;
      position: relative;
      width: fit-content;
    }
    .sidebar a::after {
      content: '';
      position: absolute;
      bottom: -4px;
      left: 0;
      width: 0;
      height: 2px;
      background: var(--accent);
      transition: width 0.2s;
    }
    .sidebar a:hover { color: var(--text); transform: translateX(8px); }
    .sidebar a:hover::after { width: 100%; }

    /* –û—Å–Ω–æ–≤–Ω–∏–π –∫–æ–Ω—Ç–µ–Ω—Ç */
    .main-content {
      margin-top: 90px;
      padding: 20px;
      max-width: 680px;
      margin-left: auto;
      margin-right: auto;
    }

    .section { display: none; opacity: 0; transform: translateY(20px); transition: 0.4s; }
    .section.active { display: block; opacity: 1; transform: translateY(0); }

    .card {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 28px;
      padding: 24px;
      margin-bottom: 24px;
      box-shadow: var(--shadow);
      transition: 0.25s;
    }
    .card:hover { border-color: var(--accent); }

    input, textarea {
      width: 100%;
      padding: 16px 20px;
      border-radius: 20px;
      border: 1px solid var(--border);
      background: var(--surface);
      color: var(--text);
      font-size: 1rem;
      outline: none;
      transition: 0.2s;
    }
    input:focus, textarea:focus { border-color: var(--accent); background: var(--card); }
    ::placeholder { color: var(--text-sec); opacity: 0.5; }

    button {
      padding: 14px 26px;
      border: none;
      border-radius: 40px;
      background: var(--surface);
      color: var(--text);
      font-weight: 600;
      border: 1px solid var(--border);
      cursor: pointer;
      transition: 0.2s;
      box-shadow: 0 2px 8px rgba(0,0,0,0.2);
    }
    button:hover {
      background: var(--hover);
      transform: scale(1.02);
      border-color: var(--accent);
    }

    /* –°—Ç—Ä—ñ—á–∫–∞ */
    .feed { display: flex; flex-direction: column; gap: 24px; }

    .post {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 28px;
      padding: 24px;
      opacity: 0;
      transform: translateY(30px);
      transition: opacity 0.6s cubic-bezier(0.2, 0.9, 0.3, 1), transform 0.6s cubic-bezier(0.2, 0.9, 0.3, 1);
    }
    .post.show { opacity: 1; transform: translateY(0); }

    .post-header {
      display: flex;
      align-items: center;
      gap: 14px;
      margin-bottom: 18px;
      position: relative;
    }
    .avatar {
      width: 52px;
      height: 52px;
      border-radius: 50%;
      background: #333;
      background-size: cover;
      background-position: center;
      border: 2px solid var(--border);
      cursor: pointer;
      transition: 0.2s;
    }
    .avatar:hover { border-color: var(--accent); }
    .username {
      font-weight: 700;
      font-size: 1.15rem;
      cursor: pointer;
      text-decoration: none;
      color: var(--text);
    }
    .username:hover { text-decoration: underline; }
    .menu-btn {
      margin-left: auto;
      font-size: 2rem;
      line-height: 1;
      background: none;
      border: none;
      color: var(--text-sec);
      padding: 0 8px;
    }
    .menu-btn:hover { color: var(--text); transform: scale(1.2); background: none; border: none; }

    .post-content {
      font-size: 1.05rem;
      line-height: 1.6;
      margin-bottom: 16px;
      word-break: break-word;
    }

    .post-media {
      width: 100%;
      border-radius: 24px;
      margin: 16px 0;
    }

    /* –§—É—Ç–µ—Ä –ø–æ—Å—Ç–∞ (–ª–∞–π–∫, –∫–æ–º–µ–Ω—Ç–∞—Ä—ñ) */
    .post-footer {
      display: flex;
      gap: 28px;
      margin: 16px 0 8px;
    }
    .post-footer button {
      background: none;
      border: none;
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 1.1rem;
      padding: 6px 12px;
      border-radius: 40px;
      color: var(--text-sec);
    }
    .post-footer button:hover { background: var(--hover); color: var(--text); border: none; }

    /* –ö–Ω–æ–ø–∫–∞ –ø—ñ–¥–ø–∏—Å–∫–∏ –ø—ñ–¥ –ø–æ—Å—Ç–æ–º */
    .subscribe-post-btn {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 30px;
      padding: 6px 16px;
      font-size: 0.9rem;
      font-weight: 600;
      margin-left: 16px;
      cursor: pointer;
      transition: 0.2s;
    }
    .subscribe-post-btn:hover {
      background: var(--accent);
      color: black;
      border-color: var(--accent);
    }

    /* –ö–æ–º–µ–Ω—Ç–∞—Ä—ñ */
    .comments-section {
      margin-top: 24px;
      border-top: 1px solid var(--border);
      padding-top: 20px;
    }
    .comment {
      display: flex;
      gap: 12px;
      margin-bottom: 16px;
      animation: fadeSlideUp 0.4s ease;
    }
    @keyframes fadeSlideUp {
      0% { opacity: 0; transform: translateY(15px); }
      100% { opacity: 1; transform: translateY(0); }
    }
    .comment .avatar { width: 36px; height: 36px; }
    .comment-content {
      background: var(--surface);
      padding: 12px 16px;
      border-radius: 22px;
      flex: 1;
      border: 1px solid var(--border);
    }
    .comment-author { font-weight: 700; margin-right: 8px; cursor: pointer; }
    .comment-author:hover { text-decoration: underline; }

    .comment-input-area {
      display: flex;
      gap: 10px;
      margin: 16px 0 8px;
    }
    .comment-input-area textarea {
      flex: 1;
      min-height: 44px;
      border-radius: 30px;
      padding: 12px 18px;
    }

    .emoji-panel {
      display: flex;
      gap: 8px;
      background: var(--surface);
      border-radius: 40px;
      padding: 8px 14px;
      border: 1px solid var(--border);
      width: fit-content;
      margin-bottom: 10px;
    }
    .emoji-panel span {
      font-size: 1.8rem;
      cursor: pointer;
      transition: 0.15s;
      filter: grayscale(20%);
    }
    .emoji-panel span:hover { transform: scale(1.3); filter: grayscale(0); }

    /* –ü–æ—à—É–∫ */
    .search-input {
      margin-bottom: 24px;
      padding: 18px 24px;
      font-size: 1.1rem;
    }
    .user-item {
      display: flex;
      align-items: center;
      gap: 16px;
      padding: 16px;
      border-radius: 28px;
      background: var(--card);
      border: 1px solid var(--border);
      margin-bottom: 12px;
      cursor: pointer;
      transition: 0.2s;
    }
    .user-item:hover { border-color: var(--accent); transform: translateX(6px); }
    .follow-btn {
      margin-left: auto;
      background: var(--accent);
      color: black;
      font-weight: 700;
      padding: 8px 22px;
      border-radius: 40px;
      border: none;
    }

    /* –ß–∞—Ç */
    .chat-window {
      display: none;
      flex-direction: column;
      height: 550px;
      border: 1px solid var(--border);
      border-radius: 32px;
      overflow: hidden;
      background: var(--card);
      margin-top: 20px;
    }
    .chat-header {
      padding: 20px;
      border-bottom: 1px solid var(--border);
      font-weight: 700;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .chat-header .avatar { width: 40px; height: 40px; }
    .chat-messages {
      flex: 1;
      padding: 20px;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    .message {
      max-width: 75%;
      padding: 12px 18px;
      border-radius: 26px;
      animation: messagePop 0.3s;
    }
    @keyframes messagePop {
      0% { opacity: 0; transform: scale(0.9); }
      100% { opacity: 1; transform: scale(1); }
    }
    .message.sent {
      background: var(--accent);
      color: black;
      align-self: flex-end;
      border-bottom-right-radius: 6px;
    }
    .message.received {
      background: var(--surface);
      border: 1px solid var(--border);
      align-self: flex-start;
      border-bottom-left-radius: 6px;
    }
    .chat-input {
      display: flex;
      padding: 16px;
      border-top: 1px solid var(--border);
      background: var(--card);
    }
    .chat-input input { flex: 1; margin-right: 16px; border-radius: 40px; }

    /* –ü—Ä–æ—Ñ—ñ–ª—å (—Å–≤—ñ–π —Ç–∞ —á—É–∂–∏–π) */
    .profile-header {
      display: flex;
      flex-wrap: wrap;
      gap: 28px;
      align-items: center;
    }
    .profile-avatar {
      width: 120px;
      height: 120px;
      border-radius: 50%;
      background: #333;
      background-size: cover;
      border: 3px solid var(--border);
      cursor: pointer;
      transition: 0.2s;
    }
    .profile-avatar:hover { border-color: var(--accent); transform: scale(1.02); }

    /* –ú–æ–¥–∞–ª–∫–∏ */
    .modal {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.7);
      backdrop-filter: blur(12px);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 3000;
    }
    .modal.active { display: flex; }
    .modal-content {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 40px;
      padding: 32px;
      width: 92%;
      max-width: 480px;
      box-shadow: var(--shadow);
      animation: modalPop 0.3s;
    }
    @keyframes modalPop {
      from { opacity: 0; transform: scale(0.9); }
      to { opacity: 1; transform: scale(1); }
    }
    .close-modal {
      float: right;
      font-size: 2.5rem;
      line-height: 1;
      cursor: pointer;
      color: var(--text-sec);
    }

    @media (max-width: 700px) {
      .main-content { padding: 16px; }
      .profile-header { flex-direction: column; text-align: center; }
    }
  </style>
</head>
<body>

<div class="top-bar">
  <div class="burger" id="burger"><span></span><span></span><span></span></div>
  <div class="site-name">FANTASYAS</div>
</div>

<nav class="sidebar" id="sidebar">
  <a data-section="home">–ì–æ–ª–æ–≤–Ω–∞</a>
  <a data-section="search">–ü–æ—à—É–∫</a>
  <a data-section="profile">–ü—Ä–æ—Ñ—ñ–ª—å</a>
  <a data-section="chats">–ß–∞—Ç–∏</a>
  <a data-section="settings">–ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è</a>
</nav>

<main class="main-content">

  <!-- –ì–û–õ–û–í–ù–ê -->
  <div id="home" class="section active">
    <div class="card" id="authBox">
      <div id="loginForm">
        <input type="text" id="loginNickname" placeholder="–ü—Å–µ–≤–¥–æ–Ω—ñ–º" autocomplete="off"/>
        <input type="password" id="loginPassword" placeholder="–ü–∞—Ä–æ–ª—å"/>
        <button id="loginBtn">–£–≤—ñ–π—Ç–∏</button>
        <div style="display:flex; gap:10px; margin-top:15px;">
          <button id="googleLoginBtn" style="flex:1; background:#2a2a2a;">Google</button>
          <button id="appleLoginBtn" style="flex:1; background:#1a1a1a;">Apple</button>
        </div>
        <p style="margin-top:18px;">–ù–µ–º–∞—î –∞–∫–∞—É–Ω—Ç–∞? <span id="toRegister" style="color:var(--accent);cursor:pointer;">–ó–∞—Ä–µ—î—Å—Ç—Ä—É–≤–∞—Ç–∏—Å—è</span></p>
      </div>
      <div id="registerForm" style="display:none;">
        <input type="text" id="registerNickname" placeholder="–ü—Å–µ–≤–¥–æ–Ω—ñ–º"/>
        <input type="password" id="registerPassword" placeholder="–ü–∞—Ä–æ–ª—å"/>
        <button id="registerBtn">–ó–∞—Ä–µ—î—Å—Ç—Ä—É–≤–∞—Ç–∏—Å—è</button>
        <p style="margin-top:18px;">–í–∂–µ —î –∞–∫–∞—É–Ω—Ç? <span id="toLogin" style="color:var(--accent);cursor:pointer;">–£–≤—ñ–π—Ç–∏</span></p>
      </div>
    </div>

    <div class="card" id="newPostBox" style="display:none;">
      <textarea id="postText" placeholder="–©–æ –Ω–æ–≤–æ–≥–æ?" rows="3"></textarea>
      <div style="display:flex; gap:12px; align-items:center; margin:15px 0;">
        <button id="emojiPostBtn">üòä –î–æ–¥–∞—Ç–∏ –µ–º–æ–¥–∑—ñ</button>
        <div id="emojiPostPicker" class="emoji-panel" style="display:none;">
          <span>üòä</span><span>üòÇ</span><span>‚ù§Ô∏è</span><span>üî•</span><span>üëç</span><span>üéâ</span><span>üò¢</span><span>üòé</span>
        </div>
      </div>
      <input type="file" id="postMedia" accept="image/*,video/*" style="margin:12px 0;"/>
      <button id="addPost">–û–ø—É–±–ª—ñ–∫—É–≤–∞—Ç–∏</button>
    </div>

    <div class="feed" id="feed"></div>
  </div>

  <!-- –ü–û–®–£–ö -->
  <div id="search" class="section">
    <input type="text" id="searchInput" class="search-input" placeholder="–ü–æ—à—É–∫ –∑–∞ –ø—Å–µ–≤–¥–æ–Ω—ñ–º–æ–º..."/>
    <div class="user-list" id="userList"></div>
  </div>

  <!-- –ü–†–û–§–Ü–õ–¨ (–¥–∏–Ω–∞–º—ñ—á–Ω–∏–π) -->
  <div id="profile" class="section">
    <!-- –ø—Ä–æ—Ñ—ñ–ª—å –±—É–¥–µ –∑–∞–ø–æ–≤–Ω—é–≤–∞—Ç–∏—Å—å –¥–∏–Ω–∞–º—ñ—á–Ω–æ, –∞–ª–µ –ø–æ–∫–∏ –∑–∞–≥–ª—É—à–∫–∞ -->
  </div>

  <!-- –ß–ê–¢–ò -->
  <div id="chats" class="section">
    <div class="chat-list" id="chatList"></div>
    <div class="chat-window" id="chatWindow">
      <div class="chat-header" id="chatHeader"></div>
      <div class="chat-messages" id="chatMessages"></div>
      <div class="chat-input">
        <input type="text" id="chatText" placeholder="–ü–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è..."/>
        <button id="sendMessage">–ù–∞–¥—ñ—Å–ª–∞—Ç–∏</button>
      </div>
    </div>
  </div>

  <!-- –ù–ê–õ–ê–®–¢–£–í–ê–ù–ù–Ø -->
  <div id="settings" class="section card">
    <h2>–ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è</h2>
    <button id="toggleTheme" style="margin:20px 0;">–ü–µ—Ä–µ–º–∫–Ω—É—Ç–∏ —Ç–µ–º—É üåô/‚òÄÔ∏è</button>
    <button id="logoutBtn">–í–∏–π—Ç–∏</button>
  </div>
</main>

<!-- –ú–û–î–ê–õ–ö–ê –†–ï–î–ê–ì–£–í–ê–ù–ù–Ø –ü–†–û–§–Ü–õ–Æ -->
<div class="modal" id="editProfileModal">
  <div class="modal-content">
    <span class="close-modal" id="closeModal">&times;</span>
    <h2>–†–µ–¥–∞–≥—É–≤–∞—Ç–∏ –ø—Ä–æ—Ñ—ñ–ª—å</h2>
    <input type="text" id="editNickname" placeholder="–ü—Å–µ–≤–¥–æ–Ω—ñ–º"/>
    <textarea id="editBio" placeholder="–ü—Ä–æ —Å–µ–±–µ" rows="4" style="margin:16px 0;"></textarea>
    <button id="saveProfileEdit">–ó–±–µ—Ä–µ–≥—Ç–∏</button>
  </div>
</div>

<!-- –ú–û–î–ê–õ–ö–ê –†–ï–î–ê–ì–£–í–ê–ù–ù–Ø –ü–û–°–¢–ê -->
<div class="modal" id="editPostModal">
  <div class="modal-content">
    <span class="close-modal" id="closeEditPostModal">&times;</span>
    <h2>–†–µ–¥–∞–≥—É–≤–∞—Ç–∏ –ø–æ—Å—Ç</h2>
    <textarea id="editPostText" rows="5" style="margin:20px 0;"></textarea>
    <button id="savePostEdit">–û–Ω–æ–≤–∏—Ç–∏</button>
  </div>
</div>

<script type="module">
  // ================= Firebase =================
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js";
  import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut, GoogleAuthProvider, OAuthProvider, signInWithPopup } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-auth.js";
  import { getFirestore, doc, setDoc, getDoc, updateDoc, collection, addDoc, query, where, onSnapshot, orderBy, serverTimestamp, arrayUnion, arrayRemove, deleteDoc, getDocs } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore.js";
  import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-storage.js";

  const firebaseConfig = {
    apiKey: "AIzaSyDRzC-QDE0-UXd-XL0i3iqayFiKcc6wmvc",
    authDomain: "fantasyasapp.firebaseapp.com",
    projectId: "fantasyasapp",
    storageBucket: "fantasyasapp.firebasestorage.app",
    messagingSenderId: "721763921060",
    appId: "1:721763921060:web:3d61044ea2424e8176ca31"
  };
  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);
  const storage = getStorage(app);

  let currentUser = null;
  let currentChatPartner = null;
  let unsubscribeFeed = null;
  let unsubscribeChat = null;
  let currentEditPostId = null;
  let viewingProfileUid = null; // uid –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞, —á–∏–π –ø—Ä–æ—Ñ—ñ–ª—å –∑–∞—Ä–∞–∑ –ø–µ—Ä–µ–≥–ª—è–¥–∞—î–º–æ

  // helpers
  const getChatId = (uid1, uid2) => [uid1, uid2].sort().join('_');

  // burger
  document.getElementById('burger').onclick = () => {
    document.getElementById('burger').classList.toggle('active');
    document.getElementById('sidebar').classList.toggle('active');
  };

  // –Ω–∞–≤—ñ–≥–∞—Ü—ñ—è
  document.querySelectorAll('[data-section]').forEach(link => {
    link.onclick = () => {
      const sectionId = link.dataset.section;
      document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
      document.getElementById(sectionId).classList.add('active');
      document.getElementById('sidebar').classList.remove('active');
      document.getElementById('burger').classList.remove('active');
      if (sectionId === 'search') loadSearchUsers();
      if (sectionId === 'chats') loadChatList();
      if (sectionId === 'profile') {
        // —è–∫—â–æ –Ω–µ –≤–∏–±—Ä–∞–Ω–æ —ñ–Ω—à–æ–≥–æ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞, –ø–æ–∫–∞–∑—É—î–º–æ —Å–≤—ñ–π –ø—Ä–æ—Ñ—ñ–ª—å
        if (!viewingProfileUid || viewingProfileUid === currentUser?.uid) {
          viewingProfileUid = currentUser?.uid;
          loadMyProfile();
        } else {
          loadUserProfile(viewingProfileUid);
        }
      }
    };
  });

  // –ø–µ—Ä–µ–º–∏–∫–∞–Ω–Ω—è –ª–æ–≥—ñ–Ω/—Ä–µ—î—Å—Ç—Ä–∞—Ü—ñ—è
  document.getElementById('toRegister').onclick = () => {
    document.getElementById('loginForm').style.display = 'none';
    document.getElementById('registerForm').style.display = 'block';
  };
  document.getElementById('toLogin').onclick = () => {
    document.getElementById('registerForm').style.display = 'none';
    document.getElementById('loginForm').style.display = 'block';
  };

  // —Ä–µ—î—Å—Ç—Ä–∞—Ü—ñ—è
  document.getElementById('registerBtn').onclick = async () => {
    const nickname = document.getElementById('registerNickname').value.trim();
    const password = document.getElementById('registerPassword').value.trim();
    if (!nickname) return alert('–í–≤–µ–¥—ñ—Ç—å –ø—Å–µ–≤–¥–æ–Ω—ñ–º');
    if (password.length < 6) return alert('–ú—ñ–Ω—ñ–º—É–º 6 —Å–∏–º–≤–æ–ª—ñ–≤');
    try {
      const safeNick = nickname.toLowerCase().replace(/[^a-z0-9]/g, '');
      const email = `${safeNick}@fantasyas.local`;
      const cred = await createUserWithEmailAndPassword(auth, email, password);
      await setDoc(doc(db, "users", cred.user.uid), {
        nickname, nickname_lower: nickname.toLowerCase(), bio: '', avatar: '', posts: [],
        followers: [], following: [], createdAt: serverTimestamp()
      });
      alert('–†–µ—î—Å—Ç—Ä–∞—Ü—ñ—è —É—Å–ø—ñ—à–Ω–∞, —É–≤—ñ–π–¥—ñ—Ç—å');
      document.getElementById('toLogin').click();
      document.getElementById('loginNickname').value = nickname;
    } catch (e) { alert(e.message); }
  };

  // –≤—Ö—ñ–¥
  document.getElementById('loginBtn').onclick = async () => {
    const nickname = document.getElementById('loginNickname').value.trim();
    const password = document.getElementById('loginPassword').value.trim();
    if (!nickname || !password) return alert('–ó–∞–ø–æ–≤–Ω—ñ—Ç—å –ø–æ–ª—è');
    try {
      const safeNick = nickname.toLowerCase().replace(/[^a-z0-9]/g, '');
      const email = `${safeNick}@fantasyas.local`;
      await signInWithEmailAndPassword(auth, email, password);
    } catch { alert('–ù–µ–≤—ñ—Ä–Ω–∏–π –ø—Å–µ–≤–¥–æ–Ω—ñ–º –∞–±–æ –ø–∞—Ä–æ–ª—å'); }
  };

  // Google
  document.getElementById('googleLoginBtn').onclick = async () => {
    try {
      const provider = new GoogleAuthProvider();
      const result = await signInWithPopup(auth, provider);
      const user = result.user;
      const userDoc = await getDoc(doc(db, "users", user.uid));
      if (!userDoc.exists()) {
        await setDoc(doc(db, "users", user.uid), {
          nickname: user.displayName || user.email.split('@')[0],
          nickname_lower: (user.displayName || user.email.split('@')[0]).toLowerCase(),
          bio: '', avatar: user.photoURL || '', posts: [], followers: [], following: [], createdAt: serverTimestamp()
        });
      }
    } catch (e) { alert(e.message); }
  };

  // Apple
  document.getElementById('appleLoginBtn').onclick = async () => {
    try {
      const provider = new OAuthProvider('apple.com');
      provider.addScope('email name');
      const result = await signInWithPopup(auth, provider);
      const user = result.user;
      const userDoc = await getDoc(doc(db, "users", user.uid));
      if (!userDoc.exists()) {
        await setDoc(doc(db, "users", user.uid), {
          nickname: user.displayName || user.email.split('@')[0],
          nickname_lower: (user.displayName || user.email.split('@')[0]).toLowerCase(),
          bio: '', avatar: user.photoURL || '', posts: [], followers: [], following: [], createdAt: serverTimestamp()
        });
      }
    } catch (e) { alert(e.message); }
  };

  // —Å–ª—É—Ö–∞—á –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü—ñ—ó
  onAuthStateChanged(auth, (user) => {
    if (user) {
      currentUser = user;
      document.getElementById('authBox').style.display = 'none';
      document.getElementById('newPostBox').style.display = 'block';
      subscribeToFeed();
      loadMyProfile();
    } else {
      currentUser = null;
      document.getElementById('authBox').style.display = 'block';
      document.getElementById('newPostBox').style.display = 'none';
      if (unsubscribeFeed) unsubscribeFeed();
    }
  });

  // –µ–º–æ–¥–∑—ñ –¥–ª—è –ø–æ—Å—Ç–∞
  document.getElementById('emojiPostBtn').onclick = () => {
    const p = document.getElementById('emojiPostPicker');
    p.style.display = p.style.display === 'none' ? 'flex' : 'none';
  };
  document.querySelectorAll('#emojiPostPicker span').forEach(s => {
    s.onclick = () => {
      document.getElementById('postText').value += s.textContent;
      document.getElementById('emojiPostPicker').style.display = 'none';
    };
  });

  // –ø—É–±–ª—ñ–∫–∞—Ü—ñ—è –ø–æ—Å—Ç–∞
  document.getElementById('addPost').onclick = async () => {
    if (!currentUser) return alert('–£–≤—ñ–π–¥—ñ—Ç—å');
    const text = document.getElementById('postText').value.trim();
    const file = document.getElementById('postMedia').files[0];
    if (!text && !file) return alert('–î–æ–¥–∞–π—Ç–µ —Ç–µ–∫—Å—Ç –∞–±–æ –º–µ–¥—ñ–∞');
    try {
      let mediaUrl = '', mediaType = '';
      if (file) {
        const storageRef = ref(storage, `posts/${currentUser.uid}/${Date.now()}_${file.name}`);
        await uploadBytes(storageRef, file);
        mediaUrl = await getDownloadURL(storageRef);
        mediaType = file.type.split('/')[0];
      }
      const postRef = await addDoc(collection(db, "posts"), {
        author: currentUser.uid, text, mediaUrl, mediaType,
        createdAt: serverTimestamp(), likes: [], commentsCount: 0
      });
      // –¥–æ–¥–∞—Ç–∏ –ø–æ—Å—Ç –≤ –º–∞—Å–∏–≤ –ø–æ—Å—Ç—ñ–≤ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞
      await updateDoc(doc(db, "users", currentUser.uid), {
        posts: arrayUnion(postRef.id)
      });
      document.getElementById('postText').value = '';
      document.getElementById('postMedia').value = '';
    } catch (e) { alert(e.message); }
  };

  // —Å—Ç—Ä—ñ—á–∫–∞ –∑ –∞–Ω—ñ–º–∞—Ü—ñ—î—é
  function subscribeToFeed() {
    if (unsubscribeFeed) unsubscribeFeed();
    const q = query(collection(db, "posts"), orderBy("createdAt", "desc"));
    unsubscribeFeed = onSnapshot(q, async (snapshot) => {
      const feed = document.getElementById('feed');
      feed.innerHTML = '';
      for (const docSnap of snapshot.docs) {
        const post = docSnap.data(); const postId = docSnap.id;
        const authorSnap = await getDoc(doc(db, "users", post.author));
        const author = authorSnap.exists() ? authorSnap.data() : { nickname: '–ù–µ–≤—ñ–¥–æ–º–æ', avatar: '' };
        const isOwn = post.author === currentUser?.uid;
        const liked = post.likes?.includes(currentUser?.uid) || false;

        // —á–∏ –ø—ñ–¥–ø–∏—Å–∞–Ω–∏–π –ø–æ—Ç–æ—á–Ω–∏–π –Ω–∞ –∞–≤—Ç–æ—Ä–∞
        let isFollowing = false;
        if (currentUser && post.author !== currentUser.uid) {
          const currentUserSnap = await getDoc(doc(db, "users", currentUser.uid));
          isFollowing = currentUserSnap.data().following?.includes(post.author) || false;
        }

        // –∫–æ–º–µ–Ω—Ç–∞—Ä—ñ
        const commentsQuery = query(collection(db, "posts", postId, "comments"), orderBy("createdAt", "desc"));
        const commentsSnap = await getDocs(commentsQuery);
        const comments = [];
        commentsSnap.forEach(c => comments.push({ id: c.id, ...c.data() }));

        const postEl = document.createElement('div');
        postEl.className = 'post';
        postEl.innerHTML = `
          <div class="post-header">
            <div class="avatar" style="background-image:url(${author.avatar || ''})" data-uid="${post.author}"></div>
            <span class="username" data-uid="${post.author}">@${author.nickname}</span>
            ${isOwn ? `<button class="menu-btn" data-post-id="${postId}">‚ãØ</button>` : ''}
            ${!isOwn && currentUser ? `<button class="subscribe-post-btn" data-author-uid="${post.author}">${isFollowing ? '–í—ñ–¥–ø–∏—Å–∞—Ç–∏—Å—è' : '–ü—ñ–¥–ø–∏—Å–∞—Ç–∏—Å—è'}</button>` : ''}
          </div>
          <div class="post-content">${post.text ? post.text.replace(/\n/g,'<br>') : ''}</div>
          ${post.mediaUrl ? (post.mediaType==='image' ? `<img src="${post.mediaUrl}" class="post-media">` : `<video src="${post.mediaUrl}" controls class="post-media"></video>`) : ''}
          <div class="post-footer">
            <button class="like-btn ${liked ? 'liked' : ''}" data-post-id="${postId}">
              <span style="font-size:1.4rem;">${liked ? '‚ù§Ô∏è' : 'ü§ç'}</span>
              <span>${post.likes?.length || 0}</span>
            </button>
            <button class="comments-toggle" data-post-id="${postId}">
              <span style="font-size:1.4rem;">üí¨</span> <span>${post.commentsCount || 0}</span>
            </button>
          </div>
          <div class="comments-section" id="comments-${postId}" style="display:none;">
            <div class="comments-list" id="comments-list-${postId}"></div>
            <div class="comment-input-area">
              <textarea id="comment-text-${postId}" placeholder="–ö–æ–º–µ–Ω—Ç–∞—Ä..."></textarea>
              <button class="send-comment" data-post-id="${postId}">‚û§</button>
            </div>
            <div class="emoji-panel" id="emoji-comment-${postId}" style="display:none;">
              <span>üòä</span><span>üòÇ</span><span>‚ù§Ô∏è</span><span>üî•</span><span>üëç</span><span>üéâ</span>
            </div>
            <button class="emoji-comment-btn" data-post-id="${postId}">üòã –ï–º–æ–¥–∑—ñ</button>
          </div>
        `;

        // –≤—Å—Ç–∞–≤–∏—Ç–∏ –∫–æ–º–µ–Ω—Ç–∞—Ä—ñ
        const listDiv = postEl.querySelector(`#comments-list-${postId}`);
        if (listDiv) {
          listDiv.innerHTML = comments.reverse().map(c => `
            <div class="comment">
              <div class="avatar" style="background-image:url(${c.authorAvatar || ''})" data-uid="${c.author}"></div>
              <div class="comment-content">
                <span class="comment-author" data-uid="${c.author}">@${c.authorNickname || '–Ω–µ–≤—ñ–¥–æ–º–æ'}</span> ${c.text}
              </div>
            </div>
          `).join('');
        }

        feed.appendChild(postEl);
        setTimeout(() => postEl.classList.add('show'), 50 * feed.children.length);
      }
    });
  }

  // –ª–∞–π–∫–∏, –∫–æ–º–µ–Ω—Ç–∞—Ä—ñ, –º–µ–Ω—é, –ø—ñ–¥–ø–∏—Å–∫–∞, –∫–ª—ñ–∫ –Ω–∞ –∞–≤–∞—Ç–∞—Ä/—ñ–º'—è
  document.getElementById('feed').addEventListener('click', async (e) => {
    // –ª–∞–π–∫
    if (e.target.closest('.like-btn')) {
      const btn = e.target.closest('.like-btn');
      const postId = btn.dataset.postId;
      const postRef = doc(db, "posts", postId);
      const snap = await getDoc(postRef);
      const likes = snap.data().likes || [];
      if (likes.includes(currentUser.uid)) {
        await updateDoc(postRef, { likes: arrayRemove(currentUser.uid) });
      } else {
        await updateDoc(postRef, { likes: arrayUnion(currentUser.uid) });
      }
    }

    // –º–µ–Ω—é –ø–æ—Å—Ç–∞ (—Ä–µ–¥–∞–≥—É–≤–∞–Ω–Ω—è/–≤–∏–¥–∞–ª–µ–Ω–Ω—è)
    if (e.target.closest('.menu-btn')) {
      const postId = e.target.closest('.menu-btn').dataset.postId;
      const action = prompt('1 - —Ä–µ–¥–∞–≥—É–≤–∞—Ç–∏, 2 - –≤–∏–¥–∞–ª–∏—Ç–∏');
      if (action === '1') {
        const postRef = doc(db, "posts", postId);
        const snap = await getDoc(postRef);
        document.getElementById('editPostText').value = snap.data().text || '';
        currentEditPostId = postId;
        document.getElementById('editPostModal').classList.add('active');
      } else if (action === '2') {
        if (confirm('–í–∏–¥–∞–ª–∏—Ç–∏ –ø–æ—Å—Ç?')) {
          await deleteDoc(doc(db, "posts", postId));
          // –≤–∏–¥–∞–ª–∏—Ç–∏ –∑ –º–∞—Å–∏–≤—É –ø–æ—Å—Ç—ñ–≤ –∞–≤—Ç–æ—Ä–∞
          const postSnap = await getDoc(postRef);
          const author = postSnap.data().author;
          await updateDoc(doc(db, "users", author), { posts: arrayRemove(postId) });
        }
      }
    }

    // –ø–æ–∫–∞–∑–∞—Ç–∏/—Å—Ö–æ–≤–∞—Ç–∏ –∫–æ–º–µ–Ω—Ç–∞—Ä—ñ
    if (e.target.closest('.comments-toggle')) {
      const postId = e.target.closest('.comments-toggle').dataset.postId;
      const sec = document.getElementById(`comments-${postId}`);
      sec.style.display = sec.style.display === 'none' ? 'block' : 'none';
    }

    // –≤—ñ–¥–ø—Ä–∞–≤–∏—Ç–∏ –∫–æ–º–µ–Ω—Ç–∞—Ä
    if (e.target.closest('.send-comment')) {
      const btn = e.target.closest('.send-comment');
      const postId = btn.dataset.postId;
      const textarea = document.getElementById(`comment-text-${postId}`);
      const text = textarea.value.trim();
      if (!text) return;
      const userDoc = await getDoc(doc(db, "users", currentUser.uid));
      const userData = userDoc.data();
      await addDoc(collection(db, "posts", postId, "comments"), {
        author: currentUser.uid, authorNickname: userData.nickname, authorAvatar: userData.avatar || '', text, createdAt: serverTimestamp()
      });
      // –∑–±—ñ–ª—å—à–∏—Ç–∏ –ª—ñ—á–∏–ª—å–Ω–∏–∫ –∫–æ–º–µ–Ω—Ç–∞—Ä—ñ–≤
      const postRef = doc(db, "posts", postId);
      await updateDoc(postRef, { commentsCount: arrayUnion('dummy') }); // –ø—Ä–æ—Å—Ç–æ —Ç—Ä–∏–≥–µ—Ä
      textarea.value = '';
    }

    // –ø–æ–∫–∞–∑–∞—Ç–∏ –ø–∞–Ω–µ–ª—å –µ–º–æ–¥–∑—ñ –¥–ª—è –∫–æ–º–µ–Ω—Ç–∞—Ä—è
    if (e.target.closest('.emoji-comment-btn')) {
      const btn = e.target.closest('.emoji-comment-btn');
      const postId = btn.dataset.postId;
      const picker = document.getElementById(`emoji-comment-${postId}`);
      picker.style.display = picker.style.display === 'none' ? 'flex' : 'none';
    }

    // –≤–∏–±—Ä–∞—Ç–∏ –µ–º–æ–¥–∑—ñ
    if (e.target.closest('.emoji-panel span')) {
      const span = e.target.closest('.emoji-panel span');
      const picker = span.closest('.emoji-panel');
      const postId = picker.id.replace('emoji-comment-', '');
      const textarea = document.getElementById(`comment-text-${postId}`);
      textarea.value += span.textContent;
      picker.style.display = 'none';
    }

    // –ø—ñ–¥–ø–∏—Å–∫–∞ –∑ –ø–æ—Å—Ç–∞
    if (e.target.closest('.subscribe-post-btn')) {
      const btn = e.target.closest('.subscribe-post-btn');
      const authorUid = btn.dataset.authorUid;
      await toggleFollow(authorUid);
      // –æ–Ω–æ–≤–∏—Ç–∏ —Ç–µ–∫—Å—Ç –∫–Ω–æ–ø–∫–∏
      const isFollowing = (await getDoc(doc(db, "users", currentUser.uid))).data().following.includes(authorUid);
      btn.textContent = isFollowing ? '–í—ñ–¥–ø–∏—Å–∞—Ç–∏—Å—è' : '–ü—ñ–¥–ø–∏—Å–∞—Ç–∏—Å—è';
    }

    // –∫–ª—ñ–∫ –Ω–∞ –∞–≤–∞—Ç–∞—Ä –∞–±–æ —ñ–º'—è
    if (e.target.closest('.avatar, .username, .comment-author')) {
      const el = e.target.closest('[data-uid]');
      if (!el) return;
      const uid = el.dataset.uid;
      if (uid === currentUser.uid) {
        viewingProfileUid = currentUser.uid;
        loadMyProfile();
      } else {
        viewingProfileUid = uid;
        loadUserProfile(uid);
      }
      // –ø–µ—Ä–µ–π—Ç–∏ –Ω–∞ —Å–µ–∫—Ü—ñ—é –ø—Ä–æ—Ñ—ñ–ª—é
      document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
      document.getElementById('profile').classList.add('active');
      document.getElementById('sidebar').classList.remove('active');
      document.getElementById('burger').classList.remove('active');
    }
  });

  // —Ä–µ–¥–∞–≥—É–≤–∞–Ω–Ω—è –ø–æ—Å—Ç–∞
  document.getElementById('savePostEdit').onclick = async () => {
    if (!currentEditPostId) return;
    const newText = document.getElementById('editPostText').value.trim();
    await updateDoc(doc(db, "posts", currentEditPostId), { text: newText });
    document.getElementById('editPostModal').classList.remove('active');
    currentEditPostId = null;
  };
  document.getElementById('closeEditPostModal').onclick = () => {
    document.getElementById('editPostModal').classList.remove('active');
    currentEditPostId = null;
  };

  // –ø–æ—à—É–∫ (–º–∏—Ç—Ç—î–≤–∏–π, –Ω–∏–∂–Ω—ñ–π —Ä–µ–≥—ñ—Å—Ç—Ä)
  async function loadSearchUsers() {
    const val = document.getElementById('searchInput').value.trim().toLowerCase();
    const userList = document.getElementById('userList');
    if (!val) { userList.innerHTML = ''; return; }
    const mySnap = await getDoc(doc(db, "users", currentUser.uid));
    const myFollowing = mySnap.data().following || [];
    const q = query(collection(db, "users"), where("nickname_lower", ">=", val), where("nickname_lower", "<=", val + '\uf8ff'));
    const snap = await getDocs(q);
    userList.innerHTML = '';
    snap.forEach(d => {
      if (d.id === currentUser.uid) return;
      const data = d.data();
      const isFollowing = myFollowing.includes(d.id);
      const div = document.createElement('div');
      div.className = 'user-item';
      div.innerHTML = `
        <div class="avatar" style="background-image:url(${data.avatar || ''})"></div>
        <span style="font-weight:600;">@${data.nickname}</span>
        <button class="follow-btn">${isFollowing ? '–í—ñ–¥–ø–∏—Å–∞—Ç–∏—Å—è' : '–ü—ñ–¥–ø–∏—Å–∞—Ç–∏—Å—è'}</button>
      `;
      div.querySelector('.follow-btn').onclick = async (e) => {
        e.stopPropagation();
        await toggleFollow(d.id);
        loadSearchUsers();
      };
      div.onclick = () => {
        // –≤—ñ–¥–∫—Ä–∏—Ç–∏ –ø—Ä–æ—Ñ—ñ–ª—å –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞
        viewingProfileUid = d.id;
        loadUserProfile(d.id);
        document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
        document.getElementById('profile').classList.add('active');
        document.getElementById('sidebar').classList.remove('active');
        document.getElementById('burger').classList.remove('active');
      };
      userList.appendChild(div);
    });
  }
  document.getElementById('searchInput').addEventListener('input', loadSearchUsers);

  async function toggleFollow(targetUid) {
    const myRef = doc(db, "users", currentUser.uid);
    const targetRef = doc(db, "users", targetUid);
    const mySnap = await getDoc(myRef);
    const following = mySnap.data().following || [];
    if (following.includes(targetUid)) {
      await updateDoc(myRef, { following: arrayRemove(targetUid) });
      await updateDoc(targetRef, { followers: arrayRemove(currentUser.uid) });
    } else {
      await updateDoc(myRef, { following: arrayUnion(targetUid) });
      await updateDoc(targetRef, { followers: arrayUnion(currentUser.uid) });
    }
  }

  // –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —Å–≤–æ–≥–æ –ø—Ä–æ—Ñ—ñ–ª—é
  async function loadMyProfile() {
    if (!currentUser) return;
    const snap = await getDoc(doc(db, "users", currentUser.uid));
    if (snap.exists()) {
      const data = snap.data();
      renderProfile(data, currentUser.uid, true);
    }
  }

  // –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —á—É–∂–æ–≥–æ –ø—Ä–æ—Ñ—ñ–ª—é
  async function loadUserProfile(uid) {
    const snap = await getDoc(doc(db, "users", uid));
    if (snap.exists()) {
      const data = snap.data();
      const isOwn = uid === currentUser?.uid;
      renderProfile(data, uid, isOwn);
    }
  }

  function renderProfile(data, uid, isOwn) {
    const profileDiv = document.getElementById('profile');
    const isFollowing = !isOwn && currentUser ? (data.followers?.includes(currentUser.uid) || false) : false;
    profileDiv.innerHTML = `
      <div class="card profile-header">
        <div class="profile-avatar" style="background-image:url(${data.avatar || ''})" data-uid="${uid}"></div>
        ${isOwn ? '<input type="file" id="avatarInput" accept="image/*" style="display:none;"/>' : ''}
        <div style="flex:1;">
          <h2>@${data.nickname}</h2>
          <p style="color:var(--text-sec); margin:10px 0;">${data.bio || '–û–ø–∏—Å –≤—ñ–¥—Å—É—Ç–Ω—ñ–π'}</p>
          <p style="color:var(--accent);">üü¢ –û–Ω–ª–∞–π–Ω</p>
          <div style="display:flex; gap:25px; font-weight:600;">
            <span>${data.posts?.length || 0} –ø–æ—Å—Ç—ñ–≤</span>
            <span>${data.followers?.length || 0} –ø—ñ–¥–ø–∏—Å–Ω–∏–∫—ñ–≤</span>
            <span>${data.following?.length || 0} –ø—ñ–¥–ø–∏—Å–æ–∫</span>
          </div>
          ${!isOwn && currentUser ? `
            <div style="margin-top:16px; display:flex; gap:10px;">
              <button id="profileFollowBtn">${isFollowing ? '–í—ñ–¥–ø–∏—Å–∞—Ç–∏—Å—è' : '–ü—ñ–¥–ø–∏—Å–∞—Ç–∏—Å—è'}</button>
              <button id="profileMessageBtn">–ù–∞–ø–∏—Å–∞—Ç–∏</button>
            </div>
          ` : ''}
          ${isOwn ? '<button id="editProfileBtn" style="margin-top:16px;">–†–µ–¥–∞–≥—É–≤–∞—Ç–∏ –ø—Ä–æ—Ñ—ñ–ª—å</button>' : ''}
        </div>
      </div>
    `;

    if (!isOwn && currentUser) {
      document.getElementById('profileFollowBtn').onclick = async () => {
        await toggleFollow(uid);
        loadUserProfile(uid); // –ø–µ—Ä–µ–∑–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ –ø—Ä–æ—Ñ—ñ–ª—å
      };
      document.getElementById('profileMessageBtn').onclick = () => {
        // –≤—ñ–¥–∫—Ä–∏—Ç–∏ —á–∞—Ç –∑ —Ü–∏–º –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–µ–º
        openChat(data.nickname, uid);
        document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
        document.getElementById('chats').classList.add('active');
      };
    }

    if (isOwn) {
      document.getElementById('profileAvatar').onclick = () => {
        document.getElementById('avatarInput').click();
      };
      document.getElementById('avatarInput').onchange = async (e) => {
        const file = e.target.files[0];
        if (!file) return;
        try {
          const storageRef = ref(storage, `avatars/${currentUser.uid}`);
          await uploadBytes(storageRef, file);
          const url = await getDownloadURL(storageRef);
          await updateDoc(doc(db, "users", currentUser.uid), { avatar: url });
          document.querySelector('.profile-avatar').style.backgroundImage = `url(${url})`;
        } catch { alert('–ü–æ–º–∏–ª–∫–∞'); }
      };
      document.getElementById('editProfileBtn').onclick = () => {
        document.getElementById('editNickname').value = data.nickname;
        document.getElementById('editBio').value = data.bio || '';
        document.getElementById('editProfileModal').classList.add('active');
      };
    }
  }

  // —Ä–µ–¥–∞–≥—É–≤–∞–Ω–Ω—è –ø—Ä–æ—Ñ—ñ–ª—é
  document.getElementById('closeModal').onclick = () => document.getElementById('editProfileModal').classList.remove('active');
  document.getElementById('saveProfileEdit').onclick = async () => {
    const nickname = document.getElementById('editNickname').value.trim();
    const bio = document.getElementById('editBio').value.trim();
    if (!nickname) return alert('–ü—Å–µ–≤–¥–æ–Ω—ñ–º –æ–±–æ–≤‚Äô—è–∑–∫–æ–≤–∏–π');
    await updateDoc(doc(db, "users", currentUser.uid), { nickname, nickname_lower: nickname.toLowerCase(), bio });
    loadMyProfile();
    document.getElementById('editProfileModal').classList.remove('active');
  };

  // —á–∞—Ç–∏
  async function loadChatList() {
    const list = document.getElementById('chatList');
    list.innerHTML = '';
    const q = query(collection(db, "users"));
    onSnapshot(q, snapshot => {
      list.innerHTML = '';
      snapshot.forEach(d => {
        if (d.id === currentUser.uid) return;
        const data = d.data();
        const item = document.createElement('div');
        item.className = 'chat-item';
        item.innerHTML = `<div class="avatar" style="background-image:url(${data.avatar || ''})"></div><span>@${data.nickname}</span>`;
        item.onclick = () => openChat(data.nickname, d.id);
        list.appendChild(item);
      });
    });
  }

  function openChat(name, uid) {
    currentChatPartner = uid;
    document.getElementById('chatWindow').style.display = 'flex';
    document.getElementById('chatHeader').innerHTML = `
      <div class="avatar" style="background-image:url(${''})"></div>
      <span>@${name}</span>
    `;
    // –∑–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ –∞–≤–∞—Ç–∞—Ä —Å–ø—ñ–≤—Ä–æ–∑–º–æ–≤–Ω–∏–∫–∞
    getDoc(doc(db, "users", uid)).then(snap => {
      if (snap.exists()) {
        document.querySelector('#chatHeader .avatar').style.backgroundImage = `url(${snap.data().avatar || ''})`;
      }
    });
    subscribeToChat(uid);
  }

  function subscribeToChat(otherUid) {
    if (unsubscribeChat) unsubscribeChat();
    const chatId = getChatId(currentUser.uid, otherUid);
    const q = query(collection(db, `messages/${chatId}/chat`), orderBy("createdAt"));
    unsubscribeChat = onSnapshot(q, snap => {
      const messages = document.getElementById('chatMessages');
      messages.innerHTML = '';
      snap.forEach(m => {
        const msg = m.data();
        const div = document.createElement('div');
        div.className = `message ${msg.from === currentUser.uid ? 'sent' : 'received'}`;
        div.textContent = msg.text;
        messages.appendChild(div);
      });
      messages.scrollTop = messages.scrollHeight;
    });
  }

  document.getElementById('sendMessage').onclick = async () => {
    const text = document.getElementById('chatText').value.trim();
    if (!text || !currentChatPartner) return;
    const chatId = getChatId(currentUser.uid, currentChatPartner);
    await addDoc(collection(db, `messages/${chatId}/chat`), {
      from: currentUser.uid, text, createdAt: serverTimestamp()
    });
    document.getElementById('chatText').value = '';
  };

  // —Ç–µ–º–∞
  document.getElementById('toggleTheme').onclick = () => {
    document.body.classList.toggle('light');
    localStorage.setItem('theme', document.body.classList.contains('light') ? 'light' : 'dark');
  };
  if (localStorage.getItem('theme') === 'light') document.body.classList.add('light');

  // –≤–∏—Ö—ñ–¥
  document.getElementById('logoutBtn').onclick = () => signOut(auth);

  // –ø—Ä–∏—Ö–æ–≤–∞—Ç–∏ —á–∞—Ç —Å–ø–æ—á–∞—Ç–∫—É
  document.getElementById('chatWindow').style.display = 'none';
</script>
</body>
</html>
